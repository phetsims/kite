function _defineProperty(t,e,i){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var s=i.call(t,e||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}!function(){if(window.phet=window.phet||{},!window.hasOwnProperty("_"))throw new Error("Underscore/Lodash not found: _");window.assertions=window.assertions||{},window.assertions.assertFunction=window.assertions.assertFunction||function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];if(!t){i=i.filter(t=>!!i),window.navigator&&"Microsoft Internet Explorer"===window.navigator.appName&&i.push("stack=\n"+(new Error).stack);const t=i.length>0?"Assertion failed: ":"Assertion failed";throw console&&console.log&&console.log(t,...i),window.phet&&phet.chipper&&phet.chipper.queryParameters&&phet.chipper.queryParameters.debugger,new Error(t+i.join("\n "))}},window.assert=window.assert||null,window.assertSlow=window.assertSlow||null,window.assertions.enableAssert=function(){window.assert=window.assertions.assertFunction,window.console&&window.console.log&&window.console.log("enabling assert")},window.assertions.disableAssert=function(){window.assert=null,window.console&&window.console.log&&window.console.log("disabling assert")},window.assertions.enableAssertSlow=function(){window.assertSlow=window.assertions.assertFunction,window.console&&window.console.log&&window.console.log("enabling assertSlow")},window.assertions.disableAssertSlow=function(){window.assertSlow=null,window.console&&window.console.log&&window.console.log("disabling assertSlow")},function(){window.phetio=window.phetio||{};window.phetio.PhetioIDUtils={append:function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];return i.forEach(e=>{t+="."+e}),t},getComponentName:function(t){const e=t.lastIndexOf(".");return-1===e?t:t.substring(e+1,t.length)},getParentID:function(t){const e=t.lastIndexOf(".");return-1===e?null:t.substring(0,e)},getDOMElementID:function(t){return"phetioID:"+t},getScreenID:function(t){const e=[],i=t.split(".");for(let s=0;s<i.length;s++){const t=i[s];e.push(t);const n=t.indexOf("Screen");if(n>0&&n+"Screen".length===t.length)return e.join(".")}return null},getGroupElementIndex:function(t){return Number(t.split(window.phetio.PhetioIDUtils.GROUP_SEPARATOR)[1])},isAncestor:function(t,e){const i=t.split("."),s=e.split(".");for(let n=0;n<i.length;n++)if(i[n]!==s[n])return!1;return e!==t},SEPARATOR:".",GROUP_SEPARATOR:"_",INTER_TERM_SEPARATOR:"-",GENERAL_COMPONENT_NAME:"general",GLOBAL_COMPONENT_NAME:"global",HOME_SCREEN_COMPONENT_NAME:"homeScreen",MODEL_COMPONENT_NAME:"model",VIEW_COMPONENT_NAME:"view",CONTROLLER_COMPONENT_NAME:"controller",COLORS_COMPONENT_NAME:"colors"}}();window.FlatQueue=class{constructor(){this.ids=[],this.values=[],this.length=0}clear(){this.length=0}push(t,e){let i=this.length++;for(this.ids[i]=t,this.values[i]=e;i>0;){const t=i-1>>1,s=this.values[t];if(e>=s)break;this.ids[i]=this.ids[t],this.values[i]=s,i=t}this.ids[i]=t,this.values[i]=e}pop(){if(0===this.length)return;const t=this.ids[0];if(this.length--,this.length>0){const t=this.ids[0]=this.ids[this.length],e=this.values[0]=this.values[this.length],i=this.length>>1;let s=0;for(;s<i;){let t=1+(s<<1);const i=t+1;let n=this.ids[t],r=this.values[t];const a=this.values[i];if(i<this.length&&a<r&&(t=i,n=this.ids[i],r=a),r>=e)break;this.ids[s]=n,this.values[s]=r,s=t}this.ids[s]=t,this.values[s]=e}return t}peek(){if(0!==this.length)return this.ids[0]}peekValue(){if(0!==this.length)return this.values[0]}},(()=>{"use strict";var t={897:(t,e,i)=>{let s;i.d(e,{Z:()=>n}),t=i.hmd(t);try{s=t&&t.hot}catch(r){s=!1}const n=s}},e={};function i(s){var n=e[s];if(void 0!==n)return n.exports;var r=e[s]={id:s,loaded:!1,exports:{}};return t[s](r,r.exports,i),r.loaded=!0,r.exports}i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.hmd=t=>((t=Object.create(t)).children||(t.children=[]),Object.defineProperty(t,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+t.id)}}),t),i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{let t;var e=i(897);const s=class{constructor(t){if(this.name=t,window.phet){if("chipper"===t)return window.phet.chipper.name="chipper",window.phet.chipper.register=this.register.bind(window.phet.chipper),window.phet.chipper;_.hasIn(window,"phet.chipper.brand");window.phet[t]=this}}register(t,i){if(t.indexOf(".")<0)e.Z,this[t]=i;else{const s=t.split(".");let n=this;for(let t=0;t<s.length-1;t++)e.Z,n=n[s[t]];const r=s[s.length-1];e.Z,n[r]=i}return i}},n=new s("axon");_.hasIn(window,"phet.chipper.queryParameters")&&phet.chipper.queryParameters.shuffleListeners;class r{constructor(t){t&&(this.onBeforeNotify=t),this.listeners=new Set,this.emitContexts=[]}dispose(){this.removeAllListeners()}emit(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if(this.onBeforeNotify&&this.onBeforeNotify.apply(null,e),this.listeners.size>0){const t={index:0};this.emitContexts.push(t);for(const i of this.listeners)if(i(...e),t.index++,t.listenerArray)break;if(t.listenerArray)for(let i=t.index;i<t.listenerArray.length;i++)t.listenerArray[i](...e);this.emitContexts.pop()}}addListener(t){this.guardListeners(),this.listeners.add(t),this.changeCount&&this.changeCount(1)}removeListener(t){this.guardListeners(),this.listeners.delete(t),this.changeCount&&this.changeCount(-1)}removeAllListeners(){const t=this.listeners.size;this.guardListeners(),this.listeners.clear(),this.changeCount&&this.changeCount(-t)}guardListeners(){for(let t=this.emitContexts.length-1;t>=0&&!this.emitContexts[t].listenerArray;t--)this.emitContexts[t].listenerArray=Array.from(this.listeners)}hasListener(t){return this.listeners.has(t)}hasListeners(){return this.listeners.size>0}getListenerCount(){return this.listeners.size}forEachListener(t){this.listeners.forEach(t)}}n.register("TinyEmitter",r);class a extends r{setTimeout(t,e){let i=0;const s=n=>{i+=n,1e3*i>=e&&this.hasListener(s)&&(t(),this.removeListener(s))};return this.addListener(s),s}clearTimeout(t){this.hasListener(t)&&this.removeListener(t)}setInterval(t,e){let i=0;const s=n=>{for(i+=n;1e3*i>=e&&this.hasListener(s);)t(),i-=e/1e3};return this.addListener(s),s}clearInterval(t){this.hasListener(t)&&this.removeListener(t)}runOnNextTick(t){this.setTimeout(t,0)}}n.register("Timer",a);const h=new a;n.register("animationFrameTimer",h);const o=new s("phetCore");o.register("Namespace",s);const l=o;function u(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];return _.each(i,e=>{if(e)for(const i in e)if(e.hasOwnProperty(i)&&void 0!==e[i]){const s=e[i];_.endsWith(i,"Options")&&"Options"!==i?t[i]=u(t[i]||{},s):t[i]=s}}),t}l.register("merge",u);const m=u,d=(t,e,i,s)=>m(t,e,i,s);function c(){return d}l.register("optionize",c);const p=new s("tandem"),g={},f=t=>{window.phet&&window.phet.chipper&&window.phet.chipper.queryParameters&&phet.chipper.queryParameters.deprecationWarnings&&(g.hasOwnProperty(t)||(g[t]=!0,console.warn("Deprecation warning: "+t)))};l.register("deprecationWarning",f);const y=f;class x{constructor(t){y("EnumerationDeprecated should be exchanged for classes that extend EnumerationValue, see WilderEnumerationPatterns for examples.");t.keys,t.map;const e=t.keys||Object.keys(t.map),i=t.map||{};t=m({phetioDocumentation:null,beforeFreeze:null},t),this.phetioDocumentation=t.phetioDocumentation,this.KEYS=e,this.VALUES=[],e.forEach(t=>{const e=i[t]||{};e.name=t,e.toString=()=>t,this[t]=e,this.VALUES.push(e)}),t.beforeFreeze&&t.beforeFreeze(this)}toString(){return this.KEYS.join(", ")}includes(t){return _.includes(this.VALUES,t)}getValue(t){return this[t]}getKey(t){return t.name}get values(){return this.VALUES}get keys(){return this.KEYS}get enumeration(){return this}static byKeys(t,e){return new x(m({keys:t},e))}static byMap(t,e){return new x(m({map:t},e))}}l.register("EnumerationDeprecated",x);const w=x,v=["string","number","boolean","function"],b=["valueType","validValues","valueComparisonStrategy","isValidValue","phetioType","validators"];class T{static getValidatorValidationError(t){if(!(t instanceof Object))return"validator must be an Object";if(!(t.hasOwnProperty("isValidValue")||t.hasOwnProperty("valueType")||t.hasOwnProperty("validValues")||t.hasOwnProperty("valueComparisonStrategy")||t.hasOwnProperty("phetioType")||t.hasOwnProperty("validators")))return this.combineErrorMessages("validator must have at least one of: "+b.join(","),t.validationMessage);if(t.hasOwnProperty("valueType")){const e=T.getValueOrElementTypeValidationError(t.valueType);if(e)return this.combineErrorMessages(`Invalid valueType: ${t.valueType}, error: ${e}`,t.validationMessage)}if(t.hasOwnProperty("isValidValue")&&"function"!=typeof t.isValidValue&&null!==t.isValidValue&&void 0!==t.isValidValue)return this.combineErrorMessages("isValidValue must be a function: "+t.isValidValue,t.validationMessage);if(t.hasOwnProperty("valueComparisonStrategy")&&"reference"!==t.valueComparisonStrategy&&"lodashDeep"!==t.valueComparisonStrategy&&"equalsFunction"!==t.valueComparisonStrategy&&"function"!=typeof t.isValidValue)return this.combineErrorMessages('valueComparisonStrategy must be "reference", "lodashDeep", \n        "equalsFunction", or a comparison function: '+t.valueComparisonStrategy,t.validationMessage);if(void 0!==t.validValues&&null!==t.validValues){if(!Array.isArray(t.validValues))return this.combineErrorMessages("validValues must be an array: "+t.validValues,t.validationMessage);const e=_.omit(t,"validValues");if(T.containsValidatorKey(e))for(let i=0;i<t.validValues.length;i++){const s=t.validValues[i],n=T.getValidationError(s,e);if(n)return this.combineErrorMessages(`Item not valid in validValues: ${s}, error: ${n}`,t.validationMessage)}}if(t.hasOwnProperty("phetioType")){if(!t.phetioType)return this.combineErrorMessages("falsey phetioType provided",t.validationMessage);if(!t.phetioType.validator)return this.combineErrorMessages("validator needed for phetioType: "+t.phetioType.typeName,t.validationMessage);const e=T.getValidatorValidationError(t.phetioType.validator);if(e)return this.combineErrorMessages(e,t.validationMessage)}if(t.hasOwnProperty("validators")){const e=t.validators;for(let i=0;i<e.length;i++){const s=e[i],n=T.getValidatorValidationError(s);if(n)return this.combineErrorMessages(`validators[${i}] invalid: ${n}`,t.validationMessage)}}return null}static getValueTypeValidatorValidationError(t){return"function"==typeof t||"string"==typeof t||t instanceof w||null==t?"string"!=typeof t||_.includes(v,t)?null:"valueType not a supported primitive types: "+t:"valueType must be {function|string|EnumerationDeprecated|null|undefined}, valueType="+t}static validateValidator(t){0}static containsValidatorKey(t){if(!(t instanceof Object))return!1;for(let e=0;e<b.length;e++)if(t.hasOwnProperty(b[e]))return!0;return!1}static combineErrorMessages(t,e){return e&&(t=`${e}: ${t}`),t}static isValueValid(t,e,i){return null===this.getValidationError(t,e,i)}static getValidationError(t,e,i){const s=c()({validateValidator:!0},i);if(s.validateValidator){const t=T.getValidatorValidationError(e);if(t)return t}if(e.hasOwnProperty("valueType")){const i=e.valueType;if(Array.isArray(i)){if(!_.some(i.map(i=>!T.getValueTypeValidationError(t,i,e.validationMessage))))return this.combineErrorMessages(`value not valid for any valueType in ${i.toString().substring(0,100)}, value: ${t}`,e.validationMessage)}else if(i){const s=T.getValueTypeValidationError(t,i,e.validationMessage);if(s)return s}}if(e.validValues){const i=e.valueComparisonStrategy||"reference";if(!e.validValues.some(e=>{if("reference"===i)return e===t;if("equalsFunction"===i){const i=e;return i.equals(t)}return"lodashDeep"===i?_.isEqual(e,t):i(e,t)}))return this.combineErrorMessages("value not in validValues: "+t,e.validationMessage)}if(e.hasOwnProperty("isValidValue")&&!e.isValidValue(t))return this.combineErrorMessages("value failed isValidValue: "+t,e.validationMessage);if(e.hasOwnProperty("phetioType")){const i=T.getValidationError(t,e.phetioType.validator,s);if(i)return this.combineErrorMessages(`value failed phetioType validator: ${t}, error: ${i}`,e.validationMessage)}if(e.hasOwnProperty("validators")){const i=e.validators;for(let n=0;n<i.length;n++){const r=i[n],a=T.getValidationError(t,r,s);if(a)return this.combineErrorMessages(`Failed validation for validators[${n}]: ${a}`,e.validationMessage)}}return null}static getValueTypeValidationError(t,e,i){return"string"==typeof e&&typeof t!==e?this.combineErrorMessages(`value should have typeof ${e}, value=${t}`,i):e!==Array||Array.isArray(t)?e instanceof w&&!e.includes(t)?this.combineErrorMessages("value is not a member of EnumerationDeprecated "+e,i):"function"!=typeof e||t instanceof e?null===e&&null!==t?this.combineErrorMessages("value should be null, value="+t,i):null:this.combineErrorMessages(`value should be instanceof ${e.name}, value=${t}`,i):this.combineErrorMessages("value should have been an array, value="+t,i)}static getValueOrElementTypeValidationError(t){if(Array.isArray(t))for(let e=0;e<t.length;e++){const i=t[e],s=T.getValueTypeValidatorValidationError(i);if(s)return"Array value invalid: "+s}else if(t){const e=T.getValueTypeValidatorValidationError(t);if(e)return"Value type invalid: "+e}return null}}_defineProperty(T,"VALIDATOR_KEYS",b),_defineProperty(T,"STRING_WITHOUT_TEMPLATE_VARS_VALIDATOR",{valueType:"string",isValidValue:t=>!/\{\{\w*\}\}/.test(t)}),n.register("Validation",T);const E=(t,e,i)=>{0};n.register("validate",E);const A=E,M={IO_TYPE_SUFFIX:"IO"};p.register("PhetioConstants",M);const P=M,I={OBJECT_IO_TYPE_NAME:"ObjectIO",EVENT_TYPE_MODEL:"MODEL",PHET_IO_OBJECT_METADATA_DEFAULTS:{phetioTypeName:"ObjectIO",phetioDocumentation:"",phetioState:!0,phetioReadOnly:!1,phetioEventType:"MODEL",phetioHighFrequency:!1,phetioPlayback:!1,phetioDynamicElement:!1,phetioIsArchetype:!1,phetioFeatured:!1,phetioDesigned:!1,phetioArchetypePhetioID:null},METADATA_KEY_NAME:"_metadata",DATA_KEY_NAME:"_data"};p.register("TandemConstants",I);const S=I,O=function(t){};l.register("assertMutuallyExclusiveOptions",O);const V=O;class N{constructor(t){const e=c()({displayString:"",validator:null,compositeSchema:null},t);this.displayString=e.displayString,this.validator=e.validator,this.compositeSchema=e.compositeSchema}validateStateSchema(t){0}defaultApplyState(t,e){const i=(e,s)=>{for(const n in e)if(e.hasOwnProperty(n))if("_private"===n)i(e._private,s._private);else{const i=e[n];"fromStateObject"===i.defaultDeserializationMethod?t[n]=e[n].fromStateObject(s[n]):e[n].applyState(t[n],s[n])}};i(this.compositeSchema,e)}defaultToStateObject(t){const e=i=>{const s={};for(const n in i)i.hasOwnProperty(n)&&("_private"===n?s._private=e(i._private):s[n]=i[n].toStateObject(t[n]));return s};return e(this.compositeSchema)}isComposite(){return!!this.compositeSchema}checkStateObjectValid(t,e,i,s){if(this.isComposite()){const e=t,n=this.compositeSchema;let r=null;const a=(t,e,i,s)=>{e?Object.keys(t).filter(t=>t!==s).forEach(s=>{const n=e.hasOwnProperty(s);n||(r=!1),t[s].validateStateObject(e[s]),i.push(s)}):r=!1};return a(n,e,i,"_private"),n._private&&a(n._private,e._private,s,null),r}{const i=t;return e&&A(i,this.validator),T.isValueValid(i,this.validator)}}getRelatedTypes(){const t=[],e=e=>{Object.keys(e).forEach(i=>{e[i]instanceof C&&t.push(e[i])})};return this.compositeSchema&&(e(this.compositeSchema),this.compositeSchema._private&&e(this.compositeSchema._private)),t}getStateSchemaAPI(){if(this.isComposite()){const t=_.mapValues(this.compositeSchema,t=>t.typeName);return this.compositeSchema._private&&(t._private=_.mapValues(this.compositeSchema._private,t=>t.typeName)),t}return this.displayString}static asValue(t,e){return new N({validator:e,displayString:t})}}p.register("StateSchema",N);const D={validateValidator:!1},Y=t=>{const e=t.indexOf(P.IO_TYPE_SUFFIX);return t.substring(0,e)};class C{constructor(t,e){this.typeName=t;const i=e.supertype||C.ObjectIO,s=!!e.toStateObject,n=!!e.applyState,r=!!e.stateSchema,a=c()({supertype:C.ObjectIO,methods:{},events:[],metadataDefaults:{},dataDefaults:{},methodOrder:[],parameterTypes:[],documentation:"IO Type for "+Y(t),isFunctionType:!1,toStateObject:i&&i.toStateObject,fromStateObject:i&&i.fromStateObject,stateObjectToCreateElementArguments:i&&i.stateObjectToCreateElementArguments,applyState:i&&i.applyState,stateSchema:null,defaultDeserializationMethod:"fromStateObject",addChildElement:i&&i.addChildElement},e);if(this.supertype=i,this.documentation=a.documentation,this.methods=a.methods,this.events=a.events,this.metadataDefaults=a.metadataDefaults,this.dataDefaults=a.dataDefaults,this.methodOrder=a.methodOrder,this.parameterTypes=a.parameterTypes,this.validator=_.pick(a,T.VALIDATOR_KEYS),this.validator.validationMessage=this.validator.validationMessage||"Validation failed IOType Validator: "+this.typeName,this.defaultDeserializationMethod=a.defaultDeserializationMethod,null===a.stateSchema||a.stateSchema instanceof N)this.stateSchema=a.stateSchema;else{const t="function"==typeof a.stateSchema?a.stateSchema(this):a.stateSchema;this.stateSchema=new N({compositeSchema:t})}this.toStateObject=t=>{let e;return A(t,this.validator,D),e=!s&&r&&this.stateSchema&&this.stateSchema.isComposite()?this.stateSchema.defaultToStateObject(t):a.toStateObject(t),e},this.fromStateObject=a.fromStateObject,this.stateObjectToCreateElementArguments=a.stateObjectToCreateElementArguments,this.applyState=(t,e)=>{A(t,this.validator,D),!n&&r&&this.stateSchema&&this.stateSchema.isComposite()?this.stateSchema.defaultApplyState(t,e):a.applyState(t,e)},this.isFunctionType=a.isFunctionType,this.addChildElement=a.addChildElement}getTypeHierarchy(){const t=[];let e=this;for(;e;)t.push(e),e=e.supertype;return t}extends(t){return this.getTypeHierarchy().includes(t)}getAllMetadataDefaults(){return _.merge({},this.supertype?this.supertype.getAllMetadataDefaults():{},this.metadataDefaults)}getAllDataDefaults(){return _.merge({},this.supertype?this.supertype.getAllDataDefaults():{},this.dataDefaults)}isStateObjectValid(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],n=!0;if(this.stateSchema){const n=this.stateSchema.checkStateObjectValid(t,e,i,s);if(null!==n)return n}if(this.supertype)return n&&this.supertype.isStateObjectValid(t,e,i,s);if(!this.supertype&&t&&"string"!=typeof t&&!Array.isArray(t)){const e=(t,e)=>{const r=("public"===t?i:s).includes(e);r||(n=!1)};return Object.keys(t).filter(t=>"_private"!==t).forEach(t=>e("public",t)),t._private&&Object.keys(t._private).forEach(t=>e("private",t)),n}return!0}validateStateObject(t){this.isStateObjectValid(t,!0)}toString(){return this.typeName}}C.ObjectIO=new C(S.OBJECT_IO_TYPE_NAME,{isValidValue:()=>!0,supertype:null,documentation:"The root of the IO Type hierarchy",toStateObject:t=>(phet&&phet.tandem&&phet.tandem.Tandem.VALIDATION,null),fromStateObject:()=>{throw new Error("ObjectIO.fromStateObject should not be called")},stateObjectToCreateElementArguments:t=>[],applyState:_.noop,metadataDefaults:S.PHET_IO_OBJECT_METADATA_DEFAULTS,dataDefaults:{initialState:null},stateSchema:null}),p.register("IOType",C);const X=new C("ValueIO",{isValidValue:_.stubTrue,supertype:C.ObjectIO,toStateObject:t=>t,fromStateObject:t=>t,stateSchema:N.asValue("*",{isValidValue:_.stubTrue})});p.register("ValueIO",X);const F=X,R=new C("BooleanIO",{supertype:F,valueType:"boolean",documentation:"IO Type for Javascript's boolean primitive type",stateSchema:N.asValue("boolean",{valueType:"boolean"}),toStateObject:_.identity});p.register("BooleanIO",R);const L=R;function z(t,e){const i=_.indexOf(t,e);t.splice(i,1)}l.register("arrayRemove",z);const k=z;class q{toString(){return this.name}isEnumerationValue(){return!0}constructor(){this.constructor;this._name=null,this._enumeration=null}set name(t){this._name=t}get name(){return this._name}set enumeration(t){this._enumeration=t}get enumeration(){return this._enumeration}}_defineProperty(q,"sealedCache",new Set),l.register("EnumerationValue",q);const B=q;function Z(t){const e=[t];let i=t.prototype;for(;i&&(i=Object.getPrototypeOf(i));)i.constructor&&e.push(i.constructor);return e}l.register("inheritance",Z);const j=Z;class H{constructor(t,e){const i=c()({phetioDocumentation:"",instanceType:t},e);this.phetioDocumentation=i.phetioDocumentation;const s=i.instanceType,n=_.reverse(j(t));this.keys=[],this.values=[],n.forEach(e=>{Object.keys(e).forEach(i=>{const n=e[i];n instanceof s&&(this.keys.push(i),this.values.push(n),n instanceof t&&(n.name=i,n.enumeration=this))})}),this.Enumeration=t,B.sealedCache.add(t)}getKey(t){return t.name}getValue(t){return this.Enumeration[t]}includes(t){return this.values.includes(t)}}l.register("Enumeration",H);const $=H,U=new Map,G=t=>t.join("|"),W=t=>{const e=t.enumeration;if(!U.has(e)){const t=e.phetioDocumentation?" "+e.phetioDocumentation:"",i=e.keys,s=e.values,n=`EnumerationIO(${G(i)})`;U.set(e,new C(n,{validValues:s,documentation:`Possible values: ${i.join(", ")}.${t}`,toStateObject:t=>e.getKey(t),fromStateObject:t=>e.getValue(t),stateSchema:N.asValue(""+G(i),{isValidValue:t=>i.includes(t)})}))}return U.get(e)};p.register("EnumerationIO",W);const Q=W;t=S.EVENT_TYPE_MODEL;class J extends B{}_defineProperty(J,"USER",new J),_defineProperty(J,t,new J),_defineProperty(J,"WRAPPER",new J),_defineProperty(J,"OPT_OUT",new J),_defineProperty(J,"enumeration",new $(J)),_defineProperty(J,"phetioType",Q(J)),p.register("EventType",J);const K=J,tt=_.hasIn(window,"phet.chipper.packageObject")?phet.chipper.packageObject:{name:"placeholder"},et=_.hasIn(window,"phet.preloads.phetio"),it=et&&phet.preloads.phetio.queryParameters.phetioPrintMissingTandems,st=!_.hasIn(tt,"phet.phet-io.validation")||!!tt.phet["phet-io"].validation,nt=window.QueryStringMachine&&QueryStringMachine.containsKey("phetioValidation"),rt=et&&nt?!!phet.preloads.phetio.queryParameters.phetioValidation:et&&st,at=et&&rt&&!it,ht=phetio.PhetioIDUtils.INTER_TERM_SEPARATOR,ot={required:[],optional:[]},lt=[],ut=[];class mt{constructor(t,e,i){_defineProperty(this,"children",{}),_defineProperty(this,"isDisposed",!1),this.parentTandem=t,this.name=e,this.phetioID=this.parentTandem?window.phetio.PhetioIDUtils.append(this.parentTandem.phetioID,this.name):this.name;const s=c()({required:!0,supplied:!0,isValidTandemName:t=>/^[a-zA-Z0-9[\],]+$/.test(t)},i);this.children={},this.parentTandem&&this.parentTandem.addChild(e,this),this.required=s.required,this.supplied=s.supplied}static onMissingTandem(t){if(it&&!t.supplied){const e=(new Error).stack;t.required?ot.required.push({phetioID:t.phetioID,stack:e}):e.includes("Font")||ot.optional.push({phetioID:t.phetioID,stack:e})}}addPhetioObject(t){if(et){if(!this.required&&!this.supplied)return;if(mt.launched)for(let e=0;e<lt.length;e++)lt[e].addPhetioObject(t);else mt.bufferedPhetioObjects.push(t)}}hasAncestor(t){return this.parentTandem===t||!(!this.parentTandem||!this.parentTandem.hasAncestor(t))}removePhetioObject(t){if(this.required||this.supplied){if(et)if(mt.launched)for(let e=0;e<lt.length;e++)lt[e].removePhetioObject(t);else k(mt.bufferedPhetioObjects,t);t.tandem.dispose()}}getExtendedOptions(t){return m({supplied:this.supplied,required:this.required},t)}createTandem(t,e){if(e=this.getExtendedOptions(e),this.hasChild(t)){const e=this.children[t];return e}return new mt(this,t,e)}hasChild(t){return this.children.hasOwnProperty(t)}addChild(t,e){this.children[t]=e}iterateDescendants(t){for(const e in this.children)this.children.hasOwnProperty(e)&&(t(this.children[e]),this.children[e].iterateDescendants(t))}removeChild(t){delete this.children[t]}dispose(){this.parentTandem.removeChild(this.name),this.parentTandem=null,this.isDisposed=!0}getArchetypalPhetioID(){const t=this.parentTandem?window.phetio.PhetioIDUtils.append(this.parentTandem.getArchetypalPhetioID(),this.name):this.phetioID;if(t.includes("_")){return t.split(ht).map(t=>t.includes("_")?"archetype":t).join(ht)}return t}createGroupTandem(t){return this.children[t]?this.children[t]:new pt(this,t)}equals(t){return this.phetioID===t.phetioID}static addPhetioObjectListener(t){lt.push(t)}static launch(){for(mt.launched=!0;ut.length>0;)ut.shift()()}static unlaunch(){mt.launched=!1,mt.bufferedPhetioObjects.length=0,ut.length=0}static addLaunchListener(t){ut.push(t)}createTandemFromPhetioID(t){return this.createTandem(t.split(window.phetio.PhetioIDUtils.SEPARATOR).join(ht),{isValidTandemName:t=>/^[a-zA-Z0-9[\],-_]+$/.test(t)})}}_defineProperty(mt,"SCREEN_TANDEM_NAME_SUFFIX","Screen"),_defineProperty(mt,"missingTandems",ot),_defineProperty(mt,"PHET_IO_ENABLED",et),_defineProperty(mt,"API_GENERATION",mt.PHET_IO_ENABLED&&(phet.preloads.phetio.queryParameters.phetioPrintAPI||phet.preloads.phetio.queryParameters.phetioCompareAPI)),_defineProperty(mt,"VALIDATION",at),_defineProperty(mt,"METADATA_KEY","_metadata"),_defineProperty(mt,"DATA_KEY","_data"),_defineProperty(mt,"launched",!1),_defineProperty(mt,"bufferedPhetioObjects",[]),mt.addLaunchListener(()=>{for(;mt.bufferedPhetioObjects.length>0;){const t=mt.bufferedPhetioObjects.shift();t.tandem.addPhetioObject(t)}});mt.ROOT=new class extends mt{createTandem(t,e){if(mt.VALIDATION){t===window.phetio.PhetioIDUtils.GLOBAL_COMPONENT_NAME||"requiredTandem"===t||"optionalTandem"===t||"test"===t||t===window.phetio.PhetioIDUtils.GENERAL_COMPONENT_NAME||_.endsWith(t,mt.SCREEN_TANDEM_NAME_SUFFIX)}return super.createTandem(t,e)}}(null,_.camelCase(tt.name));const dt=mt.ROOT.createTandem(window.phetio.PhetioIDUtils.GENERAL_COMPONENT_NAME);mt.ROOT_TEST=mt.ROOT.createTandem("test"),mt.GENERAL_MODEL=dt.createTandem(window.phetio.PhetioIDUtils.MODEL_COMPONENT_NAME),mt.GENERAL_VIEW=dt.createTandem(window.phetio.PhetioIDUtils.VIEW_COMPONENT_NAME),mt.GENERAL_CONTROLLER=dt.createTandem(window.phetio.PhetioIDUtils.CONTROLLER_COMPONENT_NAME);const ct=mt.ROOT.createTandem(window.phetio.PhetioIDUtils.GLOBAL_COMPONENT_NAME);mt.GLOBAL_MODEL=ct.createTandem(window.phetio.PhetioIDUtils.MODEL_COMPONENT_NAME),mt.GLOBAL_VIEW=ct.createTandem(window.phetio.PhetioIDUtils.VIEW_COMPONENT_NAME),mt.COLORS=mt.GLOBAL_VIEW.createTandem(window.phetio.PhetioIDUtils.COLORS_COMPONENT_NAME),mt.OPTIONAL=mt.ROOT.createTandem("optionalTandem",{required:!1,supplied:!1}),mt.OPT_OUT=mt.OPTIONAL,mt.REQUIRED=mt.ROOT.createTandem("requiredTandem",{required:at||it,supplied:!1}),mt.PREFERENCES=mt.GLOBAL_MODEL.createTandem("preferences");class pt extends mt{constructor(t,e){super(t,e),this.groupName=e,this.groupMemberIndex=0}createNextTandem(){const t=this.parentTandem.createTandem(`${this.groupName}${this.groupMemberIndex}`);return this.groupMemberIndex++,t}}p.register("Tandem",mt);const gt=mt,ft=new C("StringIO",{supertype:F,valueType:"string",documentation:"IO Type for Javascript's string primitive type",stateSchema:N.asValue("string",{valueType:"string"}),toStateObject:_.identity});p.register("StringIO",ft);const yt=ft,xt=new C("LinkedElementIO",{isValidValue:()=>!0,documentation:"A LinkedElement",toStateObject:t=>({elementID:t.element.tandem.phetioID}),applyState:_.noop,stateSchema:{elementID:yt}});p.register("LinkedElementIO",xt);const _t=xt,wt=["phetioDynamicElement","phetioEventType","phetioIsArchetype","phetioPlayback","phetioReadOnly","phetioState","phetioTypeName"];const vt=new class{constructor(){_defineProperty(this,"apiMismatches",[]),_defineProperty(this,"simHasStarted",!1),_defineProperty(this,"enabled",!1),_defineProperty(this,"everyPhetioType",{})}onSimStarted(){this.enabled&&phet.joist.sim.allScreensCreated&&(this.validateOverridesFile(),this.validatePreferencesModel()),phet.preloads.phetio.queryParameters.phetioPrintAPIProblems&&this.apiMismatches&&console.log("PhET-iO api problems detected: ",this.apiMismatches),this.simHasStarted=!0}validatePreferencesModel(){Object.keys(phet.phetio.phetioEngine.phetioObjectMap).filter(t=>t.includes(".preferencesModel.")).forEach(t=>{let e=phet.phetio.phetioEngine.phetioObjectMap[t];for(;e instanceof St;)e=e.element})}onPhetioObjectRemoved(t){if(!this.enabled)return;const e=t.tandem.phetioID;t.phetioDynamicElement||this.assertAPIError({phetioID:e,ruleInViolation:"2. Any static, registered PhetioObject can never be deregistered."})}onPhetioObjectAdded(t){if(!this.enabled)return;const e=t.phetioType;this.everyPhetioType[e.typeName]||(this.everyPhetioType[e.typeName]=e),this.simHasStarted&&phet.axon.animationFrameTimer.runOnNextTick(()=>{if(t.phetioDynamicElement){if(phet.preloads.phetio.createArchetypes&&!t.isDisposed){const e=t.tandem.getArchetypalPhetioID(),i=phet.phetio.phetioEngine.getPhetioObject(e).getMetadata();this.checkDynamicInstanceAgainstArchetype(t,i,"simulation archetype")}}else this.assertAPIError({phetioID:t.tandem.phetioID,ruleInViolation:"1. After startup, only dynamic instances prescribed by the baseline file can be registered."})})}validateOverridesFile(){const t=phet.phetio.phetioEngine.getPhetioElementsBaseline();for(const e in window.phet.preloads.phetio.phetioElementsOverrides){e.includes("archetype");if(phet.preloads.phetio.createArchetypes||t.hasOwnProperty(e))if(t.hasOwnProperty(e)){const i=window.phet.preloads.phetio.phetioElementsOverrides[e],s=t[e];0===Object.keys(i).length&&this.assertAPIError({phetioID:e,ruleInViolation:"4. Any schema entries in the overrides file must be different from its baseline counterpart.",message:"no metadata keys found for this override."});for(const t in i)s.hasOwnProperty(t)||this.assertAPIError({phetioID:e,ruleInViolation:"8. Any schema entries in the overrides file must be different from its baseline counterpart.",message:"phetioID metadata key not found in the baseline: "+t}),i[t]===s[t]&&this.assertAPIError({phetioID:e,ruleInViolation:"8. Any schema entries in the overrides file must be different from its baseline counterpart.",message:"phetioID metadata override value is the same as the corresponding metadata value in the baseline."})}else this.assertAPIError({phetioID:e,ruleInViolation:"3. Any schema entries in the overrides file must exist in the baseline file.",message:"phetioID expected in the baseline file but does not exist"});else;}}assertAPIError(t){t.phetioID?(t.phetioID,t.ruleInViolation):t.ruleInViolation;this.apiMismatches.push(t),this.simHasStarted||phet.preloads.phetio.queryParameters.phetioPrintAPIProblems}checkDynamicInstanceAgainstArchetype(t,e,i){const s=t.getMetadata();wt.forEach(n=>{"phetioDynamicElement"!==n&&"phetioArchetypePhetioID"!==n&&"phetioIsArchetype"!==n&&e[n]!==s[n]&&t.tandem&&this.assertAPIError({phetioID:t.tandem.phetioID,ruleInViolation:"5. Dynamic element metadata should match the archetype in the API.",source:i,message:"mismatched metadata: "+n})})}};p.register("phetioAPIValidation",vt);const bt=vt;class Tt{constructor(t){_defineProperty(this,"_disposeEmitter",new r),_defineProperty(this,"isDisposed",!1),_defineProperty(this,"_disposer",null),_defineProperty(this,"boundOnDisposer",null),t&&t.disposer&&(this.disposer=t.disposer),t&&t.disposeEmitter&&(this.disposeEmitter=t.disposeEmitter)}onDisposer(){!this.isDisposed&&this.dispose(),this.clearDisposer()}getDisposer(){return this._disposer}get disposer(){return this.getDisposer()}set disposer(t){this.setDisposer(t)}setDisposer(t){t!==this._disposer&&(this.ensureBoundOnDisposer(),this.clearDisposer(),this._disposer=t,this._disposer&&this.getDisposerEmitter().addListener(this.boundOnDisposer))}getDisposeEmitter(){return this._disposeEmitter}get disposeEmitter(){return this.getDisposeEmitter()}set disposeEmitter(t){this.setDisposeEmitter(t)}setDisposeEmitter(t){this._disposeEmitter.addListener(t.emit.bind(t))}ensureBoundOnDisposer(){this.boundOnDisposer=this.boundOnDisposer||this.onDisposer.bind(this)}getDisposerEmitter(){return this._disposer instanceof Tt?this._disposer._disposeEmitter:this._disposer}clearDisposer(){this._disposer&&(this.ensureBoundOnDisposer(),this.getDisposerEmitter().removeListener(this.boundOnDisposer),this._disposer=null)}dispose(){this._disposeEmitter.emit(),this.isDisposed=!0}}n.register("Disposable",Tt);const Et=Tt,At=gt.PHET_IO_ENABLED,Mt=t=>t.tandem.phetioID,Pt={tandem:gt.OPTIONAL,phetioType:C.ObjectIO,phetioDocumentation:S.PHET_IO_OBJECT_METADATA_DEFAULTS.phetioDocumentation,phetioState:S.PHET_IO_OBJECT_METADATA_DEFAULTS.phetioState,phetioReadOnly:S.PHET_IO_OBJECT_METADATA_DEFAULTS.phetioReadOnly,phetioEventType:K.MODEL,phetioHighFrequency:S.PHET_IO_OBJECT_METADATA_DEFAULTS.phetioHighFrequency,phetioPlayback:S.PHET_IO_OBJECT_METADATA_DEFAULTS.phetioPlayback,phetioFeatured:S.PHET_IO_OBJECT_METADATA_DEFAULTS.phetioFeatured,phetioDynamicElement:S.PHET_IO_OBJECT_METADATA_DEFAULTS.phetioDynamicElement,phetioDesigned:S.PHET_IO_OBJECT_METADATA_DEFAULTS.phetioDesigned,phetioEventMetadata:null,tandemNameSuffix:null};class It extends Et{constructor(t){super(t),this.tandem=Pt.tandem,this.phetioID=this.tandem.phetioID,this.phetioObjectInitialized=!1,t&&this.initializePhetioObject({},t)}initializePhetioObject(t,e){if(e.tandem&&gt.onMissingTandem(e.tandem),gt.VALIDATION&&e.tandem&&e.tandem.required,!(At&&e.tandem&&e.tandem.supplied))return void(e.tandem&&(this.tandem=e.tandem,this.phetioID=this.tandem.phetioID));const i=function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];return d(t,...i)}({},Pt,t);let s=c()(i,e);this.phetioIsArchetype=!1,this.phetioBaselineMetadata=bt.enabled||phet.preloads.phetio.queryParameters.phetioEmitAPIBaseline?this.getMetadata(m({phetioIsArchetype:this.phetioIsArchetype,phetioArchetypePhetioID:this.phetioArchetypePhetioID},s)):null;const n=s.tandem.getArchetypalPhetioID();if(window.phet.preloads.phetio.phetioElementsOverrides){const t=window.phet.preloads.phetio.phetioElementsOverrides[n];t&&(s=c()(s,t))}this.tandem=s.tandem,this.phetioID=this.tandem.phetioID,this._phetioType=s.phetioType,this._phetioState=s.phetioState,this._phetioReadOnly=s.phetioReadOnly,this._phetioDocumentation=s.phetioDocumentation,this._phetioEventType=s.phetioEventType,this._phetioHighFrequency=s.phetioHighFrequency,this._phetioPlayback=s.phetioPlayback,this._phetioDynamicElement=s.phetioDynamicElement,this._phetioFeatured=s.phetioFeatured,this._phetioEventMetadata=s.phetioEventMetadata,this._phetioDesigned=s.phetioDesigned,this.phetioArchetypePhetioID=null,this.linkedElements=[],this.phetioNotifiedObjectCreated=!1,this.phetioMessageStack=[],this._phetioPlayback&&(this._phetioEventMetadata=this._phetioEventMetadata||{},this._phetioEventMetadata.playback=!0),this.tandem.addPhetioObject(this),this.phetioObjectInitialized=!0}static swapCaseOfFirstCharacter(t){const e=t[0];return(e===e.toLowerCase()?e.toUpperCase():e.toLowerCase())+t.substring(1)}get phetioType(){return this._phetioType}get phetioState(){return this._phetioState}get phetioReadOnly(){return this._phetioReadOnly}get phetioDocumentation(){return this._phetioDocumentation}get phetioEventType(){return this._phetioEventType}get phetioHighFrequency(){return this._phetioHighFrequency}get phetioPlayback(){return this._phetioPlayback}get phetioDynamicElement(){return this._phetioDynamicElement}get phetioFeatured(){return this._phetioFeatured}get phetioEventMetadata(){return this._phetioEventMetadata}get phetioDesigned(){return this._phetioDesigned}phetioStartEvent(t,e){if(At&&this.isPhetioInstrumented()){const i=c()({data:null,getData:null},e);if(!_.hasIn(window,"phet.phetio.dataStream"))return void this.phetioMessageStack.push(-1);const s=this.phetioHighFrequency&&_.hasIn(window,"phet.preloads.phetio.queryParameters")&&!window.phet.preloads.phetio.queryParameters.phetioEmitHighFrequencyEvents&&!phet.phetio.dataStream.isEmittingLowFrequencyEvent(),n=!_.hasIn(window,"phet.phetio.dataStream");if(s||this.phetioEventType===K.OPT_OUT||n)return void this.phetioMessageStack.push(-1);const r=i.getData?i.getData():i.data;this.phetioMessageStack.push(phet.phetio.dataStream.start(this.phetioEventType,this.tandem.phetioID,this.phetioType,t,r,this.phetioEventMetadata,this.phetioHighFrequency)),this.phetioPlayback&&phet.phetio.dataStream.pushNonPlaybackable()}}phetioEndEvent(){if(At&&this.isPhetioInstrumented()){const t=this.phetioMessageStack.pop();if(-1===t)return;this.phetioPlayback&&phet.phetio.dataStream.popNonPlaybackable(),phet.phetio.dataStream.end(t)}}propagateDynamicFlagsToDescendants(){const t=phet.phetio.phetioEngine,e=gt.launched?[]:gt.bufferedPhetioObjects.map(Mt);this.tandem.iterateDescendants(i=>{const s=i.phetioID;if(t.hasPhetioObject(s)||!gt.launched&&e.includes(s)){const i=t.hasPhetioObject(s)?t.getPhetioObject(s):gt.bufferedPhetioObjects[e.indexOf(s)];i.phetioIsArchetype=this.phetioIsArchetype,i.setPhetioDynamicElement(this.phetioDynamicElement),i.phetioBaselineMetadata&&(i.phetioBaselineMetadata.phetioIsArchetype=this.phetioIsArchetype)}})}setPhetioDynamicElement(t){this._phetioDynamicElement=!this.phetioIsArchetype&&t,this.phetioArchetypePhetioID=t?this.tandem.getArchetypalPhetioID():null,this.phetioBaselineMetadata&&(this.phetioBaselineMetadata.phetioDynamicElement=this.phetioDynamicElement)}markDynamicElementArchetype(){this.phetioIsArchetype=!0,this.setPhetioDynamicElement(!1),this.phetioBaselineMetadata&&(this.phetioBaselineMetadata.phetioIsArchetype=this.phetioIsArchetype),gt.PHET_IO_ENABLED&&this.propagateDynamicFlagsToDescendants()}isPhetioInstrumented(){return this.tandem&&this.tandem.supplied}addLinkedElement(t,e){this.isPhetioInstrumented()?At&&t.isPhetioInstrumented()&&this.linkedElements.push(new St(t,e)):this.linkedElements=null}removeLinkedElements(t){if(this.isPhetioInstrumented()&&this.linkedElements){this.linkedElements.filter(e=>e.element===t).forEach(t=>{t.dispose(),k(this.linkedElements,t)})}}onSimulationConstructionCompleted(){this.phetioBaselineMetadata=null}dispose(){const t=[];if(gt.PHET_IO_ENABLED&&this.tandem.supplied){const e=phet.phetio.phetioEngine;this.tandem.iterateDescendants(i=>{e.hasPhetioObject(i.phetioID)&&t.push(e.getPhetioObject(i.phetioID))})}this.tandem.removePhetioObject(this),this.linkedElements&&(this.linkedElements.forEach(t=>t.dispose()),this.linkedElements.length=0),super.dispose()}getMetadata(t){const e={phetioTypeName:(t=t||this).phetioType.typeName,phetioDocumentation:t.phetioDocumentation,phetioState:t.phetioState,phetioReadOnly:t.phetioReadOnly,phetioEventType:K.phetioType.toStateObject(t.phetioEventType),phetioHighFrequency:t.phetioHighFrequency,phetioPlayback:t.phetioPlayback,phetioDynamicElement:t.phetioDynamicElement,phetioIsArchetype:t.phetioIsArchetype,phetioFeatured:t.phetioFeatured,phetioDesigned:t.phetioDesigned};return t.phetioArchetypePhetioID&&(e.phetioArchetypePhetioID=t.phetioArchetypePhetioID),e}static create(t){return new It(t)}}_defineProperty(It,"DEFAULT_OPTIONS",Pt);class St extends It{constructor(t,e){const i=c()({phetioType:_t,phetioState:!0},e);i.phetioReadOnly=!0,i.phetioFeatured=t.phetioFeatured,super(i),this.element=t}getMetadata(t){const e=super.getMetadata(t);return delete e.phetioFeatured,e}}p.register("PhetioObject",It);const Ot=new Map,Vt=t=>(Ot.has(t)||Ot.set(t,new C(`ArrayIO<${t.typeName}>`,{valueType:Array,isValidValue:e=>_.every(e,e=>T.isValueValid(e,t.validator)),parameterTypes:[t],toStateObject:e=>e.map(t.toStateObject),fromStateObject:e=>e.map(t.fromStateObject),documentation:"IO Type for the built-in JS array type, with the element type specified.",stateSchema:N.asValue(`Array<${t.typeName}>`,{isValidValue:e=>_.every(e,e=>t.isStateObjectValid(e))})})),Ot.get(t));p.register("ArrayIO",Vt);const Nt=Vt,Dt=new Map,Yt=(t,e)=>{for(let s=0;s<e.length;s++);const i=`${t.typeName}.${e.map(t=>t.typeName).join(",")}`;if(!Dt.has(i)){let s=e.map(t=>t.typeName).join(", ");""===s&&(s="none");const n=e.map(t=>t.typeName).join(",");Dt.set(i,new C(`FunctionIO(${n})=>${t.typeName}`,{valueType:"function",isFunctionType:!0,parameterTypes:e.concat([t]),documentation:`Wrapper for the built-in JS function type.<br><strong>Arguments:</strong> ${s}<br><strong>Return Type:</strong> `+t.typeName}))}return Dt.get(i)};p.register("FunctionIO",Yt);const Ct=Yt,Xt=new Map,Ft=t=>(Xt.has(t)||Xt.set(t,new C(`NullableIO<${t.typeName}>`,{documentation:"An IOType adding support for null in addition to the behavior of its parameter.",isValidValue:e=>null===e||T.isValueValid(e,t.validator),parameterTypes:[t],toStateObject:e=>null===e?null:t.toStateObject(e),fromStateObject:e=>null===e?null:t.fromStateObject(e),stateSchema:N.asValue(`null|<${t.typeName}>`,{isValidValue:e=>null===e||t.isStateObjectValid(e)})})),Xt.get(t));p.register("NullableIO",Ft);const Rt=Ft,Lt=new C("VoidIO",{isValidValue:()=>!0,documentation:"Type for which there is no instance, usually to mark functions without a return value",toStateObject:()=>{}});p.register("VoidIO",Lt);const zt=Lt;class kt extends B{}_defineProperty(kt,"UNDEFER",new kt),_defineProperty(kt,"NOTIFY",new kt),_defineProperty(kt,"enumeration",new $(kt)),n.register("PropertyStatePhase",kt);const qt=kt;class Bt{constructor(){_defineProperty(this,"initialized",!1),this.phaseCallbackSets=new Ht,this.undeferBeforeUndeferMapPair=new jt(qt.UNDEFER,qt.UNDEFER),this.undeferBeforeNotifyMapPair=new jt(qt.UNDEFER,qt.NOTIFY),this.notifyBeforeUndeferMapPair=new jt(qt.NOTIFY,qt.UNDEFER),this.notifyBeforeNotifyMapPair=new jt(qt.NOTIFY,qt.NOTIFY),this.mapPairs=[this.undeferBeforeUndeferMapPair,this.undeferBeforeNotifyMapPair,this.notifyBeforeUndeferMapPair,this.notifyBeforeNotifyMapPair]}initialize(t){t.onBeforeApplyStateEmitter.addListener(t=>{if(t instanceof te&&!t.isDeferred){t.setDeferred(!0);const e=t.tandem.phetioID,i=()=>{const i=t.setDeferred(!1);this.phaseCallbackSets.addNotifyPhaseCallback(new Zt(e,qt.NOTIFY,i||_.noop))};this.phaseCallbackSets.addUndeferPhaseCallback(new Zt(e,qt.UNDEFER,i))}}),t.stateSetEmitter.addListener(t=>{this.undeferAndNotifyProperties(new Set(Object.keys(t)))}),t.isSettingStateProperty.lazyLink(t=>{}),this.initialized=!0}static validateInstrumentedProperty(t){}validatePropertyPhasePair(t,e){Bt.validateInstrumentedProperty(t)}getMapPairFromPhases(t,e){const i=this.mapPairs.filter(i=>t===i.beforePhase&&e===i.afterPhase);return i[0]}registerPhetioOrderDependency(t,e,i,s){if(gt.PHET_IO_ENABLED){this.validatePropertyPhasePair(t,e),this.validatePropertyPhasePair(i,s),this.getMapPairFromPhases(e,s).addOrderDependency(t.tandem.phetioID,i.tandem.phetioID)}}propertyInAnOrderDependency(t){return Bt.validateInstrumentedProperty(t),_.some(this.mapPairs,e=>e.usesPhetioID(t.tandem.phetioID))}unregisterOrderDependenciesForProperty(t){gt.PHET_IO_ENABLED&&(Bt.validateInstrumentedProperty(t),this.propertyInAnOrderDependency(t)&&this.mapPairs.forEach(e=>e.unregisterOrderDependenciesForProperty(t)))}undeferAndNotifyProperties(t){const e={};let i=0;for(;this.phaseCallbackSets.size>0;)i++,i>5e3&&this.errorInUndeferAndNotifyStep(e),this.attemptToApplyPhases(qt.UNDEFER,e,t),this.attemptToApplyPhases(qt.NOTIFY,e,t)}errorInUndeferAndNotifyStep(t){const e=[];this.phaseCallbackSets.forEach(t=>e.push(t.getTerm()));const i=[];this.mapPairs.forEach(t=>{const s=t.beforeMap;for(const[n,r]of s)r.forEach(t=>{const r=n+s.beforePhase,a=t+s.afterPhase;(e.includes(r)||e.includes(a))&&i.push({beforeTerm:r,afterTerm:a})})});let s="";console.log("still to be undeferred",this.phaseCallbackSets.undeferSet),console.log("still to be notified",this.phaseCallbackSets.notifySet),console.log("order dependencies that apply to the still todos",i),i.forEach(t=>{s+=`${t.beforeTerm}\t${t.afterTerm}\n`}),console.log("\n\nin graphable form:\n\n",s);const n="Impossible set state: from undeferAndNotifyProperties; ordering constraints cannot be satisfied";throw new Error(n)}getNumberOfOrderDependencies(){let t=0;return this.mapPairs.forEach(e=>{e.afterMap.forEach(e=>{t+=e.size})}),t}attemptToApplyPhases(t,e,i){const s=this.phaseCallbackSets.getSetFromPhase(t);for(const n of s)this.phetioIDCanApplyPhase(n.phetioID,t,e,i)&&(n.listener(),s.delete(n),e[n.getTerm()]=!0)}phetioIDCanApplyPhase(t,e,i,s){if(e===qt.NOTIFY&&!i[t+qt.UNDEFER])return!1;const n=[];this.mapPairs.forEach(t=>{t.afterPhase===e&&n.push(t.afterMap)});for(let r=0;r<n.length;r++){const e=n[r];if(!e.has(t))return!0;const a=e.get(t);for(const n of a)if(!i[n+e.beforePhase]&&s.has(n)&&s.has(t))return!1}return!0}}class Zt{constructor(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:_.noop;this.phetioID=t,this.phase=e,this.listener=i}getTerm(){return this.phetioID+this.phase}}class jt{constructor(t,e){this.beforeMap=new Map,this.beforeMap.beforePhase=t,this.beforeMap.afterPhase=e,this.afterMap=new Map,this.afterMap.beforePhase=t,this.afterMap.afterPhase=e,this.beforeMap.otherMap=this.afterMap,this.afterMap.otherMap=this.beforeMap,this.beforePhase=t,this.afterPhase=e}addOrderDependency(t,e){this.beforeMap.has(t)||this.beforeMap.set(t,new Set),this.beforeMap.get(t).add(e),this.afterMap.has(e)||this.afterMap.set(e,new Set),this.afterMap.get(e).add(t)}unregisterOrderDependenciesForProperty(t){const e=t.tandem.phetioID;[this.beforeMap,this.afterMap].forEach(t=>{t.has(e)&&t.get(e).forEach(i=>{const s=t.otherMap.get(i);s&&s.delete(e),0===s.size&&t.otherMap.delete(i)}),t.delete(e)})}usesPhetioID(t){return this.beforeMap.has(t)||this.afterMap.has(t)}}class Ht{constructor(){_defineProperty(this,"undeferSet",new Set),_defineProperty(this,"notifySet",new Set)}get size(){return this.undeferSet.size+this.notifySet.size}forEach(t){this.undeferSet.forEach(t),this.notifySet.forEach(t)}addUndeferPhaseCallback(t){this.undeferSet.add(t)}addNotifyPhaseCallback(t){this.notifySet.add(t)}getSetFromPhase(t){return t===qt.NOTIFY?this.notifySet:this.undeferSet}}n.register("PropertyStateHandler",Bt);const $t=new Bt;n.register("propertyStateHandlerSingleton",$t);const Ut=$t;class Gt extends r{constructor(t,e){super(e),this._value=t}get(){return this._value}get value(){return this.get()}set value(t){this.set(t)}set(t){if(!this.equalsValue(t)){const e=this._value;this.setPropertyValue(t),this.notifyListeners(e)}}setPropertyValue(t){this._value=t}equalsValue(t){return this.areValuesEqual(t,this._value)}areValuesEqual(t,e){if(this.useDeepEquality){const i=t,s=e;if(i&&s&&i.constructor===s.constructor)return i.equals(s)}return t===e}notifyListeners(t){this.emit(this._value,t,this)}link(t){this.addListener(t),t(this._value,null,this)}lazyLink(t){this.addListener(t)}unlink(t){this.removeListener(t)}unlinkAll(){this.removeAllListeners()}linkAttribute(t,e){const i=i=>{t[e]=i};return this.link(i),i}isSettable(){return!0}dispose(){this.unlinkAll(),super.dispose()}}n.register("TinyProperty",Gt);const Wt={values:["1/(cm*M)","%","A","AMU","atm","cm","cm^2","C","°","°C","F","g","Hz","J","K","kg","kg/m^3","kg·m/s","kPa","L","L/s","m","m^3","m/s","m/s/s","m/s^2","mA","mm","mol","mol/L","mol/s","M","N","N/m","nm","nm/ps","N·s/m","Ω","Ω·cm","Pa·s","particles/ps","pm","pm/ps","pm/s","pm/s^2","pm^3","ps","radians","radians/s","s","V","view-coordinates/s","W"],isValidUnits:function(t){return _.includes(Wt.values,t)}};n.register("units",Wt);const Qt={validateValidator:!1};let Jt=0;const Kt=new Map;class te extends It{constructor(t,e){const i=c()({units:null,reentrant:!1,tandem:gt.OPTIONAL,phetioOuterType:te.PropertyIO,phetioValueType:C.ObjectIO},e);T.containsValidatorKey(i)||(i.isValidValue=()=>!0),i.units&&(i.phetioEventMetadata=i.phetioEventMetadata||{},i.phetioEventMetadata.units=i.units),i.phetioOuterType&&i.phetioValueType&&(i.phetioType=i.phetioOuterType(i.phetioValueType)),super(i),this.id=Jt++,this.units=i.units,gt.VALIDATION&&this.isPhetioInstrumented(),this.validValues=i.validValues,this.tinyProperty=new Gt(t),this.tinyProperty.useDeepEquality=i.valueComparisonStrategy&&"equalsFunction"===i.valueComparisonStrategy,this.notifying=!1,this.reentrant=i.reentrant,this.isDeferred=!1,this.deferredValue=null,this.hasDeferredValue=!1,this.valueValidator=_.pick(i,T.VALIDATOR_KEYS),this.valueValidator.validationMessage=this.valueValidator.validationMessage||"Property value not valid",this.valueValidator.phetioType&&(this.valueValidator.phetioType=this.valueValidator.phetioType.parameterTypes[0])}isSettable(){return!1}get(){return this.tinyProperty.get()}set(t){_.hasIn(window,"phet.joist.sim.isSettingPhetioStateProperty")&&phet.joist.sim.isSettingPhetioStateProperty.value&&_.hasIn(window,"phet.joist.sim.isClearingPhetioDynamicElementsProperty")&&!phet.joist.sim.isClearingPhetioDynamicElementsProperty.value&&this.isPhetioInstrumented()&&this.phetioState&&this.isSettable()||this.unguardedSet(t)}unguardedSet(t){if(!this.isDisposed)if(this.isDeferred)this.deferredValue=t,this.hasDeferredValue=!0;else if(!this.equalsValue(t)){const e=this.get();this.setPropertyValue(t),this._notifyListeners(e)}}setPropertyValue(t){this.tinyProperty.setPropertyValue(t)}equalsValue(t){return this.areValuesEqual(t,this.get())}areValuesEqual(t,e){return this.tinyProperty.areValuesEqual(t,e)}_notifyListeners(t){const e=this.get();gt.PHET_IO_ENABLED&&this.isPhetioInstrumented()&&this.phetioStartEvent(te.CHANGED_EVENT_NAME,{getData:()=>{const i=this.phetioType.parameterTypes[0];return{oldValue:Rt(i).toStateObject(t),newValue:i.toStateObject(e)}}}),this.notifying=!0,this.tinyProperty.emit(e,t,this),this.notifying=!1,gt.PHET_IO_ENABLED&&this.isPhetioInstrumented()&&this.phetioEndEvent()}notifyListenersStatic(){this._notifyListeners(null)}setDeferred(t){if(t)this.isDeferred=!0;else{this.isDeferred=!1;const t=this.get();if(this.hasDeferredValue&&(this.setPropertyValue(this.deferredValue),this.hasDeferredValue=!1,this.deferredValue=null),!this.equalsValue(t))return()=>!this.isDisposed&&this._notifyListeners(t)}return null}get value(){return this.get()}set value(t){this.set(t)}addPhetioStateDependencies(t){for(let e=0;e<t.length;e++){const i=t[e];i instanceof te&&i.isPhetioInstrumented()&&this.isPhetioInstrumented()&&Ut.registerPhetioOrderDependency(i,qt.UNDEFER,this,qt.NOTIFY)}}link(t,e){e&&e.phetioDependencies&&this.addPhetioStateDependencies(e.phetioDependencies),this.tinyProperty.addListener(t),t(this.get(),null,this)}lazyLink(t,e){e&&e.phetioDependencies&&this.addPhetioStateDependencies(e.phetioDependencies),this.tinyProperty.lazyLink(t)}unlink(t){this.tinyProperty.unlink(t)}unlinkAll(){this.tinyProperty.unlinkAll()}linkAttribute(t,e){const i=i=>{t[e]=i};return this.link(i),i}toString(){return`Property#${this.id}{${this.get()}}`}debug(t){const e=e=>console.log(t,e);return this.link(e),e}isValueValid(t){return null===this.getValidationError(t)}getValidationError(t){return T.getValidationError(t,this.valueValidator,Qt)}dispose(){this.isPhetioInstrumented()&&Ut.unregisterOrderDependenciesForProperty(this),super.dispose(),this.tinyProperty.dispose()}hasListener(t){return this.tinyProperty.hasListener(t)}getListenerCount(){return this.tinyProperty.getListenerCount()}forEachListener(t){this.tinyProperty.forEachListener(t)}hasListeners(){return this.tinyProperty.hasListeners()}static PropertyIO(t){return Kt.has(t)||Kt.set(t,new C(`PropertyIO<${t.typeName}>`,{valueType:te,documentation:"Observable values that send out notifications when the value changes. This differs from the traditional listener pattern in that added listeners also receive a callback with the current value when the listeners are registered. This is a widely-used pattern in PhET-iO simulations.",methodOrder:["link","lazyLink"],events:[te.CHANGED_EVENT_NAME],parameterTypes:[t],toStateObject:e=>({value:t.toStateObject(e.value),validValues:e.validValues?e.validValues.map(e=>t.toStateObject(e)):null,units:Rt(yt).toStateObject(e.units)}),applyState:(e,i)=>{Rt(yt).fromStateObject(i.units);e.unguardedSet(t.fromStateObject(i.value)),i.validValues&&(e.validValues=i.validValues.map(e=>t.fromStateObject(e)))},stateSchema:{value:t,validValues:Rt(Nt(t)),units:Rt(yt)},methods:{getValue:{returnType:t,parameterTypes:[],implementation:te.prototype.get,documentation:"Gets the current value."},getValidationError:{returnType:Rt(yt),parameterTypes:[t],implementation:te.prototype.getValidationError,documentation:"Checks to see if a proposed value is valid. Returns the first validation error, or null if the value is valid."},setValue:{returnType:zt,parameterTypes:[t],implementation:function(t){const e=T.getValidationError(t,this.valueValidator,Qt);if(e)throw new Error("Validation error: "+e);this.set(t)},documentation:"Sets the value of the Property. If the value differs from the previous value, listeners are notified with the new value.",invocableForReadOnlyElements:!1},link:{returnType:zt,parameterTypes:[Ct(zt,[t,Rt(t)])],implementation:te.prototype.link,documentation:"Adds a listener which will be called when the value changes. On registration, the listener is also called with the current value. The listener takes two arguments, the new value and the previous value."},lazyLink:{returnType:zt,parameterTypes:[Ct(zt,[t,Rt(t)])],implementation:te.prototype.lazyLink,documentation:'Adds a listener which will be called when the value changes. This method is like "link", but without the current-value callback on registration. The listener takes two arguments, the new value and the previous value.'},unlink:{returnType:zt,parameterTypes:[Ct(zt,[t])],implementation:te.prototype.unlink,documentation:"Removes a listener."}}})),Kt.get(t)}}_defineProperty(te,"TANDEM_NAME_SUFFIX","Property"),_defineProperty(te,"CHANGED_EVENT_NAME","changed"),n.register("ReadOnlyProperty",te);class ee extends te{constructor(t,e){super(t,e),this._initialValue=t}getInitialValue(){return this._initialValue}get initialValue(){return this.getInitialValue()}setInitialValue(t){this._initialValue=t}get value(){return super.value}set value(t){super.set(t)}reset(){this.set(this._initialValue)}set(t){super.set(t)}isSettable(){return!0}}n.register("Property",ee);n.register("BooleanProperty",class extends ee{constructor(t,e){super(t,c()({valueType:"boolean",phetioValueType:L},e))}toggle(){this.value=!this.value}});const ie=new a;n.register("stepTimer",ie);const se=ie;n.register("CallbackTimer",class{constructor(t){const e=c()({delay:400,interval:100},t);this.delay=e.delay,this.interval=e.interval,this.callbacks=[],e.callback&&this.callbacks.push(e.callback),this.delayID=null,this.intervalID=null,this.fired=!1}isRunning(){return null!==this.delayID||null!==this.intervalID}start(){this.isRunning()||(this.fired=!1,this.delayID=se.setTimeout(()=>{this.delayID=null,this.intervalID=se.setInterval(()=>this.fire(),this.interval),this.fire()},this.delay))}stop(t){this.isRunning()&&(this.delayID&&(se.clearTimeout(this.delayID),this.delayID=null),this.intervalID&&(se.clearInterval(this.intervalID),this.intervalID=null),t&&!this.fired&&this.fire())}addCallback(t){this.callbacks.includes(t)||this.callbacks.push(t)}removeCallback(t){const e=this.callbacks.indexOf(t);-1!==e&&this.callbacks.splice(e,1)}fire(){const t=this.callbacks.slice(0);for(let e=0;e<t.length;e++)t[e]();this.fired=!0}dispose(){this.stop(!1),this.callbacks.length=0}});const ne={validateValidator:!1},re=[],ae=(["name","phetioType","phetioDocumentation","phetioPrivate"].concat(T.VALIDATOR_KEYS),t=>t.phetioType),he=t=>t.name;class oe extends It{constructor(t){const e=c()({parameters:re,tandem:gt.OPTIONAL,phetioPlayback:It.DEFAULT_OPTIONS.phetioPlayback,phetioEventMetadata:It.DEFAULT_OPTIONS.phetioEventMetadata,phetioDocumentation:""},t),i=e.parameters.filter(ae);e.phetioType=e.phetioOuterType(i.map(ae)),e.phetioPlayback&&(e.phetioEventMetadata=e.phetioEventMetadata||{},e.phetioEventMetadata.dataKeys=e.parameters.map(he)),e.phetioDocumentation=oe.getPhetioDocumentation(e.phetioDocumentation,i),super(e),this.parameters=e.parameters}static validateParameters(t,e){A(t,{valueType:Array});let i=!1;for(let s=0;s<t.length;s++){const e=t[s];i=i||e.phetioPrivate;for(const t in e);T.validateValidator(e)}}validateArguments(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];for(let s=0;s<this.parameters.length;s++){const t=this.parameters[s];t.phetioType&&t.valueType}}getValidationErrors(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const s=[];for(let n=0;n<this.parameters.length;n++){const t=this.parameters[n];let i=T.getValidationError(e[n],t,ne);null!==i&&s.push(i),t.phetioType&&!t.valueType&&(i=T.getValidationError(e[n],t.phetioType.validator,ne),null!==i&&s.push(i))}return s}getPhetioData(){let t=null;if(this.parameters.length>0){t={};for(var e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];for(let e=0;e<this.parameters.length;e++){const s=this.parameters[e];s.phetioPrivate||(t[s.name]=s.phetioType.toStateObject(i[e]))}}return t}static getPhetioDocumentation(t,e){return t+(0===e.length?"<br>No parameters.":`<br>The parameters are:<br/><ol>${e.map(t=>{const e=t.phetioDocumentation?" - "+t.phetioDocumentation:"";return`<li>${t.name}: ${t.phetioType.typeName}${e}</li>`}).join("<br/>")}</ol>`)}}n.register("PhetioDataHandler",oe);const le=oe;class ue extends le{constructor(t){super(c()({phetioOuterType:ue.EmitterIO,phetioState:!1},t)),this.tinyEmitter=new r}emit(){gt.PHET_IO_ENABLED&&this.isPhetioInstrumented()&&this.phetioStartEvent("emitted",{data:this.getPhetioData(...arguments)}),this.tinyEmitter.emit(...arguments),gt.PHET_IO_ENABLED&&this.isPhetioInstrumented()&&this.phetioEndEvent()}dispose(){this.tinyEmitter.dispose(),super.dispose()}addListener(t){this.tinyEmitter.addListener(t)}removeListener(t){this.tinyEmitter.removeListener(t)}removeAllListeners(){this.tinyEmitter.removeAllListeners()}hasListener(t){return this.tinyEmitter.hasListener(t)}hasListeners(){return this.tinyEmitter.hasListeners()}getListenerCount(){return this.tinyEmitter.getListenerCount()}debug(t){const e=function(){for(var e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];return console.log(t,...i)};return this.addListener(e),e}}_defineProperty(ue,"EmitterIO",t=>{const e=t.map(me).join(",");return de.has(e)||de.set(e,new C(`EmitterIO<${t.map(me).join(", ")}>`,{valueType:ue,documentation:"Emits when an event occurs and calls added listeners.",parameterTypes:t,events:["emitted"],metadataDefaults:{phetioState:!1},methods:{addListener:{returnType:zt,parameterTypes:[Ct(zt,t)],implementation:ue.prototype.addListener,documentation:"Adds a listener which will be called when the emitter emits."},removeListener:{returnType:zt,parameterTypes:[Ct(zt,t)],implementation:ue.prototype.removeListener,documentation:"Remove a listener."},emit:{returnType:zt,parameterTypes:t,implementation:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const s=this.getValidationErrors(...e);if(s.length>0)throw new Error("Validation errors: "+s.join(", "));this.emit(e)},documentation:"Emits a single event to all listeners.",invocableForReadOnlyElements:!1}}})),de.get(e)});const me=t=>t.typeName,de=new Map;n.register("Emitter",ue);const ce=new C("InfiniteNumberIO",{valueType:"number",documentation:"IO Type for Javascript's number primitive type",toStateObject:t=>t===Number.POSITIVE_INFINITY?"POSITIVE_INFINITY":t===Number.NEGATIVE_INFINITY?"NEGATIVE_INFINITY":t,fromStateObject:t=>"POSITIVE_INFINITY"===t?Number.POSITIVE_INFINITY:"NEGATIVE_INFINITY"===t?Number.NEGATIVE_INFINITY:t,stateSchema:N.asValue("'POSITIVE_INFINITY'|'NEGATIVE_INFINITY'|number",{isValidValue:t=>"POSITIVE_INFINITY"===t||"NEGATIVE_INFINITY"===t||"number"==typeof t&&!isNaN(t)})});p.register("InfiniteNumberIO",ce);const pe=ce,ge=new s("dot");ge.register("FastArray",window.Float64Array?window.Float64Array:window.Array);const fe=ge;class ye{constructor(t,e){this._min=t,this._max=e}getMin(){return this._min}get min(){return this.getMin()}set min(t){this.setMin(t)}setMin(t){this._min=t}getMax(){return this._max}get max(){return this.getMax()}set max(t){this.setMax(t)}setMax(t){this._max=t}setMinMax(t,e){return this._min=t,this._max=e,this}copy(){return new ye(this._min,this._max)}getLength(){return this._max-this._min}getCenter(){return(this._max+this._min)/2}contains(t){return t>=this._min&&t<=this._max}containsRange(t){return this._min<=t.min&&this._max>=t.max}intersects(t){return this._max>=t.min&&t.max>=this._min}intersectsExclusive(t){return this._max>t.min&&t.max>this._min}union(t){return new ye(Math.min(this.min,t.min),Math.max(this.max,t.max))}intersection(t){return new ye(Math.max(this.min,t.min),Math.min(this.max,t.max))}includeRange(t){return this.setMinMax(Math.min(this.min,t.min),Math.max(this.max,t.max))}constrainRange(t){return this.setMinMax(Math.max(this.min,t.min),Math.min(this.max,t.max))}shifted(t){return new ye(this.min+t,this.max+t)}toString(){return`[Range (min:${this._min} max:${this._max})]`}constrainValue(t){return Math.min(Math.max(t,this._min),this._max)}equals(t){return this.constructor===t.constructor&&this._min===t.min&&this._max===t.max}getNormalizedValue(t){return(t-this.min)/this.getLength()}expandNormalizedValue(t){return t*this.getLength()+this.min}get defaultValue(){throw new Error("defaultValue is undefined, did you mean to use RangeWithValue?")}}_defineProperty(ye,"RangeIO",new C("RangeIO",{valueType:ye,documentation:'A range with "min" and a "max" members.',toStateObject:t=>({min:pe.toStateObject(t.min),max:pe.toStateObject(t.max)}),fromStateObject:t=>new ye(pe.fromStateObject(t.min),pe.fromStateObject(t.max)),stateSchema:{min:pe,max:pe}})),_defineProperty(ye,"EVERYTHING",new ye(Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY)),_defineProperty(ye,"NOTHING",new ye(Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY)),fe.register("Range",ye);const xe=ye,_e=new C("NumberIO",{valueType:"number",documentation:"IO Type for Javascript's number primitive type",toStateObject:_.identity,fromStateObject:t=>t,stateSchema:N.asValue("number",{isValidValue:t=>"number"==typeof t&&!isNaN(t)&&t!==Number.POSITIVE_INFINITY&&t!==Number.NEGATIVE_INFINITY})});p.register("NumberIO",_e);const we=_e,ve={valueType:"number",isValidValue:t=>t%1==0,validationMessage:"Should be a valid integer"},be={isValidValue:t=>!isNaN(t),validationMessage:"Should not be NaN"},Te=xe.EVERYTHING,Ee=ee.PropertyIO(we);class Ae extends ee{constructor(t,e){const i=c()({numberType:"FloatingPoint",range:Te,validators:[],tandem:gt.OPTIONAL},e);i.rangePropertyOptions=c()({phetioDocumentation:"provides the range of possible values for the parent NumberProperty",phetioValueType:xe.RangeIO,phetioReadOnly:!0,tandem:i.range!==Te?i.tandem.createTandem("rangeProperty"):gt.OPT_OUT},i.rangePropertyOptions),i.valueType="number",i.phetioOuterType=()=>Ae.NumberPropertyIO,i.phetioValueType=we;const s=!(i.range&&i.range instanceof te),n=i.range instanceof te?i.range:new ee(i.range,i.rangePropertyOptions);i.validators.push(be),"Integer"===i.numberType&&i.validators.push(ve),i.validators.push({isValidValue:t=>n.value.contains(t),validationMessage:"Number must be within rangeProperty value."}),super(t,i),this.numberType=i.numberType,this.rangeProperty=n;if(this.rangeProperty.addPhetioStateDependencies([this]),this.addPhetioStateDependencies([this.rangeProperty]),i.validValues&&this.validateNumberAndRangeProperty)for(let r=0;r<i.validValues.length;r++){const t=i.validValues[r];this.validateNumberAndRangeProperty(t)}this.disposeNumberProperty=()=>{s&&this.rangeProperty.dispose()},this.resetNumberProperty=()=>{s&&this.rangeProperty.reset()}}get range(){return this.rangeProperty.value}set range(t){this.rangeProperty.value=t}reset(){this.resetValueAndRange(),super.reset()}dispose(){this.disposeNumberProperty(),super.dispose()}setValueAndRange(t,e){this.setDeferred(!0),this.rangeProperty.setDeferred(!0),this.set(t),this.rangeProperty.set(e);const i=this.setDeferred(!1),s=this.rangeProperty.setDeferred(!1);i&&i(),s&&s()}resetValueAndRange(){this.setValueAndRange(this.initialValue,this.rangeProperty.initialValue)}toStateObject(){const t=Ee.toStateObject(this);t.numberType=this.numberType,t.range=xe.RangeIO.toStateObject(this.rangeProperty.value);const e=this.rangeProperty&&this.rangeProperty.isPhetioInstrumented();return t.rangePhetioID=e?this.rangeProperty.tandem.phetioID:null,t}}_defineProperty(Ae,"NumberPropertyIO",new C("NumberPropertyIO",{valueType:Ae,supertype:Ee,parameterTypes:[we],documentation:`Extends PropertyIO to add values for the numeric range ( min, max ) and numberType ( '${["FloatingPoint","Integer"].join("' | '")}' )`,toStateObject:t=>t.toStateObject(),applyState:(t,e)=>{Ee.applyState(t,e)},stateSchema:{numberType:yt,range:xe.RangeIO,rangePhetioID:Rt(yt),value:we}})),n.register("NumberProperty",Ae);const Me=t=>{V(t,["length"],["elements"]);const e=c()({length:0,elements:[],tandem:gt.OPTIONAL,phetioFeatured:!1},t);let i=null;if(e.phetioType)i={name:"value",phetioType:e.phetioType.parameterTypes[0]};else if(T.getValidatorValidationError(e))i=m({name:"value"},{isValidValue:_.stubTrue});else{const t=_.pick(e,T.VALIDATOR_KEYS);i=m({name:"value"},t)}const s=new ue({tandem:e.tandem.createTandem("elementAddedEmitter"),parameters:[i],phetioReadOnly:!0,phetioFeatured:e.phetioFeatured}),n=new ue({tandem:e.tandem.createTandem("elementRemovedEmitter"),parameters:[i],phetioReadOnly:!0,phetioFeatured:e.phetioFeatured}),r=new Ae(0,{numberType:"Integer",tandem:e.tandem.createTandem("lengthProperty"),phetioReadOnly:!0,phetioFeatured:e.phetioFeatured}),a=[],h=new Proxy(a,{get:function(t,e,i){return Ie.hasOwnProperty(e)?Ie[e]:Reflect.get(t,e,i)},set:function(t,e,i){const a=t[e];let h=null;"length"===e&&(h=t.slice(i));const o=Reflect.set(t,e,i),l=Number(e);return Number.isInteger(l)&&l>=0&&a!==i?(r.value=t.length,void 0!==a&&n.emit(t[e]),void 0!==i&&s.emit(i)):"length"===e&&(r.value=i,h&&h.forEach(t=>n.emit(t))),o},deleteProperty:function(t,e){const i=Number(e);let s;Number.isInteger(i)&&i>=0&&(s=t[e]);const r=Reflect.deleteProperty(t,e);return void 0!==s&&n.emit(s),r}});h.targetArray=a,h.elementAddedEmitter=s,h.elementRemovedEmitter=n,h.lengthProperty=r;const o=()=>{e.length>=0&&(h.length=e.length),e.elements.length>0&&Array.prototype.push.apply(h,e.elements)};return o(),h.reset=()=>{h.length=0,o()},e.tandem.supplied&&(h.phetioElementType=e.phetioType.parameterTypes[0],h._observableArrayPhetioObject=new Pe(h,e)),h};class Pe extends It{constructor(t,e){super(e),this.observableArray=t}}const Ie={pop(){const t=this.targetArray.length;for(var e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];const n=Array.prototype.pop.apply(this.targetArray,i);return this.lengthProperty.value=this.length,t>0&&this.elementRemovedEmitter.emit(n),n},shift(){const t=this.targetArray.length;for(var e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];const n=Array.prototype.shift.apply(this.targetArray,i);return this.lengthProperty.value=this.length,t>0&&this.elementRemovedEmitter.emit(n),n},push(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const s=this,n=Array.prototype.push.apply(s.targetArray,e);s.lengthProperty.value=s.length;for(let r=0;r<arguments.length;r++)s.elementAddedEmitter.emit(e[r]);return n},unshift(){const t=this;for(var e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];const n=Array.prototype.unshift.apply(t.targetArray,i);t.lengthProperty.value=t.length;for(let r=0;r<i.length;r++)t.elementAddedEmitter.emit(i[r]);return n},splice(){const t=this;for(var e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];const n=Array.prototype.splice.apply(t.targetArray,i);t.lengthProperty.value=t.length;const r=n;for(let a=2;a<i.length;a++)t.elementAddedEmitter.emit(i[a]);return r.forEach(e=>t.elementRemovedEmitter.emit(e)),n},copyWithin(){const t=this.targetArray.slice();for(var e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];const n=Array.prototype.copyWithin.apply(this.targetArray,i);return Se(t,this),n},fill(){const t=this.targetArray.slice();for(var e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];const n=Array.prototype.fill.apply(this.targetArray,i);return Se(t,this),n},get:function(t){return this[t]},addItemAddedListener:function(t){this.elementAddedEmitter.addListener(t)},removeItemAddedListener:function(t){this.elementAddedEmitter.removeListener(t)},addItemRemovedListener:function(t){this.elementRemovedEmitter.addListener(t)},removeItemRemovedListener:function(t){this.elementRemovedEmitter.removeListener(t)},add:function(t){this.push(t)},addAll:function(t){this.push(...t)},remove:function(t){k(this,t)},removeAll:function(t){t.forEach(t=>k(this,t))},clear:function(){for(;this.length>0;)this.pop()},count:function(t){let e=0;for(let i=0;i<this.length;i++)t(this[i])&&e++;return e},find:function(t,e){return _.find(this,t,e)},shuffle:function(t){const e=t.shuffle(this);this.targetArray.length=0,Array.prototype.push.apply(this.targetArray,e)},getArrayCopy:function(){return this.slice()},dispose:function(){this.elementAddedEmitter.dispose(),this.elementRemovedEmitter.dispose(),this.lengthProperty.dispose(),this._observableArrayPhetioObject&&this._observableArrayPhetioObject.dispose()},toStateObject:function(){return{array:this.map(t=>this.phetioElementType.toStateObject(t))}},applyState:function(t){this.length=0;const e=t.array.map(t=>this.phetioElementType.fromStateObject(t));this.push(...e)}},Se=(t,e)=>{const i=t,s=e.targetArray.slice();for(let n=0;n<i.length;n++){const t=i[n],e=s.indexOf(t);e>=0&&(i.splice(n,1),s.splice(e,1),n--)}i.forEach(t=>e.elementRemovedEmitter.emit(t)),s.forEach(t=>e.elementAddedEmitter.emit(t))},Oe=new Map;Me.ObservableArrayIO=t=>(Oe.has(t)||Oe.set(t,new C(`ObservableArrayIO<${t.typeName}>`,{valueType:Pe,parameterTypes:[t],toStateObject:t=>t.observableArray.toStateObject(),applyState:(t,e)=>t.observableArray.applyState(e),stateSchema:{array:Nt(t)}})),Oe.get(t)),n.register("createObservableArray",Me);function Ve(t,e){return t(...e.map(t=>t.get()))}class Ne extends te{constructor(t,e,i){const s=c()({tandem:gt.OPTIONAL,phetioReadOnly:!0,phetioOuterType:Ne.DerivedPropertyIO,phetioLinkDependencies:!0},i);super(Ve(e,t),s),gt.VALIDATION&&this.isPhetioInstrumented(),this.dependencies=t,this.derivation=e,this.derivedPropertyListener=this.getDerivedPropertyListener.bind(this),t.forEach(t=>{if(t.lazyLink(this.derivedPropertyListener),this.isPhetioInstrumented()&&t instanceof It&&t.isPhetioInstrumented()&&(t instanceof te&&Ut.registerPhetioOrderDependency(t,qt.UNDEFER,this,qt.UNDEFER),s.phetioLinkDependencies)){const e=s.tandem.createTandem("dependencies");this.addLinkedElement(t,{tandem:e.createTandemFromPhetioID(t.tandem.phetioID)})}})}hasDependency(t){return this.definedDependencies.includes(t)}get definedDependencies(){return this.dependencies}getDerivedPropertyListener(){this.isDeferred?this.hasDeferredValue=!0:super.set(Ve(this.derivation,this.definedDependencies))}recomputeDerivation(){this.getDerivedPropertyListener()}dispose(){const t=this.definedDependencies;for(let e=0;e<t.length;e++){const i=t[e];i.hasListener(this.derivedPropertyListener)&&i.unlink(this.derivedPropertyListener)}this.dependencies=null,super.dispose()}setDeferred(t){return this.isDeferred&&!t&&(this.deferredValue=Ve(this.derivation,this.definedDependencies)),super.setDeferred(t)}static valueEquals(t,e,i){return new Ne([t,e],(t,e)=>t===e,i)}static and(t,e){return Ne.deriveAny(t,()=>_.reduce(t,De,!0),e)}static or(t,e){return Ne.deriveAny(t,()=>_.reduce(t,Ye,!1),e)}static not(t,e){return new Ne([t],t=>!t,e)}static deriveAny(t,e,i){return new Ne(t,e,i)}}const De=(t,e)=>t&&e.value,Ye=(t,e)=>t||e.value,Ce=new Map;Ne.DerivedPropertyIO=t=>(Ce.has(t)||Ce.set(t,new C(`DerivedPropertyIO<${t.typeName}>`,{valueType:Ne,parameterTypes:[t],supertype:ee.PropertyIO(t),documentation:"Like PropertyIO, but not settable.  Instead it is derived from other DerivedPropertyIO or PropertyIO instances",applyState:_.noop,methods:{setValue:{returnType:zt,parameterTypes:[t],implementation:Ne.prototype.set,documentation:"Errors out when you try to set a derived property.",invocableForReadOnlyElements:!1}}})),Ce.get(t));n.register("DerivedProperty",Ne);class Xe extends te{constructor(t,e){const i=c()({bidirectional:!1,defaultValue:null,derive:_.identity,map:_.identity,inverseMap:_.identity},e),s=i.derive,n=i.map,r=i.inverseMap,a="function"==typeof s?s:t=>t[s],h="function"==typeof n?n:t=>t[n],o="function"==typeof r?r:t=>t[r];super(null===t.value?h(i.defaultValue):h(a(t.value).value),i),this.defaultValue=i.defaultValue,this.derive=a,this.map=h,this.inverseMap=o,this.bidirectional=i.bidirectional,this.valuePropertyProperty=t,this.isExternallyChanging=!1,this.propertyPropertyListener=this.onPropertyPropertyChange.bind(this),this.propertyListener=this.onPropertyChange.bind(this),t.link(this.propertyListener),i.bidirectional&&this.lazyLink(this.onSelfChange.bind(this))}onPropertyPropertyChange(t,e,i){if(this.bidirectional&&null!==this.valuePropertyProperty.value&&i){if(this.derive(this.valuePropertyProperty.value)===i&&i.areValuesEqual(this.inverseMap(this.value),i.get()))return}super.set(this.map(t))}onPropertyChange(t,e){e&&this.derive(e).unlink(this.propertyPropertyListener),t?this.derive(t).link(this.propertyPropertyListener):this.onPropertyPropertyChange(this.defaultValue,null,null)}onSelfChange(t){if(null!==this.valuePropertyProperty.value){const e=this.derive(this.valuePropertyProperty.value);this.areValuesEqual(t,this.map(e.value))||(e.value=this.inverseMap(t))}}dispose(){this.valuePropertyProperty.unlink(this.propertyListener),null!==this.valuePropertyProperty.value&&this.derive(this.valuePropertyProperty.value).unlink(this.propertyPropertyListener),super.dispose()}reset(){if(null!==this.valuePropertyProperty.value){this.derive(this.valuePropertyProperty.value).reset()}}set(t){this.isExternallyChanging=!0,super.set(t),this.isExternallyChanging=!1}get value(){return super.value}set value(t){this.set(t)}isSettable(){return super.isSettable()||this.bidirectional}}n.register("DynamicProperty",Xe);class Fe extends ee{constructor(t,e,i){y("Use EnumerationProperty. EnumerationDeprecated should be exchanged for classes that extend EnumerationValue, see WilderEnumerationPatterns for examples."),super(e,i=m({valueType:t,phetioValueType:Q(t),validValues:t.VALUES},i)),this.enumeration=t}}n.register("EnumerationDeprecatedProperty",Fe);class Re extends Xe{constructor(t,e){super(new Gt(t),e)}}n.register("MappedProperty",Re);class Le{constructor(t,e,i){if(this.dependencies=t,this.dependencyListeners=new Map,t.forEach(i=>{const s=()=>{if(!this.isDisposed){const i=t.map(t=>t.get());e(...i)}};this.dependencyListeners.set(i,s),i.lazyLink(s,{phetioDependencies:_.without(t,i)})}),!i){const i=t.map(t=>t.get());e(...i)}this.isDisposed=!1}get definedDependencies(){return this.dependencies}dispose(){const t=this.definedDependencies;for(let e=0;e<t.length;e++){const i=t[e],s=this.dependencyListeners.get(i);i.hasListener(s)&&i.unlink(s)}this.dependencies=null,this.dependencyListeners.clear(),this.isDisposed=!0}static multilink(t,e){return new Le(t,e,!1)}static multilinkAny(t,e){return new Le(t,e)}static lazyMultilink(t,e){return new Le(t,e,!0)}static unmultilink(t){t.dispose()}}n.register("Multilink",Le);class ze{constructor(t,e){_defineProperty(this,"objects",[]);const i=c()({defaultArguments:[],initialize:t.prototype.initialize,maxSize:100,initialSize:0,useDefaultConstruction:!1},e);for(this._maxPoolSize=i.maxSize,this.partialConstructor=Function.prototype.bind.bind(t,t),this.DefaultConstructor=this.partialConstructor(...i.defaultArguments),this.initialize=i.initialize,this.useDefaultConstruction=i.useDefaultConstruction;this.objects.length<i.initialSize;)this.objects.push(this.createDefaultObject())}createDefaultObject(){return new this.DefaultConstructor}fetch(){return this.objects.length?this.objects.pop():this.createDefaultObject()}create(){let t;for(var e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];return this.objects.length?(t=this.objects.pop(),this.initialize.apply(t,i)):this.useDefaultConstruction?(t=this.createDefaultObject(),this.initialize.apply(t,i)):t=new(this.partialConstructor(...i)),t}get poolSize(){return this.objects.length}set maxPoolSize(t){this._maxPoolSize=t}get maxPoolSize(){return this._maxPoolSize}freeToPool(t){this.objects.length<this.maxPoolSize&&this.objects.push(t)}forEach(t){this.objects.forEach(t)}}l.register("Pool",ze);class ke{constructor(t,e,i,s){this.x=t,this.y=e,this.z=i,this.w=s}getMagnitude(){return Math.sqrt(this.magnitudeSquared)}get magnitude(){return this.getMagnitude()}getMagnitudeSquared(){return this.dot(this)}get magnitudeSquared(){return this.getMagnitudeSquared()}distance(t){return this.minus(t).magnitude}distanceXYZW(t,e,i,s){const n=this.x-t,r=this.y-e,a=this.z-i,h=this.w-s;return Math.sqrt(n*n+r*r+a*a+h*h)}distanceSquared(t){return this.minus(t).magnitudeSquared}distanceSquaredXYZW(t,e,i,s){const n=this.x-t,r=this.y-e,a=this.z-i,h=this.w-s;return n*n+r*r+a*a+h*h}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}dotXYZW(t,e,i,s){return this.x*t+this.y*e+this.z*i+this.w*s}angleBetween(t){return Math.acos(fe.clamp(this.normalized().dot(t.normalized()),-1,1))}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}equalsEpsilon(t,e){return e||(e=0),Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)+Math.abs(this.w-t.w)<=e}isFinite(){return isFinite(this.x)&&isFinite(this.y)&&isFinite(this.z)&&isFinite(this.w)}copy(t){return t?t.set(this):qe(this.x,this.y,this.z,this.w)}normalized(){const t=this.magnitude;return this.dividedScalar(t)}roundedSymmetric(){return this.copy().roundSymmetric()}withMagnitude(t){return this.copy().setMagnitude(t)}timesScalar(t){return qe(this.x*t,this.y*t,this.z*t,this.w*t)}times(t){return this.timesScalar(t)}componentTimes(t){return qe(this.x*t.x,this.y*t.y,this.z*t.z,this.w*t.w)}plus(t){return qe(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)}plusXYZW(t,e,i,s){return qe(this.x+t,this.y+e,this.z+i,this.w+s)}plusScalar(t){return qe(this.x+t,this.y+t,this.z+t,this.w+t)}minus(t){return qe(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)}minusXYZW(t,e,i,s){return qe(this.x-t,this.y-e,this.z-i,this.w-s)}minusScalar(t){return qe(this.x-t,this.y-t,this.z-t,this.w-t)}dividedScalar(t){return qe(this.x/t,this.y/t,this.z/t,this.w/t)}negated(){return qe(-this.x,-this.y,-this.z,-this.w)}blend(t,e){return this.plus(t.minus(this).times(e))}average(t){return this.blend(t,.5)}toString(){return`Vector4(${this.x}, ${this.y}, ${this.z}, ${this.w})`}toVector3(){return new je(this.x,this.y,this.z)}setXYZW(t,e,i,s){return this.x=t,this.y=e,this.z=i,this.w=s,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}set(t){return this.setXYZW(t.x,t.y,t.z,t.w)}setMagnitude(t){const e=t/this.magnitude;return this.multiplyScalar(e)}add(t){return this.setXYZW(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)}addXYZW(t,e,i,s){return this.setXYZW(this.x+t,this.y+e,this.z+i,this.w+s)}addScalar(t){return this.setXYZW(this.x+t,this.y+t,this.z+t,this.w+t)}subtract(t){return this.setXYZW(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)}subtractXYZW(t,e,i,s){return this.setXYZW(this.x-t,this.y-e,this.z-i,this.w-s)}subtractScalar(t){return this.setXYZW(this.x-t,this.y-t,this.z-t,this.w-t)}multiplyScalar(t){return this.setXYZW(this.x*t,this.y*t,this.z*t,this.w*t)}multiply(t){return this.multiplyScalar(t)}componentMultiply(t){return this.setXYZW(this.x*t.x,this.y*t.y,this.z*t.z,this.w*t.w)}divideScalar(t){return this.setXYZW(this.x/t,this.y/t,this.z/t,this.w/t)}negate(){return this.setXYZW(-this.x,-this.y,-this.z,-this.w)}normalize(){const t=this.magnitude;if(0===t)throw new Error("Cannot normalize a zero-magnitude vector");return this.divideScalar(t)}roundSymmetric(){return this.setXYZW(ni.roundSymmetric(this.x),ni.roundSymmetric(this.y),ni.roundSymmetric(this.z),ni.roundSymmetric(this.w))}freeToPool(){ke.pool.freeToPool(this)}}_defineProperty(ke,"pool",new ze(ke,{maxSize:1e3,initialize:ke.prototype.setXYZW,defaultArguments:[0,0,0,0]})),ke.prototype.isVector4=!0,ke.prototype.dimension=4,fe.register("Vector4",ke);const qe=ke.pool.create.bind(ke.pool);fe.register("v4",qe);class Be extends ke{static mutableOverrideHelper(t){Be.prototype[t]=()=>{throw new Error(`Cannot call mutable method '${t}' on immutable Vector3`)}}}Be.mutableOverrideHelper("setXYZW"),Be.mutableOverrideHelper("setX"),Be.mutableOverrideHelper("setY"),Be.mutableOverrideHelper("setZ"),Be.mutableOverrideHelper("setW"),ke.ZERO=new ke(0,0,0,0),ke.X_UNIT=new ke(1,0,0,0),ke.Y_UNIT=new ke(0,1,0,0),ke.Z_UNIT=new ke(0,0,1,0),ke.W_UNIT=new ke(0,0,0,1);const Ze=(t,e)=>t.add(e);class je{constructor(t,e,i){this.x=t,this.y=e,this.z=i}getMagnitude(){return Math.sqrt(this.magnitudeSquared)}get magnitude(){return this.getMagnitude()}getMagnitudeSquared(){return this.dot(this)}get magnitudeSquared(){return this.getMagnitudeSquared()}distance(t){return Math.sqrt(this.distanceSquared(t))}distanceXYZ(t,e,i){const s=this.x-t,n=this.y-e,r=this.z-i;return Math.sqrt(s*s+n*n+r*r)}distanceSquared(t){const e=this.x-t.x,i=this.y-t.y,s=this.z-t.z;return e*e+i*i+s*s}distanceSquaredXYZ(t,e,i){const s=this.x-t,n=this.y-e,r=this.z-i;return s*s+n*n+r*r}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}dotXYZ(t,e,i){return this.x*t+this.y*e+this.z*i}angleBetween(t){return Math.acos(ni.clamp(this.normalized().dot(t.normalized()),-1,1))}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}equalsEpsilon(t,e){return e||(e=0),Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)<=e}isFinite(){return isFinite(this.x)&&isFinite(this.y)&&isFinite(this.z)}copy(t){return t?t.set(this):He(this.x,this.y,this.z)}cross(t){return He(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}normalized(){const t=this.magnitude;if(0===t)throw new Error("Cannot normalize a zero-magnitude vector");return He(this.x/t,this.y/t,this.z/t)}roundedSymmetric(){return this.copy().roundSymmetric()}withMagnitude(t){return this.copy().setMagnitude(t)}timesScalar(t){return He(this.x*t,this.y*t,this.z*t)}times(t){return this.timesScalar(t)}componentTimes(t){return He(this.x*t.x,this.y*t.y,this.z*t.z)}plus(t){return He(this.x+t.x,this.y+t.y,this.z+t.z)}plusXYZ(t,e,i){return He(this.x+t,this.y+e,this.z+i)}plusScalar(t){return He(this.x+t,this.y+t,this.z+t)}minus(t){return He(this.x-t.x,this.y-t.y,this.z-t.z)}minusXYZ(t,e,i){return He(this.x-t,this.y-e,this.z-i)}minusScalar(t){return He(this.x-t,this.y-t,this.z-t)}dividedScalar(t){return He(this.x/t,this.y/t,this.z/t)}negated(){return He(-this.x,-this.y,-this.z)}blend(t,e){return this.plus(t.minus(this).times(e))}average(t){return this.blend(t,.5)}static average(t){return _.reduce(t,Ze,new je(0,0,0)).divideScalar(t.length)}toString(){return`Vector3(${this.x}, ${this.y}, ${this.z})`}toVector2(){return We(this.x,this.y)}toVector4(){return qe(this.x,this.y,this.z,1)}setXYZ(t,e,i){return this.x=t,this.y=e,this.z=i,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}set(t){return this.setXYZ(t.x,t.y,t.z)}setMagnitude(t){const e=t/this.magnitude;return this.multiplyScalar(e)}add(t){return this.setXYZ(this.x+t.x,this.y+t.y,this.z+t.z)}addXYZ(t,e,i){return this.setXYZ(this.x+t,this.y+e,this.z+i)}addScalar(t){return this.setXYZ(this.x+t,this.y+t,this.z+t)}subtract(t){return this.setXYZ(this.x-t.x,this.y-t.y,this.z-t.z)}subtractXYZ(t,e,i){return this.setXYZ(this.x-t,this.y-e,this.z-i)}subtractScalar(t){return this.setXYZ(this.x-t,this.y-t,this.z-t)}multiplyScalar(t){return this.setXYZ(this.x*t,this.y*t,this.z*t)}multiply(t){return this.multiplyScalar(t)}componentMultiply(t){return this.setXYZ(this.x*t.x,this.y*t.y,this.z*t.z)}divideScalar(t){return this.setXYZ(this.x/t,this.y/t,this.z/t)}negate(){return this.setXYZ(-this.x,-this.y,-this.z)}setCross(t){return this.setXYZ(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}normalize(){const t=this.magnitude;if(0===t)throw new Error("Cannot normalize a zero-magnitude vector");return this.divideScalar(t)}roundSymmetric(){return this.setXYZ(ni.roundSymmetric(this.x),ni.roundSymmetric(this.y),ni.roundSymmetric(this.z))}toStateObject(){return{x:this.x,y:this.y,z:this.z}}freeToPool(){je.pool.freeToPool(this)}static slerp(t,e,i){return fe.Quaternion.slerp(new fe.Quaternion,fe.Quaternion.getRotationQuaternion(t,e),i).timesVector3(t)}static fromStateObject(t){return He(t.x,t.y,t.z)}}_defineProperty(je,"pool",new ze(je,{maxSize:1e3,initialize:je.prototype.setXYZ,defaultArguments:[0,0,0]})),je.prototype.isVector3=!0,je.prototype.dimension=3,fe.register("Vector3",je);const He=je.pool.create.bind(je.pool);fe.register("v3",He);class $e extends je{static mutableOverrideHelper(t){$e.prototype[t]=()=>{throw new Error(`Cannot call mutable method '${t}' on immutable Vector3`)}}}$e.mutableOverrideHelper("setXYZ"),$e.mutableOverrideHelper("setX"),$e.mutableOverrideHelper("setY"),$e.mutableOverrideHelper("setZ"),je.ZERO=new je(0,0,0),je.X_UNIT=new je(1,0,0),je.Y_UNIT=new je(0,1,0),je.Z_UNIT=new je(0,0,1),je.Vector3IO=new C("Vector3IO",{valueType:je,documentation:"Basic 3-dimensional vector, represented as (x,y,z)",toStateObject:t=>t.toStateObject(),fromStateObject:je.fromStateObject,stateSchema:{x:we,y:we,z:we}});const Ue=(t,e)=>t.add(e);class Ge{constructor(t,e){this.x=t,this.y=e}getMagnitude(){return Math.sqrt(this.magnitudeSquared)}get magnitude(){return this.getMagnitude()}getMagnitudeSquared(){return this.x*this.x+this.y*this.y}get magnitudeSquared(){return this.getMagnitudeSquared()}distance(t){return Math.sqrt(this.distanceSquared(t))}distanceXY(t,e){const i=this.x-t,s=this.y-e;return Math.sqrt(i*i+s*s)}distanceSquared(t){const e=this.x-t.x,i=this.y-t.y;return e*e+i*i}distanceSquaredXY(t,e){const i=this.x-t,s=this.y-e;return i*i+s*s}dot(t){return this.x*t.x+this.y*t.y}dotXY(t,e){return this.x*t+this.y*e}getAngle(){return Math.atan2(this.y,this.x)}get angle(){return this.getAngle()}angleBetween(t){const e=this.magnitude,i=t.magnitude;return Math.acos(fe.clamp((this.x*t.x+this.y*t.y)/(e*i),-1,1))}equals(t){return this.x===t.x&&this.y===t.y}equalsEpsilon(t,e){return e||(e=0),Math.max(Math.abs(this.x-t.x),Math.abs(this.y-t.y))<=e}isFinite(){return isFinite(this.x)&&isFinite(this.y)}copy(t){return t?t.set(this):We(this.x,this.y)}crossScalar(t){return this.x*t.y-this.y*t.x}normalized(){const t=this.magnitude;if(0===t)throw new Error("Cannot normalize a zero-magnitude vector");return We(this.x/t,this.y/t)}roundedSymmetric(){return this.copy().roundSymmetric()}withMagnitude(t){return this.copy().setMagnitude(t)}timesScalar(t){return We(this.x*t,this.y*t)}times(t){return this.timesScalar(t)}componentTimes(t){return We(this.x*t.x,this.y*t.y)}plus(t){return We(this.x+t.x,this.y+t.y)}plusXY(t,e){return We(this.x+t,this.y+e)}plusScalar(t){return We(this.x+t,this.y+t)}minus(t){return We(this.x-t.x,this.y-t.y)}minusXY(t,e){return We(this.x-t,this.y-e)}minusScalar(t){return We(this.x-t,this.y-t)}dividedScalar(t){return We(this.x/t,this.y/t)}negated(){return We(-this.x,-this.y)}getPerpendicular(){return We(this.y,-this.x)}get perpendicular(){return this.getPerpendicular()}rotated(t){const e=this.angle+t,i=this.magnitude;return We(i*Math.cos(e),i*Math.sin(e))}rotateAboutXY(t,e,i){const s=this.x-t,n=this.y-e,r=Math.cos(i),a=Math.sin(i);return this.x=t+s*r-n*a,this.y=e+s*a+n*r,this}rotateAboutPoint(t,e){return this.rotateAboutXY(t.x,t.y,e)}rotatedAboutXY(t,e,i){return We(this.x,this.y).rotateAboutXY(t,e,i)}rotatedAboutPoint(t,e){return this.rotatedAboutXY(t.x,t.y,e)}blend(t,e){return We(this.x+(t.x-this.x)*e,this.y+(t.y-this.y)*e)}average(t){return this.blend(t,.5)}static average(t){return _.reduce(t,Ue,new Ge(0,0)).divideScalar(t.length)}toString(){return`Vector2(${this.x}, ${this.y})`}toVector3(){return new je(this.x,this.y,0)}setXY(t,e){return this.x=t,this.y=e,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}set(t){return this.setXY(t.x,t.y)}setMagnitude(t){const e=t/this.magnitude;return this.multiplyScalar(e)}add(t){return this.setXY(this.x+t.x,this.y+t.y)}addXY(t,e){return this.setXY(this.x+t,this.y+e)}addScalar(t){return this.setXY(this.x+t,this.y+t)}subtract(t){return this.setXY(this.x-t.x,this.y-t.y)}subtractXY(t,e){return this.setXY(this.x-t,this.y-e)}subtractScalar(t){return this.setXY(this.x-t,this.y-t)}multiplyScalar(t){return this.setXY(this.x*t,this.y*t)}multiply(t){return this.multiplyScalar(t)}componentMultiply(t){return this.setXY(this.x*t.x,this.y*t.y)}divideScalar(t){return this.setXY(this.x/t,this.y/t)}negate(){return this.setXY(-this.x,-this.y)}normalize(){const t=this.magnitude;if(0===t)throw new Error("Cannot normalize a zero-magnitude vector");return this.divideScalar(t)}roundSymmetric(){return this.setXY(ni.roundSymmetric(this.x),ni.roundSymmetric(this.y))}rotate(t){const e=this.angle+t,i=this.magnitude;return this.setXY(i*Math.cos(e),i*Math.sin(e))}setPolar(t,e){return this.setXY(t*Math.cos(e),t*Math.sin(e))}toStateObject(){return{x:this.x,y:this.y}}freeToPool(){Ge.pool.freeToPool(this)}static createPolar(t,e){return new Ge(0,0).setPolar(t,e)}static fromStateObject(t){return We(t.x,t.y)}static getAngleBetweenVectors(t,e){const i=e.x-t.x,s=e.y-t.y;return Math.atan2(s,i)}static getDistanceBetweenVectors(t,e){const i=e.x-t.x,s=e.y-t.y;return Math.sqrt(i*i+s*s)}}_defineProperty(Ge,"pool",new ze(Ge,{maxSize:1e3,initialize:Ge.prototype.setXY,defaultArguments:[0,0]})),Ge.prototype.isVector2=!0,Ge.prototype.dimension=2,fe.register("Vector2",Ge);const We=Ge.pool.create.bind(Ge.pool);fe.register("v2",We);class Qe extends Ge{static mutableOverrideHelper(t){Qe.prototype[t]=()=>{throw new Error(`Cannot call mutable method '${t}' on immutable Vector2`)}}}Qe.mutableOverrideHelper("setXY"),Qe.mutableOverrideHelper("setX"),Qe.mutableOverrideHelper("setY"),Ge.ZERO=new Ge(0,0),Ge.X_UNIT=new Ge(1,0),Ge.Y_UNIT=new Ge(0,1),Ge.Vector2IO=new C("Vector2IO",{valueType:Ge,stateSchema:{x:we,y:we},toStateObject:t=>t.toStateObject(),fromStateObject:t=>Ge.fromStateObject(t),documentation:"A numerical object with x and y properties, like {x:3,y:4}"});const Je=Number.MIN_VALUE,Ke=2*Math.PI;let ti,ei,ii;const si={clamp:(t,e,i)=>t<e?e:t>i?i:t,moduloBetweenDown(t,e,i){const s=i-e;let n=(t-e)%s;return n<0&&(n+=s),n+e},moduloBetweenUp:(t,e,i)=>-si.moduloBetweenDown(-t,-i,-e),rangeInclusive(t,e){if(e<t)return[];const i=new Array(e-t+1);for(let s=t;s<=e;s++)i[s-t]=s;return i},rangeExclusive:(t,e)=>si.rangeInclusive(t+1,e-1),toRadians:t=>Math.PI*t/180,toDegrees:t=>180*t/Math.PI,mod:(t,e)=>t/e%1==0?0:t%e,gcd(t,e){return Math.abs(0===e?t:this.gcd(e,si.mod(t,e)))},lcm:(t,e)=>si.roundSymmetric(Math.abs(t*e)/si.gcd(t,e)),lineLineIntersection(t,e,i,s){if(t.equals(e)||i.equals(s))return null;const n=t.x-e.x,r=i.x-s.x,a=t.y-e.y,h=i.y-s.y,o=n*h-a*r;if(Math.abs(o)<1e-10)return null;const l=t.x*e.y-t.y*e.x,u=i.x*s.y-i.y*s.x;return new Ge((l*r-n*u)/o,(l*h-a*u)/o)},circleCenterFromPoints(t,e,i){const s=new Ge((t.x+e.x)/2,(t.y+e.y)/2),n=new Ge((e.x+i.x)/2,(e.y+i.y)/2),r=new Ge(s.x+(e.y-t.y),s.y-(e.x-t.x)),a=new Ge(n.x+(i.y-e.y),n.y-(i.x-e.x));return si.lineLineIntersection(s,r,n,a)},pointInCircleFromPoints(t,e,i,s){const n=t.x-s.x,r=t.y-s.y,a=(t.x-s.x)*(t.x-s.x)+(t.y-s.y)*(t.y-s.y),h=e.x-s.x,o=e.y-s.y,l=(e.x-s.x)*(e.x-s.x)+(e.y-s.y)*(e.y-s.y),u=i.x-s.x,m=i.y-s.y,d=(i.x-s.x)*(i.x-s.x)+(i.y-s.y)*(i.y-s.y);return n*o*d+r*l*u+a*h*m-a*o*u-r*h*d-n*l*m>0},sphereRayIntersection(t,e,i){i=void 0===i?1e-5:i;const s=new je(0,0,0),n=e.direction,r=e.position,a=r.minus(s),h=n.dot(a),o=4*h*h-4*(a.magnitudeSquared-t*t);if(o<i)return null;const l=n.dot(s)-n.dot(r),u=Math.sqrt(o)/2,m=l-u,d=l+u;if(d<i)return null;const c=e.pointAtDistance(d),p=c.minus(s).normalized();if(m<i)return{distance:d,hitPoint:c,normal:p.negated(),fromOutside:!1};{const t=e.pointAtDistance(m),i=t.minus(s).normalized();return{distance:m,hitPoint:t,normal:i,fromOutside:!0}}},solveLinearRootsReal:(t,e)=>0===t?0===e?null:[]:[-e/t],solveQuadraticRootsReal(t,e,i){if(0===t||Math.abs(e/t)>1e7||Math.abs(i/t)>1e7)return si.solveLinearRootsReal(e,i);const s=e*e-4*t*i;if(s<0)return[];const n=Math.sqrt(s);return[(-e-n)/(2*t),(-e+n)/(2*t)]},solveCubicRootsReal(t,e,i,s){let n,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e-7;if(0===t)n=si.solveQuadraticRootsReal(e,i,s);else{const a=1e7;if(0===t||Math.abs(e/t)>a||Math.abs(i/t)>a||Math.abs(s/t)>a)n=si.solveQuadraticRootsReal(e,i,s);else if(0===s||Math.abs(t/s)>a||Math.abs(e/s)>a||Math.abs(i/s)>a)n=[0].concat(si.solveQuadraticRootsReal(t,e,i));else{const a=(3*(i/=t)-(e/=t)*e)/9,h=(-27*(s/=t)+e*(9*i-e*e*2))/54,o=a*a*a+h*h,l=e/3;if(o>r){const t=Math.sqrt(o);n=[si.cubeRoot(h+t)+si.cubeRoot(h-t)-l]}else if(o>-r){const t=si.cubeRoot(h),e=-l-t;n=[2*t-l,e,e]}else{let t=-a*a*a;t=Math.acos(h/Math.sqrt(t));const e=2*Math.sqrt(-a);n=[-l+e*Math.cos(t/3),-l+e*Math.cos((t+2*Math.PI)/3),-l+e*Math.cos((t+4*Math.PI)/3)]}}}return n},cubeRoot:t=>t>=0?Math.pow(t,1/3):-Math.pow(-t,1/3),linear:(t,e,i,s,n)=>(s-i)/(e-t)*(n-t)+i,roundSymmetric:t=>(t<0?-1:1)*Math.round(Math.abs(t)),toFixed(t,e){const i=Math.pow(10,e);return(si.roundSymmetric(t*i)/i).toFixed(e)},toFixedNumber:(t,e)=>parseFloat(si.toFixed(t,e)),equalsEpsilon:(t,e,i)=>Math.abs(t-e)<=i,lineSegmentIntersection(t,e,i,s,n,r,a,h){const o=(t,e,i,s,n,r)=>(r-e)*(i-t)-(s-e)*(n-t);if(o(t,e,n,r,a,h)*o(i,s,n,r,a,h)>0||o(n,r,t,e,i,s)*o(a,h,t,e,i,s)>0)return null;const l=(t-i)*(r-h)-(e-s)*(n-a);return Math.abs(l)<1e-10?null:t===n&&e===r||t===a&&e===h?new Ge(t,e):i===n&&s===r||i===a&&s===h?new Ge(i,s):new Ge(((t*s-e*i)*(n-a)-(t-i)*(n*h-r*a))/l,((t*s-e*i)*(r-h)-(e-s)*(n*h-r*a))/l)},distToSegmentSquared(t,e,i){const s=e.distanceSquared(i);if(0===s)return t.distanceSquared(e);const n=((t.x-e.x)*(i.x-e.x)+(t.y-e.y)*(i.y-e.y))/s;let r;return r=n<0?t.distanceSquared(e):n>1?t.distanceSquared(i):t.distanceSquared(new Ge(e.x+n*(i.x-e.x),e.y+n*(i.y-e.y))),r},distToSegment(t,e,i){return Math.sqrt(this.distToSegmentSquared(t,e,i))},arePointsCollinear:(t,e,i,s)=>(void 0===s&&(s=0),si.triangleArea(t,e,i)<=s),triangleArea:(t,e,i)=>Math.abs(si.triangleAreaSigned(t,e,i)),triangleAreaSigned:(t,e,i)=>t.x*(e.y-i.y)+e.x*(i.y-t.y)+i.x*(t.y-e.y),centroidOfPolygon(t){const e=new Ge(0,0);let i=0;return t.forEach((s,n)=>{const r=t[(n+1)%t.length],a=s.x*r.y-r.x*s.y;i+=a/2,e.addXY((s.x+r.x)*a,(s.y+r.y)*a)}),e.divideScalar(6*i),e},cosh:t=>(Math.exp(t)+Math.exp(-t))/2,sinh:t=>(Math.exp(t)-Math.exp(-t))/2,log10:t=>Math.log(t)/Math.LN10,boxMullerTransform(t,e,i){if(ti=!ti,!ti)return ii*e+t;let s,n;do{s=i.nextDouble(),n=i.nextDouble()}while(s<=Je);return ei=Math.sqrt(-2*Math.log(s))*Math.cos(Ke*n),ii=Math.sqrt(-2*Math.log(s))*Math.sin(Ke*n),ei*e+t},numberOfDecimalPlaces(t){if(Math.floor(t)===t)return 0;{const e=t.toString();if(e.includes("e")){const t=e.split("e"),i=t[0],s=Number(t[1]),n=i.includes(".")?i.split(".")[1].length:0;return Math.max(n-s,0)}return e.split(".")[1].length}},roundToInterval:(t,e)=>si.toFixedNumber(si.roundSymmetric(t/e)*e,si.numberOfDecimalPlaces(e))};fe.register("Utils",si),fe.clamp=si.clamp,fe.moduloBetweenDown=si.moduloBetweenDown,fe.moduloBetweenUp=si.moduloBetweenUp,fe.rangeInclusive=si.rangeInclusive,fe.rangeExclusive=si.rangeExclusive,fe.toRadians=si.toRadians,fe.toDegrees=si.toDegrees,fe.lineLineIntersection=si.lineLineIntersection,fe.lineSegmentIntersection=si.lineSegmentIntersection,fe.sphereRayIntersection=si.sphereRayIntersection,fe.solveQuadraticRootsReal=si.solveQuadraticRootsReal,fe.solveCubicRootsReal=si.solveCubicRootsReal,fe.cubeRoot=si.cubeRoot,fe.linear=si.linear,fe.boxMullerTransform=si.boxMullerTransform;const ni=si,ri=t=>""+t;n.register("PatternStringProperty",class extends Ne{constructor(t,e,i){const s=c()({formatNames:[],decimalPlaces:null,phetioValueType:yt},i),n=[t],r={},a=Object.keys(e);a.forEach(t=>{const i=e[t];(i instanceof te||i instanceof Gt)&&n.push(i);let a=ri;if(null!==s.decimalPlaces&&("number"==typeof s.decimalPlaces||null!==s.decimalPlaces[t])){const e="number"==typeof s.decimalPlaces||null===s.decimalPlaces?s.decimalPlaces:s.decimalPlaces[t];a=t=>ri("number"==typeof t?ni.toFixed(t,e):t)}s.maps&&s.maps.hasOwnProperty(t)?r[t]=e=>a(s.maps[t](e)):r[t]=a}),super(n,(function(){for(var i=arguments.length,h=new Array(i),o=0;o<i;o++)h[o]=arguments[o];const l=t=>{const e=n.indexOf(t);return e>=0?h[e]:t};let u=""+l(t);s.formatNames.forEach((t,e)=>{u=u.replace(new RegExp(`\\{${e}\\}`,"g"),`{{${t}}}`)});const m=u.match(/\{\{[^{}]+\}\}/g)||[];for(let t=0;t<m.length;t++){const i=m[t],s=i.replace("{{","").replace("}}","");if(a.includes(s)){let t=l(e[s]);r[s]&&(t=r[s](t)),u=u.replace(i,""+t)}}return u}),s)}});n.register("StringProperty",class extends ee{constructor(t,e){super(t,c()({valueType:"string",phetioValueType:yt},e))}});n.register("TinyForwardingProperty",class extends Gt{constructor(t,e,i){super(t,i),e&&(this.targetPropertyInstrumented=e)}setValueOrTargetProperty(t,e,i){if((s=i)instanceof te||s instanceof Gt)this.setTargetProperty(t,e,i);else{const t=this.get();this.clearTargetProperty(),this.setPropertyValue(i),this.areValuesEqual(t,i)||this.notifyListeners(t)}var s}setTargetProperty(t,e,i){if(this.targetProperty===i)return t;this.targetProperty&&this.targetProperty instanceof te&&this.targetProperty.isPhetioInstrumented();const s=this.targetProperty;this.ownedPhetioProperty&&i!==this.ownedPhetioProperty&&this.disposeOwnedPhetioProperty(),t&&null!==e&&t.updateLinkedElementForProperty(e,s,i);const n=this.get();return this.clearTargetProperty(),this.targetProperty=i,this.targetProperty?(this.targetProperty.lazyLink(this.forwardingListener),this.setPropertyValue(this.targetProperty.value)):this.setPropertyValue(n),this.areValuesEqual(n,this.get())||this.notifyListeners(n),t}clearTargetProperty(){this.forwardingListener=this.forwardingListener||this.onTargetPropertyChange.bind(this),this.targetProperty&&this.targetProperty.unlink(this.forwardingListener),this.targetProperty=null}onTargetPropertyChange(t){super.set(t)}set(t){return this.targetProperty?this.targetProperty.set(t):super.set(t),this}setTargetPropertyInstrumented(t,e){return this.targetPropertyInstrumented=t,e}getTargetPropertyInstrumented(){return this.targetPropertyInstrumented||!1}initializePhetio(t,e,i){!this.targetProperty&&this.targetPropertyInstrumented?(this.ownedPhetioProperty=i(),this.setTargetProperty(t,e,this.ownedPhetioProperty)):this.targetProperty&&this.targetProperty instanceof te&&this.targetProperty.isPhetioInstrumented()&&t.updateLinkedElementForProperty(e,null,this.targetProperty)}disposeOwnedPhetioProperty(){this.ownedPhetioProperty&&(this.ownedPhetioProperty.dispose(),delete this.ownedPhetioProperty)}dispose(){this.clearTargetProperty(),this.disposeOwnedPhetioProperty(),super.dispose()}});n.register("TinyOverrideProperty",class extends Gt{constructor(t){super(t.value),_defineProperty(this,"isOverridden",!1),this._targetProperty=t,this._targetListener=this.onTargetPropertyChange.bind(this),this._targetProperty.lazyLink(this._targetListener)}set targetProperty(t){this.setTargetProperty(t)}setTargetProperty(t){if(this.targetProperty===t)return;const e=this.value;this.isOverridden||this._targetProperty.unlink(this._targetListener),this._targetProperty=t,this.isOverridden||(this._targetProperty.lazyLink(this._targetListener),this.equalsValue(e)||this.notifyListeners(e))}clearOverride(){if(this.isOverridden){const t=this.value;this.isOverridden=!1,this._targetProperty.lazyLink(this._targetListener),this.equalsValue(t)||this.notifyListeners(t)}}get(){return this.isOverridden?this._value:this._targetProperty.value}set(t){this.isOverridden||(this._value=this._targetProperty.value),super.set(t)}setPropertyValue(t){this.isOverridden||(this.isOverridden=!0,this._targetProperty.unlink(this._targetListener)),super.setPropertyValue(t)}equalsValue(t){return this.areValuesEqual(t,this.value)}onTargetPropertyChange(t,e){this.isOverridden||this.notifyListeners(e)}notifyListeners(t){this.emit(this.value,t,this)}dispose(){this.isOverridden||this._targetProperty.unlink(this._targetListener),super.dispose()}});function ai(t){return(t instanceof te||t instanceof Gt)&&t.isSettable()&&!!t.range&&!!t.rangeProperty}n.register("TinyStaticProperty",class extends Gt{constructor(t,e){super(t),this.onAccessAttempt=e}get(){return this.onAccessAttempt(),super.get()}set(t){throw new Error("Cannot set a TinyStaticProperty value")}isSettable(){return!1}notifyListeners(t){this.emit(this.get(),t,this)}link(t){this.addListener(t),t(this.get(),null,this)}equalsValue(t){return this.areValuesEqual(t,this.get())}});n.register("UnitConversionProperty",class extends Re{constructor(t,e){const i=t=>t*e.factor;super(t,c()({bidirectional:!0,map:i,inverseMap:t=>t/e.factor},e)),this._property=t,this.rangeProperty=new ee(Te),ai(t)&&(this._rangeListener=t=>{const e=i(t.min),s=i(t.max);this.rangeProperty.value=new xe(Math.min(e,s),Math.max(e,s))},t.rangeProperty.link(this._rangeListener))}get range(){return this.rangeProperty.value}set range(t){this.rangeProperty.value=t}dispose(){ai(this._property)&&this._property.rangeProperty.unlink(this._rangeListener),this.rangeProperty.dispose()}});class hi extends B{static fromLayoutOrientation(t){return"horizontal"===t?hi.HORIZONTAL:hi.VERTICAL}constructor(t,e,i,s,n,r,a,h,o,l,u,m,d,c,p,g,f,y,x){super(),this.coordinate=t,this.centerCoordinate=e,this.minCoordinate=i,this.maxCoordinate=s,this.minSide=n,this.maxSide=r,this.minSize=a,this.maxSize=h,this.rectCoordinate=o,this.rectSize=l,this.flowBoxOrientation=u,this.size=m,this.line=d,this.preferredSize=c,this.localPreferredSize=p,this.sizable=g,this.ariaOrientation=u,this.modelToView=f,this.viewToModel=y,this.toVector=x}}_defineProperty(hi,"HORIZONTAL",new hi("x","centerX","minX","maxX","left","right","minWidth","maxWidth","rectX","rectWidth","horizontal","width","column","preferredWidth","localPreferredWidth","widthSizable",(t,e)=>t.modelToViewX(e),(t,e)=>t.viewToModelX(e),(t,e,i)=>new i(t,e,0,0))),_defineProperty(hi,"VERTICAL",new hi("y","centerY","minY","maxY","top","bottom","minHeight","maxHeight","rectY","rectHeight","vertical","height","row","preferredHeight","localPreferredHeight","heightSizable",(t,e)=>t.modelToViewY(e),(t,e)=>t.viewToModelY(e),(t,e,i)=>new i(e,t,0,0))),_defineProperty(hi,"enumeration",new $(hi,{phetioDocumentation:"Horizontal or vertical orientation"})),hi.HORIZONTAL.opposite=hi.VERTICAL,hi.VERTICAL.opposite=hi.HORIZONTAL,l.register("Orientation",hi);const oi=hi,li=new Ge(0,0);class ui{constructor(t,e,i,s){this.minX=t,this.minY=e,this.maxX=i,this.maxY=s}getWidth(){return this.maxX-this.minX}get width(){return this.getWidth()}getHeight(){return this.maxY-this.minY}get height(){return this.getHeight()}getX(){return this.minX}get x(){return this.getX()}getY(){return this.minY}get y(){return this.getY()}getMinX(){return this.minX}getMinY(){return this.minY}getMaxX(){return this.maxX}getMaxY(){return this.maxY}getLeft(){return this.minX}get left(){return this.minX}getTop(){return this.minY}get top(){return this.minY}getRight(){return this.maxX}get right(){return this.maxX}getBottom(){return this.maxY}get bottom(){return this.maxY}getCenterX(){return(this.maxX+this.minX)/2}get centerX(){return this.getCenterX()}getCenterY(){return(this.maxY+this.minY)/2}get centerY(){return this.getCenterY()}getLeftTop(){return new Ge(this.minX,this.minY)}get leftTop(){return this.getLeftTop()}getCenterTop(){return new Ge(this.getCenterX(),this.minY)}get centerTop(){return this.getCenterTop()}getRightTop(){return new Ge(this.maxX,this.minY)}get rightTop(){return this.getRightTop()}getLeftCenter(){return new Ge(this.minX,this.getCenterY())}get leftCenter(){return this.getLeftCenter()}getCenter(){return new Ge(this.getCenterX(),this.getCenterY())}get center(){return this.getCenter()}getRightCenter(){return new Ge(this.maxX,this.getCenterY())}get rightCenter(){return this.getRightCenter()}getLeftBottom(){return new Ge(this.minX,this.maxY)}get leftBottom(){return this.getLeftBottom()}getCenterBottom(){return new Ge(this.getCenterX(),this.maxY)}get centerBottom(){return this.getCenterBottom()}getRightBottom(){return new Ge(this.maxX,this.maxY)}get rightBottom(){return this.getRightBottom()}isEmpty(){return this.getWidth()<0||this.getHeight()<0}isFinite(){return isFinite(this.minX)&&isFinite(this.minY)&&isFinite(this.maxX)&&isFinite(this.maxY)}hasNonzeroArea(){return this.getWidth()>0&&this.getHeight()>0}isValid(){return!this.isEmpty()&&this.isFinite()}closestPointTo(t){if(this.containsCoordinates(t.x,t.y))return t;{const e=Math.max(Math.min(t.x,this.maxX),this.x),i=Math.max(Math.min(t.y,this.maxY),this.y);return new Ge(e,i)}}containsCoordinates(t,e){return this.minX<=t&&t<=this.maxX&&this.minY<=e&&e<=this.maxY}containsPoint(t){return this.containsCoordinates(t.x,t.y)}containsBounds(t){return this.minX<=t.minX&&this.maxX>=t.maxX&&this.minY<=t.minY&&this.maxY>=t.maxY}intersectsBounds(t){const e=Math.max(this.minX,t.minX),i=Math.max(this.minY,t.minY),s=Math.min(this.maxX,t.maxX),n=Math.min(this.maxY,t.maxY);return s-e>=0&&n-i>=0}minimumDistanceToPointSquared(t){const e=t.x<this.minX?this.minX:t.x>this.maxX?this.maxX:null,i=t.y<this.minY?this.minY:t.y>this.maxY?this.maxY:null;let s;if(null===e&&null===i)return 0;if(null===e)return s=i-t.y,s*s;if(null===i)return s=e-t.x,s*s;{const s=e-t.x,n=i-t.y;return s*s+n*n}}maximumDistanceToPointSquared(t){let e=t.x>this.getCenterX()?this.minX:this.maxX,i=t.y>this.getCenterY()?this.minY:this.maxY;return e-=t.x,i-=t.y,e*e+i*i}toString(){return`[x:(${this.minX},${this.maxX}),y:(${this.minY},${this.maxY})]`}equals(t){return this.minX===t.minX&&this.minY===t.minY&&this.maxX===t.maxX&&this.maxY===t.maxY}equalsEpsilon(t,e){e=void 0!==e?e:0;const i=this.isFinite(),s=t.isFinite();return i&&s?Math.abs(this.minX-t.minX)<e&&Math.abs(this.minY-t.minY)<e&&Math.abs(this.maxX-t.maxX)<e&&Math.abs(this.maxY-t.maxY)<e:i===s&&(this===t||(isFinite(this.minX+t.minX)?Math.abs(this.minX-t.minX)<e:this.minX===t.minX)&&(isFinite(this.minY+t.minY)?Math.abs(this.minY-t.minY)<e:this.minY===t.minY)&&(isFinite(this.maxX+t.maxX)?Math.abs(this.maxX-t.maxX)<e:this.maxX===t.maxX)&&(isFinite(this.maxY+t.maxY)?Math.abs(this.maxY-t.maxY)<e:this.maxY===t.maxY))}copy(t){return t?t.set(this):mi(this.minX,this.minY,this.maxX,this.maxY)}union(t){return mi(Math.min(this.minX,t.minX),Math.min(this.minY,t.minY),Math.max(this.maxX,t.maxX),Math.max(this.maxY,t.maxY))}intersection(t){return mi(Math.max(this.minX,t.minX),Math.max(this.minY,t.minY),Math.min(this.maxX,t.maxX),Math.min(this.maxY,t.maxY))}withCoordinates(t,e){return mi(Math.min(this.minX,t),Math.min(this.minY,e),Math.max(this.maxX,t),Math.max(this.maxY,e))}withPoint(t){return this.withCoordinates(t.x,t.y)}withX(t){return this.copy().addX(t)}withY(t){return this.copy().addY(t)}withMinX(t){return mi(t,this.minY,this.maxX,this.maxY)}withMinY(t){return mi(this.minX,t,this.maxX,this.maxY)}withMaxX(t){return mi(this.minX,this.minY,t,this.maxY)}withMaxY(t){return mi(this.minX,this.minY,this.maxX,t)}roundedOut(){return mi(Math.floor(this.minX),Math.floor(this.minY),Math.ceil(this.maxX),Math.ceil(this.maxY))}roundedIn(){return mi(Math.ceil(this.minX),Math.ceil(this.minY),Math.floor(this.maxX),Math.floor(this.maxY))}transformed(t){return this.copy().transform(t)}dilated(t){return this.dilatedXY(t,t)}dilatedX(t){return mi(this.minX-t,this.minY,this.maxX+t,this.maxY)}dilatedY(t){return mi(this.minX,this.minY-t,this.maxX,this.maxY+t)}dilatedXY(t,e){return mi(this.minX-t,this.minY-e,this.maxX+t,this.maxY+e)}eroded(t){return this.dilated(-t)}erodedX(t){return this.dilatedX(-t)}erodedY(t){return this.dilatedY(-t)}erodedXY(t,e){return this.dilatedXY(-t,-e)}withOffsets(t,e,i,s){return mi(this.minX-t,this.minY-e,this.maxX+i,this.maxY+s)}shiftedX(t){return mi(this.minX+t,this.minY,this.maxX+t,this.maxY)}shiftedY(t){return mi(this.minX,this.minY+t,this.maxX,this.maxY+t)}shiftedXY(t,e){return mi(this.minX+t,this.minY+e,this.maxX+t,this.maxY+e)}shifted(t){return this.shiftedXY(t.x,t.y)}blend(t,e){const i=1-e;return mi(i*this.minX+e*t.minX,i*this.minY+e*t.minY,i*this.maxX+e*t.maxX,i*this.maxY+e*t.maxY)}setMinMax(t,e,i,s){return this.minX=t,this.minY=e,this.maxX=i,this.maxY=s,this}setMinX(t){return this.minX=t,this}setMinY(t){return this.minY=t,this}setMaxX(t){return this.maxX=t,this}setMaxY(t){return this.maxY=t,this}set(t){return this.setMinMax(t.minX,t.minY,t.maxX,t.maxY)}includeBounds(t){return this.setMinMax(Math.min(this.minX,t.minX),Math.min(this.minY,t.minY),Math.max(this.maxX,t.maxX),Math.max(this.maxY,t.maxY))}constrainBounds(t){return this.setMinMax(Math.max(this.minX,t.minX),Math.max(this.minY,t.minY),Math.min(this.maxX,t.maxX),Math.min(this.maxY,t.maxY))}addCoordinates(t,e){return this.setMinMax(Math.min(this.minX,t),Math.min(this.minY,e),Math.max(this.maxX,t),Math.max(this.maxY,e))}addPoint(t){return this.addCoordinates(t.x,t.y)}addX(t){return this.minX=Math.min(t,this.minX),this.maxX=Math.max(t,this.maxX),this}addY(t){return this.minY=Math.min(t,this.minY),this.maxY=Math.max(t,this.maxY),this}roundOut(){return this.setMinMax(Math.floor(this.minX),Math.floor(this.minY),Math.ceil(this.maxX),Math.ceil(this.maxY))}roundIn(){return this.setMinMax(Math.ceil(this.minX),Math.ceil(this.minY),Math.floor(this.maxX),Math.floor(this.maxY))}transform(t){if(this.isEmpty())return this;if(t.isIdentity())return this;const e=this.minX,i=this.minY,s=this.maxX,n=this.maxY;return this.set(ui.NOTHING),this.addPoint(t.multiplyVector2(li.setXY(e,i))),this.addPoint(t.multiplyVector2(li.setXY(e,n))),this.addPoint(t.multiplyVector2(li.setXY(s,i))),this.addPoint(t.multiplyVector2(li.setXY(s,n))),this}dilate(t){return this.dilateXY(t,t)}dilateX(t){return this.setMinMax(this.minX-t,this.minY,this.maxX+t,this.maxY)}dilateY(t){return this.setMinMax(this.minX,this.minY-t,this.maxX,this.maxY+t)}dilateXY(t,e){return this.setMinMax(this.minX-t,this.minY-e,this.maxX+t,this.maxY+e)}erode(t){return this.dilate(-t)}erodeX(t){return this.dilateX(-t)}erodeY(t){return this.dilateY(-t)}erodeXY(t,e){return this.dilateXY(-t,-e)}offset(t,e,i,s){return mi(this.minX-t,this.minY-e,this.maxX+i,this.maxY+s)}shiftX(t){return this.setMinMax(this.minX+t,this.minY,this.maxX+t,this.maxY)}shiftY(t){return this.setMinMax(this.minX,this.minY+t,this.maxX,this.maxY+t)}shiftXY(t,e){return this.setMinMax(this.minX+t,this.minY+e,this.maxX+t,this.maxY+e)}shift(t){return this.shiftXY(t.x,t.y)}getXRange(){return new xe(this.minX,this.maxX)}setXRange(t){return this.setMinMax(t.min,this.minY,t.max,this.maxY)}get xRange(){return this.getXRange()}set xRange(t){this.setXRange(t)}getYRange(){return new xe(this.minY,this.maxY)}setYRange(t){return this.setMinMax(this.minX,t.min,this.maxX,t.max)}get yRange(){return this.getYRange()}set yRange(t){this.setYRange(t)}getClosestPoint(t,e,i){return i?i.setXY(t,e):i=new Ge(t,e),i.x<this.minX&&(i.x=this.minX),i.x>this.maxX&&(i.x=this.maxX),i.y<this.minY&&(i.y=this.minY),i.y>this.maxY&&(i.y=this.maxY),i}freeToPool(){ui.pool.freeToPool(this)}static rect(t,e,i,s){return mi(t,e,t+i,e+s)}static oriented(t,e,i,s,n){return t===oi.HORIZONTAL?new ui(e,i,s,n):new ui(i,e,n,s)}static point(t,e){if(t instanceof Ge){const e=t;return mi(e.x,e.y,e.x,e.y)}return mi(t,e,t,e)}}_defineProperty(ui,"pool",new ze(ui,{initialize:ui.prototype.setMinMax,defaultArguments:[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY]})),_defineProperty(ui,"NOTHING",new ui(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)),_defineProperty(ui,"EVERYTHING",new ui(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY)),_defineProperty(ui,"Bounds2IO",new C("Bounds2IO",{valueType:ui,documentation:"a 2-dimensional bounds rectangle",toStateObject:t=>({minX:t.minX,minY:t.minY,maxX:t.maxX,maxY:t.maxY}),fromStateObject:t=>new ui(pe.fromStateObject(t.minX),pe.fromStateObject(t.minY),pe.fromStateObject(t.maxX),pe.fromStateObject(t.maxY)),stateSchema:{minX:pe,maxX:pe,minY:pe,maxY:pe}})),fe.register("Bounds2",ui);const mi=ui.pool.create.bind(ui.pool);fe.register("b2",mi),ui.prototype.isBounds=!0,ui.prototype.dimension=2;class di{constructor(t){this.rootBin=new ci(t,null)}allocate(t,e){const i=this.rootBin.findAvailableBin(t,e);if(i){const s=i.split(t,e);return s.use(),s}return null}deallocate(t){t.unuse()}toString(){let t="",e="";return function i(s){t+=e+s.toString()+"\n",e+="  ",_.each(s.children,i),e=e.substring(2)}(this.rootBin),t}}fe.register("BinPacker",di);class ci{constructor(t,e){this.bounds=t,this.parent=e,this.isSplit=!1,this.isUsed=!1,this.children=[]}findAvailableBin(t,e){if(this.isUsed)return null;if(this.bounds.width<t||this.bounds.height<e)return null;if(this.isSplit){for(let i=0;i<this.children.length;i++){const s=this.children[i].findAvailableBin(t,e);if(s)return s}return null}return this}split(t,e){if(t===this.bounds.width&&e===this.bounds.height)return this;this.isSplit=!0;const i=this.bounds.minX+t,s=this.bounds.minY+e,n=new ui(this.bounds.minX,this.bounds.minY,i,s),r=new ui(i,this.bounds.minY,this.bounds.maxX,s),a=new ui(this.bounds.minX,s,this.bounds.maxX,this.bounds.maxY),h=new ci(n,this);return this.children.push(h),r.hasNonzeroArea()&&this.children.push(new ci(r,this)),a.hasNonzeroArea()&&this.children.push(new ci(a,this)),h}use(){this.isUsed=!0}unuse(){this.isUsed=!1,this.parent&&this.parent.attemptToCollapse()}attemptToCollapse(){for(let t=0;t<this.children.length;t++){const e=this.children[t];if(e.isSplit||e.isUsed)return}this.children=[],this.isSplit=!1,this.parent&&this.parent.attemptToCollapse()}toString(){return this.bounds.toString()+(this.isUsed?" used":"")}}function pi(t){return _.each(Array.prototype.slice.call(arguments,1),e=>{if(e)for(const i in e)Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(e,i))}),t}di.Bin=ci,l.register("extend",pi);const gi=pi,fi={mixInto(t,e){const i=c()({defaultArguments:[],initialize:t.prototype.initialize,maxSize:100,initialSize:0,useDefaultConstruction:!1},e),s=[];let n=i.maxSize;const r=Function.prototype.bind.bind(t,t),a=r(...i.defaultArguments),h=i.initialize,o=i.useDefaultConstruction,l=t.prototype;for(gi(t,{pool:s,dirtyFromPool:()=>s.length?s.pop():new a,createFromPool(){let t;for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return s.length?(t=s.pop(),h.apply(t,i)):o?(t=new a,h.apply(t,i)):t=new(r(...i)),t},get poolSize(){return s.length},set maxPoolSize(t){n=t},get maxPoolSize(){return n}}),gi(l,{freeToPool(){s.length<n&&s.push(this)}});s.length<i.initialSize;)s.push(new a);return t}};l.register("Poolable",fi);const yi=fi;class xi{constructor(t,e,i,s,n,r){this.minX=t,this.minY=e,this.minZ=i,this.maxX=s,this.maxY=n,this.maxZ=r}getWidth(){return this.maxX-this.minX}get width(){return this.getWidth()}getHeight(){return this.maxY-this.minY}get height(){return this.getHeight()}getDepth(){return this.maxZ-this.minZ}get depth(){return this.getDepth()}getX(){return this.minX}get x(){return this.getX()}getY(){return this.minY}get y(){return this.getY()}getZ(){return this.minZ}get z(){return this.getZ()}getMinX(){return this.minX}getMinY(){return this.minY}getMinZ(){return this.minZ}getMaxX(){return this.maxX}getMaxY(){return this.maxY}getMaxZ(){return this.maxZ}getLeft(){return this.minX}get left(){return this.minX}getTop(){return this.minY}get top(){return this.minY}getBack(){return this.minZ}get back(){return this.minZ}getRight(){return this.maxX}get right(){return this.maxX}getBottom(){return this.maxY}get bottom(){return this.maxY}getFront(){return this.maxZ}get front(){return this.maxZ}getCenterX(){return(this.maxX+this.minX)/2}get centerX(){return this.getCenterX()}getCenterY(){return(this.maxY+this.minY)/2}get centerY(){return this.getCenterY()}getCenterZ(){return(this.maxZ+this.minZ)/2}get centerZ(){return this.getCenterZ()}getCenter(){return new je(this.getCenterX(),this.getCenterY(),this.getCenterZ())}get center(){return this.getCenter()}isEmpty(){return this.getWidth()<0||this.getHeight()<0||this.getDepth()<0}isFinite(){return isFinite(this.minX)&&isFinite(this.minY)&&isFinite(this.minZ)&&isFinite(this.maxX)&&isFinite(this.maxY)&&isFinite(this.maxZ)}hasNonzeroArea(){return this.getWidth()>0&&this.getHeight()>0&&this.getDepth()>0}isValid(){return!this.isEmpty()&&this.isFinite()}containsCoordinates(t,e,i){return this.minX<=t&&t<=this.maxX&&this.minY<=e&&e<=this.maxY&&this.minZ<=i&&i<=this.maxZ}containsPoint(t){return this.containsCoordinates(t.x,t.y,t.z)}containsBounds(t){return this.minX<=t.minX&&this.maxX>=t.maxX&&this.minY<=t.minY&&this.maxY>=t.maxY&&this.minZ<=t.minZ&&this.maxZ>=t.maxZ}intersectsBounds(t){return!this.intersection(t).isEmpty()}toString(){return`[x:(${this.minX},${this.maxX}),y:(${this.minY},${this.maxY}),z:(${this.minZ},${this.maxZ})]`}equals(t){return this.minX===t.minX&&this.minY===t.minY&&this.minZ===t.minZ&&this.maxX===t.maxX&&this.maxY===t.maxY&&this.maxZ===t.maxZ}equalsEpsilon(t,e){e=void 0!==e?e:0;const i=this.isFinite(),s=t.isFinite();return i&&s?Math.abs(this.minX-t.minX)<e&&Math.abs(this.minY-t.minY)<e&&Math.abs(this.minZ-t.minZ)<e&&Math.abs(this.maxX-t.maxX)<e&&Math.abs(this.maxY-t.maxY)<e&&Math.abs(this.maxZ-t.maxZ)<e:i===s&&(this===t||(isFinite(this.minX+t.minX)?Math.abs(this.minX-t.minX)<e:this.minX===t.minX)&&(isFinite(this.minY+t.minY)?Math.abs(this.minY-t.minY)<e:this.minY===t.minY)&&(isFinite(this.minZ+t.minZ)?Math.abs(this.minZ-t.minZ)<e:this.minZ===t.minZ)&&(isFinite(this.maxX+t.maxX)?Math.abs(this.maxX-t.maxX)<e:this.maxX===t.maxX)&&(isFinite(this.maxY+t.maxY)?Math.abs(this.maxY-t.maxY)<e:this.maxY===t.maxY)&&(isFinite(this.maxZ+t.maxZ)?Math.abs(this.maxZ-t.maxZ)<e:this.maxZ===t.maxZ))}copy(t){return t?t.set(this):new xi(this.minX,this.minY,this.minZ,this.maxX,this.maxY,this.maxZ)}union(t){return new xi(Math.min(this.minX,t.minX),Math.min(this.minY,t.minY),Math.min(this.minZ,t.minZ),Math.max(this.maxX,t.maxX),Math.max(this.maxY,t.maxY),Math.max(this.maxZ,t.maxZ))}intersection(t){return new xi(Math.max(this.minX,t.minX),Math.max(this.minY,t.minY),Math.max(this.minZ,t.minZ),Math.min(this.maxX,t.maxX),Math.min(this.maxY,t.maxY),Math.min(this.maxZ,t.maxZ))}withCoordinates(t,e,i){return new xi(Math.min(this.minX,t),Math.min(this.minY,e),Math.min(this.minZ,i),Math.max(this.maxX,t),Math.max(this.maxY,e),Math.max(this.maxZ,i))}withPoint(t){return this.withCoordinates(t.x,t.y,t.z)}withMinX(t){return new xi(t,this.minY,this.minZ,this.maxX,this.maxY,this.maxZ)}withMinY(t){return new xi(this.minX,t,this.minZ,this.maxX,this.maxY,this.maxZ)}withMinZ(t){return new xi(this.minX,this.minY,t,this.maxX,this.maxY,this.maxZ)}withMaxX(t){return new xi(this.minX,this.minY,this.minZ,t,this.maxY,this.maxZ)}withMaxY(t){return new xi(this.minX,this.minY,this.minZ,this.maxX,t,this.maxZ)}withMaxZ(t){return new xi(this.minX,this.minY,this.minZ,this.maxX,this.maxY,t)}roundedOut(){return new xi(Math.floor(this.minX),Math.floor(this.minY),Math.floor(this.minZ),Math.ceil(this.maxX),Math.ceil(this.maxY),Math.ceil(this.maxZ))}roundedIn(){return new xi(Math.ceil(this.minX),Math.ceil(this.minY),Math.ceil(this.minZ),Math.floor(this.maxX),Math.floor(this.maxY),Math.floor(this.maxZ))}transformed(t){return this.copy().transform(t)}dilated(t){return this.dilatedXYZ(t,t,t)}dilatedX(t){return new xi(this.minX-t,this.minY,this.minZ,this.maxX+t,this.maxY,this.maxZ)}dilatedY(t){return new xi(this.minX,this.minY-t,this.minZ,this.maxX,this.maxY+t,this.maxZ)}dilatedZ(t){return new xi(this.minX,this.minY,this.minZ-t,this.maxX,this.maxY,this.maxZ+t)}dilatedXYZ(t,e,i){return new xi(this.minX-t,this.minY-e,this.minZ-i,this.maxX+t,this.maxY+e,this.maxZ+i)}eroded(t){return this.dilated(-t)}erodedX(t){return this.dilatedX(-t)}erodedY(t){return this.dilatedY(-t)}erodedZ(t){return this.dilatedZ(-t)}erodedXYZ(t,e,i){return this.dilatedXYZ(-t,-e,-i)}shiftedX(t){return new xi(this.minX+t,this.minY,this.minZ,this.maxX+t,this.maxY,this.maxZ)}shiftedY(t){return new xi(this.minX,this.minY+t,this.minZ,this.maxX,this.maxY+t,this.maxZ)}shiftedZ(t){return new xi(this.minX,this.minY,this.minZ+t,this.maxX,this.maxY,this.maxZ+t)}shiftedXYZ(t,e,i){return new xi(this.minX+t,this.minY+e,this.minZ+i,this.maxX+t,this.maxY+e,this.maxZ+i)}shifted(t){return this.shiftedXYZ(t.x,t.y,t.z)}setMinMax(t,e,i,s,n,r){return this.minX=t,this.minY=e,this.minZ=i,this.maxX=s,this.maxY=n,this.maxZ=r,this}setMinX(t){return this.minX=t,this}setMinY(t){return this.minY=t,this}setMinZ(t){return this.minZ=t,this}setMaxX(t){return this.maxX=t,this}setMaxY(t){return this.maxY=t,this}setMaxZ(t){return this.maxZ=t,this}set(t){return this.setMinMax(t.minX,t.minY,t.minZ,t.maxX,t.maxY,t.maxZ)}includeBounds(t){return this.setMinMax(Math.min(this.minX,t.minX),Math.min(this.minY,t.minY),Math.min(this.minZ,t.minZ),Math.max(this.maxX,t.maxX),Math.max(this.maxY,t.maxY),Math.max(this.maxZ,t.maxZ))}constrainBounds(t){return this.setMinMax(Math.max(this.minX,t.minX),Math.max(this.minY,t.minY),Math.max(this.minZ,t.minZ),Math.min(this.maxX,t.maxX),Math.min(this.maxY,t.maxY),Math.min(this.maxZ,t.maxZ))}addCoordinates(t,e,i){return this.setMinMax(Math.min(this.minX,t),Math.min(this.minY,e),Math.min(this.minZ,i),Math.max(this.maxX,t),Math.max(this.maxY,e),Math.max(this.maxZ,i))}addPoint(t){return this.addCoordinates(t.x,t.y,t.z)}roundOut(){return this.setMinMax(Math.floor(this.minX),Math.floor(this.minY),Math.floor(this.minZ),Math.ceil(this.maxX),Math.ceil(this.maxY),Math.ceil(this.maxZ))}roundIn(){return this.setMinMax(Math.ceil(this.minX),Math.ceil(this.minY),Math.ceil(this.minZ),Math.floor(this.maxX),Math.floor(this.maxY),Math.floor(this.maxZ))}transform(t){if(this.isEmpty())return this;if(t.isIdentity())return this;let e=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY,r=Number.NEGATIVE_INFINITY,a=Number.NEGATIVE_INFINITY;const h=new je(0,0,0);function o(t){e=Math.min(e,t.x),i=Math.min(i,t.y),s=Math.min(s,t.z),n=Math.max(n,t.x),r=Math.max(r,t.y),a=Math.max(a,t.z)}return o(t.multiplyVector3(h.setXYZ(this.minX,this.minY,this.minZ))),o(t.multiplyVector3(h.setXYZ(this.minX,this.maxY,this.minZ))),o(t.multiplyVector3(h.setXYZ(this.maxX,this.minY,this.minZ))),o(t.multiplyVector3(h.setXYZ(this.maxX,this.maxY,this.minZ))),o(t.multiplyVector3(h.setXYZ(this.minX,this.minY,this.maxZ))),o(t.multiplyVector3(h.setXYZ(this.minX,this.maxY,this.maxZ))),o(t.multiplyVector3(h.setXYZ(this.maxX,this.minY,this.maxZ))),o(t.multiplyVector3(h.setXYZ(this.maxX,this.maxY,this.maxZ))),this.setMinMax(e,i,s,n,r,a)}dilate(t){return this.dilateXYZ(t,t,t)}dilateX(t){return this.setMinMax(this.minX-t,this.minY,this.minZ,this.maxX+t,this.maxY,this.maxZ)}dilateY(t){return this.setMinMax(this.minX,this.minY-t,this.minZ,this.maxX,this.maxY+t,this.maxZ)}dilateZ(t){return this.setMinMax(this.minX,this.minY,this.minZ-t,this.maxX,this.maxY,this.maxZ+t)}dilateXYZ(t,e,i){return this.setMinMax(this.minX-t,this.minY-e,this.minZ-i,this.maxX+t,this.maxY+e,this.maxZ+i)}erode(t){return this.dilate(-t)}erodeX(t){return this.dilateX(-t)}erodeY(t){return this.dilateY(-t)}erodeZ(t){return this.dilateZ(-t)}erodeXYZ(t,e,i){return this.dilateXYZ(-t,-e,-i)}shiftX(t){return this.setMinMax(this.minX+t,this.minY,this.minZ,this.maxX+t,this.maxY,this.maxZ)}shiftY(t){return this.setMinMax(this.minX,this.minY+t,this.minZ,this.maxX,this.maxY+t,this.maxZ)}shiftZ(t){return this.setMinMax(this.minX,this.minY,this.minZ+t,this.maxX,this.maxY,this.maxZ+t)}shiftXYZ(t,e,i){return this.setMinMax(this.minX+t,this.minY+e,this.minZ+i,this.maxX+t,this.maxY+e,this.maxZ+i)}shift(t){return this.shiftXYZ(t.x,t.y,t.z)}static cuboid(t,e,i,s,n,r){return new xi(t,e,i,t+s,e+n,i+r)}static point(t,e,i){return new xi(t,e,i,t,e,i)}}xi.prototype.isBounds=!0,xi.prototype.dimension=3,fe.register("Bounds3",xi),yi.mixInto(xi,{initialize:xi.prototype.setMinMax}),xi.NOTHING=new xi(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),xi.EVERYTHING=new xi(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),xi.Bounds3IO=new C("Bounds3IO",{valueType:xi,documentation:"a 3-dimensional bounds (bounding box)",stateSchema:{minX:we,minY:we,minZ:we,maxX:we,maxY:we,maxZ:we},toStateObject:t=>({minX:t.minX,minY:t.minY,minZ:t.minZ,maxX:t.maxX,maxY:t.maxY,maxZ:t.maxZ}),fromStateObject:t=>new xi(t.minX,t.minY,t.minZ,t.maxX,t.maxY,t.maxZ)});class _i{constructor(t){this.inclusions=t}size(){return this.inclusions.length}includes(t){return this.inclusions[t]}apply(t){return t.filter((t,e)=>this.inclusions[e])}inverted(){return new _i(this.inclusions.map(t=>!t))}getIncludedIndices(){return _.range(0,this.size()).filter(t=>this.inclusions[t])}toString(){return`C[${this.inclusions.map(t=>t?"1":"0").join("")}]`}equals(t){return this.inclusions.length===t.inclusions.length&&_.isEqual(this.inclusions,t.inclusions)}static empty(t){return new _i(_.range(0,t).map(()=>!1))}static full(t){return new _i(_.range(0,t).map(()=>!0))}static combinations(t){const e=[],i=[];return function s(n){n===t?e.push(new _i(i.slice())):(i.push(!1),s(n+1),i.pop(),i.push(!0),s(n+1),i.pop())}(0),e}static forEachCombination(t,e){const i=[];!function s(n){n===t.length?e(i):(s(n+1),i.push(t[n]),s(n+1),i.pop())}(0)}static combinationsOf(t){const e=[];return _i.forEachCombination(t,t=>{e.push(t.slice())}),e}}fe.register("Combination",_i);class wi{constructor(t){this.points=t.slice();for(let e=0;e<this.points.length-2;e++){const t=this.points[e],i=this.points[e+1],s=this.points[e+2];ni.arePointsCollinear(t,i,s)&&(this.points.splice(e+1,1),e--)}}findMatchingPair(t){let e=0;for(;e<this.points.length-2&&this.points[e+1].x<t;)e++;return[this.points[e],this.points[e+1]]}evaluate(t){if(1===this.points.length)return this.points[0].y;{const[e,i]=this.findMatchingPair(t);return e.x===t?e.y:i.x===t?i.y:ni.linear(e.x,i.x,e.y,i.y,t)}}getCombinedXValues(t){return wi.sortedUniqueEpsilon(this.points.map(t=>t.x).concat(t.points.map(t=>t.x)))}getIntersectedXValues(t){const e=this.getCombinedXValues(t),i=[];for(let n=0;n<e.length-1;n++){const s=e[n],r=e[n+1],a=ni.lineLineIntersection(new Ge(s,this.evaluate(s)),new Ge(r,this.evaluate(r)),new Ge(s,t.evaluate(s)),new Ge(r,t.evaluate(r)));a&&(0===n||a.x>s)&&(n===e.length-2||a.x<r)&&i.push(a.x)}const s=wi.sortedUniqueEpsilon([...e,...i]);return[s[0]-1,...s,s[s.length-1]+1]}binaryXOperation(t,e,i){return new wi(i.map(i=>new Ge(i,e(this.evaluate(i),t.evaluate(i)))))}binaryPointwiseOperation(t,e){return this.binaryXOperation(t,e,this.getCombinedXValues(t))}binaryIntersectingOperation(t,e){return this.binaryXOperation(t,e,this.getIntersectedXValues(t))}plus(t){return this.binaryPointwiseOperation(t,(t,e)=>t+e)}minus(t){return this.binaryPointwiseOperation(t,(t,e)=>t-e)}min(t){return this.binaryIntersectingOperation(t,Math.min)}max(t){return this.binaryIntersectingOperation(t,Math.max)}withXValues(t){return new wi(t.map(t=>new Ge(t,this.evaluate(t))))}inverted(){const t=this.points.map(t=>new Ge(t.y,t.x));return t.length>1&&t[0].x>t[1].x&&t.reverse(),new wi(t)}static sum(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return e.reduce((t,e)=>t.plus(e))}static min(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return e.reduce((t,e)=>t.min(e))}static max(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return e.reduce((t,e)=>t.max(e))}static constant(t){return new wi([new Ge(0,t)])}static linear(t,e){return new wi([new Ge(0,e),new Ge(1,t+e)])}static sortedUniqueEpsilon(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e-10;t=_.sortBy(t);for(let i=0;i<t.length-1;i++)Math.abs(t[i]-t[i+1])<e&&(t.splice(i,1),i--);return t}}fe.register("CompletePiecewiseLinearFunction",wi);class vi{constructor(t,e){this.real=t,this.imaginary=e}copy(t){return t?t.set(this):new vi(this.real,this.imaginary)}phase(){return Math.atan2(this.imaginary,this.real)}getMagnitude(){return Math.sqrt(this.magnitudeSquared)}get magnitude(){return this.getMagnitude()}getMagnitudeSquared(){return this.real*this.real+this.imaginary*this.imaginary}get magnitudeSquared(){return this.getMagnitudeSquared()}equals(t){return this.real===t.real&&this.imaginary===t.imaginary}equalsEpsilon(t,e){return e||(e=0),Math.max(Math.abs(this.real-t.real),Math.abs(this.imaginary-t.imaginary))<=e}plus(t){return new vi(this.real+t.real,this.imaginary+t.imaginary)}minus(t){return new vi(this.real-t.real,this.imaginary-t.imaginary)}times(t){return new vi(this.real*t.real-this.imaginary*t.imaginary,this.real*t.imaginary+this.imaginary*t.real)}dividedBy(t){const e=t.magnitudeSquared;return new vi((this.real*t.real+this.imaginary*t.imaginary)/e,(this.imaginary*t.real-this.real*t.imaginary)/e)}sqrtOf(){const t=this.magnitude;return new vi(Math.sqrt((t+this.real)/2),(this.imaginary>=0?1:-1)*Math.sqrt((t-this.real)/2))}powerByReal(t){const e=Math.pow(this.magnitude,t),i=t*this.phase();return new vi(e*Math.cos(i),e*Math.sin(i))}sinOf(){return new vi(Math.sin(this.real)*ni.cosh(this.imaginary),Math.cos(this.real)*ni.sinh(this.imaginary))}cosOf(){return new vi(Math.cos(this.real)*ni.cosh(this.imaginary),-Math.sin(this.real)*ni.sinh(this.imaginary))}squared(){return this.times(this)}conjugated(){return new vi(this.real,-this.imaginary)}exponentiated(){return vi.createPolar(Math.exp(this.real),this.imaginary)}setRealImaginary(t,e){return this.real=t,this.imaginary=e,this}setReal(t){return this.real=t,this}setImaginary(t){return this.imaginary=t,this}set(t){return this.setRealImaginary(t.real,t.imaginary)}setPolar(t,e){return this.setRealImaginary(t*Math.cos(e),t*Math.sin(e))}add(t){return this.setRealImaginary(this.real+t.real,this.imaginary+t.imaginary)}subtract(t){return this.setRealImaginary(this.real-t.real,this.imaginary-t.imaginary)}multiply(t){return this.setRealImaginary(this.real*t.real-this.imaginary*t.imaginary,this.real*t.imaginary+this.imaginary*t.real)}divide(t){const e=t.magnitudeSquared;return this.setRealImaginary((this.real*t.real+this.imaginary*t.imaginary)/e,(this.imaginary*t.real-this.real*t.imaginary)/e)}exponentiate(){return this.setPolar(Math.exp(this.real),this.imaginary)}square(){return this.multiply(this)}sqrt(){const t=this.magnitude;return this.setRealImaginary(Math.sqrt((t+this.real)/2),(this.imaginary>=0?1:-1)*Math.sqrt((t-this.real)/2))}sin(){return this.setRealImaginary(Math.sin(this.real)*ni.cosh(this.imaginary),Math.cos(this.real)*ni.sinh(this.imaginary))}cos(){return this.setRealImaginary(Math.cos(this.real)*ni.cosh(this.imaginary),-Math.sin(this.real)*ni.sinh(this.imaginary))}conjugate(){return this.setRealImaginary(this.real,-this.imaginary)}toString(){return`Complex(${this.real}, ${this.imaginary})`}static real(t){return new vi(t,0)}static imaginary(t){return new vi(0,t)}static createPolar(t,e){return new vi(t*Math.cos(e),t*Math.sin(e))}}fe.register("Complex",vi),vi.ZERO=new vi(0,0),vi.ONE=new vi(1,0),vi.I=vi.imaginary(1);const bi={grahamScan:(t,e)=>{if(t.length<=2)return t;let i=Number.POSITIVE_INFINITY,s=null;_.each(t,t=>{t.y<=i&&(t.y===i&&s?t.x<s.x&&(s=t):(i=t.y,s=t))}),(t=_.sortBy(t,t=>t.minus(s).angle)).splice(_.indexOf(t,s),1);const n=[s];return _.each(t,t=>{if(s.x!==t.x||s.y!==t.y){for(;i();)n.pop();n.push(t)}function i(){if(n.length<2)return!1;const i=(s=n[n.length-2],r=n[n.length-1],a=t,r.minus(s).crossScalar(a.minus(s)));var s,r,a;return e?i<0:i<=0}}),n}};fe.register("ConvexHull2",bi);class Ti extends B{}_defineProperty(Ti,"OVER_DAMPED",new Ti),_defineProperty(Ti,"UNDER_DAMPED",new Ti),_defineProperty(Ti,"CRITICALLY_DAMPED",new Ti),_defineProperty(Ti,"UNKNOWN",new Ti),_defineProperty(Ti,"enumeration",new $(Ti));class Ei{constructor(t,e,i,s,n){this.dampingConstant=e/t,this.angularFrequencySquared=i/t,this.discriminant=this.dampingConstant*this.dampingConstant-4*this.angularFrequencySquared,this.solutionType=Ti.UNKNOWN,this.c1=0,this.c2=0,Math.abs(this.discriminant)<1e-5?(this.solutionType=Ti.CRITICALLY_DAMPED,this.angularFrequency=Math.sqrt(this.angularFrequencySquared),this.c1=s,this.c2=n+this.angularFrequency*s):this.discriminant<0?(this.solutionType=Ti.UNDER_DAMPED,this.frequency=.5*Math.sqrt(-this.discriminant),this.c1=s,this.c2=this.dampingConstant*s/(2*this.frequency)+n/this.frequency):(this.solutionType=Ti.OVER_DAMPED,this.positiveRoot=.5*(-this.dampingConstant+Math.sqrt(this.discriminant)),this.negativeRoot=.5*(-this.dampingConstant-Math.sqrt(this.discriminant)),this.c2=(this.negativeRoot*s-n)/(this.negativeRoot-this.positiveRoot),this.c1=s-this.c2)}getValue(t){if(this.solutionType===Ti.CRITICALLY_DAMPED)return(this.c1+this.c2*t)*Math.exp(-this.angularFrequency*t);if(this.solutionType===Ti.UNDER_DAMPED){const e=this.frequency*t;return Math.exp(-this.dampingConstant/2*t)*(this.c1*Math.cos(e)+this.c2*Math.sin(e))}if(this.solutionType===Ti.OVER_DAMPED)return this.c1*Math.exp(this.negativeRoot*t)+this.c2*Math.exp(this.positiveRoot*t);throw new Error("Unknown solution type?")}getDerivative(t){if(this.solutionType===Ti.CRITICALLY_DAMPED)return Math.exp(-this.angularFrequency*t)*(this.c2-this.angularFrequency*(this.c1+this.c2*t));if(this.solutionType===Ti.UNDER_DAMPED){const e=this.frequency*t,i=Math.cos(e),s=Math.sin(e),n=this.frequency*(this.c2*i-this.c1*s),r=.5*this.dampingConstant*(this.c1*i+this.c2*s);return Math.exp(-.5*this.dampingConstant*t)*(n-r)}if(this.solutionType===Ti.OVER_DAMPED)return this.c1*this.negativeRoot*Math.exp(this.negativeRoot*t)+this.c2*this.positiveRoot*Math.exp(this.positiveRoot*t);throw new Error("Unknown solution type?")}}fe.register("DampedHarmonic",Ei);class Ai{constructor(t,e,i){let s;if(i=m({},i),this.points=t,this.constraints=e,this.triangles=[],this.edges=[],this.convexHull=[],0===t.length)return;for(this.vertices=t.map((t,e)=>new Mi(t,e)),s=0;s<this.constraints.length;s++){const t=this.constraints[s],e=t[0],i=t[1];this.vertices[e].constrainedVertices.push(this.vertices[i])}for(this.vertices.sort(Ai.vertexComparison),s=0;s<this.vertices.length;s++){const t=this.vertices[s];t.sortedIndex=s;for(let e=t.constrainedVertices.length-1;e>=0;e--){const i=t.constrainedVertices[e];-1===i.sortedIndex&&(i.constrainedVertices.push(t),t.constrainedVertices.splice(e,1))}}this.bottomVertex=this.vertices[0],this.remainingVertices=this.vertices.slice(1);const n=ui.NOTHING.copy();for(s=t.length-1;s>=0;s--)n.addPoint(t[s]);this.artificialMinVertex=new Mi(new Ge(n.minX-.4*n.width,n.minY-.4*n.height),-1),this.artificialMaxVertex=new Mi(new Ge(n.maxX+.4*n.width,n.minY-.4*n.height),-2),this.edges.push(new Pi(this.artificialMinVertex,this.artificialMaxVertex)),this.edges.push(new Pi(this.artificialMaxVertex,this.bottomVertex)),this.edges.push(new Pi(this.bottomVertex,this.artificialMinVertex)),this.triangles.push(new Ii(this.artificialMinVertex,this.artificialMaxVertex,this.bottomVertex,this.edges[1],this.edges[2],this.edges[0])),this.firstFrontEdge=this.edges[1],this.edges[1].connectAfter(this.edges[2]),this.firstHullEdge=this.edges[0]}step(){const t=this.remainingVertices.shift(),e=t.point.x;let i=this.firstFrontEdge;for(;i;){if(e>i.endVertex.point.x){const e=new Pi(i.startVertex,t),s=new Pi(t,i.endVertex);e.connectAfter(s),this.edges.push(e),this.edges.push(s),this.triangles.push(new Ii(i.endVertex,i.startVertex,t,e,s,i)),this.reconnectFrontEdges(i,i,e,s),this.legalizeEdge(i),this.addHalfPiHeuristic(e,s),this.constrainEdges(t,e,s);break}if(e===i.endVertex.point.x){const e=i.nextEdge,s=i,n=i.endVertex,r=e.endVertex,a=s.startVertex,h=new Pi(t,r),o=new Pi(a,t),l=new Pi(n,t);o.connectAfter(h),this.edges.push(h),this.edges.push(o),this.edges.push(l),this.triangles.push(new Ii(r,n,t,l,h,e)),this.triangles.push(new Ii(n,a,t,o,l,s)),this.reconnectFrontEdges(s,e,o,h),this.legalizeEdge(e),this.legalizeEdge(s),this.legalizeEdge(l),this.addHalfPiHeuristic(o,h),this.constrainEdges(t,o,h);break}i=i.nextEdge}}fillBorderTriangle(t,e,i,s,n){const r=new Pi(i,n);return this.edges.push(r),this.triangles.push(new Ii(n,s,i,t,r,e)),this.legalizeEdge(t),this.legalizeEdge(e),r}reconnectFrontEdges(t,e,i,s){const n=t.previousEdge,r=e.nextEdge;n?(n.disconnectAfter(),n.connectAfter(i)):this.firstFrontEdge=i,r&&(e.disconnectAfter(),s.connectAfter(r))}addHalfPiHeuristic(t,e){const i=t.endVertex;for(;t.previousEdge&&ni.triangleAreaSigned(i.point,t.startVertex.point,t.previousEdge.startVertex.point)>0&&i.point.minus(t.startVertex.point).angleBetween(t.previousEdge.startVertex.point.minus(t.startVertex.point))<Math.PI/2;){const e=t.previousEdge,s=new Pi(e.startVertex,i);this.edges.push(s),this.triangles.push(new Ii(i,t.startVertex,e.startVertex,e,s,t)),this.reconnectFrontEdges(e,t,s,s),this.legalizeEdge(e),this.legalizeEdge(t),t=s}for(;e.nextEdge&&ni.triangleAreaSigned(i.point,e.nextEdge.endVertex.point,e.endVertex.point)>0&&i.point.minus(e.endVertex.point).angleBetween(e.nextEdge.endVertex.point.minus(e.endVertex.point))<Math.PI/2;){const t=e.nextEdge,s=new Pi(i,t.endVertex);this.edges.push(s),this.triangles.push(new Ii(i,e.nextEdge.endVertex,e.endVertex,t,e,s)),this.reconnectFrontEdges(e,t,s,s),this.legalizeEdge(t),this.legalizeEdge(e),e=s}}constrainEdges(t,e,i){for(let s=0;s<t.constrainedVertices.length;s++){const n=t.constrainedVertices[s];if(n===e.startVertex||n===i.endVertex)break;const r=[],a=[];let h=null,o=null;const l=[],u=[];let m=Ai.vertexProduct(t,e.startVertex,n)>0,d=Ai.vertexProduct(t,i.endVertex,n)<0;if(!m&&!d){let i,s=e.startVertex;for(h=e.triangles[0];Ai.vertexProduct(t,i=h.getEdgeOppositeFromVertex(t).getOtherVertex(s),n)<0;)h=h.getEdgeOppositeFromVertex(s).getOtherTriangle(h),s=i;if(h.hasVertex(n))break;l.push(h),o=h.getEdgeOppositeFromVertex(t),u.push(o),r.push(h.getEdgeOppositeFromVertex(s)),a.push(h.getEdgeOppositeFromVertex(o.getOtherVertex(s)))}for(;!m&&!d;)if(o.triangles.length>1){const e=o.getOtherTriangle(h);if(e.hasVertex(n)){l.push(e),r.push(e.getNextEdge(o)),a.push(e.getPreviousEdge(o));break}{let i;e.aEdge!==o&&e.aEdge.intersectsConstrainedEdge(t,n)?i=e.aEdge:e.bEdge!==o&&e.bEdge.intersectsConstrainedEdge(t,n)?i=e.bEdge:e.cEdge!==o&&e.cEdge.intersectsConstrainedEdge(t,n)&&(i=e.cEdge),e.getNextEdge(i)===o?r.push(e.getPreviousEdge(i)):a.push(e.getNextEdge(i)),o=i,u.push(o),h=e,l.push(h)}}else n.point.x<t.point.x?d=!0:m=!0;for(let t=0;t<l.length;t++){const e=l[t];k(this.triangles,e),e.remove()}for(let t=0;t<u.length;t++)k(this.edges,u[t]);const c=new Pi(n,t);c.isConstrained=!0,this.edges.push(c),r.push(c),a.push(c),a.reverse(),window.triDebug&&window.triDebug(this),this.triangulatePolygon(r),this.triangulatePolygon(a)}}triangulatePolygon(t){for(;t.length>3;){for(let e=0;e<t.length;e++){t.length}for(let e=0;e<t.length;e++){const i=e<t.length-1?e+1:0,s=t[e],n=t[i],r=s.getSharedVertex(n),a=s.getOtherVertex(r),h=n.getOtherVertex(r);if(ni.triangleAreaSigned(a.point,r.point,h.point)<=0)continue;const o=h.point.minus(r.point),l=a.point.minus(r.point),u=o.dot(o),m=o.dot(l),d=l.dot(l),c=u*d-m*m;let p=t[0].getSharedVertex(t[t.length-1]),g=!1;for(let e=0;e<t.length;e++){const i=t[e].getOtherVertex(p);if(i!==r&&i!==a&&i!==h){const t=i.point.minus(r.point),e=o.dot(t),s=l.dot(t),n=(d*e-m*s)/c,a=(u*s-m*e)/c;if(n>=-1e-10&&a>=-1e-10&&n+a<1+1e-10){g=!0;break}}p=i}if(!g){const o=new Pi(a,h);this.edges.push(o),this.triangles.push(new Ii(a,r,h,n,o,s)),i>e?t.splice(e,2,o):(t.splice(e,1,o),t.splice(i,1)),window.triDebug&&window.triDebug(this)}}}3===t.length&&(this.triangles.push(new Ii(t[0].getSharedVertex(t[1]),t[1].getSharedVertex(t[2]),t[0].getSharedVertex(t[2]),t[2],t[0],t[1])),window.triDebug&&window.triDebug(this))}finalize(){const t=[];let e=this.firstFrontEdge.nextEdge;for(;e&&e.nextEdge;)t.push(e),e=e.nextEdge;const i=this.firstFrontEdge,s=e;for(let h=0;h<t.length-1;h++){const e=t[h],i=t[h+1];if(ni.triangleAreaSigned(i.endVertex.point,e.endVertex.point,e.startVertex.point)>1e-10){const s=this.fillBorderTriangle(e,i,e.startVertex,e.endVertex,i.endVertex);t.splice(h,2,s),h=Math.max(h-2,-1),window.triDebug&&window.triDebug(this)}}this.firstFrontEdge=null;const n=[],r=[i];let a=i;for(;a!==s;){const t=a.triangles[0];t.remove(),k(this.triangles,t);const e=t.getNonArtificialEdge();if(e){n.push(e);const i=e.getSharedVertex(a);a=t.getEdgeOppositeFromVertex(i)}else r.push(t.getEdgeOppositeFromVertex(a.endVertex)),a=t.getEdgeOppositeFromVertex(a.startVertex);r.push(a)}for(let h=0;h<r.length;h++)k(this.edges,r[h]);window.triDebug&&window.triDebug(this);for(let h=0;h<n.length-1;h++){const t=n[h+1],e=n[h],i=t.getSharedVertex(e),s=t.getOtherVertex(i),r=e.getOtherVertex(i);if(ni.triangleAreaSigned(r.point,i.point,s.point)>1e-10){const a=this.fillBorderTriangle(t,e,s,i,r);n.splice(h,2,a),h=Math.max(h-2,-1),window.triDebug&&window.triDebug(this)}}for(let h=0;h<t.length;h++)this.convexHull.push(t[h].startVertex);this.convexHull.push(t[t.length-1].endVertex);for(let h=n.length-1;h>=1;h--)this.convexHull.push(n[h].getSharedVertex(n[h-1]))}legalizeEdge(t){if(!_.includes(this.edges,t)||2!==t.triangles.length||t.isConstrained)return;const e=t.triangles[0],i=t.triangles[1],s=e.getVertexOppositeFromEdge(t),n=i.getVertexOppositeFromEdge(t);if(ni.pointInCircleFromPoints(e.aVertex.point,e.bVertex.point,e.cVertex.point,n.point)||ni.pointInCircleFromPoints(i.aVertex.point,i.bVertex.point,i.cVertex.point,s.point)){e.remove(),i.remove(),k(this.triangles,e),k(this.triangles,i),k(this.edges,t);const r=new Pi(s,n);this.edges.push(r);const a=i.getEdgeOppositeFromVertex(i.getVertexBefore(n)),h=e.getEdgeOppositeFromVertex(e.getVertexAfter(s)),o=e.getEdgeOppositeFromVertex(e.getVertexBefore(s)),l=i.getEdgeOppositeFromVertex(i.getVertexAfter(n));this.triangles.push(new Ii(s,n,e.getVertexBefore(s),a,h,r)),this.triangles.push(new Ii(n,s,i.getVertexBefore(n),o,l,r)),this.legalizeEdge(a),this.legalizeEdge(h),this.legalizeEdge(o),this.legalizeEdge(l)}}static vertexComparison(t,e){return t=t.point,e=e.point,t.y<e.y?-1:t.y>e.y?1:t.x<e.x?-1:t.x>e.x?1:0}static vertexProduct(t,e,i){const s=e.point.minus(t.point),n=i.point.minus(t.point);return s.crossScalar(n)}}fe.register("DelaunayTriangulation",Ai);class Mi{constructor(t,e){this.point=t,this.index=e,this.sortedIndex=-1,this.constrainedVertices=[]}isArtificial(){return this.index<0}}class Pi{constructor(t,e){this.startVertex=t,this.endVertex=e,this.triangles=[],this.nextEdge=null,this.previousEdge=null,this.isConstrained=!1}isArtificial(){return this.startVertex.isArtificial()||this.endVertex.isArtificial()}connectAfter(t){this.nextEdge=t,t.previousEdge=this}disconnectAfter(){this.nextEdge.previousEdge=null,this.nextEdge=null}addTriangle(t){this.triangles.push(t)}removeTriangle(t){k(this.triangles,t)}getSharedTriangle(t){for(let e=0;e<this.triangles.length;e++){const i=this.triangles[e];for(let e=0;e<t.triangles.length;e++)if(t.triangles[e]===i)return i}throw new Error("No common triangle")}getSharedVertex(t){return this.startVertex===t.startVertex||this.startVertex===t.endVertex?this.startVertex:this.endVertex}getOtherVertex(t){return t===this.startVertex?this.endVertex:this.startVertex}getOtherTriangle(t){return this.triangles[0]===t?this.triangles[1]:this.triangles[0]}intersectsConstrainedEdge(t,e){return ni.lineSegmentIntersection(t.point.x,t.point.y,e.point.x,e.point.y,this.startVertex.point.x,this.startVertex.point.y,this.endVertex.point.x,this.endVertex.point.y)}}class Ii{constructor(t,e,i,s,n,r){this.aVertex=t,this.bVertex=e,this.cVertex=i,this.aEdge=s,this.bEdge=n,this.cEdge=r,this.aEdge.addTriangle(this),this.bEdge.addTriangle(this),this.cEdge.addTriangle(this)}hasVertex(t){return this.aVertex===t||this.bVertex===t||this.cVertex===t}getVertexOppositeFromEdge(t){return t===this.aEdge?this.aVertex:t===this.bEdge?this.bVertex:this.cVertex}getEdgeOppositeFromVertex(t){return t===this.aVertex?this.aEdge:t===this.bVertex?this.bEdge:this.cEdge}getVertexBefore(t){return t===this.aVertex?this.cVertex:t===this.bVertex?this.aVertex:this.bVertex}getVertexAfter(t){return t===this.aVertex?this.bVertex:t===this.bVertex?this.cVertex:this.aVertex}getNonArtificialEdge(){return this.aEdge.isArtificial()?this.bEdge.isArtificial()?this.cEdge.isArtificial()?null:this.cEdge:this.bEdge:this.aEdge}getNextEdge(t){if(this.aEdge===t)return this.bEdge;if(this.bEdge===t)return this.cEdge;if(this.cEdge===t)return this.aEdge;throw new Error("illegal edge")}getPreviousEdge(t){if(this.aEdge===t)return this.cEdge;if(this.bEdge===t)return this.aEdge;if(this.cEdge===t)return this.bEdge;throw new Error("illegal edge")}isArtificial(){return this.aVertex.isArtificial()||this.bVertex.isArtificial()||this.cVertex.isArtificial()}remove(){this.aEdge.removeTriangle(this),this.bEdge.removeTriangle(this),this.cEdge.removeTriangle(this)}}class Si{constructor(t,e){this.width=t,this.height=e}toString(){return`[${this.width}w, ${this.height}h]`}set(t){return this.width=t.width,this.height=t.height,this}setWidth(t){return this.width=t,this}setHeight(t){return this.height=t,this}copy(t){return t?t.set(this):new Si(this.width,this.height)}swapped(){return new Si(this.height,this.width)}toBounds(t,e){return new ui(t=void 0!==t?t:0,e=void 0!==e?e:0,this.width+t,this.height+e)}equals(t){return this.width===t.width&&this.height===t.height}}fe.register("Dimension2",Si);function Oi(t){return"[object Array]"===Object.prototype.toString.call(t)}l.register("isArray",Oi);const Vi=Oi,Ni=window.Float64Array||Array;class Di{constructor(t){let e,i,s;this.matrix=t,this.LU=t.getArrayCopy();const n=this.LU;this.m=t.getRowDimension();const r=this.m;this.n=t.getColumnDimension();const a=this.n;for(this.piv=new Uint32Array(r),e=0;e<r;e++)this.piv[e]=e;this.pivsign=1;const h=new Ni(r);for(i=0;i<a;i++){for(e=0;e<r;e++)h[e]=n[t.index(e,i)];for(e=0;e<r;e++){const r=Math.min(e,i);let a=0;for(s=0;s<r;s++){a+=n[t.index(e,s)]*h[s]}h[e]-=a,n[t.index(e,i)]=h[e]}let o=i;for(e=i+1;e<r;e++)Math.abs(h[e])>Math.abs(h[o])&&(o=e);if(o!==i){for(s=0;s<a;s++){const e=t.index(o,s),r=t.index(i,s),a=n[e];n[e]=n[r],n[r]=a}s=this.piv[o],this.piv[o]=this.piv[i],this.piv[i]=s,this.pivsign=-this.pivsign}if(i<r&&0!==n[this.matrix.index(i,i)])for(e=i+1;e<r;e++)n[t.index(e,i)]/=n[t.index(i,i)]}}isNonsingular(){for(let t=0;t<this.n;t++){const e=this.matrix.index(t,t);if(0===this.LU[e])return!1}return!0}getL(){const t=new Bi(this.m,this.n);for(let e=0;e<this.m;e++)for(let i=0;i<this.n;i++)t.entries[t.index(e,i)]=e>i?this.LU[this.matrix.index(e,i)]:e===i?1:0;return t}getU(){const t=new Bi(this.n,this.n);for(let e=0;e<this.n;e++)for(let i=0;i<this.n;i++)t.entries[t.index(e,i)]=e<=i?this.LU[this.matrix.index(e,i)]:0;return t}getPivot(){const t=new Uint32Array(this.m);for(let e=0;e<this.m;e++)t[e]=this.piv[e];return t}getDoublePivot(){const t=new Ni(this.m);for(let e=0;e<this.m;e++)t[e]=this.piv[e];return t}det(){if(this.m!==this.n)throw new Error("Matrix must be square.");let t=this.pivsign;for(let e=0;e<this.n;e++)t*=this.LU[this.matrix.index(e,e)];return t}solve(t){let e,i,s;if(t.getRowDimension()!==this.m)throw new Error("Matrix row dimensions must agree.");if(!this.isNonsingular())throw new Error("Matrix is singular.");const n=t.getColumnDimension(),r=t.getArrayRowMatrix(this.piv,0,n-1);for(s=0;s<this.n;s++)for(e=s+1;e<this.n;e++)for(i=0;i<n;i++)r.entries[r.index(e,i)]-=r.entries[r.index(s,i)]*this.LU[this.matrix.index(e,s)];for(s=this.n-1;s>=0;s--){for(i=0;i<n;i++)r.entries[r.index(s,i)]/=this.LU[this.matrix.index(s,s)];for(e=0;e<s;e++)for(i=0;i<n;i++)r.entries[r.index(e,i)]-=r.entries[r.index(s,i)]*this.LU[this.matrix.index(e,s)]}return r}}fe.register("LUDecomposition",Di);const Yi=Di,Ci=window.Float64Array||Array;class Xi{constructor(t){this.matrix=t,this.QR=t.getArrayCopy();const e=this.QR;this.m=t.getRowDimension();const i=this.m;this.n=t.getColumnDimension();const s=this.n;let n,r,a;for(this.Rdiag=new Ci(s),a=0;a<s;a++){let t=0;for(n=a;n<i;n++)t=Bi.hypot(t,e[this.matrix.index(n,a)]);if(0!==t){for(e[this.matrix.index(a,a)]<0&&(t=-t),n=a;n<i;n++)e[this.matrix.index(n,a)]/=t;for(e[this.matrix.index(a,a)]+=1,r=a+1;r<s;r++){let t=0;for(n=a;n<i;n++)t+=e[this.matrix.index(n,a)]*e[this.matrix.index(n,r)];for(t=-t/e[this.matrix.index(a,a)],n=a;n<i;n++)e[this.matrix.index(n,r)]+=t*e[this.matrix.index(n,a)]}}this.Rdiag[a]=-t}}isFullRank(){for(let t=0;t<this.n;t++)if(0===this.Rdiag[t])return!1;return!0}getH(){const t=new Bi(this.m,this.n);for(let e=0;e<this.m;e++)for(let i=0;i<this.n;i++)t.entries[t.index(e,i)]=e>=i?this.QR[this.matrix.index(e,i)]:0;return t}getR(){const t=new Bi(this.n,this.n);for(let e=0;e<this.n;e++)for(let i=0;i<this.n;i++)t.entries[t.index(e,i)]=e<i?this.QR[this.matrix.index(e,i)]:e===i?this.Rdiag[e]:0;return t}getQ(){let t,e,i;const s=new Bi(this.m,this.n);for(i=this.n-1;i>=0;i--){for(t=0;t<this.m;t++)s.entries[s.index(t,i)]=0;for(s.entries[s.index(i,i)]=1,e=i;e<this.n;e++)if(0!==this.QR[this.matrix.index(i,i)]){let n=0;for(t=i;t<this.m;t++)n+=this.QR[this.matrix.index(t,i)]*s.entries[s.index(t,e)];for(n=-n/this.QR[this.matrix.index(i,i)],t=i;t<this.m;t++)s.entries[s.index(t,e)]+=n*this.QR[this.matrix.index(t,i)]}}return s}solve(t){if(t.getRowDimension()!==this.m)throw new Error("Matrix row dimensions must agree.");if(!this.isFullRank())throw new Error("Matrix is rank deficient.");let e,i,s;const n=t.getColumnDimension(),r=t.getArrayCopy();for(s=0;s<this.n;s++)for(i=0;i<n;i++){let n=0;for(e=s;e<this.m;e++)n+=this.QR[this.matrix.index(e,s)]*r[t.index(e,i)];for(n=-n/this.QR[this.matrix.index(s,s)],e=s;e<this.m;e++)r[t.index(e,i)]+=n*this.QR[this.matrix.index(e,s)]}for(s=this.n-1;s>=0;s--){for(i=0;i<n;i++)r[t.index(s,i)]/=this.Rdiag[s];for(e=0;e<s;e++)for(i=0;i<n;i++)r[t.index(e,i)]-=r[t.index(s,i)]*this.QR[this.matrix.index(e,s)]}return new Bi(this.n,n,r,!0).getMatrix(0,this.n-1,0,n-1)}}fe.register("QRDecomposition",Xi);const Fi=Xi,Ri=window.Float64Array||Array;class Li{constructor(t){this.matrix=t;const e=t,i=e.getArrayCopy();this.m=e.getRowDimension(),this.n=e.getColumnDimension();const s=this.m,n=this.n,r=Math.min,a=Math.max,h=Math.pow,o=Math.abs,l=r(s,n);this.s=new Ri(r(s+1,n));const u=this.s;this.U=new Ri(s*l);const m=this.U;this.V=new Ri(n*n);const d=this.V,c=new Ri(n),p=new Ri(s);let g,f,y,x,_,w,v;const b=Bi.hypot,T=r(s-1,n),E=a(0,r(n-2,s));for(y=0;y<a(T,E);y++){if(y<T){for(u[y]=0,g=y;g<s;g++)u[y]=b(u[y],i[g*n+y]);if(0!==u[y]){for(i[y*n+y]<0&&(u[y]=-u[y]),g=y;g<s;g++)i[g*n+y]/=u[y];i[y*n+y]+=1}u[y]=-u[y]}for(f=y+1;f<n;f++){if(y<T&&0!==u[y]){for(x=0,g=y;g<s;g++)x+=i[g*n+y]*i[g*n+f];for(x=-x/i[y*n+y],g=y;g<s;g++)i[g*n+f]+=x*i[g*n+y]}c[f]=i[y*n+f]}if(y<T)for(g=y;g<s;g++)m[g*l+y]=i[g*n+y];if(y<E){for(c[y]=0,g=y+1;g<n;g++)c[y]=b(c[y],c[g]);if(0!==c[y]){for(c[y+1]<0&&(c[y]=-c[y]),g=y+1;g<n;g++)c[g]/=c[y];c[y+1]+=1}if(c[y]=-c[y],y+1<s&&0!==c[y]){for(g=y+1;g<s;g++)p[g]=0;for(f=y+1;f<n;f++)for(g=y+1;g<s;g++)p[g]+=c[f]*i[g*n+f];for(f=y+1;f<n;f++)for(x=-c[f]/c[y+1],g=y+1;g<s;g++)i[g*n+f]+=x*p[g]}for(g=y+1;g<n;g++)d[g*n+y]=c[g]}}let A=r(n,s+1);for(T<n&&(u[T]=i[T*n+T]),s<A&&(u[A-1]=0),E+1<A&&(c[E]=i[E*n+A-1]),c[A-1]=0,f=T;f<l;f++){for(g=0;g<s;g++)m[g*l+f]=0;m[f*l+f]=1}for(y=T-1;y>=0;y--)if(0!==u[y]){for(f=y+1;f<l;f++){for(x=0,g=y;g<s;g++)x+=m[g*l+y]*m[g*l+f];for(x=-x/m[y*l+y],g=y;g<s;g++)m[g*l+f]+=x*m[g*l+y]}for(g=y;g<s;g++)m[g*l+y]=-m[g*l+y];for(m[y*l+y]=1+m[y*l+y],g=0;g<y-1;g++)m[g*l+y]=0}else{for(g=0;g<s;g++)m[g*l+y]=0;m[y*l+y]=1}for(y=n-1;y>=0;y--){if(y<E&&0!==c[y])for(f=y+1;f<l;f++){for(x=0,g=y+1;g<n;g++)x+=d[g*n+y]*d[g*n+f];for(x=-x/d[(y+1)*n+y],g=y+1;g<n;g++)d[g*n+f]+=x*d[g*n+y]}for(g=0;g<n;g++)d[g*n+y]=0;d[y*n+y]=1}const M=A-1;let P=0;const I=h(2,-52),S=h(2,-966);for(;A>0;){let t;if(P>500)break;for(y=A-2;y>=-1&&-1!==y;y--)if(o(c[y])<=S+I*(o(u[y])+o(u[y+1]))){c[y]=0;break}if(y===A-2)t=4;else{let e;for(e=A-1;e>=y&&e!==y;e--)if(x=(e!==A?o(c[e]):0)+(e!==y+1?o(c[e-1]):0),o(u[e])<=S+I*x){u[e]=0;break}e===y?t=3:e===A-1?t=1:(t=2,y=e)}switch(y++,t){case 1:for(_=c[A-2],c[A-2]=0,f=A-2;f>=y;f--)for(x=b(u[f],_),w=u[f]/x,v=_/x,u[f]=x,f!==y&&(_=-v*c[f-1],c[f-1]=w*c[f-1]),g=0;g<n;g++)x=w*d[g*n+f]+v*d[g*n+A-1],d[g*n+A-1]=-v*d[g*n+f]+w*d[g*n+A-1],d[g*n+f]=x;break;case 2:for(_=c[y-1],c[y-1]=0,f=y;f<A;f++)for(x=b(u[f],_),w=u[f]/x,v=_/x,u[f]=x,_=-v*c[f],c[f]=w*c[f],g=0;g<s;g++)x=w*m[g*l+f]+v*m[g*l+y-1],m[g*l+y-1]=-v*m[g*l+f]+w*m[g*l+y-1],m[g*l+f]=x;break;case 3:{const t=a(a(a(a(o(u[A-1]),o(u[A-2])),o(c[A-2])),o(u[y])),o(c[y])),e=u[A-1]/t,i=u[A-2]/t,r=c[A-2]/t,h=u[y]/t,p=c[y]/t,T=((i+e)*(i-e)+r*r)/2,E=e*r*(e*r);let M=0;0===T&&0===E||(M=Math.sqrt(T*T+E),T<0&&(M=-M),M=E/(T+M)),_=(h+e)*(h-e)+M;let I=h*p;for(f=y;f<A-1;f++){for(x=b(_,I),w=_/x,v=I/x,f!==y&&(c[f-1]=x),_=w*u[f]+v*c[f],c[f]=w*c[f]-v*u[f],I=v*u[f+1],u[f+1]=w*u[f+1],g=0;g<n;g++)x=w*d[g*n+f]+v*d[g*n+f+1],d[g*n+f+1]=-v*d[g*n+f]+w*d[g*n+f+1],d[g*n+f]=x;if(x=b(_,I),w=_/x,v=I/x,u[f]=x,_=w*c[f]+v*u[f+1],u[f+1]=-v*c[f]+w*u[f+1],I=v*c[f+1],c[f+1]=w*c[f+1],f<s-1)for(g=0;g<s;g++)x=w*m[g*l+f]+v*m[g*l+f+1],m[g*l+f+1]=-v*m[g*l+f]+w*m[g*l+f+1],m[g*l+f]=x}c[A-2]=_,P+=1}break;case 4:if(u[y]<=0)for(u[y]=u[y]<0?-u[y]:0,g=0;g<=M;g++)d[g*n+y]=-d[g*n+y];for(;y<M&&!(u[y]>=u[y+1]);){if(x=u[y],u[y]=u[y+1],u[y+1]=x,y<n-1)for(g=0;g<n;g++)x=d[g*n+y+1],d[g*n+y+1]=d[g*n+y],d[g*n+y]=x;if(y<s-1)for(g=0;g<s;g++)x=m[g*l+y+1],m[g*l+y+1]=m[g*l+y],m[g*l+y]=x;y++}P=0,A--;break;default:throw new Error("invalid kase: "+t)}}}getU(){return new Bi(this.m,Math.min(this.m+1,this.n),this.U,!0)}getV(){return new Bi(this.n,this.n,this.V,!0)}getSingularValues(){return this.s}getS(){const t=new Bi(this.n,this.n);for(let e=0;e<this.n;e++){for(let i=0;i<this.n;i++)t.entries[t.index(e,i)]=0;t.entries[t.index(e,e)]=this.s[e]}return t}norm2(){return this.s[0]}cond(){return this.s[0]/this.s[Math.min(this.m,this.n)-1]}rank(){const t=Math.pow(2,-23),e=Math.max(this.m,this.n)*this.s[0]*t;let i=0;for(let s=0;s<this.s.length;s++)this.s[s]>e&&i++;return i}static pseudoinverse(t){const e=new Li(t),i=Bi.diagonalMatrix(e.getSingularValues().map(t=>Math.abs(t)<1e-300?0:1/t));return e.getV().times(i).times(e.getU().transpose())}}fe.register("SingularValueDecomposition",Li);const zi=Li,ki=window.Float64Array||Array;class qi{constructor(t,e,i,s){this.m=t,this.n=e;const n=t*e;let r;if(this.size=n,s)this.entries=i;else if(i||(i=0),this.entries=new ki(n),Vi(i))for(r=0;r<n;r++)this.entries[r]=i[r];else for(r=0;r<n;r++)this.entries[r]=i}copy(){const t=new qi(this.m,this.n);for(let e=0;e<this.size;e++)t.entries[e]=this.entries[e];return t}getArray(){return this.entries}getArrayCopy(){return new ki(this.entries)}getRowDimension(){return this.m}getColumnDimension(){return this.n}index(t,e){return t*this.n+e}get(t,e){return this.entries[this.index(t,e)]}set(t,e,i){this.entries[this.index(t,e)]=i}getMatrix(t,e,i,s){const n=new qi(e-t+1,s-i+1);for(let r=t;r<=e;r++)for(let e=i;e<=s;e++)n.entries[n.index(r-t,e-i)]=this.entries[this.index(r,e)];return n}getArrayRowMatrix(t,e,i){const s=new qi(t.length,i-e+1);for(let n=0;n<t.length;n++)for(let r=e;r<=i;r++)s.entries[s.index(n,r-e)]=this.entries[this.index(t[n],r)];return s}transpose(t){t=t||new qi(this.n,this.m);for(let e=0;e<this.m;e++)for(let i=0;i<this.n;i++)t.entries[t.index(i,e)]=this.entries[this.index(e,i)];return t}norm1(){let t=0;for(let e=0;e<this.n;e++){let i=0;for(let t=0;t<this.m;t++)i+=Math.abs(this.entries[this.index(t,e)]);t=Math.max(t,i)}return t}norm2(){return new zi(this).norm2()}normInf(){let t=0;for(let e=0;e<this.m;e++){let i=0;for(let t=0;t<this.n;t++)i+=Math.abs(this.entries[this.index(e,t)]);t=Math.max(t,i)}return t}normF(){let t=0;for(let e=0;e<this.m;e++)for(let i=0;i<this.n;i++)t=qi.hypot(t,this.entries[this.index(e,i)]);return t}uminus(){const t=new qi(this.m,this.n);for(let e=0;e<this.m;e++)for(let i=0;i<this.n;i++)t.entries[t.index(e,i)]=-this.entries[this.index(e,i)];return t}plus(t){this.checkMatrixDimensions(t);const e=new qi(this.m,this.n);for(let i=0;i<this.m;i++)for(let s=0;s<this.n;s++){const n=e.index(i,s);e.entries[n]=this.entries[n]+t.entries[n]}return e}plusEquals(t){this.checkMatrixDimensions(t);for(let e=0;e<this.m;e++)for(let i=0;i<this.n;i++){const s=this.index(e,i);this.entries[s]=this.entries[s]+t.entries[s]}return this}blendEquals(t,e){this.checkMatrixDimensions(t);for(let i=0;i<this.m;i++)for(let s=0;s<this.n;s++){const n=this.index(i,s),r=this.entries[n],a=t.entries[n];this.entries[n]=r+(a-r)*e}return this}minus(t){this.checkMatrixDimensions(t);const e=new qi(this.m,this.n);for(let i=0;i<this.m;i++)for(let s=0;s<this.n;s++){const n=this.index(i,s);e.entries[n]=this.entries[n]-t.entries[n]}return e}minusEquals(t){this.checkMatrixDimensions(t);for(let e=0;e<this.m;e++)for(let i=0;i<this.n;i++){const s=this.index(e,i);this.entries[s]=this.entries[s]-t.entries[s]}return this}arrayTimes(t){this.checkMatrixDimensions(t);const e=new qi(this.m,this.n);for(let i=0;i<this.m;i++)for(let s=0;s<this.n;s++){const n=e.index(i,s);e.entries[n]=this.entries[n]*t.entries[n]}return e}arrayTimesEquals(t){this.checkMatrixDimensions(t);for(let e=0;e<this.m;e++)for(let i=0;i<this.n;i++){const s=this.index(e,i);this.entries[s]=this.entries[s]*t.entries[s]}return this}arrayRightDivide(t){this.checkMatrixDimensions(t);const e=new qi(this.m,this.n);for(let i=0;i<this.m;i++)for(let s=0;s<this.n;s++){const n=this.index(i,s);e.entries[n]=this.entries[n]/t.entries[n]}return e}arrayRightDivideEquals(t){this.checkMatrixDimensions(t);for(let e=0;e<this.m;e++)for(let i=0;i<this.n;i++){const s=this.index(e,i);this.entries[s]=this.entries[s]/t.entries[s]}return this}arrayLeftDivide(t){this.checkMatrixDimensions(t);const e=new qi(this.m,this.n);for(let i=0;i<this.m;i++)for(let s=0;s<this.n;s++){const n=this.index(i,s);e.entries[n]=t.entries[n]/this.entries[n]}return e}arrayLeftDivideEquals(t){this.checkMatrixDimensions(t);for(let e=0;e<this.m;e++)for(let i=0;i<this.n;i++){const s=this.index(e,i);this.entries[s]=t.entries[s]/this.entries[s]}return this}times(t){let e,i,s,n,r,a;if(t.isMatrix){if(a=t,a.m!==this.n)throw new Error("Matrix inner dimensions must agree.");e=new qi(this.m,a.n);const h=new ki(this.n);for(s=0;s<a.n;s++){for(n=0;n<this.n;n++)h[n]=a.entries[a.index(n,s)];for(i=0;i<this.m;i++){for(r=0,n=0;n<this.n;n++)r+=this.entries[this.index(i,n)]*h[n];e.entries[e.index(i,s)]=r}}return e}for(r=t,e=new qi(this.m,this.n),i=0;i<this.m;i++)for(s=0;s<this.n;s++)e.entries[e.index(i,s)]=r*this.entries[this.index(i,s)];return e}timesEquals(t){for(let e=0;e<this.m;e++)for(let i=0;i<this.n;i++){const s=this.index(e,i);this.entries[s]=t*this.entries[s]}return this}solve(t){return this.m===this.n?new Yi(this).solve(t):new Fi(this).solve(t)}solveTranspose(t){return this.transpose().solve(t.transpose())}inverse(){return this.solve(qi.identity(this.m,this.m))}det(){return new Yi(this).det()}rank(){return new zi(this).rank()}cond(){return new zi(this).cond()}trace(){let t=0;for(let e=0;e<Math.min(this.m,this.n);e++)t+=this.entries[this.index(e,e)];return t}checkMatrixDimensions(t){if(t.m!==this.m||t.n!==this.n)throw new Error("Matrix dimensions must agree.")}toString(){let t="";t+=`dim: ${this.getRowDimension()}x${this.getColumnDimension()}\n`;for(let e=0;e<this.getRowDimension();e++){for(let i=0;i<this.getColumnDimension();i++)t+=this.get(e,i)+" ";t+="\n"}return t}extractVector2(t){return new Ge(this.get(0,t),this.get(1,t))}extractVector3(t){return new je(this.get(0,t),this.get(1,t),this.get(2,t))}extractVector4(t){return new ke(this.get(0,t),this.get(1,t),this.get(2,t),this.get(3,t))}setVectors3(t){const e=t.length;for(let i=0;i<e;i++){const s=t[i];this.entries[i]=s.x,this.entries[i+e]=s.y,this.entries[i+2*e]=s.z}return this}static hypot(t,e){let i;return Math.abs(t)>Math.abs(e)?(i=e/t,i=Math.abs(t)*Math.sqrt(1+i*i)):0!==e?(i=t/e,i=Math.abs(e)*Math.sqrt(1+i*i)):i=0,i}static identity(t,e){const i=new qi(t,e);for(let s=0;s<t;s++)for(let t=0;t<e;t++)i.entries[i.index(s,t)]=s===t?1:0;return i}static diagonalMatrix(t){const e=t.length,i=new qi(e,e);for(let s=0;s<e;s++)i.entries[i.index(s,s)]=t[s];return i}static rowVector2(t){return new qi(1,2,[t.x,t.y])}static rowVector3(t){return new qi(1,3,[t.x,t.y,t.z])}static rowVector4(t){return new qi(1,4,[t.x,t.y,t.z,t.w])}static rowVector(t){if(t.isVector2)return qi.rowVector2(t);if(t.isVector3)return qi.rowVector3(t);if(t.isVector4)return qi.rowVector4(t);throw new Error("undetected type of vector: "+t.toString())}static columnVector2(t){return new qi(2,1,[t.x,t.y])}static columnVector3(t){return new qi(3,1,[t.x,t.y,t.z])}static columnVector4(t){return new qi(4,1,[t.x,t.y,t.z,t.w])}static columnVector(t){if(t.isVector2)return qi.columnVector2(t);if(t.isVector3)return qi.columnVector3(t);if(t.isVector4)return qi.columnVector4(t);throw new Error("undetected type of vector: "+t.toString())}static fromVectors2(t){const e=t.length,i=new ki(2*e);for(let s=0;s<e;s++){const n=t[s];i[s]=n.x,i[s+e]=n.y}return new qi(2,e,i,!0)}static fromVectors3(t){const e=t.length,i=new ki(3*e);for(let s=0;s<e;s++){const n=t[s];i[s]=n.x,i[s+e]=n.y,i[s+2*e]=n.z}return new qi(3,e,i,!0)}static fromVectors4(t){const e=t.length,i=new ki(4*e);for(let s=0;s<e;s++){const n=t[s];i[s]=n.x,i[s+e]=n.y,i[s+2*e]=n.z,i[s+3*e]=n.w}return new qi(4,e,i,!0)}}qi.prototype.isMatrix=!0,fe.register("Matrix",qi);const Bi=qi,Zi=window.Float64Array||Array;class ji{constructor(t){let e,i;const s=t.entries;this.n=t.getColumnDimension();const n=this.n;for(this.V=new Zi(n*n),this.d=new Zi(n),this.e=new Zi(n),this.issymmetric=!0,i=0;i<n&&this.issymmetric;i++)for(e=0;e<n&&this.issymmetric;e++)this.issymmetric=s[e*this.n+i]===s[i*this.n+e];if(this.issymmetric){for(e=0;e<n;e++)for(i=0;i<n;i++)this.V[e*this.n+i]=s[e*this.n+i];this.tred2(),this.tql2()}else{for(this.H=new Zi(n*n),this.ort=new Zi(n),i=0;i<n;i++)for(e=0;e<n;e++)this.H[e*this.n+i]=s[e*this.n+i];this.orthes(),this.hqr2()}}getV(){return this.V.copy()}getRealEigenvalues(){return this.d}getImagEigenvalues(){return this.e}getD(){const t=this.n,e=this.d,i=this.e,s=new Bi(t,t),n=s.entries;for(let r=0;r<t;r++){for(let e=0;e<t;e++)n[r*this.n+e]=0;n[r*this.n+r]=e[r],i[r]>0?n[r*this.n+r+1]=i[r]:i[r]<0&&(n[r*this.n+r-1]=i[r])}return s}tred2(){const t=this.n,e=this.V,i=this.d,s=this.e;let n,r,a,h,o,l;for(r=0;r<t;r++)i[r]=e[(t-1)*t+r];for(n=t-1;n>0;n--){let u=0;for(l=0,a=0;a<n;a++)u+=Math.abs(i[a]);if(0===u)for(s[n]=i[n-1],r=0;r<n;r++)i[r]=e[(n-1)*t+r],e[n*this.n+r]=0,e[r*this.n+n]=0;else{for(a=0;a<n;a++)i[a]/=u,l+=i[a]*i[a];for(h=i[n-1],o=Math.sqrt(l),h>0&&(o=-o),s[n]=u*o,l-=h*o,i[n-1]=h-o,r=0;r<n;r++)s[r]=0;for(r=0;r<n;r++){for(h=i[r],e[r*this.n+n]=h,o=s[r]+e[r*t+r]*h,a=r+1;a<=n-1;a++)o+=e[a*t+r]*i[a],s[a]+=e[a*t+r]*h;s[r]=o}for(h=0,r=0;r<n;r++)s[r]/=l,h+=s[r]*i[r];const m=h/(l+l);for(r=0;r<n;r++)s[r]-=m*i[r];for(r=0;r<n;r++){for(h=i[r],o=s[r],a=r;a<=n-1;a++)e[a*t+r]-=h*s[a]+o*i[a];i[r]=e[(n-1)*t+r],e[n*this.n+r]=0}}i[n]=l}for(n=0;n<t-1;n++){if(e[(t-1)*t+n]=e[n*t+n],e[n*t+n]=1,l=i[n+1],0!==l){for(a=0;a<=n;a++)i[a]=e[a*t+(n+1)]/l;for(r=0;r<=n;r++){for(o=0,a=0;a<=n;a++)o+=e[a*t+(n+1)]*e[a*t+r];for(a=0;a<=n;a++)e[a*t+r]-=o*i[a]}}for(a=0;a<=n;a++)e[a*t+(n+1)]=0}for(r=0;r<t;r++)i[r]=e[(t-1)*t+r],e[(t-1)*t+r]=0;e[(t-1)*t+(t-1)]=1,s[0]=0}tql2(){const t=this.n,e=this.V,i=this.d,s=this.e;let n,r,a,h,o,l,u;for(n=1;n<t;n++)s[n-1]=s[n];s[t-1]=0;let m=0,d=0;const c=Math.pow(2,-52);for(h=0;h<t;h++){d=Math.max(d,Math.abs(i[h])+Math.abs(s[h]));let r=h;for(;r<t&&!(Math.abs(s[r])<=c*d);)r++;if(r>h){u=0;do{u+=1,o=i[h],l=(i[h+1]-o)/(2*s[h]);let d=Bi.hypot(l,1);l<0&&(d=-d),i[h]=s[h]/(l+d),i[h+1]=s[h]*(l+d);const c=i[h+1];let p=o-i[h];for(n=h+2;n<t;n++)i[n]-=p;m+=p,l=i[r];let g=1,f=g,y=g;const x=s[h+1];let _=0,w=0;for(n=r-1;n>=h;n--)for(y=f,f=g,w=_,o=g*s[n],p=g*l,d=Bi.hypot(l,s[n]),s[n+1]=_*d,_=s[n]/d,g=l/d,l=g*i[n]-_*o,i[n+1]=p+_*(g*o+_*i[n]),a=0;a<t;a++)p=e[a*t+(n+1)],e[a*t+(n+1)]=_*e[a*t+n]+g*p,e[a*t+n]=g*e[a*t+n]-_*p;l=-_*w*y*x*s[h]/c,s[h]=_*l,i[h]=g*l}while(Math.abs(s[h])>c*d)}i[h]=i[h]+m,s[h]=0}for(n=0;n<t-1;n++){for(a=n,l=i[n],r=n+1;r<t;r++)i[r]<l&&(a=r,l=i[r]);if(a!==n)for(i[a]=i[n],i[n]=l,r=0;r<t;r++)l=e[r*this.n+n],e[r*this.n+n]=e[r*t+a],e[r*t+a]=l}}orthes(){const t=this.n,e=this.V,i=this.H,s=this.ort;let n,r,a,h,o;const l=t-1;for(a=1;a<=l-1;a++){let e=0;for(n=a;n<=l;n++)e+=Math.abs(i[n*t+(a-1)]);if(0!==e){let u=0;for(n=l;n>=a;n--)s[n]=i[n*t+(a-1)]/e,u+=s[n]*s[n];for(o=Math.sqrt(u),s[a]>0&&(o=-o),u-=s[a]*o,s[a]=s[a]-o,r=a;r<t;r++){for(h=0,n=l;n>=a;n--)h+=s[n]*i[n*this.n+r];for(h/=u,n=a;n<=l;n++)i[n*this.n+r]-=h*s[n]}for(n=0;n<=l;n++){for(h=0,r=l;r>=a;r--)h+=s[r]*i[n*this.n+r];for(h/=u,r=a;r<=l;r++)i[n*this.n+r]-=h*s[r]}s[a]=e*s[a],i[a*t+(a-1)]=e*o}}for(n=0;n<t;n++)for(r=0;r<t;r++)e[n*this.n+r]=n===r?1:0;for(a=l-1;a>=1;a--)if(0!==i[a*t+(a-1)]){for(n=a+1;n<=l;n++)s[n]=i[n*t+(a-1)];for(r=a;r<=l;r++){for(o=0,n=a;n<=l;n++)o+=s[n]*e[n*this.n+r];for(o=o/s[a]/i[a*t+(a-1)],n=a;n<=l;n++)e[n*this.n+r]+=o*s[n]}}}cdiv(t,e,i,s){let n,r;Math.abs(i)>Math.abs(s)?(n=s/i,r=i+n*s,this.cdivr=(t+n*e)/r,this.cdivi=(e-n*t)/r):(n=i/s,r=s+n*i,this.cdivr=(n*t+e)/r,this.cdivi=(n*e-t)/r)}hqr2(){let t;const e=this.V,i=this.d,s=this.e,n=this.H;let r,a,h,o,l,u;const m=this.n;t=m-1;const d=m-1,c=Math.pow(2,-52);let p,g,f,y,x=0,_=0,w=0,v=0,b=0,T=0,E=0;for(r=0;r<m;r++)for((r<0||r>d)&&(i[r]=n[r*t+r],s[r]=0),a=Math.max(r-1,0);a<m;a++)E+=Math.abs(n[r*this.n+a]);for(u=0;t>=0;){for(o=t;o>0&&(b=Math.abs(n[(o-1)*t+(o-1)])+Math.abs(n[o*t+o]),0===b&&(b=E),!(Math.abs(n[o*t+(o-1)])<c*b));)o--;if(o===t)n[t*t+t]=n[t*t+t]+x,i[t]=n[t*t+t],s[t]=0,t--,u=0;else if(o===t-1){if(g=n[t*t+t-1]*n[(t-1)*t+t],_=(n[(t-1)*t+(t-1)]-n[t*t+t])/2,w=_*_+g,T=Math.sqrt(Math.abs(w)),n[t*t+t]=n[t*t+t]+x,n[(t-1)*t+(t-1)]=n[(t-1)*t+(t-1)]+x,f=n[t*t+t],w>=0){for(T=_>=0?_+T:_-T,i[t-1]=f+T,i[t]=i[t-1],0!==T&&(i[t]=f-g/T),s[t-1]=0,s[t]=0,f=n[t*t+t-1],b=Math.abs(f)+Math.abs(T),_=f/b,w=T/b,v=Math.sqrt(_*_+w*w),_/=v,w/=v,a=t-1;a<m;a++)T=n[(t-1)*t+a],n[(t-1)*t+a]=w*T+_*n[t*t+a],n[t*t+a]=w*n[t*t+a]-_*T;for(r=0;r<=t;r++)T=n[r*t+t-1],n[r*t+t-1]=w*T+_*n[r*t+t],n[r*t+t]=w*n[r*t+t]-_*T;for(r=0;r<=d;r++)T=e[r*t+t-1],e[r*t+t-1]=w*T+_*e[r*t+t],e[r*t+t]=w*e[r*t+t]-_*T}else i[t-1]=f+_,i[t]=f+_,s[t-1]=T,s[t]=-T;t-=2,u=0}else{if(f=n[t*t+t],y=0,g=0,o<t&&(y=n[(t-1)*t+(t-1)],g=n[t*t+t-1]*n[(t-1)*t+t]),10===u){for(x+=f,r=0;r<=t;r++)n[r*t+r]-=f;b=Math.abs(n[t*t+t-1])+Math.abs(n[(t-1)*t+t-2]),f=y=.75*b,g=-.4375*b*b}if(30===u&&(b=(y-f)/2,b=b*b+g,b>0)){for(b=Math.sqrt(b),y<f&&(b=-b),b=f-g/((y-f)/2+b),r=0;r<=t;r++)n[r*t+r]-=b;x+=b,f=y=g=.964}for(u+=1,l=t-2;l>=o&&(T=n[l*t+l],v=f-T,b=y-T,_=(v*b-g)/n[(l+1)*t+l]+n[l*t+l+1],w=n[(l+1)*t+l+1]-T-v-b,v=n[(l+2)*t+l+1],b=Math.abs(_)+Math.abs(w)+Math.abs(v),_/=b,w/=b,v/=b,l!==o)&&!(Math.abs(n[l*t+(l-1)])*(Math.abs(w)+Math.abs(v))<c*(Math.abs(_)*(Math.abs(n[(l-1)*t+l-1])+Math.abs(T)+Math.abs(n[(l+1)*t+l+1]))));)l--;for(r=l+2;r<=t;r++)n[r*t+r-2]=0,r>l+2&&(n[r*t+r-3]=0);for(h=l;h<=t-1;h++){const i=h!==t-1;if(h!==l&&(_=n[h*t+h-1],w=n[(h+1)*t+h-1],v=i?n[(h+2)*t+h-1]:0,f=Math.abs(_)+Math.abs(w)+Math.abs(v),0!==f&&(_/=f,w/=f,v/=f)),0===f)break;if(b=Math.sqrt(_*_+w*w+v*v),_<0&&(b=-b),0!==b){for(h!==l?n[h*t+h-1]=-b*f:o!==l&&(n[h*t+h-1]=-n[h*t+h-1]),_+=b,f=_/b,y=w/b,T=v/b,w/=_,v/=_,a=h;a<m;a++)_=n[h*t+a]+w*n[(h+1)*t+a],i&&(_+=v*n[(h+2)*t+a],n[(h+2)*t+a]=n[(h+2)*t+a]-_*T),n[h*t+a]=n[h*t+a]-_*f,n[(h+1)*t+a]=n[(h+1)*t+a]-_*y;for(r=0;r<=Math.min(t,h+3);r++)_=f*n[r*t+h]+y*n[r*t+h+1],i&&(_+=T*n[r*t+h+2],n[r*t+h+2]=n[r*t+h+2]-_*v),n[r*t+h]=n[r*t+h]-_,n[r*t+h+1]=n[r*t+h+1]-_*w;for(r=0;r<=d;r++)_=f*e[r*t+h]+y*e[r*t+h+1],i&&(_+=T*e[r*t+h+2],e[r*t+h+2]=e[r*t+h+2]-_*v),e[r*t+h]=e[r*t+h]-_,e[r*t+h+1]=e[r*t+h+1]-_*w}}}}if(0!==E){for(t=m-1;t>=0;t--)if(_=i[t],w=s[t],0===w)for(o=t,n[t*t+t]=1,r=t-1;r>=0;r--){for(g=n[r*t+r]-_,v=0,a=o;a<=t;a++)v+=n[r*this.n+a]*n[a*t+t];if(s[r]<0)T=g,b=v;else if(o=r,0===s[r]?n[r*t+t]=0!==g?-v/g:-v/(c*E):(f=n[r*t+r+1],y=n[(r+1)*t+r],w=(i[r]-_)*(i[r]-_)+s[r]*s[r],p=(f*b-T*v)/w,n[r*t+t]=p,Math.abs(f)>Math.abs(T)?n[(r+1)*t+t]=(-v-g*p)/f:n[(r+1)*t+t]=(-b-y*p)/T),p=Math.abs(n[r*t+t]),c*p*p>1)for(a=r;a<=t;a++)n[a*t+t]=n[a*t+t]/p}else if(w<0)for(o=t-1,Math.abs(n[t*t+t-1])>Math.abs(n[(t-1)*t+t])?(n[(t-1)*t+(t-1)]=w/n[t*t+t-1],n[(t-1)*t+t]=-(n[t*t+t]-_)/n[t*t+t-1]):(this.cdiv(0,-n[(t-1)*t+t],n[(t-1)*t+(t-1)]-_,w),n[(t-1)*t+(t-1)]=this.cdivr,n[(t-1)*t+t]=this.cdivi),n[t*t+t-1]=0,n[t*t+t]=1,r=t-2;r>=0;r--){let e,h,l,u;for(e=0,h=0,a=o;a<=t;a++)e+=n[r*this.n+a]*n[a*t+t-1],h+=n[r*this.n+a]*n[a*t+t];if(g=n[r*t+r]-_,s[r]<0)T=g,v=e,b=h;else if(o=r,0===s[r]?(this.cdiv(-e,-h,g,w),n[r*t+t-1]=this.cdivr,n[r*t+t]=this.cdivi):(f=n[r*t+r+1],y=n[(r+1)*t+r],l=(i[r]-_)*(i[r]-_)+s[r]*s[r]-w*w,u=2*(i[r]-_)*w,0===l&&0===u&&(l=c*E*(Math.abs(g)+Math.abs(w)+Math.abs(f)+Math.abs(y)+Math.abs(T))),this.cdiv(f*v-T*e+w*h,f*b-T*h-w*e,l,u),n[r*t+t-1]=this.cdivr,n[r*t+t]=this.cdivi,Math.abs(f)>Math.abs(T)+Math.abs(w)?(n[(r+1)*t+t-1]=(-e-g*n[r*t+t-1]+w*n[r*t+t])/f,n[(r+1)*t+t]=(-h-g*n[r*t+t]-w*n[r*t+t-1])/f):(this.cdiv(-v-y*n[r*t+t-1],-b-y*n[r*t+t],T,w),n[(r+1)*t+t-1]=this.cdivr,n[(r+1)*t+t]=this.cdivi)),p=Math.max(Math.abs(n[r*t+t-1]),Math.abs(n[r*t+t])),c*p*p>1)for(a=r;a<=t;a++)n[a*t+t-1]=n[a*t+t-1]/p,n[a*t+t]=n[a*t+t]/p}for(r=0;r<m;r++)if(r<0||r>d)for(a=r;a<m;a++)e[r*this.n+a]=n[r*this.n+a];for(a=m-1;a>=0;a--)for(r=0;r<=d;r++){for(T=0,h=0;h<=Math.min(a,d);h++)T+=e[r*t+h]*n[h*t+a];e[r*this.n+a]=T}}}}fe.register("EigenvalueDecomposition",ji);const Hi=(t,e,i,s,n,r)=>{let a=ni.linear(t,e,i,s,n);if(r){const t=Math.max(i,s),e=Math.min(i,s);a=ni.clamp(a,e,t)}return a};fe.register("LinearFunction",class{constructor(t,e,i,s){let n=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this.a1=t,this.a2=e,this.b1=i,this.b2=s,this.clamp=n}evaluate(t){return Hi(this.a1,this.a2,this.b1,this.b2,t,this.clamp)}inverse(t){return Hi(this.b1,this.b2,this.a1,this.a2,t,this.clamp)}});const $i=window.Float32Array||Array;class Ui{constructor(t,e,i,s,n,r,a,h,o,l,u,m,d,c,p,g,f){this.entries=new $i(16),this.type=Gi.OTHER,this.rowMajor(void 0!==t?t:1,void 0!==e?e:0,void 0!==i?i:0,void 0!==s?s:0,void 0!==n?n:0,void 0!==r?r:1,void 0!==a?a:0,void 0!==h?h:0,void 0!==o?o:0,void 0!==l?l:0,void 0!==u?u:1,void 0!==m?m:0,void 0!==d?d:0,void 0!==c?c:0,void 0!==p?p:0,void 0!==g?g:1,f)}rowMajor(t,e,i,s,n,r,a,h,o,l,u,m,d,c,p,g,f){return this.entries[0]=t,this.entries[1]=n,this.entries[2]=o,this.entries[3]=d,this.entries[4]=e,this.entries[5]=r,this.entries[6]=l,this.entries[7]=c,this.entries[8]=i,this.entries[9]=a,this.entries[10]=u,this.entries[11]=p,this.entries[12]=s,this.entries[13]=h,this.entries[14]=m,this.entries[15]=g,this.type=void 0===f?0===d&&0===c&&0===p&&1===g?Gi.AFFINE:Gi.OTHER:f,this}columnMajor(t,e,i,s,n,r,a,h,o,l,u,m,d,c,p,g,f){return this.rowMajor(t,n,o,d,e,r,l,c,i,a,u,p,s,h,m,g,f)}set(t){return this.rowMajor(t.m00(),t.m01(),t.m02(),t.m03(),t.m10(),t.m11(),t.m12(),t.m13(),t.m20(),t.m21(),t.m22(),t.m23(),t.m30(),t.m31(),t.m32(),t.m33(),t.type)}m00(){return this.entries[0]}m01(){return this.entries[4]}m02(){return this.entries[8]}m03(){return this.entries[12]}m10(){return this.entries[1]}m11(){return this.entries[5]}m12(){return this.entries[9]}m13(){return this.entries[13]}m20(){return this.entries[2]}m21(){return this.entries[6]}m22(){return this.entries[10]}m23(){return this.entries[14]}m30(){return this.entries[3]}m31(){return this.entries[7]}m32(){return this.entries[11]}m33(){return this.entries[15]}isFinite(){return isFinite(this.m00())&&isFinite(this.m01())&&isFinite(this.m02())&&isFinite(this.m03())&&isFinite(this.m10())&&isFinite(this.m11())&&isFinite(this.m12())&&isFinite(this.m13())&&isFinite(this.m20())&&isFinite(this.m21())&&isFinite(this.m22())&&isFinite(this.m23())&&isFinite(this.m30())&&isFinite(this.m31())&&isFinite(this.m32())&&isFinite(this.m33())}getTranslation(){return new je(this.m03(),this.m13(),this.m23())}get translation(){return this.getTranslation()}getScaleVector(){const t=this.m00()+this.m03(),e=this.m10()+this.m13(),i=this.m20()+this.m23(),s=this.m30()+this.m33(),n=this.m01()+this.m03(),r=this.m11()+this.m13(),a=this.m21()+this.m23(),h=this.m31()+this.m33(),o=this.m02()+this.m03(),l=this.m12()+this.m13(),u=this.m22()+this.m23(),m=this.m32()+this.m33();return new je(Math.sqrt(t*t+e*e+i*i+s*s),Math.sqrt(n*n+r*r+a*a+h*h),Math.sqrt(o*o+l*l+u*u+m*m))}get scaleVector(){return this.getScaleVector()}getCSSTransform(){return`matrix3d(${this.entries[0].toFixed(20)},${this.entries[1].toFixed(20)},${this.entries[2].toFixed(20)},${this.entries[3].toFixed(20)},${this.entries[4].toFixed(20)},${this.entries[5].toFixed(20)},${this.entries[6].toFixed(20)},${this.entries[7].toFixed(20)},${this.entries[8].toFixed(20)},${this.entries[9].toFixed(20)},${this.entries[10].toFixed(20)},${this.entries[11].toFixed(20)},${this.entries[12].toFixed(20)},${this.entries[13].toFixed(20)},${this.entries[14].toFixed(20)},${this.entries[15].toFixed(20)})`}get cssTransform(){return this.getCSSTransform()}equals(t){return this.m00()===t.m00()&&this.m01()===t.m01()&&this.m02()===t.m02()&&this.m03()===t.m03()&&this.m10()===t.m10()&&this.m11()===t.m11()&&this.m12()===t.m12()&&this.m13()===t.m13()&&this.m20()===t.m20()&&this.m21()===t.m21()&&this.m22()===t.m22()&&this.m23()===t.m23()&&this.m30()===t.m30()&&this.m31()===t.m31()&&this.m32()===t.m32()&&this.m33()===t.m33()}equalsEpsilon(t,e){return Math.abs(this.m00()-t.m00())<e&&Math.abs(this.m01()-t.m01())<e&&Math.abs(this.m02()-t.m02())<e&&Math.abs(this.m03()-t.m03())<e&&Math.abs(this.m10()-t.m10())<e&&Math.abs(this.m11()-t.m11())<e&&Math.abs(this.m12()-t.m12())<e&&Math.abs(this.m13()-t.m13())<e&&Math.abs(this.m20()-t.m20())<e&&Math.abs(this.m21()-t.m21())<e&&Math.abs(this.m22()-t.m22())<e&&Math.abs(this.m23()-t.m23())<e&&Math.abs(this.m30()-t.m30())<e&&Math.abs(this.m31()-t.m31())<e&&Math.abs(this.m32()-t.m32())<e&&Math.abs(this.m33()-t.m33())<e}copy(){return new Ui(this.m00(),this.m01(),this.m02(),this.m03(),this.m10(),this.m11(),this.m12(),this.m13(),this.m20(),this.m21(),this.m22(),this.m23(),this.m30(),this.m31(),this.m32(),this.m33(),this.type)}plus(t){return new Ui(this.m00()+t.m00(),this.m01()+t.m01(),this.m02()+t.m02(),this.m03()+t.m03(),this.m10()+t.m10(),this.m11()+t.m11(),this.m12()+t.m12(),this.m13()+t.m13(),this.m20()+t.m20(),this.m21()+t.m21(),this.m22()+t.m22(),this.m23()+t.m23(),this.m30()+t.m30(),this.m31()+t.m31(),this.m32()+t.m32(),this.m33()+t.m33())}minus(t){return new Ui(this.m00()-t.m00(),this.m01()-t.m01(),this.m02()-t.m02(),this.m03()-t.m03(),this.m10()-t.m10(),this.m11()-t.m11(),this.m12()-t.m12(),this.m13()-t.m13(),this.m20()-t.m20(),this.m21()-t.m21(),this.m22()-t.m22(),this.m23()-t.m23(),this.m30()-t.m30(),this.m31()-t.m31(),this.m32()-t.m32(),this.m33()-t.m33())}transposed(){return new Ui(this.m00(),this.m10(),this.m20(),this.m30(),this.m01(),this.m11(),this.m21(),this.m31(),this.m02(),this.m12(),this.m22(),this.m32(),this.m03(),this.m13(),this.m23(),this.m33())}negated(){return new Ui(-this.m00(),-this.m01(),-this.m02(),-this.m03(),-this.m10(),-this.m11(),-this.m12(),-this.m13(),-this.m20(),-this.m21(),-this.m22(),-this.m23(),-this.m30(),-this.m31(),-this.m32(),-this.m33())}inverted(){let t;switch(this.type){case Gi.IDENTITY:return this;case Gi.TRANSLATION_3D:return new Ui(1,0,0,-this.m03(),0,1,0,-this.m13(),0,0,1,-this.m23(),0,0,0,1,Gi.TRANSLATION_3D);case Gi.SCALING:return new Ui(1/this.m00(),0,0,0,0,1/this.m11(),0,0,0,0,1/this.m22(),0,0,0,0,1/this.m33(),Gi.SCALING);case Gi.AFFINE:case Gi.OTHER:if(t=this.getDeterminant(),0!==t)return new Ui((-this.m31()*this.m22()*this.m13()+this.m21()*this.m32()*this.m13()+this.m31()*this.m12()*this.m23()-this.m11()*this.m32()*this.m23()-this.m21()*this.m12()*this.m33()+this.m11()*this.m22()*this.m33())/t,(this.m31()*this.m22()*this.m03()-this.m21()*this.m32()*this.m03()-this.m31()*this.m02()*this.m23()+this.m01()*this.m32()*this.m23()+this.m21()*this.m02()*this.m33()-this.m01()*this.m22()*this.m33())/t,(-this.m31()*this.m12()*this.m03()+this.m11()*this.m32()*this.m03()+this.m31()*this.m02()*this.m13()-this.m01()*this.m32()*this.m13()-this.m11()*this.m02()*this.m33()+this.m01()*this.m12()*this.m33())/t,(this.m21()*this.m12()*this.m03()-this.m11()*this.m22()*this.m03()-this.m21()*this.m02()*this.m13()+this.m01()*this.m22()*this.m13()+this.m11()*this.m02()*this.m23()-this.m01()*this.m12()*this.m23())/t,(this.m30()*this.m22()*this.m13()-this.m20()*this.m32()*this.m13()-this.m30()*this.m12()*this.m23()+this.m10()*this.m32()*this.m23()+this.m20()*this.m12()*this.m33()-this.m10()*this.m22()*this.m33())/t,(-this.m30()*this.m22()*this.m03()+this.m20()*this.m32()*this.m03()+this.m30()*this.m02()*this.m23()-this.m00()*this.m32()*this.m23()-this.m20()*this.m02()*this.m33()+this.m00()*this.m22()*this.m33())/t,(this.m30()*this.m12()*this.m03()-this.m10()*this.m32()*this.m03()-this.m30()*this.m02()*this.m13()+this.m00()*this.m32()*this.m13()+this.m10()*this.m02()*this.m33()-this.m00()*this.m12()*this.m33())/t,(-this.m20()*this.m12()*this.m03()+this.m10()*this.m22()*this.m03()+this.m20()*this.m02()*this.m13()-this.m00()*this.m22()*this.m13()-this.m10()*this.m02()*this.m23()+this.m00()*this.m12()*this.m23())/t,(-this.m30()*this.m21()*this.m13()+this.m20()*this.m31()*this.m13()+this.m30()*this.m11()*this.m23()-this.m10()*this.m31()*this.m23()-this.m20()*this.m11()*this.m33()+this.m10()*this.m21()*this.m33())/t,(this.m30()*this.m21()*this.m03()-this.m20()*this.m31()*this.m03()-this.m30()*this.m01()*this.m23()+this.m00()*this.m31()*this.m23()+this.m20()*this.m01()*this.m33()-this.m00()*this.m21()*this.m33())/t,(-this.m30()*this.m11()*this.m03()+this.m10()*this.m31()*this.m03()+this.m30()*this.m01()*this.m13()-this.m00()*this.m31()*this.m13()-this.m10()*this.m01()*this.m33()+this.m00()*this.m11()*this.m33())/t,(this.m20()*this.m11()*this.m03()-this.m10()*this.m21()*this.m03()-this.m20()*this.m01()*this.m13()+this.m00()*this.m21()*this.m13()+this.m10()*this.m01()*this.m23()-this.m00()*this.m11()*this.m23())/t,(this.m30()*this.m21()*this.m12()-this.m20()*this.m31()*this.m12()-this.m30()*this.m11()*this.m22()+this.m10()*this.m31()*this.m22()+this.m20()*this.m11()*this.m32()-this.m10()*this.m21()*this.m32())/t,(-this.m30()*this.m21()*this.m02()+this.m20()*this.m31()*this.m02()+this.m30()*this.m01()*this.m22()-this.m00()*this.m31()*this.m22()-this.m20()*this.m01()*this.m32()+this.m00()*this.m21()*this.m32())/t,(this.m30()*this.m11()*this.m02()-this.m10()*this.m31()*this.m02()-this.m30()*this.m01()*this.m12()+this.m00()*this.m31()*this.m12()+this.m10()*this.m01()*this.m32()-this.m00()*this.m11()*this.m32())/t,(-this.m20()*this.m11()*this.m02()+this.m10()*this.m21()*this.m02()+this.m20()*this.m01()*this.m12()-this.m00()*this.m21()*this.m12()-this.m10()*this.m01()*this.m22()+this.m00()*this.m11()*this.m22())/t);throw new Error("Matrix could not be inverted, determinant === 0");default:throw new Error("Matrix4.inverted with unknown type: "+this.type)}}timesMatrix(t){if(this.type===Gi.IDENTITY||t.type===Gi.IDENTITY)return this.type===Gi.IDENTITY?t:this;if(this.type===t.type){if(this.type===Gi.TRANSLATION_3D)return new Ui(1,0,0,this.m03()+t.m02(),0,1,0,this.m13()+t.m12(),0,0,1,this.m23()+t.m23(),0,0,0,1,Gi.TRANSLATION_3D);if(this.type===Gi.SCALING)return new Ui(this.m00()*t.m00(),0,0,0,0,this.m11()*t.m11(),0,0,0,0,this.m22()*t.m22(),0,0,0,0,1,Gi.SCALING)}return this.type!==Gi.OTHER&&t.type!==Gi.OTHER?new Ui(this.m00()*t.m00()+this.m01()*t.m10()+this.m02()*t.m20(),this.m00()*t.m01()+this.m01()*t.m11()+this.m02()*t.m21(),this.m00()*t.m02()+this.m01()*t.m12()+this.m02()*t.m22(),this.m00()*t.m03()+this.m01()*t.m13()+this.m02()*t.m23()+this.m03(),this.m10()*t.m00()+this.m11()*t.m10()+this.m12()*t.m20(),this.m10()*t.m01()+this.m11()*t.m11()+this.m12()*t.m21(),this.m10()*t.m02()+this.m11()*t.m12()+this.m12()*t.m22(),this.m10()*t.m03()+this.m11()*t.m13()+this.m12()*t.m23()+this.m13(),this.m20()*t.m00()+this.m21()*t.m10()+this.m22()*t.m20(),this.m20()*t.m01()+this.m21()*t.m11()+this.m22()*t.m21(),this.m20()*t.m02()+this.m21()*t.m12()+this.m22()*t.m22(),this.m20()*t.m03()+this.m21()*t.m13()+this.m22()*t.m23()+this.m23(),0,0,0,1,Gi.AFFINE):new Ui(this.m00()*t.m00()+this.m01()*t.m10()+this.m02()*t.m20()+this.m03()*t.m30(),this.m00()*t.m01()+this.m01()*t.m11()+this.m02()*t.m21()+this.m03()*t.m31(),this.m00()*t.m02()+this.m01()*t.m12()+this.m02()*t.m22()+this.m03()*t.m32(),this.m00()*t.m03()+this.m01()*t.m13()+this.m02()*t.m23()+this.m03()*t.m33(),this.m10()*t.m00()+this.m11()*t.m10()+this.m12()*t.m20()+this.m13()*t.m30(),this.m10()*t.m01()+this.m11()*t.m11()+this.m12()*t.m21()+this.m13()*t.m31(),this.m10()*t.m02()+this.m11()*t.m12()+this.m12()*t.m22()+this.m13()*t.m32(),this.m10()*t.m03()+this.m11()*t.m13()+this.m12()*t.m23()+this.m13()*t.m33(),this.m20()*t.m00()+this.m21()*t.m10()+this.m22()*t.m20()+this.m23()*t.m30(),this.m20()*t.m01()+this.m21()*t.m11()+this.m22()*t.m21()+this.m23()*t.m31(),this.m20()*t.m02()+this.m21()*t.m12()+this.m22()*t.m22()+this.m23()*t.m32(),this.m20()*t.m03()+this.m21()*t.m13()+this.m22()*t.m23()+this.m23()*t.m33(),this.m30()*t.m00()+this.m31()*t.m10()+this.m32()*t.m20()+this.m33()*t.m30(),this.m30()*t.m01()+this.m31()*t.m11()+this.m32()*t.m21()+this.m33()*t.m31(),this.m30()*t.m02()+this.m31()*t.m12()+this.m32()*t.m22()+this.m33()*t.m32(),this.m30()*t.m03()+this.m31()*t.m13()+this.m32()*t.m23()+this.m33()*t.m33())}timesVector4(t){const e=this.m00()*t.x+this.m01()*t.y+this.m02()*t.z+this.m03()*t.w,i=this.m10()*t.x+this.m11()*t.y+this.m12()*t.z+this.m13()*t.w,s=this.m20()*t.x+this.m21()*t.y+this.m22()*t.z+this.m23()*t.w,n=this.m30()*t.x+this.m31()*t.y+this.m32()*t.z+this.m33()*t.w;return new ke(e,i,s,n)}timesVector3(t){return this.timesVector4(t.toVector4()).toVector3()}timesTransposeVector4(t){const e=this.m00()*t.x+this.m10()*t.y+this.m20()*t.z+this.m30()*t.w,i=this.m01()*t.x+this.m11()*t.y+this.m21()*t.z+this.m31()*t.w,s=this.m02()*t.x+this.m12()*t.y+this.m22()*t.z+this.m32()*t.w,n=this.m03()*t.x+this.m13()*t.y+this.m23()*t.z+this.m33()*t.w;return new ke(e,i,s,n)}timesTransposeVector3(t){return this.timesTransposeVector4(t.toVector4()).toVector3()}timesRelativeVector3(t){const e=this.m00()*t.x+this.m10()*t.y+this.m20()*t.z,i=this.m01()*t.y+this.m11()*t.y+this.m21()*t.z,s=this.m02()*t.z+this.m12()*t.y+this.m22()*t.z;return new je(e,i,s)}getDeterminant(){return this.m03()*this.m12()*this.m21()*this.m30()-this.m02()*this.m13()*this.m21()*this.m30()-this.m03()*this.m11()*this.m22()*this.m30()+this.m01()*this.m13()*this.m22()*this.m30()+this.m02()*this.m11()*this.m23()*this.m30()-this.m01()*this.m12()*this.m23()*this.m30()-this.m03()*this.m12()*this.m20()*this.m31()+this.m02()*this.m13()*this.m20()*this.m31()+this.m03()*this.m10()*this.m22()*this.m31()-this.m00()*this.m13()*this.m22()*this.m31()-this.m02()*this.m10()*this.m23()*this.m31()+this.m00()*this.m12()*this.m23()*this.m31()+this.m03()*this.m11()*this.m20()*this.m32()-this.m01()*this.m13()*this.m20()*this.m32()-this.m03()*this.m10()*this.m21()*this.m32()+this.m00()*this.m13()*this.m21()*this.m32()+this.m01()*this.m10()*this.m23()*this.m32()-this.m00()*this.m11()*this.m23()*this.m32()-this.m02()*this.m11()*this.m20()*this.m33()+this.m01()*this.m12()*this.m20()*this.m33()+this.m02()*this.m10()*this.m21()*this.m33()-this.m00()*this.m12()*this.m21()*this.m33()-this.m01()*this.m10()*this.m22()*this.m33()+this.m00()*this.m11()*this.m22()*this.m33()}get determinant(){return this.getDeterminant()}toString(){return`${this.m00()} ${this.m01()} ${this.m02()} ${this.m03()}\n${this.m10()} ${this.m11()} ${this.m12()} ${this.m13()}\n${this.m20()} ${this.m21()} ${this.m22()} ${this.m23()}\n${this.m30()} ${this.m31()} ${this.m32()} ${this.m33()}`}makeImmutable(){return this}copyToArray(t){return t[0]=this.m00(),t[1]=this.m10(),t[2]=this.m20(),t[3]=this.m30(),t[4]=this.m01(),t[5]=this.m11(),t[6]=this.m21(),t[7]=this.m31(),t[8]=this.m02(),t[9]=this.m12(),t[10]=this.m22(),t[11]=this.m32(),t[12]=this.m03(),t[13]=this.m13(),t[14]=this.m23(),t[15]=this.m33(),t}static identity(){return new Ui(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,Gi.IDENTITY)}static translation(t,e,i){return new Ui(1,0,0,t,0,1,0,e,0,0,1,i,0,0,0,1,Gi.TRANSLATION_3D)}static translationFromVector(t){return Ui.translation(t.x,t.y,t.z)}static scaling(t,e,i){return new Ui(t,0,0,0,0,e=void 0===e?t:e,0,0,0,0,i=void 0===i?t:i,0,0,0,0,1,Gi.SCALING)}static rotationAxisAngle(t,e){const i=Math.cos(e),s=Math.sin(e),n=1-i;return new Ui(t.x*t.x*n+i,t.x*t.y*n-t.z*s,t.x*t.z*n+t.y*s,0,t.y*t.x*n+t.z*s,t.y*t.y*n+i,t.y*t.z*n-t.x*s,0,t.z*t.x*n-t.y*s,t.z*t.y*n+t.x*s,t.z*t.z*n+i,0,0,0,0,1,Gi.AFFINE)}static rotationX(t){const e=Math.cos(t),i=Math.sin(t);return new Ui(1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1,Gi.AFFINE)}static rotationY(t){const e=Math.cos(t),i=Math.sin(t);return new Ui(e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1,Gi.AFFINE)}static rotationZ(t){const e=Math.cos(t),i=Math.sin(t);return new Ui(e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1,Gi.AFFINE)}static gluPerspective(t,e,i,s){const n=Math.cos(t)/Math.sin(t);return new Ui(n/e,0,0,0,0,n,0,0,0,0,(s+i)/(i-s),2*s*i/(i-s),0,0,-1,0)}}fe.register("Matrix4",Ui);const Gi=w.byKeys(["OTHER","IDENTITY","TRANSLATION_3D","SCALING","AFFINE"]);Ui.Types=Gi,Ui.IDENTITY=(new Ui).makeImmutable();const Wi=Ui;function Qi(t){return t.toFixed(20)}fe.register("toSVGNumber",Qi);const Ji=Qi;class Ki extends B{}_defineProperty(Ki,"OTHER",new Ki),_defineProperty(Ki,"IDENTITY",new Ki),_defineProperty(Ki,"TRANSLATION_2D",new Ki),_defineProperty(Ki,"SCALING",new Ki),_defineProperty(Ki,"AFFINE",new Ki),_defineProperty(Ki,"enumeration",new $(Ki));class ts{constructor(){this.entries=[1,0,0,0,1,0,0,0,1],this.type=Ki.IDENTITY}m00(){return this.entries[0]}m01(){return this.entries[3]}m02(){return this.entries[6]}m10(){return this.entries[1]}m11(){return this.entries[4]}m12(){return this.entries[7]}m20(){return this.entries[2]}m21(){return this.entries[5]}m22(){return this.entries[8]}isIdentity(){return this.type===Ki.IDENTITY||this.equals(ts.IDENTITY)}isFastIdentity(){return this.type===Ki.IDENTITY}isTranslation(){return this.type===Ki.TRANSLATION_2D||1===this.m00()&&1===this.m11()&&1===this.m22()&&0===this.m01()&&0===this.m10()&&0===this.m20()&&0===this.m21()}isAffine(){return this.type===Ki.AFFINE||0===this.m20()&&0===this.m21()&&1===this.m22()}isAligned(){return this.isAffine()&&0===this.m01()&&0===this.m10()}isAxisAligned(){return this.isAffine()&&(0===this.m01()&&0===this.m10()||0===this.m00()&&0===this.m11())}isFinite(){return isFinite(this.m00())&&isFinite(this.m01())&&isFinite(this.m02())&&isFinite(this.m10())&&isFinite(this.m11())&&isFinite(this.m12())&&isFinite(this.m20())&&isFinite(this.m21())&&isFinite(this.m22())}getDeterminant(){return this.m00()*this.m11()*this.m22()+this.m01()*this.m12()*this.m20()+this.m02()*this.m10()*this.m21()-this.m02()*this.m11()*this.m20()-this.m01()*this.m10()*this.m22()-this.m00()*this.m12()*this.m21()}get determinant(){return this.getDeterminant()}getTranslation(){return new Ge(this.m02(),this.m12())}get translation(){return this.getTranslation()}getScaleVector(){return new Ge(Math.sqrt(this.m00()*this.m00()+this.m10()*this.m10()),Math.sqrt(this.m01()*this.m01()+this.m11()*this.m11()))}get scaleVector(){return this.getScaleVector()}getRotation(){return Math.atan2(this.m10(),this.m00())}get rotation(){return this.getRotation()}toMatrix4(){return new Wi(this.m00(),this.m01(),this.m02(),0,this.m10(),this.m11(),this.m12(),0,this.m20(),this.m21(),this.m22(),0,0,0,0,1)}toAffineMatrix4(){return new Wi(this.m00(),this.m01(),0,this.m02(),this.m10(),this.m11(),0,this.m12(),0,0,1,0,0,0,0,1)}toString(){return`${this.m00()} ${this.m01()} ${this.m02()}\n${this.m10()} ${this.m11()} ${this.m12()}\n${this.m20()} ${this.m21()} ${this.m22()}`}toSVGMatrix(){const t=document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGMatrix();return t.a=this.m00(),t.b=this.m10(),t.c=this.m01(),t.d=this.m11(),t.e=this.m02(),t.f=this.m12(),t}getCSSTransform(){return`matrix(${this.entries[0].toFixed(20)},${this.entries[1].toFixed(20)},${this.entries[3].toFixed(20)},${this.entries[4].toFixed(20)},${this.entries[6].toFixed(20)},${this.entries[7].toFixed(20)})`}get cssTransform(){return this.getCSSTransform()}getSVGTransform(){switch(this.type){case Ki.IDENTITY:return"";case Ki.TRANSLATION_2D:return`translate(${Ji(this.entries[6])},${Ji(this.entries[7])})`;case Ki.SCALING:return`scale(${Ji(this.entries[0])}${this.entries[0]===this.entries[4]?"":","+Ji(this.entries[4])})`;default:return`matrix(${Ji(this.entries[0])},${Ji(this.entries[1])},${Ji(this.entries[3])},${Ji(this.entries[4])},${Ji(this.entries[6])},${Ji(this.entries[7])})`}}get svgTransform(){return this.getSVGTransform()}getCSSTransformStyles(){const t=this.getCSSTransform();return{"-webkit-perspective":"1000","-webkit-backface-visibility":"hidden","-webkit-transform":t+" translateZ(0)","-moz-transform":t+" translateZ(0)","-ms-transform":t,"-o-transform":t,transform:t,"transform-origin":"top left","-ms-transform-origin":"top left"}}get cssTransformStyles(){return this.getCSSTransformStyles()}equals(t){return this.m00()===t.m00()&&this.m01()===t.m01()&&this.m02()===t.m02()&&this.m10()===t.m10()&&this.m11()===t.m11()&&this.m12()===t.m12()&&this.m20()===t.m20()&&this.m21()===t.m21()&&this.m22()===t.m22()}equalsEpsilon(t,e){return Math.abs(this.m00()-t.m00())<e&&Math.abs(this.m01()-t.m01())<e&&Math.abs(this.m02()-t.m02())<e&&Math.abs(this.m10()-t.m10())<e&&Math.abs(this.m11()-t.m11())<e&&Math.abs(this.m12()-t.m12())<e&&Math.abs(this.m20()-t.m20())<e&&Math.abs(this.m21()-t.m21())<e&&Math.abs(this.m22()-t.m22())<e}copy(){return es(this.m00(),this.m01(),this.m02(),this.m10(),this.m11(),this.m12(),this.m20(),this.m21(),this.m22(),this.type)}plus(t){return es(this.m00()+t.m00(),this.m01()+t.m01(),this.m02()+t.m02(),this.m10()+t.m10(),this.m11()+t.m11(),this.m12()+t.m12(),this.m20()+t.m20(),this.m21()+t.m21(),this.m22()+t.m22())}minus(t){return es(this.m00()-t.m00(),this.m01()-t.m01(),this.m02()-t.m02(),this.m10()-t.m10(),this.m11()-t.m11(),this.m12()-t.m12(),this.m20()-t.m20(),this.m21()-t.m21(),this.m22()-t.m22())}transposed(){return es(this.m00(),this.m10(),this.m20(),this.m01(),this.m11(),this.m21(),this.m02(),this.m12(),this.m22(),this.type===Ki.IDENTITY||this.type===Ki.SCALING?this.type:void 0)}negated(){return es(-this.m00(),-this.m01(),-this.m02(),-this.m10(),-this.m11(),-this.m12(),-this.m20(),-this.m21(),-this.m22())}inverted(){let t;switch(this.type){case Ki.IDENTITY:return this;case Ki.TRANSLATION_2D:return es(1,0,-this.m02(),0,1,-this.m12(),0,0,1,Ki.TRANSLATION_2D);case Ki.SCALING:return es(1/this.m00(),0,0,0,1/this.m11(),0,0,0,1/this.m22(),Ki.SCALING);case Ki.AFFINE:if(t=this.getDeterminant(),0!==t)return es((-this.m12()*this.m21()+this.m11()*this.m22())/t,(this.m02()*this.m21()-this.m01()*this.m22())/t,(-this.m02()*this.m11()+this.m01()*this.m12())/t,(this.m12()*this.m20()-this.m10()*this.m22())/t,(-this.m02()*this.m20()+this.m00()*this.m22())/t,(this.m02()*this.m10()-this.m00()*this.m12())/t,0,0,1,Ki.AFFINE);throw new Error("Matrix could not be inverted, determinant === 0");case Ki.OTHER:if(t=this.getDeterminant(),0!==t)return es((-this.m12()*this.m21()+this.m11()*this.m22())/t,(this.m02()*this.m21()-this.m01()*this.m22())/t,(-this.m02()*this.m11()+this.m01()*this.m12())/t,(this.m12()*this.m20()-this.m10()*this.m22())/t,(-this.m02()*this.m20()+this.m00()*this.m22())/t,(this.m02()*this.m10()-this.m00()*this.m12())/t,(-this.m11()*this.m20()+this.m10()*this.m21())/t,(this.m01()*this.m20()-this.m00()*this.m21())/t,(-this.m01()*this.m10()+this.m00()*this.m11())/t,Ki.OTHER);throw new Error("Matrix could not be inverted, determinant === 0");default:throw new Error("Matrix3.inverted with unknown type: "+this.type)}}timesMatrix(t){if(this.type===Ki.IDENTITY||t.type===Ki.IDENTITY)return this.type===Ki.IDENTITY?t:this;if(this.type===t.type){if(this.type===Ki.TRANSLATION_2D)return es(1,0,this.m02()+t.m02(),0,1,this.m12()+t.m12(),0,0,1,Ki.TRANSLATION_2D);if(this.type===Ki.SCALING)return es(this.m00()*t.m00(),0,0,0,this.m11()*t.m11(),0,0,0,1,Ki.SCALING)}return this.type!==Ki.OTHER&&t.type!==Ki.OTHER?es(this.m00()*t.m00()+this.m01()*t.m10(),this.m00()*t.m01()+this.m01()*t.m11(),this.m00()*t.m02()+this.m01()*t.m12()+this.m02(),this.m10()*t.m00()+this.m11()*t.m10(),this.m10()*t.m01()+this.m11()*t.m11(),this.m10()*t.m02()+this.m11()*t.m12()+this.m12(),0,0,1,Ki.AFFINE):es(this.m00()*t.m00()+this.m01()*t.m10()+this.m02()*t.m20(),this.m00()*t.m01()+this.m01()*t.m11()+this.m02()*t.m21(),this.m00()*t.m02()+this.m01()*t.m12()+this.m02()*t.m22(),this.m10()*t.m00()+this.m11()*t.m10()+this.m12()*t.m20(),this.m10()*t.m01()+this.m11()*t.m11()+this.m12()*t.m21(),this.m10()*t.m02()+this.m11()*t.m12()+this.m12()*t.m22(),this.m20()*t.m00()+this.m21()*t.m10()+this.m22()*t.m20(),this.m20()*t.m01()+this.m21()*t.m11()+this.m22()*t.m21(),this.m20()*t.m02()+this.m21()*t.m12()+this.m22()*t.m22())}timesVector2(t){const e=this.m00()*t.x+this.m01()*t.y+this.m02(),i=this.m10()*t.x+this.m11()*t.y+this.m12();return new Ge(e,i)}timesVector3(t){const e=this.m00()*t.x+this.m01()*t.y+this.m02()*t.z,i=this.m10()*t.x+this.m11()*t.y+this.m12()*t.z,s=this.m20()*t.x+this.m21()*t.y+this.m22()*t.z;return new je(e,i,s)}timesTransposeVector2(t){const e=this.m00()*t.x+this.m10()*t.y,i=this.m01()*t.x+this.m11()*t.y;return new Ge(e,i)}timesRelativeVector2(t){const e=this.m00()*t.x+this.m01()*t.y,i=this.m10()*t.y+this.m11()*t.y;return new Ge(e,i)}rowMajor(t,e,i,s,n,r,a,h,o,l){return this.entries[0]=t,this.entries[1]=s,this.entries[2]=a,this.entries[3]=e,this.entries[4]=n,this.entries[5]=h,this.entries[6]=i,this.entries[7]=r,this.entries[8]=o,this.type=void 0===l?0===a&&0===h&&1===o?Ki.AFFINE:Ki.OTHER:l,this}set(t){return this.rowMajor(t.m00(),t.m01(),t.m02(),t.m10(),t.m11(),t.m12(),t.m20(),t.m21(),t.m22(),t.type)}setArray(t){return this.rowMajor(t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8])}set00(t){return this.entries[0]=t,this}set01(t){return this.entries[3]=t,this}set02(t){return this.entries[6]=t,this}set10(t){return this.entries[1]=t,this}set11(t){return this.entries[4]=t,this}set12(t){return this.entries[7]=t,this}set20(t){return this.entries[2]=t,this}set21(t){return this.entries[5]=t,this}set22(t){return this.entries[8]=t,this}makeImmutable(){return this}columnMajor(t,e,i,s,n,r,a,h,o,l){return this.rowMajor(t,s,a,e,n,h,i,r,o,l)}add(t){return this.rowMajor(this.m00()+t.m00(),this.m01()+t.m01(),this.m02()+t.m02(),this.m10()+t.m10(),this.m11()+t.m11(),this.m12()+t.m12(),this.m20()+t.m20(),this.m21()+t.m21(),this.m22()+t.m22())}subtract(t){return this.rowMajor(this.m00()-t.m00(),this.m01()-t.m01(),this.m02()-t.m02(),this.m10()-t.m10(),this.m11()-t.m11(),this.m12()-t.m12(),this.m20()-t.m20(),this.m21()-t.m21(),this.m22()-t.m22())}transpose(){return this.rowMajor(this.m00(),this.m10(),this.m20(),this.m01(),this.m11(),this.m21(),this.m02(),this.m12(),this.m22(),this.type===Ki.IDENTITY||this.type===Ki.SCALING?this.type:void 0)}negate(){return this.rowMajor(-this.m00(),-this.m01(),-this.m02(),-this.m10(),-this.m11(),-this.m12(),-this.m20(),-this.m21(),-this.m22())}invert(){let t;switch(this.type){case Ki.IDENTITY:return this;case Ki.TRANSLATION_2D:return this.rowMajor(1,0,-this.m02(),0,1,-this.m12(),0,0,1,Ki.TRANSLATION_2D);case Ki.SCALING:return this.rowMajor(1/this.m00(),0,0,0,1/this.m11(),0,0,0,1/this.m22(),Ki.SCALING);case Ki.AFFINE:if(t=this.getDeterminant(),0!==t)return this.rowMajor((-this.m12()*this.m21()+this.m11()*this.m22())/t,(this.m02()*this.m21()-this.m01()*this.m22())/t,(-this.m02()*this.m11()+this.m01()*this.m12())/t,(this.m12()*this.m20()-this.m10()*this.m22())/t,(-this.m02()*this.m20()+this.m00()*this.m22())/t,(this.m02()*this.m10()-this.m00()*this.m12())/t,0,0,1,Ki.AFFINE);throw new Error("Matrix could not be inverted, determinant === 0");case Ki.OTHER:if(t=this.getDeterminant(),0!==t)return this.rowMajor((-this.m12()*this.m21()+this.m11()*this.m22())/t,(this.m02()*this.m21()-this.m01()*this.m22())/t,(-this.m02()*this.m11()+this.m01()*this.m12())/t,(this.m12()*this.m20()-this.m10()*this.m22())/t,(-this.m02()*this.m20()+this.m00()*this.m22())/t,(this.m02()*this.m10()-this.m00()*this.m12())/t,(-this.m11()*this.m20()+this.m10()*this.m21())/t,(this.m01()*this.m20()-this.m00()*this.m21())/t,(-this.m01()*this.m10()+this.m00()*this.m11())/t,Ki.OTHER);throw new Error("Matrix could not be inverted, determinant === 0");default:throw new Error("Matrix3.inverted with unknown type: "+this.type)}}multiplyMatrix(t){if(t.type===Ki.IDENTITY)return this;if(this.type===Ki.IDENTITY)return this.set(t);if(this.type===t.type){if(this.type===Ki.TRANSLATION_2D)return this.rowMajor(1,0,this.m02()+t.m02(),0,1,this.m12()+t.m12(),0,0,1,Ki.TRANSLATION_2D);if(this.type===Ki.SCALING)return this.rowMajor(this.m00()*t.m00(),0,0,0,this.m11()*t.m11(),0,0,0,1,Ki.SCALING)}return this.type!==Ki.OTHER&&t.type!==Ki.OTHER?this.rowMajor(this.m00()*t.m00()+this.m01()*t.m10(),this.m00()*t.m01()+this.m01()*t.m11(),this.m00()*t.m02()+this.m01()*t.m12()+this.m02(),this.m10()*t.m00()+this.m11()*t.m10(),this.m10()*t.m01()+this.m11()*t.m11(),this.m10()*t.m02()+this.m11()*t.m12()+this.m12(),0,0,1,Ki.AFFINE):this.rowMajor(this.m00()*t.m00()+this.m01()*t.m10()+this.m02()*t.m20(),this.m00()*t.m01()+this.m01()*t.m11()+this.m02()*t.m21(),this.m00()*t.m02()+this.m01()*t.m12()+this.m02()*t.m22(),this.m10()*t.m00()+this.m11()*t.m10()+this.m12()*t.m20(),this.m10()*t.m01()+this.m11()*t.m11()+this.m12()*t.m21(),this.m10()*t.m02()+this.m11()*t.m12()+this.m12()*t.m22(),this.m20()*t.m00()+this.m21()*t.m10()+this.m22()*t.m20(),this.m20()*t.m01()+this.m21()*t.m11()+this.m22()*t.m21(),this.m20()*t.m02()+this.m21()*t.m12()+this.m22()*t.m22())}prependTranslation(t,e){return this.set02(this.m02()+t),this.set12(this.m12()+e),this.type===Ki.IDENTITY||this.type===Ki.TRANSLATION_2D?this.type=Ki.TRANSLATION_2D:this.type===Ki.OTHER?this.type=Ki.OTHER:this.type=Ki.AFFINE,this}setToIdentity(){return this.rowMajor(1,0,0,0,1,0,0,0,1,Ki.IDENTITY)}setToTranslation(t,e){return this.rowMajor(1,0,t,0,1,e,0,0,1,Ki.TRANSLATION_2D)}setToScale(t,e){return e=void 0===e?t:e,this.rowMajor(t,0,0,0,e,0,0,0,1,Ki.SCALING)}setToAffine(t,e,i,s,n,r){return this.rowMajor(t,e,i,s,n,r,0,0,1,Ki.AFFINE)}setToRotationAxisAngle(t,e){let i=Math.cos(e),s=Math.sin(e);Math.abs(i)<1e-15&&(i=0),Math.abs(s)<1e-15&&(s=0);const n=1-i;return this.rowMajor(t.x*t.x*n+i,t.x*t.y*n-t.z*s,t.x*t.z*n+t.y*s,t.y*t.x*n+t.z*s,t.y*t.y*n+i,t.y*t.z*n-t.x*s,t.z*t.x*n-t.y*s,t.z*t.y*n+t.x*s,t.z*t.z*n+i,Ki.OTHER)}setToRotationX(t){let e=Math.cos(t),i=Math.sin(t);return Math.abs(e)<1e-15&&(e=0),Math.abs(i)<1e-15&&(i=0),this.rowMajor(1,0,0,0,e,-i,0,i,e,Ki.OTHER)}setToRotationY(t){let e=Math.cos(t),i=Math.sin(t);return Math.abs(e)<1e-15&&(e=0),Math.abs(i)<1e-15&&(i=0),this.rowMajor(e,0,i,0,1,0,-i,0,e,Ki.OTHER)}setToRotationZ(t){let e=Math.cos(t),i=Math.sin(t);return Math.abs(e)<1e-15&&(e=0),Math.abs(i)<1e-15&&(i=0),this.rowMajor(e,-i,0,i,e,0,0,0,1,Ki.AFFINE)}setToTranslationRotation(t,e,i){let s=Math.cos(i),n=Math.sin(i);return Math.abs(s)<1e-15&&(s=0),Math.abs(n)<1e-15&&(n=0),this.rowMajor(s,-n,t,n,s,e,0,0,1,Ki.AFFINE)}setToTranslationRotationPoint(t,e){return this.setToTranslationRotation(t.x,t.y,e)}setToSVGMatrix(t){return this.rowMajor(t.a,t.c,t.e,t.b,t.d,t.f,0,0,1,Ki.AFFINE)}setRotationAToB(t,e){const i=t,s=e;let n=i.cross(s);const r=i.dot(s);if((r<0?-r:r)>.9999){let t=new je(i.x>0?i.x:-i.x,i.y>0?i.y:-i.y,i.z>0?i.z:-i.z);t=t.x<t.y?t.x<t.z?je.X_UNIT:je.Z_UNIT:t.y<t.z?je.Y_UNIT:je.Z_UNIT;const e=t.minus(i);n=t.minus(s);const r=2/e.dot(e),a=2/n.dot(n),h=r*a*e.dot(n);return this.rowMajor(-r*e.x*e.x-a*n.x*n.x+h*n.x*e.x+1,-r*e.x*e.y-a*n.x*n.y+h*n.x*e.y,-r*e.x*e.z-a*n.x*n.z+h*n.x*e.z,-r*e.y*e.x-a*n.y*n.x+h*n.y*e.x,-r*e.y*e.y-a*n.y*n.y+h*n.y*e.y+1,-r*e.y*e.z-a*n.y*n.z+h*n.y*e.z,-r*e.z*e.x-a*n.z*n.x+h*n.z*e.x,-r*e.z*e.y-a*n.z*n.y+h*n.z*e.y,-r*e.z*e.z-a*n.z*n.z+h*n.z*e.z+1)}{const t=1/(1+r),e=t*n.x,i=t*n.z,s=e*n.y,a=e*n.z,h=i*n.y;return this.rowMajor(r+e*n.x,s-n.z,a+n.y,s+n.z,r+t*n.y*n.y,h-n.x,a-n.y,h+n.x,r+i*n.z)}}multiplyVector2(t){return t.setXY(this.m00()*t.x+this.m01()*t.y+this.m02(),this.m10()*t.x+this.m11()*t.y+this.m12())}multiplyVector3(t){return t.setXYZ(this.m00()*t.x+this.m01()*t.y+this.m02()*t.z,this.m10()*t.x+this.m11()*t.y+this.m12()*t.z,this.m20()*t.x+this.m21()*t.y+this.m22()*t.z)}multiplyTransposeVector2(t){return t.setXY(this.m00()*t.x+this.m10()*t.y,this.m01()*t.x+this.m11()*t.y)}multiplyRelativeVector2(t){return t.setXY(this.m00()*t.x+this.m01()*t.y,this.m10()*t.y+this.m11()*t.y)}canvasSetTransform(t){t.setTransform(this.entries[0],this.entries[1],this.entries[3],this.entries[4],this.entries[6],this.entries[7])}canvasAppendTransform(t){this.type!==Ki.IDENTITY&&t.transform(this.entries[0],this.entries[1],this.entries[3],this.entries[4],this.entries[6],this.entries[7])}copyToArray(t){return t[0]=this.m00(),t[1]=this.m10(),t[2]=this.m20(),t[3]=this.m01(),t[4]=this.m11(),t[5]=this.m21(),t[6]=this.m02(),t[7]=this.m12(),t[8]=this.m22(),t}freeToPool(){ts.pool.freeToPool(this)}static identity(){return is().setToIdentity()}static translation(t,e){return is().setToTranslation(t,e)}static translationFromVector(t){return ts.translation(t.x,t.y)}static scaling(t,e){return is().setToScale(t,e)}static scale(t,e){return ts.scaling(t,e)}static affine(t,e,i,s,n,r){return is().setToAffine(t,e,i,s,n,r)}static rowMajor(t,e,i,s,n,r,a,h,o,l){return is().rowMajor(t,e,i,s,n,r,a,h,o,l)}static rotationAxisAngle(t,e){return is().setToRotationAxisAngle(t,e)}static rotationX(t){return is().setToRotationX(t)}static rotationY(t){return is().setToRotationY(t)}static rotationZ(t){return is().setToRotationZ(t)}static translationRotation(t,e,i){return is().setToTranslationRotation(t,e,i)}static rotation2(t){return is().setToRotationZ(t)}static rotationAround(t,e,i){return ts.translation(e,i).timesMatrix(ts.rotation2(t)).timesMatrix(ts.translation(-e,-i))}static rotationAroundPoint(t,e){return ts.rotationAround(t,e.x,e.y)}static fromSVGMatrix(t){return is().setToSVGMatrix(t)}static rotateAToB(t,e){return is().setRotationAToB(t,e)}static translationTimesMatrix(t,e,i){let s;return i.type===Ki.IDENTITY||i.type===Ki.TRANSLATION_2D?es(1,0,i.m02()+t,0,1,i.m12()+e,0,0,1,Ki.TRANSLATION_2D):(s=i.type===Ki.OTHER?Ki.OTHER:Ki.AFFINE,es(i.m00(),i.m01(),i.m02()+t,i.m10(),i.m11(),i.m12()+e,i.m20(),i.m21(),i.m22(),s))}static toStateObject(t){return{entries:t.entries,type:t.type.name}}static fromStateObject(t){const e=ts.identity();return e.entries=t.entries,e.type=Ki.enumeration.getValue(t.type),e}}_defineProperty(ts,"pool",new ze(ts,{initialize:ts.prototype.rowMajor,useDefaultConstruction:!0,maxSize:300})),fe.register("Matrix3",ts);const es=ts.pool.create.bind(ts.pool);fe.register("m3",es);const is=ts.pool.fetch.bind(ts.pool);ts.IDENTITY=ts.identity().makeImmutable(),ts.X_REFLECTION=es(-1,0,0,0,1,0,0,0,1,Ki.AFFINE).makeImmutable(),ts.Y_REFLECTION=es(1,0,0,0,-1,0,0,0,1,Ki.AFFINE).makeImmutable(),ts.Matrix3IO=new C("Matrix3IO",{valueType:ts,documentation:"A 3x3 matrix often used for holding transform data.",toStateObject:t=>ts.toStateObject(t),fromStateObject:ts.fromStateObject,stateSchema:{entries:Nt(we),type:Q(Ki)}});const ss=Math.sqrt(.5),ns={Array:fe.FastArray,index3:(t,e)=>3*t+e,set3(t,e){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8]},transpose3(t,e){const i=t[3],s=t[6],n=t[1],r=t[7],a=t[2],h=t[5];e[0]=t[0],e[1]=i,e[2]=s,e[3]=n,e[4]=t[4],e[5]=r,e[6]=a,e[7]=h,e[8]=t[8]},det3:t=>t[0]*t[4]*t[8]+t[1]*t[5]*t[6]+t[2]*t[3]*t[7]-t[2]*t[4]*t[6]-t[1]*t[3]*t[8]-t[0]*t[5]*t[7],mult3(t,e,i){const s=t[0]*e[0]+t[1]*e[3]+t[2]*e[6],n=t[0]*e[1]+t[1]*e[4]+t[2]*e[7],r=t[0]*e[2]+t[1]*e[5]+t[2]*e[8],a=t[3]*e[0]+t[4]*e[3]+t[5]*e[6],h=t[3]*e[1]+t[4]*e[4]+t[5]*e[7],o=t[3]*e[2]+t[4]*e[5]+t[5]*e[8],l=t[6]*e[0]+t[7]*e[3]+t[8]*e[6],u=t[6]*e[1]+t[7]*e[4]+t[8]*e[7],m=t[6]*e[2]+t[7]*e[5]+t[8]*e[8];i[0]=s,i[1]=n,i[2]=r,i[3]=a,i[4]=h,i[5]=o,i[6]=l,i[7]=u,i[8]=m},mult3LeftTranspose(t,e,i){const s=t[0]*e[0]+t[3]*e[3]+t[6]*e[6],n=t[0]*e[1]+t[3]*e[4]+t[6]*e[7],r=t[0]*e[2]+t[3]*e[5]+t[6]*e[8],a=t[1]*e[0]+t[4]*e[3]+t[7]*e[6],h=t[1]*e[1]+t[4]*e[4]+t[7]*e[7],o=t[1]*e[2]+t[4]*e[5]+t[7]*e[8],l=t[2]*e[0]+t[5]*e[3]+t[8]*e[6],u=t[2]*e[1]+t[5]*e[4]+t[8]*e[7],m=t[2]*e[2]+t[5]*e[5]+t[8]*e[8];i[0]=s,i[1]=n,i[2]=r,i[3]=a,i[4]=h,i[5]=o,i[6]=l,i[7]=u,i[8]=m},mult3RightTranspose(t,e,i){const s=t[0]*e[0]+t[1]*e[1]+t[2]*e[2],n=t[0]*e[3]+t[1]*e[4]+t[2]*e[5],r=t[0]*e[6]+t[1]*e[7]+t[2]*e[8],a=t[3]*e[0]+t[4]*e[1]+t[5]*e[2],h=t[3]*e[3]+t[4]*e[4]+t[5]*e[5],o=t[3]*e[6]+t[4]*e[7]+t[5]*e[8],l=t[6]*e[0]+t[7]*e[1]+t[8]*e[2],u=t[6]*e[3]+t[7]*e[4]+t[8]*e[5],m=t[6]*e[6]+t[7]*e[7]+t[8]*e[8];i[0]=s,i[1]=n,i[2]=r,i[3]=a,i[4]=h,i[5]=o,i[6]=l,i[7]=u,i[8]=m},mult3BothTranspose(t,e,i){const s=t[0]*e[0]+t[3]*e[1]+t[6]*e[2],n=t[0]*e[3]+t[3]*e[4]+t[6]*e[5],r=t[0]*e[6]+t[3]*e[7]+t[6]*e[8],a=t[1]*e[0]+t[4]*e[1]+t[7]*e[2],h=t[1]*e[3]+t[4]*e[4]+t[7]*e[5],o=t[1]*e[6]+t[4]*e[7]+t[7]*e[8],l=t[2]*e[0]+t[5]*e[1]+t[8]*e[2],u=t[2]*e[3]+t[5]*e[4]+t[8]*e[5],m=t[2]*e[6]+t[5]*e[7]+t[8]*e[8];i[0]=s,i[1]=n,i[2]=r,i[3]=a,i[4]=h,i[5]=o,i[6]=l,i[7]=u,i[8]=m},mult3Vector3(t,e,i){const s=t[0]*e.x+t[1]*e.y+t[2]*e.z,n=t[3]*e.x+t[4]*e.y+t[5]*e.z,r=t[6]*e.x+t[7]*e.y+t[8]*e.z;i.x=s,i.y=n,i.z=r},swapNegateColumn(t,e,i){const s=t[e],n=t[e+3],r=t[e+6];t[e]=t[i],t[e+3]=t[i+3],t[e+6]=t[i+6],t[i]=-s,t[i+3]=-n,t[i+6]=-r},setIdentity3(t){t[0]=t[4]=t[8]=1,t[1]=t[2]=t[3]=t[5]=t[6]=t[7]=0},setGivens3(t,e,i,s,n){this.setIdentity3(t),t[this.index3(s,s)]=e,t[this.index3(n,n)]=e,t[this.index3(s,n)]=i,t[this.index3(n,s)]=-i},preMult3Givens(t,e,i,s,n){const r=3*s,a=3*n,h=e*t[r+0]+i*t[a+0],o=e*t[a+0]-i*t[r+0],l=e*t[r+1]+i*t[a+1],u=e*t[a+1]-i*t[r+1],m=e*t[r+2]+i*t[a+2],d=e*t[a+2]-i*t[r+2];t[r+0]=h,t[a+0]=o,t[r+1]=l,t[a+1]=u,t[r+2]=m,t[a+2]=d},postMult3Givens(t,e,i,s,n){const r=e*t[s+0]+i*t[n+0],a=e*t[n+0]-i*t[s+0],h=e*t[s+3]+i*t[n+3],o=e*t[n+3]-i*t[s+3],l=e*t[s+6]+i*t[n+6],u=e*t[n+6]-i*t[s+6];t[s+0]=r,t[n+0]=a,t[s+3]=h,t[n+3]=o,t[s+6]=l,t[n+6]=u},applyJacobi3(t,e,i,s){const n=t[3*i+i],r=t[3*i+s],a=t[3*s+s],h=r*r;let o=n-a;o*=o;const l=h<o,u=1/Math.sqrt(h+o),m=l?u*(n-a):ss,d=l?u*r:ss;this.preMult3Givens(t,m,d,i,s),this.postMult3Givens(t,m,d,i,s),this.preMult3Givens(e,m,d,i,s)},jacobiIteration3(t,e,i){for(let s=0;s<i;s++)this.applyJacobi3(t,e,0,1),this.applyJacobi3(t,e,0,2),this.applyJacobi3(t,e,1,2)},qrAnnihilate3(t,e,i,s){let n,r;const a=e[this.index3(s,s)],h=e[this.index3(i,s)],o=a*a,l=h*h;if(o+l<1e-10)n=a>0?1:0,r=0;else{const t=1/Math.sqrt(o+l);n=t*a,r=t*h}this.preMult3Givens(e,n,r,s,i),this.postMult3Givens(t,n,r,s,i)},svd3(t,e,i,s,n){const r=i,a=n,h=s;this.mult3LeftTranspose(t,t,h),this.setIdentity3(r),this.jacobiIteration3(h,r,e),this.transpose3(r,a),this.mult3(t,a,h);let o,l=h[0]*h[0]+h[3]*h[3]+h[6]*h[6],u=h[1]*h[1]+h[4]*h[4]+h[7]*h[7],m=h[2]*h[2]+h[5]*h[5]+h[8]*h[8];l<u&&(o=l,l=u,u=o,this.swapNegateColumn(h,0,1),this.swapNegateColumn(a,0,1)),l<m&&(o=l,l=m,m=o,this.swapNegateColumn(h,0,2),this.swapNegateColumn(a,0,2)),u<m&&(this.swapNegateColumn(h,1,2),this.swapNegateColumn(a,1,2)),this.setIdentity3(r),this.qrAnnihilate3(r,h,1,0),this.qrAnnihilate3(r,h,2,0),this.qrAnnihilate3(r,h,2,1);r[0]*r[0]+r[1]*r[1]+r[2]*r[2]<.001&&(r[0]=1),r[3]*r[3]+r[4]*r[4]+r[5]*r[5]<.001&&(r[4]=1),r[6]*r[6]+r[7]*r[7]+r[8]*r[8]<.001&&(r[8]=1)},setVectors3(t,e){const i=t.length;for(let s=0;s<i;s++){const n=t[s];e[s]=n.x,e[s+i]=n.y,e[s+2*i]=n.z}},getColumnVector3(t,e,i,s,n){n.x=i[s],n.y=i[s+e],n.z=i[s+2*e]},index:(t,e,i,s)=>e*i+s,transpose(t,e,i,s){for(let n=0;n<t;n++)for(let r=0;r<e;r++)s[t*r+n]=i[e*n+r]},mult(t,e,i,s,n,r){for(let a=0;a<t;a++)for(let h=0;h<i;h++){let o=0;for(let r=0;r<e;r++)o+=s[this.index(t,e,a,r)]*n[this.index(e,i,r,h)];r[this.index(t,i,a,h)]=o}},multRightTranspose(t,e,i,s,n,r){for(let a=0;a<t;a++)for(let h=0;h<i;h++){let o=0;for(let r=0;r<e;r++)o+=s[this.index(t,e,a,r)]*n[this.index(i,e,h,r)];r[this.index(t,i,a,h)]=o}},permuteColumns(t,e,i,s,n){for(let r=0;r<e;r++){const a=s.indices[r];for(let s=0;s<t;s++)n[this.index(t,e,s,r)]=i[this.index(t,e,s,a)]}}};fe.register("MatrixOps3",ns);class rs{constructor(t){this.indices=t}size(){return this.indices.length}apply(t){if("number"==typeof t)return this.indices[t];{if(t.length!==this.size())throw new Error(`Permutation length ${this.size()} not equal to list length ${t.length}`);const e=new Array(t.length);for(let i=0;i<t.length;i++)e[i]=t[this.indices[i]];return e}}inverted(){const t=new Array(this.size());for(let e=0;e<this.size();e++)t[this.indices[e]]=e;return new rs(t)}withIndicesPermuted(t){const e=[];return rs.forEachPermutation(t,i=>{const s=this.indices,n=s.slice(0);for(let e=0;e<t.length;e++)n[t[e]]=s[i[e]];e.push(new rs(n))}),e}toString(){return`P[${this.indices.join(", ")}]`}equals(t){return this.indices.length===t.indices.length&&_.isEqual(this.indices,t.indices)}static identity(t){const e=new Array(t);for(let i=0;i<t;i++)e[i]=i;return new rs(e)}static permutations(t){const e=[];return rs.forEachPermutation(ni.rangeInclusive(0,t-1),t=>{e.push(new rs(t.slice()))}),e}static forEachPermutation(t,e){!function t(e,i,s){if(0===e.length)s(i);else for(let n=0;n<e.length;n++){const r=e[n],a=e.slice(0);a.splice(n,1);const h=i.slice(0);h.push(r),t(a,h,s)}}(t,[],e)}static permutationsOf(t){const e=[];return rs.forEachPermutation(t,t=>{e.push(t.slice())}),e}}fe.register("Permutation",rs);class as{constructor(t,e){this.normal=t,this.distance=e}intersectWithRay(t){return t.pointAtDistance(t.distanceToPlane(this))}static fromTriangle(t,e,i){const s=i.minus(t).cross(e.minus(t));return 0===s.magnitude?null:(s.normalize(),new as(s,s.dot(t)))}}_defineProperty(as,"XY",new as(new je(0,0,1),0)),_defineProperty(as,"XZ",new as(new je(0,1,0),0)),_defineProperty(as,"YZ",new as(new je(1,0,0),0)),fe.register("Plane3",as);class hs{constructor(t,e,i,s){this.setXYZW(t,e,i,s)}setXYZW(t,e,i,s){this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.z=void 0!==i?i:0,this.w=void 0!==s?s:1}plus(t){return new hs(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)}timesScalar(t){return new hs(this.x*t,this.y*t,this.z*t,this.w*t)}timesQuaternion(t){return new hs(this.x*t.w-this.z*t.y+this.y*t.z+this.w*t.x,-this.x*t.z+this.y*t.w+this.z*t.x+this.w*t.y,this.x*t.y-this.y*t.x+this.z*t.w+this.w*t.z,-this.x*t.x-this.y*t.y-this.z*t.z+this.w*t.w)}timesVector3(t){return 0===t.magnitude?new je(0,0,0):new je(this.w*this.w*t.x+2*this.y*this.w*t.z-2*this.z*this.w*t.y+this.x*this.x*t.x+2*this.y*this.x*t.y+2*this.z*this.x*t.z-this.z*this.z*t.x-this.y*this.y*t.x,2*this.x*this.y*t.x+this.y*this.y*t.y+2*this.z*this.y*t.z+2*this.w*this.z*t.x-this.z*this.z*t.y+this.w*this.w*t.y-2*this.x*this.w*t.z-this.x*this.x*t.y,2*this.x*this.z*t.x+2*this.y*this.z*t.y+this.z*this.z*t.z-2*this.w*this.y*t.x-this.y*this.y*t.z+2*this.w*this.x*t.y-this.x*this.x*t.z+this.w*this.w*t.z)}getMagnitude(){return Math.sqrt(this.magnitudeSquared)}get magnitude(){return this.getMagnitude()}getMagnitudeSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}get magnitudeSquared(){return this.getMagnitudeSquared()}normalized(){const t=this.magnitude;return this.timesScalar(1/t)}negated(){return new hs(-this.x,-this.y,-this.z,-this.w)}toRotationMatrix(){const t=this.magnitudeSquared,e=1===t?2:t>0?2/t:0,i=this.x*this.x*e,s=this.x*this.y*e,n=this.x*this.z*e,r=this.w*this.x*e,a=this.y*this.y*e,h=this.y*this.z*e,o=this.w*this.y*e,l=this.z*this.z*e,u=this.w*this.z*e;return ts.pool.fetch().columnMajor(1-(a+l),s+u,n-o,s-u,1-(i+l),h+r,n+o,h-r,1-(i+a))}static fromEulerAngles(t,e,i){const s=Math.sin(.5*i),n=Math.cos(.5*i),r=Math.sin(.5*e),a=Math.cos(.5*e),h=Math.sin(.5*t),o=Math.cos(.5*t),l=a*n,u=r*s,m=a*s,d=r*n;return new hs(l*h+u*o,d*o+m*h,m*o-d*h,l*o-u*h)}static fromRotationMatrix(t){const e=t.m00(),i=t.m01(),s=t.m02(),n=t.m10(),r=t.m11(),a=t.m12(),h=t.m20(),o=t.m21(),l=t.m22(),u=e+r+l;let m;return u>=0?(m=Math.sqrt(u+1),new hs(.5*(o-a)/m,.5*(s-h)/m,.5*(n-i)/m,.5*m)):e>r&&e>l?(m=Math.sqrt(1+e-r-l),new hs(.5*m,.5*(n+i)/m,.5*(s+h)/m,.5*(o-a)/m)):r>l?(m=Math.sqrt(1+r-e-l),new hs(.5*(n+i)/m,.5*m,.5*(o+a)/m,.5*(s-h)/m)):(m=Math.sqrt(1+l-e-r),new hs(.5*(s+h)/m,.5*(o+a)/m,.5*m,.5*(n-i)/m))}static getRotationQuaternion(t,e){return hs.fromRotationMatrix(ts.rotateAToB(t,e))}static slerp(t,e,i){if(t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w)return t;let s=t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w;s<0&&(e=e.negated(),s=-s);let n=1-i,r=i;if(1-s>.1){const t=Math.acos(s),e=1/Math.sin(t);n=Math.sin((1-i)*t)*e,r=Math.sin(i*t)*e}return new hs(n*t.x+r*e.x,n*t.y+r*e.y,n*t.z+r*e.z,n*t.w+r*e.w)}}hs.prototype.isQuaternion=!0,fe.register("Quaternion",hs),yi.mixInto(hs,{initialize:hs.prototype.setXYZW});class os{constructor(t){t=m({seed:null},t),this.seed=null,this.seedrandom=null,this.setSeed(t.seed),this.numberOfCalls=0,os.allRandomInstances.add(this)}dispose(){os.allRandomInstances.delete(this)}getSeed(){return this.seed}nextBoolean(){return this.nextDouble()>=.5}nextInt(t){const e=this.nextDouble()*t;return Math.floor(e)}nextIntBetween(t,e){const i=e-t;return this.nextInt(i+1)+t}sample(t){return t[this.nextIntBetween(0,t.length-1)]}shuffle(t){let e=-1;const i=new Array(t.length);return _.forEach(t,t=>{const s=this.nextIntBetween(0,++e);i[e]=i[s],i[s]=t}),i}nextDouble(){return this.numberOfCalls++,this.seedrandom()}nextDoubleBetween(t,e){const i=t+this.nextDouble()*(e-t);return i}nextGaussian(){return ni.boxMullerTransform(0,1,this)}nextDoubleInRange(t){return t.min<t.max?this.nextDoubleBetween(t.min,t.max):t.min}setSeed(t){"number"==typeof t||(t=Math.random()),this.seed=t,this.seedrandom=Math.seedrandom?new Math.seedrandom(""+t):()=>Math.random()}sampleProbabilities(t){const e=_.sum(t)*this.nextDouble();let i=0;for(let s=0;s<t.length;s++)if(i+=t[s],i>=e)return s;return t.length-1}}os.allRandomInstances=new Set,os.isNormalized=t=>{},fe.register("Random",os);class ls{constructor(t,e){this.position=t,this.direction=e}shifted(t){return new ls(this.pointAtDistance(t),this.direction)}pointAtDistance(t){return this.position.plus(this.direction.timesScalar(t))}toString(){return`${this.position.toString()} => ${this.direction.toString()}`}}fe.register("Ray2",ls);class us{constructor(t,e){this.position=t,this.direction=e}shifted(t){return new us(this.pointAtDistance(t),this.direction)}pointAtDistance(t){return this.position.plus(this.direction.timesScalar(t))}distanceToPlane(t){return(t.distance-this.position.dot(t.normal))/this.direction.dot(t.normal)}toString(){return`${this.position.toString()} => ${this.direction.toString()}`}}fe.register("Ray3",us);class ms extends ui{constructor(t,e,i,s){super(t,e,t+i,e+s)}}fe.register("Rectangle",ms);class ds{constructor(t,e){this.center=t,this.radius=e}intersect(t,e){const i=t.direction,s=t.position,n=s.minus(this.center),r=i.dot(n),a=4*r*r-4*(n.magnitudeSquared-this.radius*this.radius);if(a<e)return null;const h=i.dot(this.center)-i.dot(s),o=Math.sqrt(a)/2,l=h-o,u=h+o;if(u<e)return null;const m=t.pointAtDistance(u),d=m.minus(this.center).normalized();if(l<e)return{distance:u,hitPoint:m,normal:d.negated(),fromOutside:!1};{const e=t.pointAtDistance(l),i=e.minus(this.center).normalized();return{distance:l,hitPoint:e,normal:i,fromOutside:!0}}}intersections(t,e){const i=t.direction,s=t.position,n=s.minus(this.center),r=i.dot(n),a=4*r*r-4*(n.magnitudeSquared-this.radius*this.radius);if(a<e)return[];const h=i.dot(this.center)-i.dot(s),o=Math.sqrt(a)/2,l=h-o,u=h+o;if(u<e)return[];const m=t.pointAtDistance(u),d=m.minus(this.center).normalized(),c=t.pointAtDistance(l),p=c.minus(this.center).normalized(),g={distance:u,hitPoint:m,normal:d.negated(),fromOutside:!1},f={distance:l,hitPoint:c,normal:p,fromOutside:!0};return l<e?[g,f]:[f,g]}}fe.register("Sphere3",ds);const cs=new ts;class ps{constructor(t){this.matrix=ts.IDENTITY.copy(),this.inverse=ts.IDENTITY.copy(),this.matrixTransposed=ts.IDENTITY.copy(),this.inverseTransposed=ts.IDENTITY.copy(),this.inverseValid=!0,this.transposeValid=!0,this.inverseTransposeValid=!0,this.changeEmitter=new r,t&&this.setMatrix(t)}setMatrix(t){this.matrix.set(t),this.invalidate()}validateMatrix(t){}invalidate(){this.inverseValid=!1,this.transposeValid=!1,this.inverseTransposeValid=!1,this.changeEmitter.emit()}prepend(t){cs.set(this.matrix),this.matrix.set(t),this.matrix.multiplyMatrix(cs),this.invalidate()}prependTranslation(t,e){this.matrix.prependTranslation(t,e),this.invalidate()}append(t){this.matrix.multiplyMatrix(t),this.invalidate()}prependTransform(t){this.prepend(t.matrix)}appendTransform(t){this.append(t.matrix)}applyToCanvasContext(t){t.setTransform(this.matrix.m00(),this.matrix.m10(),this.matrix.m01(),this.matrix.m11(),this.matrix.m02(),this.matrix.m12())}copy(){const t=new ps(this.matrix);t.inverse=this.inverse,t.matrixTransposed=this.matrixTransposed,t.inverseTransposed=this.inverseTransposed,t.inverseValid=this.inverseValid,t.transposeValid=this.transposeValid,t.inverseTransposeValid=this.inverseTransposeValid}getMatrix(){return this.matrix}getInverse(){return this.inverseValid||(this.inverseValid=!0,this.inverse.set(this.matrix),this.inverse.invert()),this.inverse}getMatrixTransposed(){return this.transposeValid||(this.transposeValid=!0,this.matrixTransposed.set(this.matrix),this.matrixTransposed.transpose()),this.matrixTransposed}getInverseTransposed(){return this.inverseTransposeValid||(this.inverseTransposeValid=!0,this.inverseTransposed.set(this.getInverse()),this.inverseTransposed.transpose()),this.inverseTransposed}isIdentity(){return this.matrix.isFastIdentity()}isFinite(){return this.matrix.isFinite()}transformPosition2(t){return this.matrix.timesVector2(t)}transformDelta2(t){const e=this.getMatrix();return new Ge(e.m00()*t.x+e.m01()*t.y,e.m10()*t.x+e.m11()*t.y)}transformNormal2(t){return this.getInverse().timesTransposeVector2(t).normalize()}transformX(t){const e=this.getMatrix();return e.m00()*t+e.m02()}transformY(t){const e=this.getMatrix();return e.m11()*t+e.m12()}transformDeltaX(t){return this.getMatrix().m00()*t}transformDeltaY(t){return this.getMatrix().m11()*t}transformBounds2(t){return t.transformed(this.matrix)}transformShape(t){return t.transformed(this.matrix)}transformRay2(t){return new ls(this.transformPosition2(t.position),this.transformDelta2(t.direction).normalized())}inversePosition2(t){return this.getInverse().timesVector2(t)}inverseDelta2(t){const e=this.getInverse();return new Ge(e.m00()*t.x+e.m01()*t.y,e.m10()*t.x+e.m11()*t.y)}inverseNormal2(t){return this.matrix.timesTransposeVector2(t).normalize()}inverseX(t){const e=this.getInverse();return e.m00()*t+e.m02()}inverseY(t){const e=this.getInverse();return e.m11()*t+e.m12()}inverseDeltaX(t){const e=this.getInverse();return e.m00()*t}inverseDeltaY(t){const e=this.getInverse();return e.m11()*t}inverseBounds2(t){return t.transformed(this.getInverse())}inverseShape(t){return t.transformed(this.getInverse())}inverseRay2(t){return new ls(this.inversePosition2(t.position),this.inverseDelta2(t.direction).normalized())}}fe.register("Transform3",ps);const gs=ps,fs=new Wi;class ys{constructor(t){this.matrix=Wi.IDENTITY.copy(),this.inverse=Wi.IDENTITY.copy(),this.matrixTransposed=Wi.IDENTITY.copy(),this.inverseTransposed=Wi.IDENTITY.copy(),this.inverseValid=!0,this.transposeValid=!0,this.inverseTransposeValid=!0,this.changeEmitter=new r,t&&this.setMatrix(t)}setMatrix(t){this.matrix.set(t),this.invalidate()}invalidate(){this.inverseValid=!1,this.transposeValid=!1,this.inverseTransposeValid=!1,this.changeEmitter.emit()}prepend(t){fs.set(this.matrix),this.matrix.set(t),this.matrix.multiplyMatrix(fs),this.invalidate()}append(t){this.matrix.multiplyMatrix(t),this.invalidate()}prependTransform(t){this.prepend(t.matrix)}appendTransform(t){this.append(t.matrix)}applyToCanvasContext(t){t.setTransform(this.matrix.m00(),this.matrix.m10(),this.matrix.m01(),this.matrix.m11(),this.matrix.m03(),this.matrix.m13())}copy(){const t=new ys(this.matrix);t.inverse=this.inverse,t.matrixTransposed=this.matrixTransposed,t.inverseTransposed=this.inverseTransposed,t.inverseValid=this.inverseValid,t.transposeValid=this.transposeValid,t.inverseTransposeValid=this.inverseTransposeValid}getMatrix(){return this.matrix}getInverse(){return this.inverseValid||(this.inverseValid=!0,this.inverse.set(this.matrix),this.inverse.invert()),this.inverse}getMatrixTransposed(){return this.transposeValid||(this.transposeValid=!0,this.matrixTransposed.set(this.matrix),this.matrixTransposed.transpose()),this.matrixTransposed}getInverseTransposed(){return this.inverseTransposeValid||(this.inverseTransposeValid=!0,this.inverseTransposed.set(this.getInverse()),this.inverseTransposed.transpose()),this.inverseTransposed}isIdentity(){return this.matrix.type===Wi.Types.IDENTITY}isFinite(){return this.matrix.isFinite()}transformPosition3(t){return this.matrix.timesVector3(t)}transformDelta3(t){return this.matrix.timesRelativeVector3(t)}transformNormal3(t){return this.getInverse().timesTransposeVector3(t)}transformDeltaX(t){return this.transformDelta3(new je(t,0,0)).x}transformDeltaY(t){return this.transformDelta3(new je(0,t,0)).y}transformDeltaZ(t){return this.transformDelta3(new je(0,0,t)).z}transformRay(t){return new us(this.transformPosition3(t.position),this.transformPosition3(t.position.plus(t.direction)).minus(this.transformPosition3(t.position)))}inversePosition3(t){return this.getInverse().timesVector3(t)}inverseDelta3(t){return this.inversePosition3(t).minus(this.inversePosition3(je.ZERO))}inverseNormal3(t){return this.matrix.timesTransposeVector3(t)}inverseDeltaX(t){return this.inverseDelta3(new je(t,0,0)).x}inverseDeltaY(t){return this.inverseDelta3(new je(0,t,0)).y}inverseDeltaZ(t){return this.inverseDelta3(new je(0,0,t)).z}inverseRay(t){return new us(this.inversePosition3(t.position),this.inversePosition3(t.position.plus(t.direction)).minus(this.inversePosition3(t.position)))}}fe.register("Transform4",ys);function xs(t,e,i,s,n){i=i||[],s=s||[],n=n||[],Array.prototype.push.apply(i,t),Array.prototype.push.apply(s,e);t:for(let r=0;r<i.length;r++){const t=i[r];for(let e=0;e<s.length;e++){if(t===s[e]){if(n.push(t),i.splice(r,1),s.splice(e,1),e=0,r===i.length)break t;r-=1}}}return i}l.register("arrayDifference",xs);function _s(t){if(t){for(;t.length;)t.pop();return t}return[]}l.register("cleanArray",_s);const ws=_s;function vs(t){const e=[];return t(t=>{e.push(t)}),e}l.register("collect",vs);function bs(t,e){return void 0!==t[e]?e:void 0!==t["moz"+(e=e.charAt(0).toUpperCase()+e.slice(1))]?"moz"+e:void 0!==t["Moz"+e]?"Moz"+e:void 0!==t["webkit"+e]?"webkit"+e:void 0!==t["ms"+e]?"ms"+e:void 0!==t["o"+e]?"o"+e:void 0}l.register("detectPrefix",bs);function Ts(t,e,i){return void 0!==t["on"+e]?e:void 0!==t["onmoz"+e]?"moz"+e:void 0!==t["onMoz"+e]?"Moz"+e:void 0!==t["onwebkit"+e]?"webkit"+e:void 0!==t["onms"+e]?"ms"+e:void 0!==t["ono"+e]?"o"+e:void 0}l.register("detectPrefixEvent",Ts);function Es(t,e,i){const s=[];return function t(e,n){return n.forEach((n,r)=>{s.push(r),1===e?i(...[n].concat(s)):t(e-1,n),s.pop()})}(t,e)}l.register("dimensionForEach",Es);function As(t,e,i){const s=[];return function t(e,n){return n.map((n,r)=>{s.push(r);const a=1===e?i(...[n].concat(s)):t(e-1,n);return s.pop(),a})}(t,e)}l.register("dimensionMap",As);class Ms{constructor(t,e){_defineProperty(this,"_map",new Map),this._enumeration=t,this._values=t.enumeration.values,this._values.forEach(t=>{this._map.set(t,e(t))})}get(t){return this._map.get(t)}set(t,e){this._map.set(t,e)}map(t){return new Ms(this._enumeration,e=>t(this.get(e),e))}forEach(t){this._values.forEach(e=>t(this.get(e),e))}values(){return this._values.map(t=>this.get(t))}}l.register("EnumerationMap",Ms);const Ps=Ms;function Is(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")}l.register("escapeHTML",Is);class Ss{constructor(t,e){this.eventModel=t,this.eventCallback=e,this.period=this.eventModel.getPeriodBeforeNextEvent(),this.timeBeforeNextEvent=this.period}step(t){for(;t>=this.timeBeforeNextEvent;)t-=this.timeBeforeNextEvent,this.period=this.eventModel.getPeriodBeforeNextEvent(),this.timeBeforeNextEvent=this.period,this.eventCallback(t);this.timeBeforeNextEvent-=t}getRatio(){return(this.period-this.timeBeforeNextEvent)/this.period}}function Os(t){return _.each(Array.prototype.slice.call(arguments,1),e=>{if(e)for(const i in e){const s=Object.getOwnPropertyDescriptor(e,i);!s||"function"!=typeof s.get&&void 0===e[i]||Object.defineProperty(t,i,s)}}),t}_defineProperty(Ss,"ConstantEventModel",class{constructor(t){this.rate=t}getPeriodBeforeNextEvent(){return 1/this.rate}}),_defineProperty(Ss,"UniformEventModel",class{constructor(t,e){this.rate=t,this.pseudoRandomNumberSource=e}getPeriodBeforeNextEvent(){const t=this.pseudoRandomNumberSource();return 2*t/this.rate}}),_defineProperty(Ss,"PoissonEventModel",class{constructor(t,e){this.rate=t,this.pseudoRandomNumberSource=e}getPeriodBeforeNextEvent(){const t=this.pseudoRandomNumberSource();return-Math.log(t)/this.rate}}),l.register("EventTimer",Ss),l.register("extendDefined",Os);function Vs(t,e){const i=[],s=2*t.length-1;for(let n=0;n<s;n++)n%2==0?i.push(t[n/2]):i.push(e((n-1)/2));return i}l.register("interleave",Vs);function Ns(t){"string"==typeof t&&(t={src:t});const e=t.src,i=t.callback,s=void 0===t.async||t.async,n=void 0!==t.cacheBust&&t.cacheBust;let r=!1;const a=document.createElement("script");a.type="text/javascript",a.async=s,a.onload=a.onreadystatechange=function(){const t=this.readyState;t&&"complete"!==t&&"loaded"!==t||r||(r=!0,i&&i())},a.src=e+(n?"?random="+Math.random().toFixed(10):"");const h=document.getElementsByTagName("script")[0];h.parentNode.insertBefore(a,h)}l.register("loadScript",Ns);function Ds(t){const e=new Map;return i=>{if(e.has(i))return e.get(i);{const s=t(i);return e.set(i,s),s}}}l.register("memoize",Ds);function Ys(t,e,i){i&&_.each(e,e=>{void 0!==i[e]&&(t[e]=i[e])})}l.register("mutate",Ys);class Cs extends Ps{constructor(t,e){super(oi,i=>i===oi.HORIZONTAL?t:e)}get horizontal(){return this.get(oi.HORIZONTAL)}set horizontal(t){this.set(oi.HORIZONTAL,t)}get vertical(){return this.get(oi.VERTICAL)}set vertical(t){this.set(oi.VERTICAL,t)}static create(t){return new Cs(t(oi.HORIZONTAL),t(oi.VERTICAL))}}l.register("OrientationPair",Cs);function Xs(t){const e=[],i=t.length;if(i>1)for(let s=0;s<i-1;s++){const n=t[s];for(let r=s+1;r<i;r++)e.push([n,t[r]])}return e}l.register("pairs",Xs);function Fs(t,e){const i=[],s=[],n=t.length;for(let r=0;r<n;r++)e(t[r])?i.push(t[r]):s.push(t[r]);return[i,s]}l.register("partition",Fs);const Rs=navigator.userAgent;function Ls(t){return ks()===t}function zs(){return!!(window.phet&&phet.chipper&&phet.chipper.queryParameters&&phet.chipper.queryParameters["phet-app"]||(Rs.match(/(iPod|iPhone|iPad)/)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>=2)&&Rs.match(/AppleWebKit/))}function ks(){let t=-1,e=null;return"Microsoft Internet Explorer"===navigator.appName?(e=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})"),null!==e.exec(Rs)&&(t=parseFloat(RegExp.$1))):"Netscape"===navigator.appName&&(e=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})"),null!==e.exec(Rs)&&(t=parseFloat(RegExp.$1))),t}const qs={firefox:Rs.toLowerCase().indexOf("firefox")>-1,mobileSafari:zs(),safari5:!!(Rs.match(/Version\/5\./)&&Rs.match(/Safari\//)&&Rs.match(/AppleWebKit/)),safari6:!!(Rs.match(/Version\/6\./)&&Rs.match(/Safari\//)&&Rs.match(/AppleWebKit/)),safari7:!!(Rs.match(/Version\/7\./)&&Rs.match(/Safari\//)&&Rs.match(/AppleWebKit/)),safari10:!!(Rs.match(/Version\/10\./)&&Rs.match(/Safari\//)&&Rs.match(/AppleWebKit/)),safari11:!!(Rs.match(/Version\/11\./)&&Rs.match(/Safari\//)&&Rs.match(/AppleWebKit/)),safari9:!!(Rs.match(/Version\/9\./)&&Rs.match(/Safari\//)&&Rs.match(/AppleWebKit/)),safari:zs()||!!(Rs.match(/Version\//)&&Rs.match(/Safari\//)&&Rs.match(/AppleWebKit/)),ie:-1!==ks(),ie9:Ls(9),ie10:Ls(10),ie11:Ls(11),android:Rs.indexOf("Android")>0,edge:!!Rs.match(/Edge\//),chromium:/chrom(e|ium)/.test(Rs.toLowerCase())&&!Rs.match(/Edge\//),mac:navigator.platform.includes("Mac")};l.register("platform",qs);const Bs=new s("kite"),Zs=ni.lineLineIntersection,js={lineWidth:1,lineCap:"butt",lineJoin:"miter",lineDash:[],lineDashOffset:0,miterLimit:10};class Hs{constructor(t){const e=m({},js,t);this.lineWidth=e.lineWidth,this.lineCap=e.lineCap,this.lineJoin=e.lineJoin,this.lineDash=e.lineDash,this.lineDashOffset=e.lineDashOffset,this.miterLimit=e.miterLimit}equals(t){if(!(this.lineWidth===t.lineWidth&&this.lineCap===t.lineCap&&this.lineJoin===t.lineJoin&&this.miterLimit===t.miterLimit&&this.lineDashOffset===t.lineDashOffset))return!1;if(this.lineDash.length!==t.lineDash.length)return!1;for(let e=0;e<this.lineDash.length;e++)if(this.lineDash[e]!==t.lineDash[e])return!1;return!0}copy(){return new Hs({lineWidth:this.lineWidth,lineCap:this.lineCap,lineJoin:this.lineJoin,lineDash:this.lineDash,lineDashOffset:this.lineDashOffset,miterLimit:this.miterLimit})}leftJoin(t,e,i){e=e.normalized(),i=i.normalized();const s=t.plus(e.perpendicular.negated().times(this.lineWidth/2)),n=t.plus(i.perpendicular.negated().times(this.lineWidth/2)),r=s.equals(n)?[]:[new rn(s,n)];let a,h,o;if(!(e.perpendicular.dot(i)>1e-12))return r;switch(this.lineJoin){case"round":return a=e.angle+Math.PI/2,h=i.angle+Math.PI/2,[new _n(t,this.lineWidth/2,a,h,!0)];case"miter":if(o=e.angleBetween(i.negated()),1/Math.sin(o/2)<=this.miterLimit&&o<Math.PI-1e-5){const t=Zs(s,s.plus(e),n,n.plus(i));return t?[new rn(s,t),new rn(t,n)]:[new rn(s,n)]}return r;case"bevel":return r;default:throw new Error("invalid lineJoin: "+this.lineJoin)}}rightJoin(t,e,i){return this.leftJoin(t,i.negated(),e.negated())}cap(t,e){e=e.normalized();const i=t.plus(e.perpendicular.times(-this.lineWidth/2)),s=t.plus(e.perpendicular.times(this.lineWidth/2));let n,r,a,h,o,l;switch(this.lineCap){case"butt":return[new rn(i,s)];case"round":return n=e.angle,[new _n(t,this.lineWidth/2,n+Math.PI/2,n-Math.PI/2,!0)];case"square":return r=e.perpendicular.negated().times(this.lineWidth/2),a=e.perpendicular.times(this.lineWidth/2),h=e.times(this.lineWidth/2),o=t.plus(r).plus(h),l=t.plus(a).plus(h),[new rn(i,o),new rn(o,l),new rn(l,s)];default:throw new Error("invalid lineCap: "+this.lineCap)}}}Bs.register("LineStyles",Hs);class $s{constructor(t,e){this.a=t,this.b=e;let i=0,s=1,n=this.apply(i),r=this.apply(s);n>1&&(n=1,i=this.applyInverse(n)),n<0&&(n=0,i=this.applyInverse(n)),r>1&&(r=1,s=this.applyInverse(r)),r<0&&(r=0,s=this.applyInverse(r)),this.t0=i,this.t1=s,t>0?(this.qt0=n,this.qt1=r):(this.qt0=r,this.qt1=n),this.t0<0&&this.t0>-1e-8&&(this.t0=0),this.t0>1&&this.t0<1+1e-8&&(this.t0=1),this.t1<0&&this.t1>-1e-8&&(this.t1=0),this.t1>1&&this.t1<1+1e-8&&(this.t1=1),this.qt0<0&&this.qt0>-1e-8&&(this.qt0=0),this.qt0>1&&this.qt0<1+1e-8&&(this.qt0=1),this.qt1<0&&this.qt1>-1e-8&&(this.qt1=0),this.qt1>1&&this.qt1<1+1e-8&&(this.qt1=1)}apply(t){return this.a*t+this.b}applyInverse(t){return(t-this.b)/this.a}static createLinear(t,e,i,s){const n=(s-e)/(i-t);return new $s(n,e-t*n)}}Bs.register("Overlap",$s);class Us{constructor(t,e,i,s,n){this.point=e,this.normal=i,this.distance=t,this.wind=s,this.t=ni.clamp(n,0,1)}}Bs.register("RayIntersection",Us);class Gs{constructor(t,e,i){this.point=t,this.aT=ni.clamp(e,0,1),this.bT=ni.clamp(i,0,1)}getSwapped(){return new Gs(this.point,this.bT,this.aT)}}Bs.register("SegmentIntersection",Gs);const Ws=t=>t.toFixed(20);Bs.register("svgNumber",Ws);const Qs=Ws;function Js(t){return'"'+t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}const Ks={parse:function(t,e){const i={svgPath:function(){let t,e,i,n,r,a;r=s,a=s,t=[],e=H();for(;null!==e;)t.push(e),e=H();if(null!==t)if(e=h(),e=null!==e?e:"",null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?t=[t,e,i]:(t=null,s=a)}else t=null,s=a;else t=null,s=a;null!==t&&(o=t[1],t=o||[]);var o;null===t&&(s=r);return t},movetoDrawtoCommandGroups:h,movetoDrawtoCommandGroup:o,drawtoCommands:l,drawtoCommand:u,moveto:m,movetoArgumentSequence:d,closepath:c,lineto:p,linetoArgumentSequence:g,horizontalLineto:f,horizontalLinetoArgumentSequence:y,verticalLineto:x,verticalLinetoArgumentSequence:_,curveto:w,curvetoArgumentSequence:v,curvetoArgument:b,smoothCurveto:T,smoothCurvetoArgumentSequence:E,smoothCurvetoArgument:A,quadraticBezierCurveto:M,quadraticBezierCurvetoArgumentSequence:P,quadraticBezierCurvetoArgument:I,smoothQuadraticBezierCurveto:S,smoothQuadraticBezierCurvetoArgumentSequence:O,ellipticalArc:V,ellipticalArcArgumentSequence:N,ellipticalArcArgument:D,coordinatePair:Y,nonnegativeNumber:C,number:X,flag:F,commaWsp:R,comma:L,floatingPointConstant:z,fractionalConstant:k,exponent:q,sign:B,digitSequence:Z,digit:j,wsp:H};if(void 0!==e){if(void 0===i[e])throw new Error("Invalid rule name: "+Js(e)+".")}else e="svgPath";let s=0;let n=0,r=[];function a(t){s<n||(s>n&&(n=s,r=[]),r.push(t))}function h(){let t,e,i,n,r;if(n=s,r=s,t=o(),null!==t){for(e=[],i=H();null!==i;)e.push(i),i=H();null!==e?(i=h(),null!==i?t=[t,e,i]:(t=null,s=r)):(t=null,s=r)}else t=null,s=r;var a,l;return null!==t&&(a=t[0],l=t[2],t=a.concat(l)),null===t&&(s=n),null===t&&(n=s,t=o(),null!==t&&(t=function(t,e){return e}(0,t)),null===t&&(s=n)),t}function o(){let t,e,i,n,r;if(n=s,r=s,t=m(),null!==t){for(e=[],i=H();null!==i;)e.push(i),i=H();null!==e?(i=l(),i=null!==i?i:"",null!==i?t=[t,e,i]:(t=null,s=r)):(t=null,s=r)}else t=null,s=r;var a,h;return null!==t&&(a=t[0],t=(h=t[2]).length?a.concat(h):a),null===t&&(s=n),t}function l(){let t,e,i,n,r;if(n=s,r=s,t=u(),null!==t){for(e=[],i=H();null!==i;)e.push(i),i=H();null!==e?(i=l(),null!==i?t=[t,e,i]:(t=null,s=r)):(t=null,s=r)}else t=null,s=r;var a,h;return null!==t&&(a=t[0],h=t[2],t=a.concat(h)),null===t&&(s=n),null===t&&(n=s,t=u(),null!==t&&(t=function(t,e){return e}(0,t)),null===t&&(s=n)),t}function u(){let t;return t=c(),null===t&&(t=p(),null===t&&(t=f(),null===t&&(t=x(),null===t&&(t=w(),null===t&&(t=T(),null===t&&(t=M(),null===t&&(t=S(),null===t&&(t=V())))))))),t}function m(){let e,i,n,r,h;if(r=s,h=s,77===t.charCodeAt(s)?(e="M",s++):(e=null,a('"M"')),null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?(n=d(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)}else e=null,s=h;if(null!==e&&(e=$(e[2],!1)),null===e&&(s=r),null===e){if(r=s,h=s,109===t.charCodeAt(s)?(e="m",s++):(e=null,a('"m"')),null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?(n=d(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)}else e=null,s=h;null!==e&&(e=function(t,e){return $(e,!0)}(0,e[2])),null===e&&(s=r)}return e}function d(){let t,e,i,n,r;var a,h;return n=s,r=s,t=Y(),null!==t?(e=R(),e=null!==e?e:"",null!==e?(i=g(),null!==i?t=[t,e,i]:(t=null,s=r)):(t=null,s=r)):(t=null,s=r),null!==t&&(a=t[0],h=t[2],t=[a].concat(h)),null===t&&(s=n),null===t&&(n=s,t=Y(),null!==t&&(t=function(t,e){return[e]}(0,t)),null===t&&(s=n)),t}function c(){let e,i;return i=s,90===t.charCodeAt(s)?(e="Z",s++):(e=null,a('"Z"')),null===e&&(122===t.charCodeAt(s)?(e="z",s++):(e=null,a('"z"'))),null!==e&&(e={cmd:"close"}),null===e&&(s=i),e}function p(){let e,i,n,r,h;if(r=s,h=s,76===t.charCodeAt(s)?(e="L",s++):(e=null,a('"L"')),null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?(n=g(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)}else e=null,s=h;if(null!==e&&(e=e[2].map(t=>({cmd:"lineTo",args:[t.x,t.y]}))),null===e&&(s=r),null===e){if(r=s,h=s,108===t.charCodeAt(s)?(e="l",s++):(e=null,a('"l"')),null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?(n=g(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)}else e=null,s=h;null!==e&&(e=function(t,e){return e.map(t=>({cmd:"lineToRelative",args:[t.x,t.y]}))}(0,e[2])),null===e&&(s=r)}return e}function g(){let t,e,i,n,r;var a,h;return n=s,r=s,t=Y(),null!==t?(e=R(),e=null!==e?e:"",null!==e?(i=g(),null!==i?t=[t,e,i]:(t=null,s=r)):(t=null,s=r)):(t=null,s=r),null!==t&&(a=t[0],h=t[2],t=[a].concat(h)),null===t&&(s=n),null===t&&(n=s,t=Y(),null!==t&&(t=function(t,e){return[e]}(0,t)),null===t&&(s=n)),t}function f(){let e,i,n,r,h;if(r=s,h=s,72===t.charCodeAt(s)?(e="H",s++):(e=null,a('"H"')),null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?(n=y(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)}else e=null,s=h;if(null!==e&&(e=e[2].map(t=>({cmd:"horizontalLineTo",args:[t]}))),null===e&&(s=r),null===e){if(r=s,h=s,104===t.charCodeAt(s)?(e="h",s++):(e=null,a('"h"')),null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?(n=y(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)}else e=null,s=h;null!==e&&(e=function(t,e){return e.map(t=>({cmd:"horizontalLineToRelative",args:[t]}))}(0,e[2])),null===e&&(s=r)}return e}function y(){let t,e,i,n,r;var a,h;return n=s,r=s,t=X(),null!==t?(e=R(),e=null!==e?e:"",null!==e?(i=y(),null!==i?t=[t,e,i]:(t=null,s=r)):(t=null,s=r)):(t=null,s=r),null!==t&&(a=t[0],h=t[2],t=[a].concat(h)),null===t&&(s=n),null===t&&(n=s,t=X(),null!==t&&(t=function(t,e){return[e]}(0,t)),null===t&&(s=n)),t}function x(){let e,i,n,r,h;if(r=s,h=s,86===t.charCodeAt(s)?(e="V",s++):(e=null,a('"V"')),null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?(n=_(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)}else e=null,s=h;if(null!==e&&(e=e[2].map(t=>({cmd:"verticalLineTo",args:[t]}))),null===e&&(s=r),null===e){if(r=s,h=s,118===t.charCodeAt(s)?(e="v",s++):(e=null,a('"v"')),null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?(n=_(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)}else e=null,s=h;null!==e&&(e=function(t,e){return e.map(t=>({cmd:"verticalLineToRelative",args:[t]}))}(0,e[2])),null===e&&(s=r)}return e}function _(){let t,e,i,n,r;var a,h;return n=s,r=s,t=X(),null!==t?(e=R(),e=null!==e?e:"",null!==e?(i=_(),null!==i?t=[t,e,i]:(t=null,s=r)):(t=null,s=r)):(t=null,s=r),null!==t&&(a=t[0],h=t[2],t=[a].concat(h)),null===t&&(s=n),null===t&&(n=s,t=X(),null!==t&&(t=function(t,e){return[e]}(0,t)),null===t&&(s=n)),t}function w(){let e,i,n,r,h;if(r=s,h=s,67===t.charCodeAt(s)?(e="C",s++):(e=null,a('"C"')),null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?(n=v(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)}else e=null,s=h;if(null!==e&&(e=e[2].map(t=>({cmd:"cubicCurveTo",args:t}))),null===e&&(s=r),null===e){if(r=s,h=s,99===t.charCodeAt(s)?(e="c",s++):(e=null,a('"c"')),null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?(n=v(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)}else e=null,s=h;null!==e&&(e=function(t,e){return e.map(t=>({cmd:"cubicCurveToRelative",args:t}))}(0,e[2])),null===e&&(s=r)}return e}function v(){let t,e,i,n,r;var a,h;return n=s,r=s,t=b(),null!==t?(e=R(),e=null!==e?e:"",null!==e?(i=v(),null!==i?t=[t,e,i]:(t=null,s=r)):(t=null,s=r)):(t=null,s=r),null!==t&&(a=t[0],h=t[2],t=[a].concat(h)),null===t&&(s=n),null===t&&(n=s,t=b(),null!==t&&(t=function(t,e){return[e]}(0,t)),null===t&&(s=n)),t}function b(){let t,e,i,n,r,a,h;var o,l,u;return a=s,h=s,t=Y(),null!==t?(e=R(),e=null!==e?e:"",null!==e?(i=Y(),null!==i?(n=R(),n=null!==n?n:"",null!==n?(r=Y(),null!==r?t=[t,e,i,n,r]:(t=null,s=h)):(t=null,s=h)):(t=null,s=h)):(t=null,s=h)):(t=null,s=h),null!==t&&(o=t[0],l=t[2],u=t[4],t=[o.x,o.y,l.x,l.y,u.x,u.y]),null===t&&(s=a),t}function T(){let e,i,n,r,h;if(r=s,h=s,83===t.charCodeAt(s)?(e="S",s++):(e=null,a('"S"')),null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?(n=E(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)}else e=null,s=h;if(null!==e&&(e=e[2].map(t=>({cmd:"smoothCubicCurveTo",args:t}))),null===e&&(s=r),null===e){if(r=s,h=s,115===t.charCodeAt(s)?(e="s",s++):(e=null,a('"s"')),null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?(n=E(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)}else e=null,s=h;null!==e&&(e=function(t,e){return e.map(t=>({cmd:"smoothCubicCurveToRelative",args:t}))}(0,e[2])),null===e&&(s=r)}return e}function E(){let t,e,i,n,r;var a,h;return n=s,r=s,t=A(),null!==t?(e=R(),e=null!==e?e:"",null!==e?(i=E(),null!==i?t=[t,e,i]:(t=null,s=r)):(t=null,s=r)):(t=null,s=r),null!==t&&(a=t[0],h=t[2],t=[a].concat(h)),null===t&&(s=n),null===t&&(n=s,t=A(),null!==t&&(t=function(t,e){return[e]}(0,t)),null===t&&(s=n)),t}function A(){let t,e,i,n,r;var a,h;return n=s,r=s,t=Y(),null!==t?(e=R(),e=null!==e?e:"",null!==e?(i=Y(),null!==i?t=[t,e,i]:(t=null,s=r)):(t=null,s=r)):(t=null,s=r),null!==t&&(a=t[0],h=t[2],t=[a.x,a.y,h.x,h.y]),null===t&&(s=n),t}function M(){let e,i,n,r,h;if(r=s,h=s,81===t.charCodeAt(s)?(e="Q",s++):(e=null,a('"Q"')),null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?(n=P(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)}else e=null,s=h;if(null!==e&&(e=e[2].map(t=>({cmd:"quadraticCurveTo",args:t}))),null===e&&(s=r),null===e){if(r=s,h=s,113===t.charCodeAt(s)?(e="q",s++):(e=null,a('"q"')),null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?(n=P(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)}else e=null,s=h;null!==e&&(e=function(t,e){return e.map(t=>({cmd:"quadraticCurveToRelative",args:t}))}(0,e[2])),null===e&&(s=r)}return e}function P(){let t,e,i,n,r;var a,h;return n=s,r=s,t=I(),null!==t?(e=R(),e=null!==e?e:"",null!==e?(i=P(),null!==i?t=[t,e,i]:(t=null,s=r)):(t=null,s=r)):(t=null,s=r),null!==t&&(a=t[0],h=t[2],t=[a].concat(h)),null===t&&(s=n),null===t&&(n=s,t=I(),null!==t&&(t=function(t,e){return[e]}(0,t)),null===t&&(s=n)),t}function I(){let t,e,i,n,r;var a,h;return n=s,r=s,t=Y(),null!==t?(e=R(),e=null!==e?e:"",null!==e?(i=Y(),null!==i?t=[t,e,i]:(t=null,s=r)):(t=null,s=r)):(t=null,s=r),null!==t&&(a=t[0],h=t[2],t=[a.x,a.y,h.x,h.y]),null===t&&(s=n),t}function S(){let e,i,n,r,h;if(r=s,h=s,84===t.charCodeAt(s)?(e="T",s++):(e=null,a('"T"')),null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?(n=O(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)}else e=null,s=h;if(null!==e&&(e=e[2].map(t=>({cmd:"smoothQuadraticCurveTo",args:[t.x,t.y]}))),null===e&&(s=r),null===e){if(r=s,h=s,116===t.charCodeAt(s)?(e="t",s++):(e=null,a('"t"')),null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?(n=O(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)}else e=null,s=h;null!==e&&(e=function(t,e){return e.map(t=>({cmd:"smoothQuadraticCurveToRelative",args:[t.x,t.y]}))}(0,e[2])),null===e&&(s=r)}return e}function O(){let t,e,i,n,r;var a,h;return n=s,r=s,t=Y(),null!==t?(e=R(),e=null!==e?e:"",null!==e?(i=O(),null!==i?t=[t,e,i]:(t=null,s=r)):(t=null,s=r)):(t=null,s=r),null!==t&&(a=t[0],h=t[2],t=[a].concat(h)),null===t&&(s=n),null===t&&(n=s,t=Y(),null!==t&&(t=function(t,e){return[e]}(0,t)),null===t&&(s=n)),t}function V(){let e,i,n,r,h;if(r=s,h=s,65===t.charCodeAt(s)?(e="A",s++):(e=null,a('"A"')),null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?(n=N(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)}else e=null,s=h;if(null!==e&&(e=e[2].map(t=>(t[2]*=Math.PI/180,{cmd:"ellipticalArcTo",args:t}))),null===e&&(s=r),null===e){if(r=s,h=s,97===t.charCodeAt(s)?(e="a",s++):(e=null,a('"a"')),null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?(n=N(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)}else e=null,s=h;null!==e&&(e=function(t,e){return e.map(t=>(t[2]*=Math.PI/180,{cmd:"ellipticalArcToRelative",args:t}))}(0,e[2])),null===e&&(s=r)}return e}function N(){let t,e,i,n,r;var a,h;return n=s,r=s,t=D(),null!==t?(e=R(),e=null!==e?e:"",null!==e?(i=N(),null!==i?t=[t,e,i]:(t=null,s=r)):(t=null,s=r)):(t=null,s=r),null!==t&&(a=t[0],h=t[2],t=[a].concat(h)),null===t&&(s=n),null===t&&(n=s,t=D(),null!==t&&(t=function(t,e){return[e]}(0,t)),null===t&&(s=n)),t}function D(){let t,e,i,n,r,a,h,o,l,u,m,d,c;var p,g,f,y,x,_;return d=s,c=s,t=C(),null!==t?(e=R(),e=null!==e?e:"",null!==e?(i=C(),null!==i?(n=R(),n=null!==n?n:"",null!==n?(r=X(),null!==r?(a=R(),null!==a?(h=F(),null!==h?(o=R(),o=null!==o?o:"",null!==o?(l=F(),null!==l?(u=R(),u=null!==u?u:"",null!==u?(m=Y(),null!==m?t=[t,e,i,n,r,a,h,o,l,u,m]:(t=null,s=c)):(t=null,s=c)):(t=null,s=c)):(t=null,s=c)):(t=null,s=c)):(t=null,s=c)):(t=null,s=c)):(t=null,s=c)):(t=null,s=c)):(t=null,s=c)):(t=null,s=c),null!==t&&(p=t[0],g=t[2],f=t[4],y=t[6],x=t[8],_=t[10],t=[p,g,f,y,x,_.x,_.y]),null===t&&(s=d),t}function Y(){let t,e,i,n,r;var a,h;return n=s,r=s,t=X(),null!==t?(e=R(),e=null!==e?e:"",null!==e?(i=X(),null!==i?t=[t,e,i]:(t=null,s=r)):(t=null,s=r)):(t=null,s=r),null!==t&&(a=t[0],h=t[2],t={x:a,y:h}),null===t&&(s=n),t}function C(){let t,e;return e=s,t=z(),null!==t&&(t=parseFloat(t)),null===t&&(s=e),null===t&&(e=s,t=Z(),null!==t&&(t=function(t,e){return Number(e)}(0,t)),null===t&&(s=e)),t}function X(){let t,e,i,n;var r,a;return i=s,n=s,t=B(),t=null!==t?t:"",null!==t?(e=z(),null!==e?t=[t,e]:(t=null,s=n)):(t=null,s=n),null!==t&&(r=t[0],a=t[1],t=parseFloat(r+a)),null===t&&(s=i),null===t&&(i=s,n=s,t=B(),t=null!==t?t:"",null!==t?(e=Z(),null!==e?t=[t,e]:(t=null,s=n)):(t=null,s=n),null!==t&&(t=function(t,e,i){return Number(e+i)}(0,t[0],t[1])),null===t&&(s=i)),t}function F(){let e,i;return i=s,48===t.charCodeAt(s)?(e="0",s++):(e=null,a('"0"')),null!==e&&(e=!1),null===e&&(s=i),null===e&&(i=s,49===t.charCodeAt(s)?(e="1",s++):(e=null,a('"1"')),null!==e&&(e=!0),null===e&&(s=i)),e}function R(){let t,e,i,n,r;if(r=s,e=H(),null!==e)for(t=[];null!==e;)t.push(e),e=H();else t=null;if(null!==t)if(e=L(),e=null!==e?e:"",null!==e){for(i=[],n=H();null!==n;)i.push(n),n=H();null!==i?t=[t,e,i]:(t=null,s=r)}else t=null,s=r;else t=null,s=r;if(null===t)if(r=s,t=L(),null!==t){for(e=[],i=H();null!==i;)e.push(i),i=H();null!==e?t=[t,e]:(t=null,s=r)}else t=null,s=r;return t}function L(){let e;return 44===t.charCodeAt(s)?(e=",",s++):(e=null,a('","')),e}function z(){let t,e,i,n;var r,a;return i=s,n=s,t=k(),null!==t?(e=q(),e=null!==e?e:"",null!==e?t=[t,e]:(t=null,s=n)):(t=null,s=n),null!==t&&(r=t[0],a=t[1],t=r+a),null===t&&(s=i),null===t&&(i=s,n=s,t=Z(),null!==t?(e=q(),null!==e?t=[t,e]:(t=null,s=n)):(t=null,s=n),null!==t&&(t=function(t,e,i){return e+i}(0,t[0],t[1])),null===t&&(s=i)),t}function k(){let e,i,n,r,h;var o,l;return r=s,h=s,e=Z(),e=null!==e?e:"",null!==e?(46===t.charCodeAt(s)?(i=".",s++):(i=null,a('"."')),null!==i?(n=Z(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)):(e=null,s=h),null!==e&&(o=e[0],l=e[2],e=o+"."+l),null===e&&(s=r),null===e&&(r=s,h=s,e=Z(),null!==e?(46===t.charCodeAt(s)?(i=".",s++):(i=null,a('"."')),null!==i?e=[e,i]:(e=null,s=h)):(e=null,s=h),null!==e&&(e=function(t,e){return e}(0,e[0])),null===e&&(s=r)),e}function q(){let e,i,n,r,h;var o,l,u;return r=s,h=s,101===t.charCodeAt(s)?(e="e",s++):(e=null,a('"e"')),null===e&&(69===t.charCodeAt(s)?(e="E",s++):(e=null,a('"E"'))),null!==e?(i=B(),i=null!==i?i:"",null!==i?(n=Z(),null!==n?e=[e,i,n]:(e=null,s=h)):(e=null,s=h)):(e=null,s=h),null!==e&&(o=e[0],l=e[1],u=e[2],e=o+l+u),null===e&&(s=r),e}function B(){let e;return 43===t.charCodeAt(s)?(e="+",s++):(e=null,a('"+"')),null===e&&(45===t.charCodeAt(s)?(e="-",s++):(e=null,a('"-"'))),e}function Z(){let t,e,i,n;var r,a;return i=s,n=s,t=j(),null!==t?(e=Z(),null!==e?t=[t,e]:(t=null,s=n)):(t=null,s=n),null!==t&&(r=t[0],a=t[1],t=r+a),null===t&&(s=i),null===t&&(t=j()),t}function j(){let e;return/^[0-9]/.test(t.charAt(s))?(e=t.charAt(s),s++):(e=null,a("[0-9]")),e}function H(){let e;return 32===t.charCodeAt(s)?(e=" ",s++):(e=null,a('" "')),null===e&&(9===t.charCodeAt(s)?(e="\t",s++):(e=null,a('"\\t"')),null===e&&(13===t.charCodeAt(s)?(e="\r",s++):(e=null,a('"\\r"')),null===e&&(10===t.charCodeAt(s)?(e="\n",s++):(e=null,a('"\\n"'))))),e}function $(t,e){const i=[{cmd:e?"moveToRelative":"moveTo",args:[t[0].x,t[0].y]}];if(t.length>1)for(let s=1;s<t.length;s++)i.push({cmd:e?"lineToRelative":"lineTo",args:[t[s].x,t[s].y]});return i}const U=i[e]();if(null===U||s!==t.length){const e=Math.max(s,n),i=e<t.length?t.charAt(e):null,a=function(){let e=1,i=1,r=!1;for(let a=0;a<Math.max(s,n);a++){const s=t.charAt(a);"\n"===s?(r||e++,i=1,r=!1):"\r"===s||"\u2028"===s||"\u2029"===s?(e++,i=1,r=!0):(i++,r=!1)}return{line:e,column:i}}();throw new this.SyntaxError(function(t){t.sort();let e=null;const i=[];for(let s=0;s<t.length;s++)t[s]!==e&&(i.push(t[s]),e=t[s]);return i}(r),i,e,a.line,a.column)}return U},toSource:function(){return this._source},SyntaxError:function(t,e,i,s,n){this.name="SyntaxError",this.expected=t,this.found=e,this.message=function(t,e){let i,s;switch(t.length){case 0:i="end of input";break;case 1:i=t[0];break;default:i=t.slice(0,t.length-1).join(", ")+" or "+t[t.length-1]}return s=e?Js(e):"end of input","Expected "+i+" but "+s+" found."}(t,e),this.offset=i,this.line=s,this.column=n}};Ks.SyntaxError.prototype=Error.prototype,Bs.register("svgPath",Ks);const tn=Bs.svgPath;class en{constructor(){this.invalidationEmitter=new r}areStrokedBoundsDilated(){return Math.abs(this.startTangent.x*this.startTangent.y)<1e-7&&Math.abs(this.endTangent.x*this.endTangent.y)<1e-7}getBoundsWithTransform(t){return this.transformed(t).getBounds()}slice(t,e){let i=this;return e<1&&(i=i.subdivided(e)[0]),t>0&&(i=i.subdivided(ni.linear(0,e,0,1,t))[1]),i}subdivisions(t){let e=this;const i=[];for(let s=0;s<t.length;s++){const n=t[s],r=e.subdivided(n);i.push(r[0]),e=r[1];for(let e=s+1;e<t.length;e++)t[e]=ni.linear(n,1,0,1,t[e])}return i.push(e),i}subdividedIntoMonotone(){return this.subdivisions(this.getInteriorExtremaTs())}isSufficientlyFlat(t,e){const i=this.start,s=this.positionAt(.5),n=this.end;return en.isSufficientlyFlat(t,e,i,s,n)}getArcLength(t,e,i){if(t=void 0===t?1e-10:t,e=void 0===e?1e-8:e,(i=void 0===i?15:i)<=0||this.isSufficientlyFlat(t,e))return this.start.distance(this.end);{const s=this.subdivided(.5);return s[0].getArcLength(t,e,i-1)+s[1].getArcLength(t,e,i-1)}}getDashValues(t,e,i,s){const n=this,r=[];let a=0;const h=_.sum(t);(e%=h)<0&&(e+=h);let o=0,l=0,u=!0;function m(){o=(o+1)%t.length,u=!u}for(;e>0;)e>=t[o]?(e-=t[o],m()):(l=e,e=0);const d=u;return function e(h,u,d,c,p){const g=(h+u)/2,f=n.positionAt(g);if(p>14||en.isSufficientlyFlat(i,s,d,f,c)){const e=d.distance(f)+f.distance(c);a+=e;let i=e;for(;l+i>=t[o];){const s=ni.linear(0,e,h,u,e-i+t[o]-l);r.push(s),i-=t[o]-l,l=0,m()}l+=i}else e(h,g,d,f,p+1),e(g,u,f,c,p+1)}(0,1,this.start,this.end,0),{values:r,arcLength:a,initiallyInside:d}}toPiecewiseLinearSegments(t,e,i,s,n,r){e=void 0===e?t.minLevels:e,i=void 0===i?t.maxLevels:i,s=s||[];const a=t.pointMap||_.identity;n=n||a(this.start),r=r||a(this.end);const h=a(this.positionAt(.5));let o=0===i;if(!o&&e<=0&&(o=this.isSufficientlyFlat(null===t.distanceEpsilon||void 0===t.distanceEpsilon?Number.POSITIVE_INFINITY:t.distanceEpsilon,null===t.curveEpsilon||void 0===t.curveEpsilon?Number.POSITIVE_INFINITY:t.curveEpsilon)),o)s.push(new rn(n,r));else{const a=this.subdivided(.5);a[0].toPiecewiseLinearSegments(t,e-1,i-1,s,n,h),a[1].toPiecewiseLinearSegments(t,e-1,i-1,s,h,r)}return s}toPiecewiseLinearOrArcSegments(t){const e=c()({minLevels:2,maxLevels:7,curvatureThreshold:.02,errorThreshold:10,errorPoints:[.25,.75]},t),i=[];return this.toPiecewiseLinearOrArcRecursion(e,e.minLevels,e.maxLevels,i,0,1,this.positionAt(0),this.positionAt(1),this.curvatureAt(0),this.curvatureAt(1)),i}toPiecewiseLinearOrArcRecursion(t,e,i,s,n,r,a,h,o,l){const u=(n+r)/2,m=this.positionAt(u),d=this.curvatureAt(u);if(i<=0||e<=0&&Math.abs(o-d)+Math.abs(d-l)<2*t.curvatureThreshold){const e=_n.createFromPoints(a,m,h);let i=!1;if(e instanceof _n){const s=e.radius*e.radius;for(let a=0;a<t.errorPoints.length;a++){const h=t.errorPoints[a],o=this.positionAt(n*(1-h)+r*h);if(Math.abs(o.distanceSquared(e.center)-s)>t.errorThreshold){i=!0;break}}}if(!i)return void s.push(e)}this.toPiecewiseLinearOrArcRecursion(t,e-1,i-1,s,n,u,a,m,o,d),this.toPiecewiseLinearOrArcRecursion(t,e-1,i-1,s,u,r,m,h,d,l)}toShape(){return new Sn([new En([this])])}static closestToPoint(t,e,i){const s=i*i;let n=[],r=[],a=Number.POSITIVE_INFINITY,h=!1;for(_.each(t,t=>{if(t instanceof rn){const i=t.explicitClosestToPoint(e);_.each(i,t=>{t.distanceSquared<a?(r=[t],a=t.distanceSquared):t.distanceSquared===a&&r.push(t)})}else{const i=[0].concat(t.getInteriorExtremaTs()).concat([1]);for(let s=0;s<i.length-1;s++){const h=i[s],o=i[s+1],l=t.positionAt(h),u=t.positionAt(o),m=ui.point(l).addPoint(u),d=m.minimumDistanceToPointSquared(e);if(d<=a){const i=m.maximumDistanceToPointSquared(e);i<a&&(a=i,r=[]),n.push({ta:h,tb:o,pa:l,pb:u,segment:t,bounds:m,min:d,max:i})}}}});n.length&&!h;){const t=n;n=[],h=!0;for(const i of t){if(i.min>a)continue;h&&i.pa.distanceSquared(i.pb)>s&&(h=!1);const t=(i.ta+i.tb)/2,o=i.segment.positionAt(t),l=ui.point(i.pa).addPoint(o),u=ui.point(i.pb).addPoint(o),m=l.minimumDistanceToPointSquared(e),d=u.minimumDistanceToPointSquared(e);if(m<=a){const s=l.maximumDistanceToPointSquared(e);s<a&&(a=s,r=[]),n.push({ta:i.ta,tb:t,pa:i.pa,pb:o,segment:i.segment,bounds:l,min:m,max:s})}if(d<=a){const s=u.maximumDistanceToPointSquared(e);s<a&&(a=s,r=[]),n.push({ta:t,tb:i.tb,pa:o,pb:i.pb,segment:i.segment,bounds:u,min:d,max:s})}}}return _.each(n,t=>{const i=(t.ta+t.tb)/2,s=t.segment.positionAt(i);r.push({segment:t.segment,t:i,closestPoint:s,distanceSquared:e.distanceSquared(s)})}),r}static polynomialGetOverlapCubic(t,e,i,s,n,r,a,h){if(0===h)return en.polynomialGetOverlapQuadratic(t,e,i,n,r,a);const o=Math.sign(s/h)*Math.pow(Math.abs(s/h),1/3);return 0===o?null:{a:o,b:(i-o*o*a)/(3*o*o*h)}}static polynomialGetOverlapQuadratic(t,e,i,s,n,r){if(0===r)return en.polynomialGetOverlapLinear(t,e,s,n);if(i/r<0)return null;const a=Math.sqrt(i/r);return 0===a?null:{a:a,b:(e-a*n)/(2*a*r)}}static polynomialGetOverlapLinear(t,e,i,s){if(0===s)return t===i||null;const n=e/s;return 0===n?null:{a:n,b:(t-i)/s}}static intersect(t,e){return rn&&t instanceof rn&&e instanceof rn?rn.intersect(t,e):rn&&t instanceof rn?rn.intersectOther(t,e):rn&&e instanceof rn?rn.intersectOther(e,t).map(sn):_n&&t instanceof _n&&e instanceof _n?_n.intersect(t,e):vn&&t instanceof vn&&e instanceof vn?vn.intersect(t,e):jn.intersect(t,e)}static deserialize(t){return Bs[t.type].deserialize(t)}static isSufficientlyFlat(t,e,i,s,n){return!(ni.distToSegmentSquared(s,i,n)/i.distanceSquared(n)>e)&&!(ni.distToSegmentSquared(s,i,n)>t)}}function sn(t){return t.getSwapped()}Bs.register("Segment",en);const nn=new Ge(0,0);class rn extends en{constructor(t,e){super(),this._start=t,this._end=e,this.invalidate()}setStart(t){return this._start.equals(t)||(this._start=t,this.invalidate()),this}set start(t){this.setStart(t)}get start(){return this.getStart()}getStart(){return this._start}setEnd(t){return this._end.equals(t)||(this._end=t,this.invalidate()),this}set end(t){this.setEnd(t)}get end(){return this.getEnd()}getEnd(){return this._end}positionAt(t){return this._start.plus(this._end.minus(this._start).times(t))}tangentAt(t){return this.getStartTangent()}curvatureAt(t){return 0}subdivided(t){if(0===t||1===t)return[this];const e=this.positionAt(t);return[new rn(this._start,e),new rn(e,this._end)]}invalidate(){this._tangent=null,this._bounds=null,this._svgPathFragment=null,this.invalidationEmitter.emit()}getStartTangent(){return null===this._tangent&&(this._tangent=this._end.minus(this._start).normalized()),this._tangent}get startTangent(){return this.getStartTangent()}getEndTangent(){return this.getStartTangent()}get endTangent(){return this.getEndTangent()}getBounds(){return null===this._bounds&&(this._bounds=ui.NOTHING.copy().addPoint(this._start).addPoint(this._end)),this._bounds}get bounds(){return this.getBounds()}getBoundsWithTransform(t){const e=ui.NOTHING.copy();return e.addPoint(t.multiplyVector2(nn.set(this._start))),e.addPoint(t.multiplyVector2(nn.set(this._end))),e}getNondegenerateSegments(){return this._start.equals(this._end)?[]:[this]}getSVGPathFragment(){return this._svgPathFragment||(this._svgPathFragment=`L ${Qs(this._end.x)} ${Qs(this._end.y)}`),this._svgPathFragment}strokeLeft(t){const e=this.getEndTangent().perpendicular.negated().times(t/2);return[new rn(this._start.plus(e),this._end.plus(e))]}strokeRight(t){const e=this.getStartTangent().perpendicular.times(t/2);return[new rn(this._end.plus(e),this._start.plus(e))]}getInteriorExtremaTs(){return[]}intersection(t){const e=[],i=this._start,s=this._end.minus(i);if(0===s.magnitudeSquared)return e;const n=t.direction.y*s.x-t.direction.x*s.y;if(0===n)return e;const r=(t.direction.x*(i.y-t.position.y)-t.direction.y*(i.x-t.position.x))/n;if(r<0||r>=1)return e;const a=(s.x*(i.y-t.position.y)-s.y*(i.x-t.position.x))/n;if(a<1e-8)return e;const h=s.perpendicular,o=i.plus(s.times(r)),l=(h.dot(t.direction)>0?h.negated():h).normalized(),u=t.direction.perpendicular.dot(s)<0?1:-1;return e.push(new Us(a,o,l,u,r)),e}windingIntersection(t){const e=this.intersection(t);return e.length?e[0].wind:0}writeToContext(t){t.lineTo(this._end.x,this._end.y)}transformed(t){return new rn(t.timesVector2(this._start),t.timesVector2(this._end))}explicitClosestToPoint(t){const e=this._end.minus(this._start);let i=t.minus(this._start).dot(e)/e.magnitudeSquared;i=ni.clamp(i,0,1);const s=this.positionAt(i);return[{segment:this,t:i,closestPoint:s,distanceSquared:t.distanceSquared(s)}]}getSignedAreaFragment(){return.5*(this._start.x*this._end.y-this._start.y*this._end.x)}reparameterized(t,e){return new rn(this.positionAt(e),this.positionAt(t+e))}reversed(){return new rn(this._end,this._start)}polarToCartesian(t){return this._start.x===this._end.x?[new rn(Ge.createPolar(this._start.y,this._start.x),Ge.createPolar(this._end.y,this._end.x))]:this._start.y===this._end.y?[new _n(Ge.ZERO,this._start.y,this._start.x,this._end.x,this._start.x>this._end.x)]:this.toPiecewiseLinearSegments(t)}getArcLength(){return this.start.distance(this.end)}toPiecewiseLinearOrArcSegments(){return[this]}serialize(){return{type:"Line",startX:this._start.x,startY:this._start.y,endX:this._end.x,endY:this._end.y}}getOverlaps(t){arguments.length>1&&void 0!==arguments[1]&&arguments[1];return t instanceof rn?rn.getOverlaps(this,t):null}static deserialize(t){return new rn(new Ge(t.startX,t.startY),new Ge(t.endX,t.endY))}static getOverlaps(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-6;const s=[],n=t._start.x,r=-1*t._start.x+t._end.x,a=t._start.y,h=-1*t._start.y+t._end.y,o=e._start.x,l=-1*e._start.x+e._end.x,u=e._start.y,m=-1*e._start.y+e._end.y,d=Math.abs(Math.max(t._start.x,t._end.x,e._start.x,e._end.x)-Math.min(t._start.x,t._end.x,e._start.x,e._end.x)),c=Math.abs(Math.max(t._start.y,t._end.y,e._start.y,e._end.y)-Math.min(t._start.y,t._end.y,e._start.y,e._end.y)),p=en.polynomialGetOverlapLinear(n,r,o,l),g=en.polynomialGetOverlapLinear(a,h,u,m);let f;if(f=d>c?null===p||!0===p?g:p:null===g||!0===g?p:g,null===f||!0===f)return s;const y=f.a,x=f.b,_=o+x*l-n,w=y*l-r,v=u+x*m-a,b=y*m-h;if(Math.abs(_)>i||Math.abs(w+_)>i||Math.abs(v)>i||Math.abs(b+v)>i)return s;const T=y+x;return x>1&&T>1||x<0&&T<0?s:[new $s(y,x)]}static intersect(t,e){const i=ni.lineSegmentIntersection(t.start.x,t.start.y,t.end.x,t.end.y,e.start.x,e.start.y,e.end.x,e.end.y);if(null!==i){const s=t.explicitClosestToPoint(i)[0].t,n=e.explicitClosestToPoint(i)[0].t;return[new Gs(i,s,n)]}return[]}static intersectOther(t,e){const i=t.end.minus(t.start),s=i.magnitude,n=new ls(t.start,i.normalize()),r=e.intersection(n),a=[];for(let h=0;h<r.length;h++){const t=r[h],e=t.distance/s;e>1e-8&&e<1-1e-8&&a.push(new Gs(t.point,e,t.t))}return a}}Bs.register("Line",rn);const an=ni.solveQuadraticRootsReal,hn=ni.arePointsCollinear;function on(t){return t>=0&&t<=1}class ln extends en{constructor(t,e,i){super(),this._start=t,this._control=e,this._end=i,this.invalidate()}setStart(t){return this._start.equals(t)||(this._start=t,this.invalidate()),this}set start(t){this.setStart(t)}get start(){return this.getStart()}getStart(){return this._start}setControl(t){return this._control.equals(t)||(this._control=t,this.invalidate()),this}set control(t){this.setControl(t)}get control(){return this.getControl()}getControl(){return this._control}setEnd(t){return this._end.equals(t)||(this._end=t,this.invalidate()),this}set end(t){this.setEnd(t)}get end(){return this.getEnd()}getEnd(){return this._end}positionAt(t){const e=1-t;return this._start.times(e*e).plus(this._control.times(2*e*t)).plus(this._end.times(t*t))}tangentAt(t){return this._control.minus(this._start).times(2*(1-t)).plus(this._end.minus(this._control).times(2*t))}curvatureAt(t){if(Math.abs(t-.5)>.5-1e-7){const e=t<.5,i=e?this._start:this._end,s=this._control,n=e?this._end:this._start,r=s.minus(i),a=r.magnitude;return(e?-1:1)*r.perpendicular.normalized().dot(n.minus(s))*(this.degree-1)/(this.degree*a*a)}return this.subdivided(t)[0].curvatureAt(1)}subdivided(t){if(0===t||1===t)return[this];const e=this._start.blend(this._control,t),i=this._control.blend(this._end,t),s=e.blend(i,t);return[new ln(this._start,e,s),new ln(s,i,this._end)]}invalidate(){this._startTangent=null,this._endTangent=null,this._tCriticalX=null,this._tCriticalY=null,this._bounds=null,this._svgPathFragment=null,this.invalidationEmitter.emit()}getStartTangent(){if(null===this._startTangent){const t=this._start.equals(this._control);this._startTangent=t?this._end.minus(this._start).normalized():this._control.minus(this._start).normalized()}return this._startTangent}get startTangent(){return this.getStartTangent()}getEndTangent(){if(null===this._endTangent){const t=this._end.equals(this._control);this._endTangent=t?this._end.minus(this._start).normalized():this._end.minus(this._control).normalized()}return this._endTangent}get endTangent(){return this.getEndTangent()}getTCriticalX(){return null===this._tCriticalX&&(this._tCriticalX=ln.extremaT(this._start.x,this._control.x,this._end.x)),this._tCriticalX}get tCriticalX(){return this.getTCriticalX()}getTCriticalY(){return null===this._tCriticalY&&(this._tCriticalY=ln.extremaT(this._start.y,this._control.y,this._end.y)),this._tCriticalY}get tCriticalY(){return this.getTCriticalY()}getNondegenerateSegments(){const t=this._start,e=this._control,i=this._end,s=t.equals(i),n=t.equals(e),r=t.equals(e);if(s&&n)return[];if(s){const e=this.positionAt(.5);return[new rn(t,e),new rn(e,i)]}if(hn(t,e,i)){if(n||r)return[new rn(t,i)];const s=i.minus(t),a=e.minus(t).dot(s.normalized())/s.magnitude,h=ln.extremaT(0,a,1);if(!isNaN(h)&&h>0&&h<1){const e=this.positionAt(h);return _.flatten([new rn(t,e).getNondegenerateSegments(),new rn(e,i).getNondegenerateSegments()])}return[new rn(t,i)]}return[this]}getBounds(){if(null===this._bounds){this._bounds=new ui(Math.min(this._start.x,this._end.x),Math.min(this._start.y,this._end.y),Math.max(this._start.x,this._end.x),Math.max(this._start.y,this._end.y));const t=this.getTCriticalX(),e=this.getTCriticalY();!isNaN(t)&&t>0&&t<1&&(this._bounds=this._bounds.withPoint(this.positionAt(t))),!isNaN(e)&&e>0&&e<1&&(this._bounds=this._bounds.withPoint(this.positionAt(e)))}return this._bounds}get bounds(){return this.getBounds()}offsetTo(t,e){let i=[this];for(let n=0;n<5;n++)i=_.flatten(_.map(i,t=>t.subdivided(.5)));let s=_.map(i,e=>e.approximateOffset(t));return e&&(s.reverse(),s=_.map(s,t=>t.reversed())),s}degreeElevated(){return new yn(this._start,this._start.plus(this._control.timesScalar(2)).dividedScalar(3),this._end.plus(this._control.timesScalar(2)).dividedScalar(3),this._end)}approximateOffset(t){return new ln(this._start.plus((this._start.equals(this._control)?this._end.minus(this._start):this._control.minus(this._start)).perpendicular.normalized().times(t)),this._control.plus(this._end.minus(this._start).perpendicular.normalized().times(t)),this._end.plus((this._end.equals(this._control)?this._end.minus(this._start):this._end.minus(this._control)).perpendicular.normalized().times(t)))}getSVGPathFragment(){return this._svgPathFragment||(this._svgPathFragment=`Q ${Qs(this._control.x)} ${Qs(this._control.y)} ${Qs(this._end.x)} ${Qs(this._end.y)}`),this._svgPathFragment}strokeLeft(t){return this.offsetTo(-t/2,!1)}strokeRight(t){return this.offsetTo(t/2,!0)}getInteriorExtremaTs(){const t=[],e=this.getTCriticalX(),i=this.getTCriticalY();return!isNaN(e)&&e>1e-10&&e<1-1e-10&&t.push(this.tCriticalX),!isNaN(i)&&i>1e-10&&i<1-1e-10&&t.push(this.tCriticalY),t.sort()}intersection(t){const e=[],i=ts.rotation2(-t.direction.angle).timesMatrix(ts.translation(-t.position.x,-t.position.y)),s=i.timesVector2(this._start),n=i.timesVector2(this._control),r=i.timesVector2(this._end),a=s.y-2*n.y+r.y,h=-2*s.y+2*n.y,o=s.y,l=an(a,h,o);return _.each(l,i=>{if(i>=0&&i<=1){const s=this.positionAt(i),n=this.tangentAt(i).normalized(),r=n.perpendicular,a=s.minus(t.position);if(a.dot(t.direction)>0){const h=r.dot(t.direction)>0?r.negated():r,o=t.direction.perpendicular.dot(n)<0?1:-1;e.push(new Us(a.magnitude,s,h,o,i))}}}),e}windingIntersection(t){let e=0;const i=this.intersection(t);return _.each(i,t=>{e+=t.wind}),e}writeToContext(t){t.quadraticCurveTo(this._control.x,this._control.y,this._end.x,this._end.y)}transformed(t){return new ln(t.timesVector2(this._start),t.timesVector2(this._control),t.timesVector2(this._end))}getSignedAreaFragment(){return 1/6*(this._start.x*(2*this._control.y+this._end.y)+this._control.x*(-2*this._start.y+2*this._end.y)+this._end.x*(-this._start.y-2*this._control.y))}reparameterized(t,e){const i=this._start.plus(this._end.plus(this._control.timesScalar(-2))),s=this._control.minus(this._start).timesScalar(2),n=this._start,r=i.timesScalar(t*t),a=i.timesScalar(t*e).timesScalar(2).plus(s.timesScalar(t)),h=i.timesScalar(e*e).plus(s.timesScalar(e)).plus(n);return new ln(h,a.timesScalar(.5).plus(h),r.plus(a).plus(h))}reversed(){return new ln(this._end,this._control,this._start)}serialize(){return{type:"Quadratic",startX:this._start.x,startY:this._start.y,controlX:this._control.x,controlY:this._control.y,endX:this._end.x,endY:this._end.y}}getOverlaps(t){arguments.length>1&&void 0!==arguments[1]&&arguments[1];return t instanceof ln?ln.getOverlaps(this,t):null}static deserialize(t){return new ln(new Ge(t.startX,t.startY),new Ge(t.controlX,t.controlY),new Ge(t.endX,t.endY))}static extremaT(t,e,i){const s=2*(i-2*e+t);return 0!==s?-2*(e-t)/s:NaN}static getOverlaps(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-6;const s=[],n=t._start.x,r=-2*t._start.x+2*t._control.x,a=t._start.x-2*t._control.x+t._end.x,h=t._start.y,o=-2*t._start.y+2*t._control.y,l=t._start.y-2*t._control.y+t._end.y,u=e._start.x,m=-2*e._start.x+2*e._control.x,d=e._start.x-2*e._control.x+e._end.x,c=e._start.y,p=-2*e._start.y+2*e._control.y,g=e._start.y-2*e._control.y+e._end.y,f=Math.abs(Math.max(t._start.x,t._control.x,t._end.x,e._start.x,e._control.x,e._end.x)-Math.min(t._start.x,t._control.x,t._end.x,e._start.x,e._control.x,e._end.x)),y=Math.abs(Math.max(t._start.y,t._control.y,t._end.y,e._start.y,e._control.y,e._end.y)-Math.min(t._start.y,t._control.y,t._end.y,e._start.y,e._control.y,e._end.y)),x=en.polynomialGetOverlapQuadratic(n,r,a,u,m,d),w=en.polynomialGetOverlapQuadratic(h,o,l,c,p,g);let v;if(v=f>y?null===x||!0===x?w:x:null===w||!0===w?x:w,null===v||!0===v)return s;const b=v.a,T=v.b,E=b*b,A=T*T,M=2*b*T,P=u+T*m+A*d-n,I=b*m+M*d-r,S=E*d-a,O=c+T*p+A*g-h,V=b*p+M*g-o,N=E*g-l,D=ni.solveLinearRootsReal(2*S,I),Y=ni.solveLinearRootsReal(2*N,V),C=_.uniq([0,1].concat(D?D.filter(on):[])),X=_.uniq([0,1].concat(Y?Y.filter(on):[]));for(let _=0;_<C.length;_++){const t=C[_];if(Math.abs((S*t+I)*t+P)>i)return s}for(let _=0;_<X.length;_++){const t=X[_];if(Math.abs((N*t+V)*t+O)>i)return s}const F=b+T;return T>1&&F>1||T<0&&F<0?s:[new $s(b,T)]}}ln.prototype.degree=2,Bs.register("Quadratic",ln);const un=ni.solveQuadraticRootsReal,mn=ni.solveCubicRootsReal,dn=ni.arePointsCollinear,cn=new Ge(0,0),pn=new Ge(0,0),gn=new Ge(0,0);function fn(t){return t>=0&&t<=1}class yn extends en{constructor(t,e,i,s){super(),this._start=t,this._control1=e,this._control2=i,this._end=s,this.invalidate()}setStart(t){return this._start.equals(t)||(this._start=t,this.invalidate()),this}set start(t){this.setStart(t)}get start(){return this.getStart()}getStart(){return this._start}setControl1(t){return this._control1.equals(t)||(this._control1=t,this.invalidate()),this}set control1(t){this.setControl1(t)}get control1(){return this.getControl1()}getControl1(){return this._control1}setControl2(t){return this._control2.equals(t)||(this._control2=t,this.invalidate()),this}set control2(t){this.setControl2(t)}get control2(){return this.getControl2()}getControl2(){return this._control2}setEnd(t){return this._end.equals(t)||(this._end=t,this.invalidate()),this}set end(t){this.setEnd(t)}get end(){return this.getEnd()}getEnd(){return this._end}positionAt(t){const e=1-t,i=e*e*e,s=3*e*e*t,n=3*e*t*t,r=t*t*t;return new Ge(this._start.x*i+this._control1.x*s+this._control2.x*n+this._end.x*r,this._start.y*i+this._control1.y*s+this._control2.y*n+this._end.y*r)}tangentAt(t){const e=1-t;return new Ge(0,0).set(this._start).multiplyScalar(-3*e*e).add(cn.set(this._control1).multiplyScalar(3*e*e-6*e*t)).add(cn.set(this._control2).multiplyScalar(6*e*t-3*t*t)).add(cn.set(this._end).multiplyScalar(3*t*t))}curvatureAt(t){if(Math.abs(t-.5)>.5-1e-7){const e=t<.5,i=e?this._start:this._end,s=e?this._control1:this._control2,n=e?this._control2:this._control1,r=s.minus(i),a=r.magnitude;return(e?-1:1)*r.perpendicular.normalized().dot(n.minus(s))*(this.degree-1)/(this.degree*a*a)}return this.subdivided(t)[0].curvatureAt(1)}subdivided(t){if(0===t||1===t)return[this];const e=this._start.blend(this._control1,t),i=this._control2.blend(this._end,t),s=this._control1.blend(this._control2,t),n=e.blend(s,t),r=s.blend(i,t),a=n.blend(r,t);return[new yn(this._start,e,n,a),new yn(a,r,i,this._end)]}invalidate(){this._startTangent=null,this._endTangent=null,this._r=null,this._s=null,this._tCusp=null,this._tDeterminant=null,this._tInflection1=null,this._tInflection2=null,this._quadratics=null,this._xExtremaT=null,this._yExtremaT=null,this._bounds=null,this._svgPathFragment=null,this.invalidationEmitter.emit()}getStartTangent(){return null===this._startTangent&&(this._startTangent=this.tangentAt(0).normalized()),this._startTangent}get startTangent(){return this.getStartTangent()}getEndTangent(){return null===this._endTangent&&(this._endTangent=this.tangentAt(1).normalized()),this._endTangent}get endTangent(){return this.getEndTangent()}getR(){return null===this._r&&(this._r=this._control1.minus(this._start).normalized()),this._r}get r(){return this.getR()}getS(){return null===this._s&&(this._s=this.getR().perpendicular),this._s}get s(){return this.getS()}getTCusp(){return null===this._tCusp&&this.computeCuspInfo(),this._tCusp}get tCusp(){return this.getTCusp()}getTDeterminant(){return null===this._tDeterminant&&this.computeCuspInfo(),this._tDeterminant}get tDeterminant(){return this.getTDeterminant()}getTInflection1(){return null===this._tInflection1&&this.computeCuspInfo(),this._tInflection1}get tInflection1(){return this.getTInflection1()}getTInflection2(){return null===this._tInflection2&&this.computeCuspInfo(),this._tInflection2}get tInflection2(){return this.getTInflection2()}getQuadratics(){return null===this._quadratics&&this.computeCuspSegments(),this._quadratics}getXExtremaT(){return null===this._xExtremaT&&(this._xExtremaT=yn.extremaT(this._start.x,this._control1.x,this._control2.x,this._end.x)),this._xExtremaT}get xExtremaT(){return this.getXExtremaT()}getYExtremaT(){return null===this._yExtremaT&&(this._yExtremaT=yn.extremaT(this._start.y,this._control1.y,this._control2.y,this._end.y)),this._yExtremaT}get yExtremaT(){return this.getYExtremaT()}getBounds(){return null===this._bounds&&(this._bounds=ui.NOTHING,this._bounds=this._bounds.withPoint(this._start),this._bounds=this._bounds.withPoint(this._end),_.each(this.getXExtremaT(),t=>{t>=0&&t<=1&&(this._bounds=this._bounds.withPoint(this.positionAt(t)))}),_.each(this.getYExtremaT(),t=>{t>=0&&t<=1&&(this._bounds=this._bounds.withPoint(this.positionAt(t)))}),this.hasCusp()&&(this._bounds=this._bounds.withPoint(this.positionAt(this.getTCusp())))),this._bounds}get bounds(){return this.getBounds()}computeCuspInfo(){const t=this._start.times(-1).plus(this._control1.times(3)).plus(this._control2.times(-3)).plus(this._end),e=this._start.times(3).plus(this._control1.times(-6)).plus(this._control2.times(3)),i=this._start.times(-3).plus(this._control1.times(3)),s=t.perpendicular,n=e.perpendicular,r=s.dot(e);if(this._tCusp=s.dot(i)/r*-.5,this._tDeterminant=this._tCusp*this._tCusp-1/3*(n.dot(i)/r),this._tDeterminant>=0){const t=Math.sqrt(this._tDeterminant);this._tInflection1=this._tCusp-t,this._tInflection2=this._tCusp+t}else this._tInflection1=NaN,this._tInflection2=NaN}computeCuspSegments(){if(this.hasCusp()){this._quadratics=[];const t=this.getTCusp();if(0===t)this._quadratics.push(new ln(this.start,this.control2,this.end));else if(1===t)this._quadratics.push(new ln(this.start,this.control1,this.end));else{const e=this.subdivided(t);this._quadratics.push(new ln(e[0].start,e[0].control1,e[0].end)),this._quadratics.push(new ln(e[1].start,e[1].control2,e[1].end))}}else this._quadratics=null}getNondegenerateSegments(){const t=this._start,e=this._control1,i=this._control2,s=this._end,n=this.degreeReduced(1e-9);if(t.equals(s)&&t.equals(e)&&t.equals(i))return[];if(this.hasCusp())return _.flatten(this.getQuadratics().map(t=>t.getNondegenerateSegments()));if(n)return n.getNondegenerateSegments();if(dn(t,e,s)&&dn(t,i,s)&&!t.equalsEpsilon(s,1e-7)){const e=this.getXExtremaT().concat(this.getYExtremaT()).sort().map(t=>this.positionAt(t)),i=[];let n=t;e.length&&(i.push(new rn(t,e[0])),n=e[0]);for(let t=1;t<e.length;t++)i.push(new rn(e[t-1],e[t])),n=e[t];return i.push(new rn(n,s)),_.flatten(i.map(t=>t.getNondegenerateSegments()))}return[this]}hasCusp(){const t=this.getTCusp();return t>=0&&t<=1&&this.tangentAt(t).magnitude<1e-7}toRS(t){const e=t.minus(this._start);return new Ge(e.dot(this.getR()),e.dot(this.getS()))}offsetTo(t,e){const i=[],s=[];for(let n=0;n<32;n++){let r=n/31;e&&(r=1-r),i.push(this.positionAt(r).plus(this.tangentAt(r).perpendicular.normalized().times(t))),n>0&&s.push(new rn(i[n-1],i[n]))}return s}getSVGPathFragment(){return this._svgPathFragment||(this._svgPathFragment=`C ${Qs(this._control1.x)} ${Qs(this._control1.y)} ${Qs(this._control2.x)} ${Qs(this._control2.y)} ${Qs(this._end.x)} ${Qs(this._end.y)}`),this._svgPathFragment}strokeLeft(t){return this.offsetTo(-t/2,!1)}strokeRight(t){return this.offsetTo(t/2,!0)}getInteriorExtremaTs(){const t=this.getXExtremaT().concat(this.getYExtremaT()),e=[];return _.each(t,t=>{t>1e-10&&t<1-1e-10&&_.every(e,e=>Math.abs(t-e)>1e-10)&&e.push(t)}),e.sort()}intersection(t){const e=[],i=ts.rotation2(-t.direction.angle).timesMatrix(ts.translation(-t.position.x,-t.position.y)),s=i.timesVector2(this._start),n=i.timesVector2(this._control1),r=i.timesVector2(this._control2),a=i.timesVector2(this._end),h=-s.y+3*n.y-3*r.y+a.y,o=3*s.y-6*n.y+3*r.y,l=-3*s.y+3*n.y,u=s.y,m=mn(h,o,l,u);return _.each(m,i=>{if(i>=0&&i<=1){const s=this.positionAt(i),n=this.tangentAt(i).normalized(),r=n.perpendicular,a=s.minus(t.position);if(a.dot(t.direction)>0){const h=r.dot(t.direction)>0?r.negated():r,o=t.direction.perpendicular.dot(n)<0?1:-1;e.push(new Us(a.magnitude,s,h,o,i))}}}),e}windingIntersection(t){let e=0;const i=this.intersection(t);return _.each(i,t=>{e+=t.wind}),e}writeToContext(t){t.bezierCurveTo(this._control1.x,this._control1.y,this._control2.x,this._control2.y,this._end.x,this._end.y)}transformed(t){return new yn(t.timesVector2(this._start),t.timesVector2(this._control1),t.timesVector2(this._control2),t.timesVector2(this._end))}degreeReduced(t){t=t||0;const e=cn.set(this._control1).multiplyScalar(3).subtract(this._start).divideScalar(2),i=pn.set(this._control2).multiplyScalar(3).subtract(this._end).divideScalar(2);return gn.set(e).subtract(i).magnitude<=t?new ln(this._start,e.average(i),this._end):null}getSignedAreaFragment(){return.05*(this._start.x*(6*this._control1.y+3*this._control2.y+this._end.y)+this._control1.x*(-6*this._start.y+3*this._control2.y+3*this._end.y)+this._control2.x*(-3*this._start.y-3*this._control1.y+6*this._end.y)+this._end.x*(-this._start.y-3*this._control1.y-6*this._control2.y))}reversed(){return new yn(this._end,this._control2,this._control1,this._start)}getSelfIntersection(){const t=this.getInteriorExtremaTs(),e=[0].concat(t).concat([1]),i=this.subdivisions(t);if(i.length<3)return null;for(let s=0;s<i.length;s++){const t=i[s];for(let n=s+1;n<i.length;n++){const r=i[n],a=jn.intersect(t,r);if(a.length){const t=a[0];if(t.aT>1e-7&&t.aT<1-1e-7&&t.bT>1e-7&&t.bT<1-1e-7){const i=e[s]+t.aT*(e[s+1]-e[s]),r=e[n]+t.bT*(e[n+1]-e[n]);return new Gs(t.point,i,r)}}}}return null}serialize(){return{type:"Cubic",startX:this._start.x,startY:this._start.y,control1X:this._control1.x,control1Y:this._control1.y,control2X:this._control2.x,control2Y:this._control2.y,endX:this._end.x,endY:this._end.y}}getOverlaps(t){arguments.length>1&&void 0!==arguments[1]&&arguments[1];return t instanceof yn?yn.getOverlaps(this,t):null}static deserialize(t){return new yn(new Ge(t.startX,t.startY),new Ge(t.control1X,t.control1Y),new Ge(t.control2X,t.control2Y),new Ge(t.endX,t.endY))}static extremaT(t,e,i,s){if(t===e&&t===i&&t===s)return[];const n=-3*t+9*e-9*i+3*s,r=6*t-12*e+6*i,a=-3*t+3*e;return _.filter(un(n,r,a),fn)}static getOverlaps(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-6;const s=[],n=t._start.x,r=-3*t._start.x+3*t._control1.x,a=3*t._start.x-6*t._control1.x+3*t._control2.x,h=-1*t._start.x+3*t._control1.x-3*t._control2.x+t._end.x,o=t._start.y,l=-3*t._start.y+3*t._control1.y,u=3*t._start.y-6*t._control1.y+3*t._control2.y,m=-1*t._start.y+3*t._control1.y-3*t._control2.y+t._end.y,d=e._start.x,c=-3*e._start.x+3*e._control1.x,p=3*e._start.x-6*e._control1.x+3*e._control2.x,g=-1*e._start.x+3*e._control1.x-3*e._control2.x+e._end.x,f=e._start.y,y=-3*e._start.y+3*e._control1.y,x=3*e._start.y-6*e._control1.y+3*e._control2.y,w=-1*e._start.y+3*e._control1.y-3*e._control2.y+e._end.y,v=Math.abs(Math.max(t._start.x,t._control1.x,t._control2.x,t._end.x,t._start.x,t._control1.x,t._control2.x,t._end.x)-Math.min(t._start.x,t._control1.x,t._control2.x,t._end.x,t._start.x,t._control1.x,t._control2.x,t._end.x)),b=Math.abs(Math.max(t._start.y,t._control1.y,t._control2.y,t._end.y,t._start.y,t._control1.y,t._control2.y,t._end.y)-Math.min(t._start.y,t._control1.y,t._control2.y,t._end.y,t._start.y,t._control1.y,t._control2.y,t._end.y)),T=en.polynomialGetOverlapCubic(n,r,a,h,d,c,p,g),E=en.polynomialGetOverlapCubic(o,l,u,m,f,y,x,w);let A;if(A=v>b?null===T||!0===T?E:T:null===E||!0===E?T:E,null===A||!0===A)return s;const M=A.a,P=A.b,I=M*M,S=M*M*M,O=P*P,V=P*P*P,N=2*M*P,D=3*M*O,Y=3*I*P,C=d+P*c+O*p+V*g-n,X=M*c+N*p+D*g-r,F=I*p+Y*g-a,R=S*g-h,L=f+P*y+O*x+V*w-o,z=M*y+N*x+D*w-l,k=I*x+Y*w-u,q=S*w-m,B=ni.solveQuadraticRootsReal(3*R,2*F,X),Z=ni.solveQuadraticRootsReal(3*q,2*k,z),j=_.uniq([0,1].concat(null!==B?B.filter(fn):[])),H=_.uniq([0,1].concat(null!==Z?Z.filter(fn):[]));for(let _=0;_<j.length;_++){const t=j[_];if(Math.abs(((R*t+F)*t+X)*t+C)>i)return s}for(let _=0;_<H.length;_++){const t=H[_];if(Math.abs(((q*t+k)*t+z)*t+L)>i)return s}const $=M+P;return P>1&&$>1||P<0&&$<0?s:[new $s(M,P)]}}yn.prototype.degree=3,Bs.register("Cubic",yn);const xn=2*Math.PI;class _n extends en{constructor(t,e,i,s,n){super(),this._center=t,this._radius=e,this._startAngle=i,this._endAngle=s,this._anticlockwise=n,this.invalidate()}setCenter(t){return this._center.equals(t)||(this._center=t,this.invalidate()),this}set center(t){this.setCenter(t)}get center(){return this.getCenter()}getCenter(){return this._center}setRadius(t){return this._radius!==t&&(this._radius=t,this.invalidate()),this}set radius(t){this.setRadius(t)}get radius(){return this.getRadius()}getRadius(){return this._radius}setStartAngle(t){return this._startAngle!==t&&(this._startAngle=t,this.invalidate()),this}set startAngle(t){this.setStartAngle(t)}get startAngle(){return this.getStartAngle()}getStartAngle(){return this._startAngle}setEndAngle(t){return this._endAngle!==t&&(this._endAngle=t,this.invalidate()),this}set endAngle(t){this.setEndAngle(t)}get endAngle(){return this.getEndAngle()}getEndAngle(){return this._endAngle}setAnticlockwise(t){return this._anticlockwise!==t&&(this._anticlockwise=t,this.invalidate()),this}set anticlockwise(t){this.setAnticlockwise(t)}get anticlockwise(){return this.getAnticlockwise()}getAnticlockwise(){return this._anticlockwise}positionAt(t){return this.positionAtAngle(this.angleAt(t))}tangentAt(t){return this.tangentAtAngle(this.angleAt(t))}curvatureAt(t){return(this._anticlockwise?-1:1)/this._radius}subdivided(t){if(0===t||1===t)return[this];const e=this.angleAt(0),i=this.angleAt(t),s=this.angleAt(1);return[new _n(this._center,this._radius,e,i,this._anticlockwise),new _n(this._center,this._radius,i,s,this._anticlockwise)]}invalidate(){this._start=null,this._end=null,this._startTangent=null,this._endTangent=null,this._actualEndAngle=null,this._isFullPerimeter=null,this._angleDifference=null,this._bounds=null,this._svgPathFragment=null,this._radius<0&&(this._radius=-this._radius,this._startAngle+=Math.PI,this._endAngle+=Math.PI),this.invalidationEmitter.emit()}getStart(){return null===this._start&&(this._start=this.positionAtAngle(this._startAngle)),this._start}get start(){return this.getStart()}getEnd(){return null===this._end&&(this._end=this.positionAtAngle(this._endAngle)),this._end}get end(){return this.getEnd()}getStartTangent(){return null===this._startTangent&&(this._startTangent=this.tangentAtAngle(this._startAngle)),this._startTangent}get startTangent(){return this.getStartTangent()}getEndTangent(){return null===this._endTangent&&(this._endTangent=this.tangentAtAngle(this._endAngle)),this._endTangent}get endTangent(){return this.getEndTangent()}getActualEndAngle(){return null===this._actualEndAngle&&(this._actualEndAngle=_n.computeActualEndAngle(this._startAngle,this._endAngle,this._anticlockwise)),this._actualEndAngle}get actualEndAngle(){return this.getActualEndAngle()}getIsFullPerimeter(){return null===this._isFullPerimeter&&(this._isFullPerimeter=!this._anticlockwise&&this._endAngle-this._startAngle>=2*Math.PI||this._anticlockwise&&this._startAngle-this._endAngle>=2*Math.PI),this._isFullPerimeter}get isFullPerimeter(){return this.getIsFullPerimeter()}getAngleDifference(){return null===this._angleDifference&&(this._angleDifference=this._anticlockwise?this._startAngle-this._endAngle:this._endAngle-this._startAngle,this._angleDifference<0&&(this._angleDifference+=2*Math.PI)),this._angleDifference}get angleDifference(){return this.getAngleDifference()}getBounds(){return null===this._bounds&&(this._bounds=ui.NOTHING.copy().withPoint(this.getStart()).withPoint(this.getEnd()),this._startAngle!==this._endAngle&&(this.includeBoundsAtAngle(0),this.includeBoundsAtAngle(Math.PI/2),this.includeBoundsAtAngle(Math.PI),this.includeBoundsAtAngle(3*Math.PI/2))),this._bounds}get bounds(){return this.getBounds()}getNondegenerateSegments(){return this._radius<=0||this._startAngle===this._endAngle?[]:[this]}includeBoundsAtAngle(t){this.containsAngle(t)&&(this._bounds=this._bounds.withPoint(this._center.plus(Ge.createPolar(this._radius,t))))}mapAngle(t){return Math.abs(ni.moduloBetweenDown(t-this._startAngle,-Math.PI,Math.PI))<1e-8?this._startAngle:Math.abs(ni.moduloBetweenDown(t-this.getActualEndAngle(),-Math.PI,Math.PI))<1e-8?this.getActualEndAngle():this._startAngle>this.getActualEndAngle()?ni.moduloBetweenUp(t,this._startAngle-2*Math.PI,this._startAngle):ni.moduloBetweenDown(t,this._startAngle,this._startAngle+2*Math.PI)}tAtAngle(t){const e=(this.mapAngle(t)-this._startAngle)/(this.getActualEndAngle()-this._startAngle);return e}angleAt(t){return this._startAngle+(this.getActualEndAngle()-this._startAngle)*t}positionAtAngle(t){return this._center.plus(Ge.createPolar(this._radius,t))}tangentAtAngle(t){const e=Ge.createPolar(1,t);return this._anticlockwise?e.perpendicular:e.perpendicular.negated()}containsAngle(t){const e=this._anticlockwise?t-this._endAngle:t-this._startAngle;return ni.moduloBetweenDown(e,0,2*Math.PI)<=this.angleDifference}getSVGPathFragment(){if(!this._svgPathFragment){const t=.01,e=this._anticlockwise?"0":"1";let i;if(this.angleDifference<2*Math.PI-t)i=this.angleDifference<Math.PI?"0":"1",this._svgPathFragment=`A ${Qs(this._radius)} ${Qs(this._radius)} 0 ${i} ${e} ${Qs(this.end.x)} ${Qs(this.end.y)}`;else{const t=(this._startAngle+this._endAngle)/2,s=this._center.plus(Ge.createPolar(this._radius,t));i="0";const n=`A ${Qs(this._radius)} ${Qs(this._radius)} 0 ${i} ${e} ${Qs(s.x)} ${Qs(s.y)}`,r=`A ${Qs(this._radius)} ${Qs(this._radius)} 0 ${i} ${e} ${Qs(this.end.x)} ${Qs(this.end.y)}`;this._svgPathFragment=`${n} ${r}`}}return this._svgPathFragment}strokeLeft(t){return[new _n(this._center,this._radius+(this._anticlockwise?1:-1)*t/2,this._startAngle,this._endAngle,this._anticlockwise)]}strokeRight(t){return[new _n(this._center,this._radius+(this._anticlockwise?-1:1)*t/2,this._endAngle,this._startAngle,!this._anticlockwise)]}getInteriorExtremaTs(){const t=[];return _.each([0,Math.PI/2,Math.PI,3*Math.PI/2],e=>{if(this.containsAngle(e)){const i=this.tAtAngle(e),s=1e-10;i>s&&i<1-s&&t.push(i)}}),t.sort()}intersection(t){const e=[],i=t.position.minus(this._center),s=t.direction.dot(i),n=4*s*s-4*(i.magnitudeSquared-this._radius*this._radius);if(n<0)return e;const r=t.direction.dot(this._center)-t.direction.dot(t.position),a=Math.sqrt(n)/2,h=r-a,o=r+a;if(o<0)return e;const l=t.pointAtDistance(o),u=l.minus(this._center).normalized(),m=u.angle;if(h<0)this.containsAngle(m)&&e.push(new Us(o,l,u.negated(),this._anticlockwise?-1:1,this.tAtAngle(m)));else{const i=t.pointAtDistance(h),s=i.minus(this._center).normalized(),n=s.angle;this.containsAngle(n)&&e.push(new Us(h,i,s,this._anticlockwise?1:-1,this.tAtAngle(n))),this.containsAngle(m)&&e.push(new Us(o,l,u.negated(),this._anticlockwise?-1:1,this.tAtAngle(m)))}return e}windingIntersection(t){let e=0;const i=this.intersection(t);return _.each(i,t=>{e+=t.wind}),e}writeToContext(t){t.arc(this._center.x,this._center.y,this._radius,this._startAngle,this._endAngle,this._anticlockwise)}transformed(t){const e=t.timesVector2(Ge.createPolar(1,this._startAngle)).minus(t.timesVector2(Ge.ZERO)).angle;let i=t.timesVector2(Ge.createPolar(1,this._endAngle)).minus(t.timesVector2(Ge.ZERO)).angle;const s=t.getDeterminant()>=0?this._anticlockwise:!this._anticlockwise;Math.abs(this._endAngle-this._startAngle)===2*Math.PI&&(i=s?e-2*Math.PI:e+2*Math.PI);const n=t.getScaleVector();if(n.x!==n.y){const r=n.x*this._radius,a=n.y*this._radius;return new vn(t.timesVector2(this._center),r,a,0,e,i,s)}{const r=n.x*this._radius;return new _n(t.timesVector2(this._center),r,e,i,s)}}getSignedAreaFragment(){const t=this._startAngle,e=this.getActualEndAngle();return.5*this._radius*(this._radius*(e-t)+this._center.x*(Math.sin(e)-Math.sin(t))-this._center.y*(Math.cos(e)-Math.cos(t)))}reversed(){return new _n(this._center,this._radius,this._endAngle,this._startAngle,!this._anticlockwise)}getArcLength(){return this.getAngleDifference()*this._radius}toPiecewiseLinearOrArcSegments(){return[this]}serialize(){return{type:"Arc",centerX:this._center.x,centerY:this._center.y,radius:this._radius,startAngle:this._startAngle,endAngle:this._endAngle,anticlockwise:this._anticlockwise}}getOverlaps(t){arguments.length>1&&void 0!==arguments[1]&&arguments[1];return t instanceof _n?_n.getOverlaps(this,t):null}static deserialize(t){return new _n(new Ge(t.centerX,t.centerY),t.radius,t.startAngle,t.endAngle,t.anticlockwise)}static computeActualEndAngle(t,e,i){return i?t>e?e:t<e?e-2*Math.PI:t:t<e?e:t>e?e+2*Math.PI:t}static getPartialOverlap(t,e,i,s,n){const r=i<e,a=r?e:i,h=r?i:e,o=Math.min(t,a);return o<h+1e-8?[]:[$s.createLinear(ni.clamp(ni.linear(0,t,0,1,h),0,1),ni.clamp(ni.linear(e,i,s,n,h),0,1),ni.clamp(ni.linear(0,t,0,1,o),0,1),ni.clamp(ni.linear(e,i,s,n,o),0,1))]}static getAngularOverlaps(t,e,i,s){let n=e-t;const r=n<0?-1:1;n*=r;const a=ni.moduloBetweenDown(r*(i-t),0,xn),h=r*(s-i)+a;let o;return h<-1e-10?(o=-a/(h-a),_n.getPartialOverlap(n,a,0,0,o).concat(_n.getPartialOverlap(n,xn,h+xn,o,1))):h>xn+1e-10?(o=(xn-a)/(h-a),_n.getPartialOverlap(n,a,xn,0,o).concat(_n.getPartialOverlap(n,0,h-xn,o,1))):_n.getPartialOverlap(n,a,h,0,1)}static getOverlaps(t,e){return t._center.distance(e._center)>1e-8||Math.abs(t._radius-e._radius)>1e-8?[]:_n.getAngularOverlaps(t._startAngle,t.getActualEndAngle(),e._startAngle,e.getActualEndAngle())}static getCircleIntersectionPoint(t,e,i,s){const n=i.minus(t),r=n.magnitude;let a=[];if(r<1e-10||r>e+s+1e-10);else if(r>e+s-1e-10)a=[t.blend(i,e/r)];else{const h=.5*(r*r-s*s+e*e)/r,o=r*r-s*s+e*e,l=4*r*r*e*e-o*o,u=t.blend(i,h/r);if(l>=1e-10){const t=Math.sqrt(l)/r/2,e=n.perpendicular.setMagnitude(t);a=[u.plus(e),u.minus(e)]}else l>-1e-10&&(a=[u])}return a}static intersect(t,e){const i=[];if(t._center.equalsEpsilon(e._center,1e-8)&&Math.abs(t._radius-e._radius)<1e-8){const s=t.positionAt(0),n=t.positionAt(1),r=e.positionAt(0),a=e.positionAt(1);s.equalsEpsilon(r,1e-8)&&i.push(new Gs(s.average(r),0,0)),s.equalsEpsilon(a,1e-8)&&i.push(new Gs(s.average(a),0,1)),n.equalsEpsilon(r,1e-8)&&i.push(new Gs(n.average(r),1,0)),n.equalsEpsilon(a,1e-8)&&i.push(new Gs(n.average(a),1,1))}else{const s=_n.getCircleIntersectionPoint(t._center,t._radius,e._center,e._radius);for(let n=0;n<s.length;n++){const r=s[n],a=r.minus(t._center).angle,h=r.minus(e._center).angle;t.containsAngle(a)&&e.containsAngle(h)&&i.push(new Gs(r,t.tAtAngle(a),e.tAtAngle(h)))}}return i}static createFromPoints(t,e,i){const s=ni.circleCenterFromPoints(t,e,i);if(null===s)return new rn(t,i);{const n=t.minus(s),r=e.minus(s),a=i.minus(s),h=n.angle,o=r.angle,l=a.angle,u=(n.magnitude+r.magnitude+a.magnitude)/3,m=new _n(s,u,h,l,!1);return m.containsAngle(o)?m:new _n(s,u,h,l,!0)}}}Bs.register("Arc",_n);const wn=ni.toDegrees;class vn extends en{constructor(t,e,i,s,n,r,a){super(),this._center=t,this._radiusX=e,this._radiusY=i,this._rotation=s,this._startAngle=n,this._endAngle=r,this._anticlockwise=a,this.invalidate()}setCenter(t){return this._center.equals(t)||(this._center=t,this.invalidate()),this}set center(t){this.setCenter(t)}get center(){return this.getCenter()}getCenter(){return this._center}setRadiusX(t){return this._radiusX!==t&&(this._radiusX=t,this.invalidate()),this}set radiusX(t){this.setRadiusX(t)}get radiusX(){return this.getRadiusX()}getRadiusX(){return this._radiusX}setRadiusY(t){return this._radiusY!==t&&(this._radiusY=t,this.invalidate()),this}set radiusY(t){this.setRadiusY(t)}get radiusY(){return this.getRadiusY()}getRadiusY(){return this._radiusY}setRotation(t){return this._rotation!==t&&(this._rotation=t,this.invalidate()),this}set rotation(t){this.setRotation(t)}get rotation(){return this.getRotation()}getRotation(){return this._rotation}setStartAngle(t){return this._startAngle!==t&&(this._startAngle=t,this.invalidate()),this}set startAngle(t){this.setStartAngle(t)}get startAngle(){return this.getStartAngle()}getStartAngle(){return this._startAngle}setEndAngle(t){return this._endAngle!==t&&(this._endAngle=t,this.invalidate()),this}set endAngle(t){this.setEndAngle(t)}get endAngle(){return this.getEndAngle()}getEndAngle(){return this._endAngle}setAnticlockwise(t){return this._anticlockwise!==t&&(this._anticlockwise=t,this.invalidate()),this}set anticlockwise(t){this.setAnticlockwise(t)}get anticlockwise(){return this.getAnticlockwise()}getAnticlockwise(){return this._anticlockwise}positionAt(t){return this.positionAtAngle(this.angleAt(t))}tangentAt(t){return this.tangentAtAngle(this.angleAt(t))}curvatureAt(t){const e=this.angleAt(t),i=this._radiusX*Math.sin(e),s=this._radiusY*Math.cos(e),n=Math.pow(s*s+i*i,1.5);return(this._anticlockwise?-1:1)*this._radiusX*this._radiusY/n}subdivided(t){if(0===t||1===t)return[this];const e=this.angleAt(0),i=this.angleAt(t),s=this.angleAt(1);return[new vn(this._center,this._radiusX,this._radiusY,this._rotation,e,i,this._anticlockwise),new vn(this._center,this._radiusX,this._radiusY,this._rotation,i,s,this._anticlockwise)]}invalidate(){if(this._unitTransform=null,this._start=null,this._end=null,this._startTangent=null,this._endTangent=null,this._actualEndAngle=null,this._isFullPerimeter=null,this._angleDifference=null,this._unitArcSegment=null,this._bounds=null,this._svgPathFragment=null,this._radiusX<0&&(this._radiusX=-this._radiusX,this._startAngle=Math.PI-this._startAngle,this._endAngle=Math.PI-this._endAngle,this._anticlockwise=!this._anticlockwise),this._radiusY<0&&(this._radiusY=-this._radiusY,this._startAngle=-this._startAngle,this._endAngle=-this._endAngle,this._anticlockwise=!this._anticlockwise),this._radiusX<this._radiusY){this._rotation+=Math.PI/2,this._startAngle-=Math.PI/2,this._endAngle-=Math.PI/2;const t=this._radiusX;this._radiusX=this._radiusY,this._radiusY=t}if(this._radiusX<this._radiusY)throw new Error("Not verified to work if radiusX < radiusY");this.invalidationEmitter.emit()}getUnitTransform(){return null===this._unitTransform&&(this._unitTransform=vn.computeUnitTransform(this._center,this._radiusX,this._radiusY,this._rotation)),this._unitTransform}get unitTransform(){return this.getUnitTransform()}getStart(){return null===this._start&&(this._start=this.positionAtAngle(this._startAngle)),this._start}get start(){return this.getStart()}getEnd(){return null===this._end&&(this._end=this.positionAtAngle(this._endAngle)),this._end}get end(){return this.getEnd()}getStartTangent(){return null===this._startTangent&&(this._startTangent=this.tangentAtAngle(this._startAngle)),this._startTangent}get startTangent(){return this.getStartTangent()}getEndTangent(){return null===this._endTangent&&(this._endTangent=this.tangentAtAngle(this._endAngle)),this._endTangent}get endTangent(){return this.getEndTangent()}getActualEndAngle(){return null===this._actualEndAngle&&(this._actualEndAngle=_n.computeActualEndAngle(this._startAngle,this._endAngle,this._anticlockwise)),this._actualEndAngle}get actualEndAngle(){return this.getActualEndAngle()}getIsFullPerimeter(){return null===this._isFullPerimeter&&(this._isFullPerimeter=!this._anticlockwise&&this._endAngle-this._startAngle>=2*Math.PI||this._anticlockwise&&this._startAngle-this._endAngle>=2*Math.PI),this._isFullPerimeter}get isFullPerimeter(){return this.getIsFullPerimeter()}getAngleDifference(){return null===this._angleDifference&&(this._angleDifference=this._anticlockwise?this._startAngle-this._endAngle:this._endAngle-this._startAngle,this._angleDifference<0&&(this._angleDifference+=2*Math.PI)),this._angleDifference}get angleDifference(){return this.getAngleDifference()}getUnitArcSegment(){return null===this._unitArcSegment&&(this._unitArcSegment=new _n(Ge.ZERO,1,this._startAngle,this._endAngle,this._anticlockwise)),this._unitArcSegment}get unitArcSegment(){return this.getUnitArcSegment()}getBounds(){if(null===this._bounds&&(this._bounds=ui.NOTHING.withPoint(this.getStart()).withPoint(this.getEnd()),this._startAngle!==this._endAngle)){const t=Math.atan(-this._radiusY/this._radiusX*Math.tan(this._rotation)),e=Math.atan(this._radiusY/this._radiusX/Math.tan(this._rotation));this.possibleExtremaAngles=[t,t+Math.PI,e,e+Math.PI],_.each(this.possibleExtremaAngles,this.includeBoundsAtAngle.bind(this))}return this._bounds}get bounds(){return this.getBounds()}getNondegenerateSegments(){if(this._radiusX<=0||this._radiusY<=0||this._startAngle===this._endAngle)return[];if(this._radiusX===this._radiusY){const t=this._startAngle+this._rotation;let e=this._endAngle+this._rotation;return Math.abs(this._endAngle-this._startAngle)===2*Math.PI&&(e=this._anticlockwise?t-2*Math.PI:t+2*Math.PI),[new _n(this._center,this._radiusX,t,e,this._anticlockwise)]}return[this]}includeBoundsAtAngle(t){this.unitArcSegment.containsAngle(t)&&(this._bounds=this._bounds.withPoint(this.positionAtAngle(t)))}mapAngle(t){return Math.abs(ni.moduloBetweenDown(t-this._startAngle,-Math.PI,Math.PI))<1e-8?this._startAngle:Math.abs(ni.moduloBetweenDown(t-this.getActualEndAngle(),-Math.PI,Math.PI))<1e-8?this.getActualEndAngle():this._startAngle>this.getActualEndAngle()?ni.moduloBetweenUp(t,this._startAngle-2*Math.PI,this._startAngle):ni.moduloBetweenDown(t,this._startAngle,this._startAngle+2*Math.PI)}tAtAngle(t){return(this.mapAngle(t)-this._startAngle)/(this.getActualEndAngle()-this._startAngle)}angleAt(t){return this._startAngle+(this.getActualEndAngle()-this._startAngle)*t}positionAtAngle(t){return this.getUnitTransform().transformPosition2(Ge.createPolar(1,t))}tangentAtAngle(t){const e=this.getUnitTransform().transformNormal2(Ge.createPolar(1,t));return this._anticlockwise?e.perpendicular:e.perpendicular.negated()}offsetTo(t,e){const i=[],s=[];for(let n=0;n<32;n++){let r=n/31;e&&(r=1-r);const a=this.angleAt(r);i.push(this.positionAtAngle(a).plus(this.tangentAtAngle(a).perpendicular.normalized().times(t))),n>0&&s.push(new rn(i[n-1],i[n]))}return s}getSVGPathFragment(){if(!this._svgPathFragment){const t=.01,e=this._anticlockwise?"0":"1";let i;const s=wn(this._rotation);if(this.getAngleDifference()<2*Math.PI-t)i=this.getAngleDifference()<Math.PI?"0":"1",this._svgPathFragment=`A ${Qs(this._radiusX)} ${Qs(this._radiusY)} ${s} ${i} ${e} ${Qs(this.getEnd().x)} ${Qs(this.getEnd().y)}`;else{const t=(this._startAngle+this._endAngle)/2,n=this.positionAtAngle(t);i="0";const r=`A ${Qs(this._radiusX)} ${Qs(this._radiusY)} ${s} ${i} ${e} ${Qs(n.x)} ${Qs(n.y)}`,a=`A ${Qs(this._radiusX)} ${Qs(this._radiusY)} ${s} ${i} ${e} ${Qs(this.getEnd().x)} ${Qs(this.getEnd().y)}`;this._svgPathFragment=`${r} ${a}`}}return this._svgPathFragment}strokeLeft(t){return this.offsetTo(-t/2,!1)}strokeRight(t){return this.offsetTo(t/2,!0)}getInteriorExtremaTs(){const t=[];return _.each(this.possibleExtremaAngles,e=>{if(this.unitArcSegment.containsAngle(e)){const i=this.tAtAngle(e),s=1e-10;i>s&&i<1-s&&t.push(i)}}),t.sort()}intersection(t){const e=this.getUnitTransform(),i=e.inverseRay2(t),s=this.getUnitArcSegment().intersection(i);return _.map(s,i=>{const s=e.transformPosition2(i.point),n=t.position.distance(s),r=e.inverseNormal2(i.normal);return new Us(n,s,r,i.wind,i.t)})}windingIntersection(t){const e=this.getUnitTransform().inverseRay2(t);return this.getUnitArcSegment().windingIntersection(e)}writeToContext(t){t.ellipse?t.ellipse(this._center.x,this._center.y,this._radiusX,this._radiusY,this._rotation,this._startAngle,this._endAngle,this._anticlockwise):(this.getUnitTransform().getMatrix().canvasAppendTransform(t),t.arc(0,0,1,this._startAngle,this._endAngle,this._anticlockwise),this.getUnitTransform().getInverse().canvasAppendTransform(t))}transformed(t){const e=t.timesVector2(Ge.createPolar(this._radiusX,this._rotation)).minus(t.timesVector2(Ge.ZERO)),i=t.timesVector2(Ge.createPolar(this._radiusY,this._rotation+Math.PI/2)).minus(t.timesVector2(Ge.ZERO)),s=e.angle,n=e.magnitude,r=i.magnitude,a=t.getDeterminant()<0,h=a?!this._anticlockwise:this._anticlockwise,o=a?-this._startAngle:this._startAngle;let l=a?-this._endAngle:this._endAngle;return Math.abs(this._endAngle-this._startAngle)===2*Math.PI&&(l=h?o-2*Math.PI:o+2*Math.PI),new vn(t.timesVector2(this._center),n,r,s,o,l,h)}getSignedAreaFragment(){const t=this._startAngle,e=this.getActualEndAngle(),i=Math.sin(t),s=Math.sin(e),n=Math.cos(t),r=Math.cos(e);return.5*(this._radiusX*this._radiusY*(e-t)+Math.cos(this._rotation)*(this._radiusX*this._center.y*(n-r)+this._radiusY*this._center.x*(s-i))+Math.sin(this._rotation)*(this._radiusX*this._center.x*(r-n)+this._radiusY*this._center.y*(s-i)))}reversed(){return new vn(this._center,this._radiusX,this._radiusY,this._rotation,this._endAngle,this._startAngle,!this._anticlockwise)}serialize(){return{type:"EllipticalArc",centerX:this._center.x,centerY:this._center.y,radiusX:this._radiusX,radiusY:this._radiusY,rotation:this._rotation,startAngle:this._startAngle,endAngle:this._endAngle,anticlockwise:this._anticlockwise}}getOverlaps(t){arguments.length>1&&void 0!==arguments[1]&&arguments[1];return t instanceof vn?vn.getOverlaps(this,t):null}static deserialize(t){return new vn(new Ge(t.centerX,t.centerY),t.radiusX,t.radiusY,t.rotation,t.startAngle,t.endAngle,t.anticlockwise)}static getOverlapType(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-10;if(t._center.distance(e._center)<i){const s=Math.abs(t._radiusX-e._radiusX)<i&&Math.abs(t._radiusY-e._radiusY)<i,n=Math.abs(t._radiusX-e._radiusY)<i&&Math.abs(t._radiusY-e._radiusX)<i;if(s&&Math.abs(ni.moduloBetweenDown(t._rotation-e._rotation+Math.PI/2,0,Math.PI)-Math.PI/2)<i)return bn.MATCHING_OVERLAP;if(n&&Math.abs(ni.moduloBetweenDown(t._rotation-e._rotation,0,Math.PI)-Math.PI/2)<i)return bn.OPPOSITE_OVERLAP}return bn.NONE}static getOverlaps(t,e){return vn.getOverlapType(t,e)===bn.NONE?[]:_n.getAngularOverlaps(t._startAngle+t._rotation,t.getActualEndAngle()+t._rotation,e._startAngle+e._rotation,e.getActualEndAngle()+e._rotation)}static intersect(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-10;if(vn.getOverlapType(t,e,i)===bn.NONE)return jn.intersect(t,e);{const s=[],n=t.positionAt(0),r=t.positionAt(1),a=e.positionAt(0),h=e.positionAt(1);return n.equalsEpsilon(a,i)&&s.push(new Gs(n.average(a),0,0)),n.equalsEpsilon(h,i)&&s.push(new Gs(n.average(h),0,1)),r.equalsEpsilon(a,i)&&s.push(new Gs(r.average(a),1,0)),r.equalsEpsilon(h,i)&&s.push(new Gs(r.average(h),1,1)),s}}static computeUnitTransform(t,e,i,s){return new gs(ts.translation(t.x,t.y).timesMatrix(ts.rotation2(s)).timesMatrix(ts.scaling(e,i)))}}class bn extends B{}_defineProperty(bn,"MATCHING_OVERLAP",new bn),_defineProperty(bn,"OPPOSITE_OVERLAP",new bn),_defineProperty(bn,"NONE",new bn),_defineProperty(bn,"enumeration",new $(bn)),Bs.register("EllipticalArc",vn);class Tn{constructor(t,e,i){if(this.invalidatedEmitter=new r,this.segments=[],this.points=e||(t&&t.length?_.map(t,t=>t.start).concat(t[t.length-1].end):[]),this.closed=!!i,this._strokedSubpaths=null,this._strokedSubpathsComputed=!1,this._strokedStyles=null,this._bounds=null,this._invalidateListener=this.invalidate.bind(this),this._invalidatingPoints=!1,t)for(let s=0;s<t.length;s++)_.each(t[s].getNondegenerateSegments(),t=>{this.addSegmentDirectly(t)})}getBounds(){if(null===this._bounds){const t=ui.NOTHING.copy();_.each(this.segments,e=>{t.includeBounds(e.getBounds())}),this._bounds=t}return this._bounds}get bounds(){return this.getBounds()}getArcLength(t,e,i){let s=0;for(let n=0;n<this.segments.length;n++)s+=this.segments[n].getArcLength(t,e,i);return s}copy(){return new Tn(this.segments.slice(0),this.points.slice(0),this.closed)}invalidatePoints(){this._invalidatingPoints=!0;const t=this.segments.length;for(let e=0;e<t;e++)this.segments[e].invalidate();this._invalidatingPoints=!1,this.invalidate()}invalidate(){this._invalidatingPoints||(this._bounds=null,this._strokedSubpathsComputed=!1,this.invalidatedEmitter.emit())}addPoint(t){return this.points.push(t),this}addSegmentDirectly(t){return this.segments.push(t),t.invalidationEmitter.addListener(this._invalidateListener),this}addSegment(t){const e=t.getNondegenerateSegments().length;for(let i=0;i<e;i++)this.addSegmentDirectly(t);return this.invalidate(),this}addClosingSegment(){if(this.hasClosingSegment()){const t=this.getClosingSegment();this.addSegmentDirectly(t),this.invalidate(),this.addPoint(this.getFirstPoint()),this.closed=!0}}close(){this.closed=!0,this.addClosingSegment()}getLength(){return this.points.length}getFirstPoint(){return _.first(this.points)}getLastPoint(){return _.last(this.points)}getFirstSegment(){return _.first(this.segments)}getLastSegment(){return _.last(this.segments)}getFillSegments(){const t=this.segments.slice();return this.hasClosingSegment()&&t.push(this.getClosingSegment()),t}isDrawable(){return this.segments.length>0}isClosed(){return this.closed}hasClosingSegment(){return!this.getFirstPoint().equalsEpsilon(this.getLastPoint(),1e-9)}getClosingSegment(){return new rn(this.getLastPoint(),this.getFirstPoint())}writeToContext(t){if(this.isDrawable()){const e=this.getFirstSegment().start;t.moveTo(e.x,e.y);let i=this.segments.length;this.closed&&i>=2&&this.segments[i-1]instanceof rn&&i--;for(let s=0;s<i;s++)this.segments[s].writeToContext(t);this.closed&&t.closePath()}}toPiecewiseLinear(t){return new Tn(_.flatten(_.map(this.segments,e=>e.toPiecewiseLinearSegments(t))),null,this.closed)}transformed(t){return new Tn(_.map(this.segments,e=>e.transformed(t)),_.map(this.points,e=>t.timesVector2(e)),this.closed)}nonlinearTransformed(t){return new Tn(_.flatten(_.map(this.segments,e=>t.methodName&&e[t.methodName]?e[t.methodName](t):e.toPiecewiseLinearSegments(t))),null,this.closed)}getBoundsWithTransform(t){const e=ui.NOTHING.copy(),i=this.segments.length;for(let s=0;s<i;s++)e.includeBounds(this.segments[s].getBoundsWithTransform(t));return e}offset(t){if(!this.isDrawable())return new Tn([],null,this.closed);if(0===t)return new Tn(this.segments.slice(),null,this.closed);let e;const i=this.segments.slice(),s=[];for(e=0;e<i.length;e++)s.push(i[e].strokeLeft(2*t));let n=[];for(e=0;e<i.length;e++){if(this.closed||e>0){const s=(e>0?e:i.length)-1,r=i[e].start,a=i[s].endTangent,h=i[e].startTangent,o=a.perpendicular.negated().times(t).angle,l=h.perpendicular.negated().times(t).angle,u=a.perpendicular.dot(h)>0;n.push(new _n(r,Math.abs(t),o,l,u))}n=n.concat(s[e])}return new Tn(n,null,this.closed)}stroked(t){if(!this.isDrawable())return[];if(void 0===t&&(t=new Hs),this._strokedSubpathsComputed&&this._strokedStyles.equals(t))return this._strokedSubpaths;const e=t.lineWidth;let i,s=[],n=[];const r=this.getFirstSegment(),a=this.getLastSegment();function h(t){s=s.concat(t)}function o(t){n=n.concat(t)}const l=a.end.equals(r.start),u=l?null:new rn(this.segments[this.segments.length-1].end,this.segments[0].start);for(i=0;i<this.segments.length;i++)i>0&&h(t.leftJoin(this.segments[i].start,this.segments[i-1].endTangent,this.segments[i].startTangent)),h(this.segments[i].strokeLeft(e));for(i=this.segments.length-1;i>=0;i--)i<this.segments.length-1&&o(t.rightJoin(this.segments[i].end,this.segments[i].endTangent,this.segments[i+1].startTangent)),o(this.segments[i].strokeRight(e));let m;return this.closed?(l?(h(t.leftJoin(a.end,a.endTangent,r.startTangent)),o(t.rightJoin(a.end,a.endTangent,r.startTangent))):(h(t.leftJoin(u.start,a.endTangent,u.startTangent)),h(u.strokeLeft(e)),h(t.leftJoin(u.end,u.endTangent,r.startTangent)),o(t.rightJoin(u.end,u.endTangent,r.startTangent)),o(u.strokeRight(e)),o(t.rightJoin(u.start,a.endTangent,u.startTangent))),m=[new Tn(s,null,!0),new Tn(n,null,!0)]):m=[new Tn(s.concat(t.cap(a.end,a.endTangent)).concat(n).concat(t.cap(r.start,r.startTangent.negated())),null,!0)],this._strokedSubpaths=m,this._strokedSubpathsComputed=!0,this._strokedStyles=t.copy(),m}dashed(t,e,i,s){function n(t,e){const i=t[t.length-1].concat(e[0]),s=t.slice(0,t.length-1).concat([i]).concat(e.slice(1));return s}function r(t,e){if(!t.hasRightFilled||!e.hasLeftFilled)return!1;const i=_.last(_.last(t.segmentArrays)),s=e.segmentArrays[0][0];return i.end.distance(s.start)<1e-5}const a=[];for(let h=0;h<this.segments.length;h++){const n=this.segments[h],r=n.getDashValues(t,e,i,s);a.push(r),e+=r.arcLength;const o=[0].concat(r.values).concat([1]),l=r.initiallyInside;r.hasLeftFilled=l,r.hasRightFilled=o.length%2==0?l:!l,r.segmentArrays=[];for(let t=l?0:1;t<o.length-1;t+=2)o[t]!==o[t+1]&&r.segmentArrays.push([n.slice(o[t],o[t+1])])}for(let h=a.length-1;h>=1;h--){const t=a[h-1],e=a[h];r(t,e)&&a.splice(h-1,2,{segmentArrays:n(t.segmentArrays,e.segmentArrays),hasLeftFilled:t.hasLeftFilled,hasRightFilled:e.hasRightFilled})}if(a.length>1&&r(a[a.length-1],a[0])){const t=a.pop(),e=a.shift();a.push({segmentArrays:n(t.segmentArrays,e.segmentArrays),hasLeftFilled:t.hasLeftFilled,hasRightFilled:e.hasRightFilled})}return this.closed&&1===a.length&&1===a[0].segmentArrays.length&&a[0].hasLeftFilled&&a[0].hasRightFilled?[new Tn(a[0].segmentArrays[0],null,!0)]:_.flatten(a.map(t=>t.segmentArrays)).map(t=>new Tn(t))}serialize(){return{type:"Subpath",segments:this.segments.map(t=>t.serialize()),points:this.points.map(t=>({x:t.x,y:t.y})),closed:this.closed}}static deserialize(t){return new Tn(t.segments.map(en.deserialize),t.points.map(t=>new Ge(t.x,t.y)),t.closed)}}Bs.register("Subpath",Tn);const En=Tn,An=Math.random;function Mn(t,e){return new Ge(t,e)}function Pn(t,e,i,s){return i.copy().subtract(t).multiplyScalar((1-s)/6).add(e)}class In{constructor(t,e){if(this.subpaths=[],this._bounds=e?e.copy():null,this.invalidatedEmitter=new r,this.resetControlPoints(),this._invalidateListener=this.invalidate.bind(this),this._invalidatingPoints=!1,this._immutable=!1,"object"==typeof t)for(let i=0;i<t.length;i++)this.addSubpath(t[i]);t&&"object"!=typeof t&&_.each(tn.parse(t),t=>{this[t.cmd].apply(this,t.args)}),this.invalidate()}resetControlPoints(){this.lastQuadraticControlPoint=null,this.lastCubicControlPoint=null}setQuadraticControlPoint(t){this.lastQuadraticControlPoint=t,this.lastCubicControlPoint=null}setCubicControlPoint(t){this.lastQuadraticControlPoint=null,this.lastCubicControlPoint=t}moveTo(t,e){return this.moveToPoint(Mn(t,e))}moveToRelative(t,e){return this.moveToPointRelative(Mn(t,e))}moveToPointRelative(t){return this.moveToPoint(this.getRelativePoint().plus(t))}moveToPoint(t){return this.addSubpath((new En).addPoint(t)),this.resetControlPoints(),this}lineTo(t,e){return this.lineToPoint(Mn(t,e))}lineToRelative(t,e){return this.lineToPointRelative(Mn(t,e))}lineToPointRelative(t){return this.lineToPoint(this.getRelativePoint().plus(t))}lineToPoint(t){if(this.hasSubpaths()){const e=this.getLastSubpath().getLastPoint(),i=t,s=new rn(e,i);this.getLastSubpath().addPoint(i),this.addSegmentAndBounds(s)}else this.ensure(t);return this.resetControlPoints(),this}horizontalLineTo(t){return this.lineTo(t,this.getRelativePoint().y)}horizontalLineToRelative(t){return this.lineToRelative(t,0)}verticalLineTo(t){return this.lineTo(this.getRelativePoint().x,t)}verticalLineToRelative(t){return this.lineToRelative(0,t)}zigZagTo(t,e,i,s,n){return this.zigZagToPoint(new Ge(t,e),i,s,n)}zigZagToPoint(t,e,i,s){this.ensure(t);const n=this.getLastPoint(),r=t.minus(n),a=r.normalized(),h=a.perpendicular.times(e);let o;o=s?r.magnitude/(i+.5):r.magnitude/i;for(let l=0;l<i;l++){const t=a.times(l*o).plus(n),e=t.plus(a.times(o/4)).plus(h),i=t.plus(a.times(3*o/4)).minus(h);this.lineToPoint(e),this.lineToPoint(i)}if(s){const t=a.times(i*o).plus(n).plus(a.times(o/4)).plus(h);this.lineToPoint(t)}return this.lineToPoint(t)}quadraticCurveTo(t,e,i,s){return this.quadraticCurveToPoint(Mn(t,e),Mn(i,s))}quadraticCurveToRelative(t,e,i,s){return this.quadraticCurveToPointRelative(Mn(t,e),Mn(i,s))}quadraticCurveToPointRelative(t,e){const i=this.getRelativePoint();return this.quadraticCurveToPoint(i.plus(t),i.plus(e))}smoothQuadraticCurveTo(t,e){return this.quadraticCurveToPoint(this.getSmoothQuadraticControlPoint(),Mn(t,e))}smoothQuadraticCurveToRelative(t,e){return this.quadraticCurveToPoint(this.getSmoothQuadraticControlPoint(),Mn(t,e).plus(this.getRelativePoint()))}quadraticCurveToPoint(t,e){this.ensure(t);const i=this.getLastSubpath().getLastPoint(),s=new ln(i,t,e);this.getLastSubpath().addPoint(e);const n=s.getNondegenerateSegments();return _.each(n,t=>{this.addSegmentAndBounds(t)}),this.setQuadraticControlPoint(t),this}cubicCurveTo(t,e,i,s,n,r){return this.cubicCurveToPoint(Mn(t,e),Mn(i,s),Mn(n,r))}cubicCurveToRelative(t,e,i,s,n,r){return this.cubicCurveToPointRelative(Mn(t,e),Mn(i,s),Mn(n,r))}cubicCurveToPointRelative(t,e,i){const s=this.getRelativePoint();return this.cubicCurveToPoint(s.plus(t),s.plus(e),s.plus(i))}smoothCubicCurveTo(t,e,i,s){return this.cubicCurveToPoint(this.getSmoothCubicControlPoint(),Mn(t,e),Mn(i,s))}smoothCubicCurveToRelative(t,e,i,s){return this.cubicCurveToPoint(this.getSmoothCubicControlPoint(),Mn(t,e).plus(this.getRelativePoint()),Mn(i,s).plus(this.getRelativePoint()))}cubicCurveToPoint(t,e,i){this.ensure(t);const s=this.getLastSubpath().getLastPoint(),n=new yn(s,t,e,i).getNondegenerateSegments();return _.each(n,t=>{this.addSegmentAndBounds(t)}),this.getLastSubpath().addPoint(i),this.setCubicControlPoint(e),this}arc(t,e,i,s,n,r){return this.arcPoint(Mn(t,e),i,s,n,r)}arcPoint(t,e,i,s,n){void 0===n&&(n=!1);const r=new _n(t,e,i,s,n),a=r.getStart(),h=r.getEnd();return this.hasSubpaths()&&this.getLastSubpath().getLength()>0&&!a.equals(this.getLastSubpath().getLastPoint(),0)&&this.addSegmentAndBounds(new rn(this.getLastSubpath().getLastPoint(),a)),this.hasSubpaths()||this.addSubpath(new En),this.getLastSubpath().addPoint(a),this.getLastSubpath().addPoint(h),this.addSegmentAndBounds(r),this.resetControlPoints(),this}ellipticalArc(t,e,i,s,n,r,a,h){return this.ellipticalArcPoint(Mn(t,e),i,s,n,r,a,h)}ellipticalArcPoint(t,e,i,s,n,r,a){void 0===a&&(a=!1);const h=new vn(t,e,i,s,n,r,a),o=h.start,l=h.end;return this.hasSubpaths()&&this.getLastSubpath().getLength()>0&&!o.equals(this.getLastSubpath().getLastPoint(),0)&&this.addSegmentAndBounds(new rn(this.getLastSubpath().getLastPoint(),o)),this.hasSubpaths()||this.addSubpath(new En),this.getLastSubpath().addPoint(o),this.getLastSubpath().addPoint(l),this.addSegmentAndBounds(h),this.resetControlPoints(),this}close(){if(this.hasSubpaths()){const t=this.getLastSubpath(),e=new En;t.close(),this.addSubpath(e),e.addPoint(t.getFirstPoint())}return this.resetControlPoints(),this}newSubpath(){return this.addSubpath(new En),this.resetControlPoints(),this}makeImmutable(){return this._immutable=!0,this.notifyInvalidationListeners(),this}isImmutable(){return this._immutable}ellipticalArcToRelative(t,e,i,s,n,r,a){const h=this.getRelativePoint();return this.ellipticalArcTo(t,e,i,s,n,r+h.x,a+h.y)}ellipticalArcTo(t,e,i,s,n,r,a){const h=new Ge(r,a);this.ensure(h);const o=this.getLastSubpath().getLastPoint();this.getLastSubpath().addPoint(h),t<0&&(t*=-1),e<0&&(e*=-1);let l=t*t,u=e*e;const m=o.minus(h).dividedScalar(2).rotated(-i),d=m.x*m.x,c=m.y*m.y;let p=new Ge(t*m.y/e,-e*m.x/t);const g=d/l+c/u;g>1&&(l=(t*=Math.sqrt(g))*t,u=(e*=Math.sqrt(g))*e,p=new Ge(t*m.y/e,-e*m.x/t)),p.multiplyScalar(Math.sqrt(Math.max(0,(l*u-l*c-u*d)/(l*c+u*d)))),s===n&&p.multiplyScalar(-1);const f=o.blend(h,.5).plus(p.rotated(i));function y(t,e){return(t.x*e.y-t.y*e.x>0?1:-1)*t.angleBetween(e)}const x=new Ge((m.x-p.x)/t,(m.y-p.y)/e),w=new Ge((-m.x-p.x)/t,(-m.y-p.y)/e),v=y(Ge.X_UNIT,x);let b=y(x,w)%(2*Math.PI);!n&&b>0&&(b-=2*Math.PI),n&&b<0&&(b+=2*Math.PI);const T=new vn(f,t,e,i,v,v+b,!n).getNondegenerateSegments();return _.each(T,t=>{this.addSegmentAndBounds(t)}),this}circle(t,e,i){if("object"==typeof t){const s=t;return i=e,this.arcPoint(s,i,0,2*Math.PI,!1).close()}return this.arcPoint(Mn(t,e),i,0,2*Math.PI,!1).close()}ellipse(t,e,i,s,n){if("object"==typeof t){const r=t;return n=s,s=i,i=e,this.ellipticalArcPoint(r,i,s,n||0,0,2*Math.PI,!1).close()}return this.ellipticalArcPoint(Mn(t,e),i,s,n||0,0,2*Math.PI,!1).close()}rect(t,e,i,s){const n=new En;return this.addSubpath(n),n.addPoint(Mn(t,e)),n.addPoint(Mn(t+i,e)),n.addPoint(Mn(t+i,e+s)),n.addPoint(Mn(t,e+s)),this.addSegmentAndBounds(new rn(n.points[0],n.points[1])),this.addSegmentAndBounds(new rn(n.points[1],n.points[2])),this.addSegmentAndBounds(new rn(n.points[2],n.points[3])),n.close(),this.addSubpath(new En),this.getLastSubpath().addPoint(Mn(t,e)),this.resetControlPoints(),this}roundRect(t,e,i,s,n,r){const a=t+n,h=t+i-n,o=e+r,l=e+s-r;return n===r?this.arc(h,o,n,-Math.PI/2,0,!1).arc(h,l,n,0,Math.PI/2,!1).arc(a,l,n,Math.PI/2,Math.PI,!1).arc(a,o,n,Math.PI,3*Math.PI/2,!1).close():this.ellipticalArc(h,o,n,r,0,-Math.PI/2,0,!1).ellipticalArc(h,l,n,r,0,0,Math.PI/2,!1).ellipticalArc(a,l,n,r,0,Math.PI/2,Math.PI,!1).ellipticalArc(a,o,n,r,0,Math.PI,3*Math.PI/2,!1).close(),this}polygon(t){const e=t.length;if(e>0){this.moveToPoint(t[0]);for(let i=1;i<e;i++)this.lineToPoint(t[i])}return this.close()}cardinalSpline(t,e){e=m({tension:0,isClosedLineSegments:!1},e);const i=t.length,s=e.isClosedLineSegments?i:i-1;for(let n=0;n<s;n++){let r;r=0!==n||e.isClosedLineSegments?n!==s-1||e.isClosedLineSegments?[t[(n-1+i)%i],t[n%i],t[(n+1)%i],t[(n+2)%i]]:[t[n-1],t[n],t[n+1],t[n+1]]:[t[0],t[0],t[1],t[2]];const a=[r[1],Pn(r[0],r[1],r[2],e.tension),Pn(r[3],r[2],r[1],e.tension),r[2]];0===n&&(this.ensure(a[0]),this.getLastSubpath().addPoint(a[0])),this.cubicCurveToPoint(a[1],a[2],a[3])}return this}copy(){return new In(_.map(this.subpaths,t=>t.copy()),this.bounds)}writeToContext(t){const e=this.subpaths.length;for(let i=0;i<e;i++)this.subpaths[i].writeToContext(t)}getSVGPath(){let t="";const e=this.subpaths.length;for(let i=0;i<e;i++){const e=this.subpaths[i];if(e.isDrawable()){const i=e.segments[0].start;t+=`M ${Qs(i.x)} ${Qs(i.y)} `;for(let s=0;s<e.segments.length;s++)t+=e.segments[s].getSVGPathFragment()+" ";e.isClosed()&&(t+="Z ")}}return t}transformed(t){const e=_.map(this.subpaths,e=>e.transformed(t)),i=_.reduce(e,(t,e)=>t.union(e.bounds),ui.NOTHING);return new In(e,i)}nonlinearTransformed(t){t=m({minLevels:0,maxLevels:7,distanceEpsilon:.16,curveEpsilon:t&&t.includeCurvature?.002:null},t);const e=_.map(this.subpaths,e=>e.nonlinearTransformed(t)),i=_.reduce(e,(t,e)=>t.union(e.bounds),ui.NOTHING);return new In(e,i)}polarToCartesian(t){return this.nonlinearTransformed(m({pointMap:t=>Ge.createPolar(t.y,t.x),methodName:"polarToCartesian"},t))}toPiecewiseLinear(t){return this.nonlinearTransformed(t)}containsPoint(t){const e=new ls(t,Ge.X_UNIT);return 0!==this.windingIntersection(e)}intersection(t){let e=[];const i=this.subpaths.length;for(let s=0;s<i;s++){const i=this.subpaths[s];if(i.isDrawable()){const s=i.segments.length;for(let n=0;n<s;n++){const s=i.segments[n];e=e.concat(s.intersection(t))}i.hasClosingSegment()&&(e=e.concat(i.getClosingSegment().intersection(t)))}}return _.sortBy(e,t=>t.distance)}interiorIntersectsLineSegment(t,e){const i=t.blend(e,.5);if(this.containsPoint(i))return!0;const s=e.minus(t),n=s.magnitude;if(0===n)return!1;s.normalize();const r=this.intersection(new ls(t,s));for(let a=0;a<r.length;a++)if(r[a].distance<=n)return!0;return!1}windingIntersection(t){let e=0;const i=this.subpaths.length;for(let s=0;s<i;s++){const i=this.subpaths[s];if(i.isDrawable()){const s=i.segments.length;for(let n=0;n<s;n++)e+=i.segments[n].windingIntersection(t);i.hasClosingSegment()&&(e+=i.getClosingSegment().windingIntersection(t))}}return e}intersectsBounds(t){if(this.bounds.intersection(t).equals(this.bounds))return!0;const e=new ls(new Ge(t.minX,t.minY),new Ge(1,0)),i=new ls(new Ge(t.minX,t.minY),new Ge(0,1)),s=new ls(new Ge(t.maxX,t.maxY),new Ge(-1,0)),n=new ls(new Ge(t.maxX,t.maxY),new Ge(0,-1));let r,a;const h=this.intersection(e).concat(this.intersection(s));for(a=0;a<h.length;a++)if(r=h[a].point,r.x>=t.minX&&r.x<=t.maxX)return!0;const o=this.intersection(i).concat(this.intersection(n));for(a=0;a<o.length;a++)if(r=o[a].point,r.y>=t.minY&&r.y<=t.maxY)return!0;return!1}getStrokedShape(t){let e=[];const i=ui.NOTHING.copy();let s=this.subpaths.length;for(let n=0;n<s;n++){const i=this.subpaths[n].stroked(t);e=e.concat(i)}s=e.length;for(let n=0;n<s;n++)i.includeBounds(e[n].bounds);return new In(e,i)}getOffsetShape(t){const e=[],i=ui.NOTHING.copy();let s=this.subpaths.length;for(let n=0;n<s;n++)e.push(this.subpaths[n].offset(t));s=e.length;for(let n=0;n<s;n++)i.includeBounds(e[n].bounds);return new In(e,i)}getDashedShape(t,e,i){return i=m({distanceEpsilon:1e-10,curveEpsilon:1e-8},i),new In(_.flatten(this.subpaths.map(s=>s.dashed(t,e,i.distanceEpsilon,i.curveEpsilon))))}getBounds(){if(null===this._bounds){const t=ui.NOTHING.copy();_.each(this.subpaths,e=>{t.includeBounds(e.getBounds())}),this._bounds=t}return this._bounds}get bounds(){return this.getBounds()}getStrokedBounds(t){let e=!0;for(let i=0;i<this.subpaths.length;i++){const t=this.subpaths[i];if(t.isDrawable()&&!t.isClosed()){e=!1;break}for(let i=0;i<t.segments.length;i++){if(!t.segments[i].areStrokedBoundsDilated()){e=!1;break}}}if(e)return this.bounds.dilated(t.lineWidth/2);{const e=this.bounds.copy();for(let i=0;i<this.subpaths.length;i++){const s=this.subpaths[i].stroked(t);for(let t=0;t<s.length;t++)e.includeBounds(s[t].bounds)}return e}}getSimplifiedAreaShape(){return er.simplifyNonZero(this)}getBoundsWithTransform(t,e){const i=ui.NOTHING.copy(),s=this.subpaths.length;for(let n=0;n<s;n++){const e=this.subpaths[n];i.includeBounds(e.getBoundsWithTransform(t))}return e&&i.includeBounds(this.getStrokedShape(e).getBoundsWithTransform(t)),i}getApproximateArea(t){const e=this.bounds.minX,i=this.bounds.minY,s=this.bounds.width,n=this.bounds.height,r=s*n;let a=0;const h=new Ge(0,0);for(let o=0;o<t;o++)h.x=e+An()*s,h.y=i+An()*n,this.containsPoint(h)&&a++;return r*a/t}getNonoverlappingArea(){return Math.abs(_.sum(this.subpaths.map(t=>_.sum(t.getFillSegments().map(t=>t.getSignedAreaFragment())))))}getArea(){return this.getSimplifiedAreaShape().getNonoverlappingArea()}getApproximateCentroid(t){const e=this.bounds.minX,i=this.bounds.minY,s=this.bounds.width,n=this.bounds.height;let r=0;const a=new Ge(0,0),h=new Ge(0,0);for(let o=0;o<t;o++)h.x=e+An()*s,h.y=i+An()*n,this.containsPoint(h)&&(a.add(h),r++);return a.dividedScalar(r)}invalidatePoints(){this._invalidatingPoints=!0;const t=this.subpaths.length;for(let e=0;e<t;e++)this.subpaths[e].invalidatePoints();this._invalidatingPoints=!1,this.invalidate()}toString(){return`new phet.kite.Shape( '${this.getSVGPath()}' )`}invalidate(){this._invalidatingPoints||(this._bounds=null,this.notifyInvalidationListeners())}notifyInvalidationListeners(){this.invalidatedEmitter.emit()}addSegmentAndBounds(t){this.getLastSubpath().addSegment(t),this.invalidate()}ensure(t){this.hasSubpaths()||(this.addSubpath(new En),this.getLastSubpath().addPoint(t))}addSubpath(t){return this.subpaths.push(t),t.invalidatedEmitter.addListener(this._invalidateListener),this.invalidate(),this}hasSubpaths(){return this.subpaths.length>0}getLastSubpath(){return _.last(this.subpaths)}getLastPoint(){return this.hasSubpaths()?this.getLastSubpath().getLastPoint():null}getLastSegment(){if(!this.hasSubpaths())return null;const t=this.getLastSubpath();return t.isDrawable()?t.getLastSegment():null}getSmoothQuadraticControlPoint(){const t=this.getLastPoint();return this.lastQuadraticControlPoint?t.plus(t.minus(this.lastQuadraticControlPoint)):t}getSmoothCubicControlPoint(){const t=this.getLastPoint();return this.lastCubicControlPoint?t.plus(t.minus(this.lastCubicControlPoint)):t}getRelativePoint(){const t=this.getLastPoint();return t||Ge.ZERO}shapeUnion(t){return er.binaryResult(this,t,er.BINARY_NONZERO_UNION)}shapeIntersection(t){return er.binaryResult(this,t,er.BINARY_NONZERO_INTERSECTION)}shapeDifference(t){return er.binaryResult(this,t,er.BINARY_NONZERO_DIFFERENCE)}shapeXor(t){return er.binaryResult(this,t,er.BINARY_NONZERO_XOR)}shapeClip(t,e){return er.clipShape(t,this,e)}getArcLength(t,e,i){let s=0;for(let n=0;n<this.subpaths.length;n++)s+=this.subpaths[n].getArcLength(t,e,i);return s}serialize(){return{type:"Shape",subpaths:this.subpaths.map(t=>t.serialize())}}static deserialize(t){return new In(t.subpaths.map(En.deserialize))}static rectangle(t,e,i,s){return(new In).rect(t,e,i,s)}static roundRect(t,e,i,s,n,r){return(new In).roundRect(t,e,i,s,n,r)}static roundedRectangleWithRadii(t,e,i,s,n){let r=n&&n.topLeft||0,a=n&&n.topRight||0,h=n&&n.bottomLeft||0,o=n&&n.bottomRight||0;const l=r+a;l>i&&l>0&&(r=r/l*i,a=a/l*i);const u=h+o;u>i&&u>0&&(h=h/u*i,o=o/u*i);const m=r+h;m>s&&m>0&&(r=r/m*s,h=h/m*s);const d=a+o;d>s&&d>0&&(a=a/d*s,o=o/d*s);const c=new In,p=t+i,g=e+s;return o>0?c.arc(p-o,g-o,o,0,Math.PI/2,!1):c.moveTo(p,g),h>0?c.arc(t+h,g-h,h,Math.PI/2,Math.PI,!1):c.lineTo(t,g),r>0?c.arc(t+r,e+r,r,Math.PI,3*Math.PI/2,!1):c.lineTo(t,e),a>0?c.arc(p-a,e+a,a,3*Math.PI/2,2*Math.PI,!1):c.lineTo(p,e),c.close(),c}static boundsOffsetWithRadii(t,e,i){const s=t.withOffsets(e.left,e.top,e.right,e.bottom);return In.roundedRectangleWithRadii(s.minX,s.minY,s.width,s.height,i)}static polygon(t){return(new In).polygon(t)}static bounds(t){return(new In).rect(t.minX,t.minY,t.maxX-t.minX,t.maxY-t.minY)}static lineSegment(t,e,i,s){return"number"==typeof t?(new In).moveTo(t,e).lineTo(i,s):(new In).moveToPoint(t).lineToPoint(e)}static regularPolygon(t,e){const i=new In;return _.each(_.range(t),s=>{const n=Ge.createPolar(e,2*Math.PI*s/t);0===s?i.moveToPoint(n):i.lineToPoint(n)}),i.close()}static circle(t,e,i){return void 0===e?(new In).circle(0,0,t):(new In).circle(t,e,i)}static ellipse(t,e,i,s,n){return void 0===s?(new In).ellipse(0,0,t,e,i):(new In).ellipse(t,e,i,s,n)}static arc(t,e,i,s,n,r){return(new In).arc(t,e,i,s,n,r)}static union(t){return er.unionNonZero(t)}static intersection(t){return er.intersectionNonZero(t)}static xor(t){return er.xorNonZero(t)}static segments(t,e){return new In([new En(t,void 0,!!e)])}}Bs.register("Shape",In),In.rect=In.rectangle,In.roundRectangle=In.roundRect;const Sn=In;let On=0;class Vn{constructor(t,e){this.id=++On,this.initialize(t,e)}initialize(t,e){return this.edge=t,this.face=null,this.isReversed=e,this.signedAreaFragment=t.signedAreaFragment*(e?-1:1),this.startVertex=null,this.endVertex=null,this.sortVector=this.sortVector||new Ge(0,0),this.data=null,this.updateReferences(),this}serialize(){return{type:"HalfEdge",id:this.id,edge:this.edge.id,face:null===this.face?null:this.face.id,isReversed:this.isReversed,signedAreaFragment:this.signedAreaFragment,startVertex:null===this.startVertex?null:this.startVertex.id,endVertex:null===this.endVertex?null:this.endVertex.id,sortVector:Ge.Vector2IO.toStateObject(this.sortVector),data:this.data}}dispose(){this.edge=null,this.face=null,this.startVertex=null,this.endVertex=null,this.data=null,this.freeToPool()}getNext(t){for(let e=1;;e++){let i=this.endVertex.incidentHalfEdges.indexOf(this)-e;i<0&&(i+=this.endVertex.incidentHalfEdges.length);const s=this.endVertex.incidentHalfEdges[i].getReversed();if(!t||t(s.edge))return s}}updateReferences(){this.startVertex=this.isReversed?this.edge.endVertex:this.edge.startVertex,this.endVertex=this.isReversed?this.edge.startVertex:this.edge.endVertex}getEndTangent(){return this.isReversed?this.edge.segment.startTangent:this.edge.segment.endTangent.negated()}getEndCurvature(){return this.isReversed?-this.edge.segment.curvatureAt(0):this.edge.segment.curvatureAt(1)}getReversed(){return this.isReversed?this.edge.forwardHalf:this.edge.reversedHalf}getDirectionalSegment(){return this.isReversed?this.edge.segment.reversed():this.edge.segment}}Bs.register("HalfEdge",Vn),yi.mixInto(Vn);const Nn=Vn;let Dn=0;class Yn{constructor(t){this.id=++Dn,this.initialize(t)}initialize(t){return this.point=t,this.incidentHalfEdges=ws(this.incidentHalfEdges),this.visited=!1,this.visitIndex=0,this.lowIndex=0,this.data=null,this.internalData={},this}serialize(){return{type:"Vertex",id:this.id,point:Ge.Vector2IO.toStateObject(this.point),incidentHalfEdges:this.incidentHalfEdges.map(t=>t.id),visited:this.visited,visitIndex:this.visitIndex,lowIndex:this.lowIndex}}dispose(){this.point=Ge.ZERO,ws(this.incidentHalfEdges),this.freeToPool()}sortEdges(){const t=[];for(let s=0;s<this.incidentHalfEdges.length;s++){const e=this.incidentHalfEdges[s];t.push(e.sortVector.setXY(e.getEndTangent().angle,e.getEndCurvature()))}const e=1e-4-Math.PI;let i=!1;for(;!i;){i=!0;for(let s=0;s<t.length;s++)t[s].x<e&&(i=!1);if(!i)for(let e=0;e<t.length;e++){const i=t[e];i.x-=1.62594024516,i.x<-Math.PI-1e-4&&(i.x+=2*Math.PI)}}this.incidentHalfEdges.sort(Yn.edgeComparison)}static edgeComparison(t,e){const i=t.sortVector.x,s=e.sortVector.x;if(Math.abs(i-s)>1e-5||i!==s&&t.edge.segment instanceof rn&&e.edge.segment instanceof rn)return i<s?-1:1;{const i=t.sortVector.y,s=e.sortVector.y;if(Math.abs(i-s)>1e-5)return i<s?1:-1;throw new Error("TODO: Need to implement more advanced disambiguation ")}}}Bs.register("Vertex",Yn),yi.mixInto(Yn);const Cn=Yn;let Xn=0;class Fn{constructor(t,e,i){this.id=++Xn,this.initialize(t,e,i)}initialize(t,e,i){return this.segment=t,this.startVertex=e,this.endVertex=i,this.signedAreaFragment=t.getSignedAreaFragment(),this.forwardHalf=Nn.createFromPool(this,!1),this.reversedHalf=Nn.createFromPool(this,!0),this.visited=!1,this.data=null,this.internalData={},this}serialize(){return{type:"Edge",id:this.id,segment:this.segment.serialize(),startVertex:null===this.startVertex?null:this.startVertex.id,endVertex:null===this.endVertex?null:this.endVertex.id,signedAreaFragment:this.signedAreaFragment,forwardHalf:this.forwardHalf.serialize(),reversedHalf:this.reversedHalf.serialize(),visited:this.visited,data:this.data}}dispose(){this.segment=null,this.startVertex=null,this.endVertex=null,this.forwardHalf.dispose(),this.reversedHalf.dispose(),this.forwardHalf=null,this.reversedHalf=null,this.data=null,this.freeToPool()}getOtherVertex(t){return this.startVertex===t?this.endVertex:this.startVertex}updateReferences(){this.forwardHalf.updateReferences(),this.reversedHalf.updateReferences()}}Bs.register("Edge",Fn),yi.mixInto(Fn);const Rn=Fn;let Ln=0;class zn{constructor(t){this.id=++Ln,this.initialize(t)}initialize(t){return this.boundary=t,this.holes=ws(this.holes),this.windingMap=null,this.filled=null,t&&this.addBoundaryFaceReferences(t),this}serialize(){return{type:"Face",id:this.id,boundary:null===this.boundary?null:this.boundary.id,holes:this.holes.map(t=>t.id),windingMap:this.windingMap,filled:this.filled}}dispose(){this.boundary=null,ws(this.holes),this.windingMap=null,this.filled=null,this.freeToPool()}addBoundaryFaceReferences(t){for(let e=0;e<t.halfEdges.length;e++)t.halfEdges[e].face=this}recursivelyAddHoles(t){this.holes.push(t),this.addBoundaryFaceReferences(t);for(let e=0;e<t.childBoundaries.length;e++)this.recursivelyAddHoles(t.childBoundaries[e])}}Bs.register("Face",zn),yi.mixInto(zn);const kn=zn;let qn=0;class Bn{constructor(t,e){this.id=++qn,this.initialize(t,e)}initialize(t,e){return this.shapeId=t,this.closed=e,this.halfEdges=ws(this.halfEdges),this}serialize(){return{type:"Loop",id:this.id,shapeId:this.shapeId,closed:this.closed,halfEdges:this.halfEdges.map(t=>t.id)}}toSubpath(){const t=[];for(let e=0;e<this.halfEdges.length;e++)t.push(this.halfEdges[e].getDirectionalSegment());return new En(t,void 0,this.closed)}dispose(){ws(this.halfEdges),this.freeToPool()}}Bs.register("Loop",Bn),yi.mixInto(Bn);const Zn=Bn;class jn{constructor(t,e,i,s,n,r,a,h,o,l){this.initialize(t,e,i,s,n,r,a,h,o,l)}initialize(t,e,i,s,n,r,a,h,o,l){return this.a=t,this.b=e,this.atMin=i,this.atMax=s,this.btMin=n,this.btMax=r,this.aMin=a,this.aMax=h,this.bMin=o,this.bMax=l,this}pushSubdivisions(t){const e=this,i=(e.atMax+e.atMin)/2,s=(e.btMax+e.btMin)/2;if(i===this.atMin||i===this.atMax||s===this.btMin||s===this.btMax)return void t.push(this);const n=e.a.positionAt(i),r=e.b.positionAt(s);jn.boxIntersects(e.aMin,n,e.bMin,r)&&t.push(jn.pool.create(e.a,e.b,e.atMin,i,e.btMin,s,e.aMin,n,e.bMin,r)),jn.boxIntersects(n,e.aMax,e.bMin,r)&&t.push(jn.pool.create(e.a,e.b,i,e.atMax,e.btMin,s,n,e.aMax,e.bMin,r)),jn.boxIntersects(e.aMin,n,r,e.bMax)&&t.push(jn.pool.create(e.a,e.b,e.atMin,i,s,e.btMax,e.aMin,n,r,e.bMax)),jn.boxIntersects(n,e.aMax,r,e.bMax)&&t.push(jn.pool.create(e.a,e.b,i,e.atMax,s,e.btMax,n,e.aMax,r,e.bMax)),this.freeToPool()}distance(t){const e=this.atMin-t.atMin,i=this.atMax-t.atMax,s=this.btMin-t.btMin,n=this.btMax-t.btMax;return e*e+i*i+s*s+n*n}clean(){this.a=null,this.b=null,this.aMin=null,this.aMax=null,this.bMin=null,this.bMax=null}static intersect(t,e){if(!t.bounds.intersectsBounds(e.bounds))return[];const i=jn.getIntersectionRanges(t,e),s=[];for(let r=0;r<i.length;r++){const t=i[r];let e=!1;t:for(let i=0;i<s.length;i++){const n=s[i];for(let i=0;i<n.length;i++){const s=n[i];if(t.distance(s)<1e-13){n.push(t),e=!0;break t}}}e||s.push([t])}const n=[];for(let r=0;r<s.length;r++){const i=s[r];let a=0,h=0;for(let t=0;t<i.length;t++)a+=i[t].atMin+i[t].atMax,h+=i[t].btMin+i[t].btMax;a/=2*i.length,h/=2*i.length;const o=t.positionAt(a),l=e.positionAt(h);n.push(new Gs(o.average(l),a,h))}for(let r=0;r<i.length;r++)i[r].freeToPool();return jn.cleanPool(),n}static getIntersectionRanges(t,e){const i=t.getInteriorExtremaTs(),s=e.getInteriorExtremaTs(),n=_.zip([0].concat(i),i.concat([1])),r=_.zip([0].concat(s),s.concat([1]));let a=[];for(let h=0;h<n.length;h++)for(let i=0;i<r.length;i++){const s=n[h][0],o=n[h][1],l=r[i][0],u=r[i][1],m=t.positionAt(s),d=t.positionAt(o),c=e.positionAt(l),p=e.positionAt(u);jn.boxIntersects(m,d,c,p)&&a.push(jn.pool.create(t,e,s,o,l,u,m,d,c,p))}for(let h=0;h<50;h++){const t=[];for(let e=a.length-1;e>=0;e--)a[e].pushSubdivisions(t);a=t}return a}static boxIntersects(t,e,i,s){const n=Math.max(Math.min(t.x,e.x),Math.min(i.x,s.x)),r=Math.max(Math.min(t.y,e.y),Math.min(i.y,s.y)),a=Math.min(Math.max(t.x,e.x),Math.max(i.x,s.x)),h=Math.min(Math.max(t.y,e.y),Math.max(i.y,s.y));return a-n>=0&&h-r>=0}static cleanPool(){jn.pool.forEach(t=>t.clean())}freeToPool(){jn.pool.freeToPool(this)}}_defineProperty(jn,"pool",new ze(jn)),Bs.register("BoundsIntersection",jn);let Hn=1;const $n=[];class Un{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e-6;this.rootNode=Gn.createFromPool(this,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY),this.rootNode.isBlack=!0,this.epsilon=t,this.items=new Set}query(t,e){const i=Hn++;return!!this.rootNode&&this.rootNode.query(t,this.getMinX(t,this.epsilon),this.getMaxX(t,this.epsilon),i,e)}addItem(t){const e=this.getMinX(t,this.epsilon),i=this.getMaxX(t,this.epsilon);this.rootNode.split(e,this),this.rootNode.split(i,this),this.rootNode.addItem(t,e,i),this.items.add(t)}removeItem(t){this.rootNode.removeItem(t,this.getMinX(t,this.epsilon),this.getMaxX(t,this.epsilon)),this.items.delete(t)}audit(){this.rootNode.audit(this.epsilon,this.items,[])}toString(){let t=0,e="";return function i(s){e+=`${_.repeat("  ",t)}${s.toString()}\n`,t++,s.hasChildren()&&(i(s.left),i(s.right)),t--}(this.rootNode),e}}class Gn{constructor(t,e,i){this.items=[],this.initialize(t,e,i)}initialize(t,e,i){return this.min=e,this.max=i,this.splitValue=null,this.left=null,this.right=null,this.parent=null,this.tree=t,this.isBlack=!1,ws(this.items),this}contains(t){return t>=this.min&&t<=this.max}hasChildren(){return null!==this.splitValue}query(t,e,i,s,n){let r=!1;if(this.min<=i&&this.max>=e){for(let t=0;t<this.items.length;t++){const e=this.items[t];if((!e.internalData.segmentId||e.internalData.segmentId<s)&&(e.internalData.segmentId=s,r=n(e),r))return!0}this.hasChildren()&&(r||(r=this.left.query(t,e,i,s,n)),r||(r=this.right.query(t,e,i,s,n)))}return r}swapChild(t,e){this.left===t?this.left=e:this.right=e}hasChild(t){return this.left===t||this.right===t}otherChild(t){return this.left===t?this.right:this.left}leftRotate(t){if(this.right.hasChildren()){const e=this.right,i=this.left,s=e.left,n=e.right;e.parent=this.parent,this.parent?this.parent.swapChild(this,e):t.rootNode=e,this.parent=e,s.parent=this,e.left=this,this.left=i,this.right=s,this.max=s.max,this.splitValue=i.max,e.min=this.min,e.splitValue=this.max;const r=ws($n);r.push(...this.items),ws(this.items);for(let t=i.items.length-1;t>=0;t--){const e=i.items[t],n=s.items.indexOf(e);n>=0&&(i.items.splice(t,1),s.items.splice(n,1),this.items.push(e))}s.items.push(...e.items),n.items.push(...e.items),ws(e.items),e.items.push(...r)}}rightRotate(t){const e=this.left,i=this.right,s=e.left,n=e.right;e.parent=this.parent,this.parent?this.parent.swapChild(this,e):t.rootNode=e,this.parent=e,n.parent=this,e.right=this,this.left=n,this.right=i,this.min=n.min,this.splitValue=i.min,e.max=this.max,e.splitValue=this.min;const r=ws($n);r.push(...this.items),ws(this.items);for(let a=i.items.length-1;a>=0;a--){const t=i.items[a],e=n.items.indexOf(t);e>=0&&(i.items.splice(a,1),n.items.splice(e,1),this.items.push(t))}s.items.push(...e.items),n.items.push(...e.items),ws(e.items),e.items.push(...r)}fixRedBlack(t){if(this.parent){const e=this.parent;if(!e.isBlack){const i=e.parent,s=i.otherChild(e);s.isBlack?e===i.left?this===e.right?(e.leftRotate(t),e.parent.isBlack=!0,e.parent.parent.isBlack=!1,e.parent.parent.rightRotate(t)):(e.isBlack=!0,i.isBlack=!1,i.rightRotate(t)):this===e.left?(e.rightRotate(t),e.parent.isBlack=!0,e.parent.parent.isBlack=!1,e.parent.parent.leftRotate(t)):(e.isBlack=!0,i.isBlack=!1,i.leftRotate(t)):(e.isBlack=!0,s.isBlack=!0,i.isBlack=!1,i.fixRedBlack(t))}}else this.isBlack=!0}split(t,e){if(t!==this.min&&t!==this.max)if(this.hasChildren())this.splitValue!==t&&(t>this.splitValue?this.right:this.left).split(t,e);else{this.splitValue=t;const i=Gn.createFromPool(this.tree,this.min,t);i.parent=this,this.left=i;const s=Gn.createFromPool(this.tree,t,this.max);if(s.parent=this,this.right=s,!this.isBlack&&this.parent){const t=this.parent,n=t.otherChild(this);n.isBlack?(this===t.left?(t.rightRotate(e),i.isBlack=!0):(t.leftRotate(e),s.isBlack=!0),this.fixRedBlack(e)):(this.isBlack=!0,n.isBlack=!0,t.isBlack=!1,t.fixRedBlack(e))}}}addItem(t,e,i){this.min>i||this.max<e||(this.min>=e&&this.max<=i?this.items.push(t):this.hasChildren()&&(this.left.addItem(t,e,i),this.right.addItem(t,e,i)))}removeItem(t,e,i){this.min>i||this.max<e||(this.min>=e&&this.max<=i?k(this.items,t):this.hasChildren()&&(this.left.removeItem(t,e,i),this.right.removeItem(t,e,i)))}audit(t,e){arguments.length>2&&void 0!==arguments[2]&&arguments[2]}toString(){return`[${this.min} ${this.max}] split:${this.splitValue} ${this.isBlack?"black":"red"} ${this.items}`}}yi.mixInto(Gn),Bs.register("SegmentTree",Un);class Wn extends Un{getMinX(t,e){return t.segment.bounds.left-e}getMaxX(t,e){return t.segment.bounds.right+e}}Bs.register("EdgeSegmentTree",Wn);class Qn extends Un{getMinX(t,e){return t.point.x-e}getMaxX(t,e){return t.point.x+e}}Bs.register("VertexSegmentTree",Qn);let Jn=0,Kn=0;class tr{constructor(){this.vertices=[],this.edges=[],this.innerBoundaries=[],this.outerBoundaries=[],this.boundaries=[],this.shapeIds=[],this.loops=[],this.unboundedFace=kn.createFromPool(null),this.faces=[this.unboundedFace]}serialize(){return{type:"Graph",vertices:this.vertices.map(t=>t.serialize()),edges:this.edges.map(t=>t.serialize()),boundaries:this.boundaries.map(t=>t.serialize()),innerBoundaries:this.innerBoundaries.map(t=>t.id),outerBoundaries:this.outerBoundaries.map(t=>t.id),shapeIds:this.shapeIds,loops:this.loops.map(t=>t.serialize()),unboundedFace:this.unboundedFace.id,faces:this.faces.map(t=>t.serialize())}}static deserialize(t){const e=new tr,i={},s={},n={},r={},a={},h={};return e.vertices=t.vertices.map(t=>{const e=new Cn(Ge.Vector2IO.fromStateObject(t.point));return i[t.id]=e,e.visited=t.visited,e.visitIndex=t.visitIndex,e.lowIndex=t.lowIndex,e}),e.edges=t.edges.map(t=>{const e=new Rn(en.deserialize(t.segment),i[t.startVertex],i[t.endVertex]);s[t.id]=e,e.signedAreaFragment=t.signedAreaFragment;const r=(t,e)=>{n[e.id]=t,t.isReversed=e.isReversed,t.signedAreaFragment=e.signedAreaFragment,t.startVertex=i[e.startVertex.id],t.endVertex=i[e.endVertex.id],t.sortVector=Ge.Vector2IO.fromStateObject(e.sortVector),t.data=e.data};return r(e.forwardHalf,t.forwardHalf),r(e.reversedHalf,t.reversedHalf),e.visited=t.visited,e.data=t.data,e}),t.vertices.forEach((t,i)=>{e.vertices[i].incidentHalfEdges=t.incidentHalfEdges.map(t=>n[t])}),e.boundaries=t.boundaries.map(t=>{const e=new nr(t.halfEdges.map(t=>n[t]));return r[t.id]=e,e.signedArea=t.signedArea,e.bounds=ui.Bounds2IO.fromStateObject(t.bounds),e}),t.boundaries.forEach((t,i)=>{e.boundaries[i].childBoundaries=t.childBoundaries.map(t=>r[t])}),e.innerBoundaries=t.innerBoundaries.map(t=>r[t]),e.outerBoundaries=t.outerBoundaries.map(t=>r[t]),e.shapeIds=t.shapeIds,e.loops=t.loops.map(t=>{const e=new Zn(t.shapeId,t.closed);return a[t.id]=e,e.halfEdges=t.halfEdges.map(t=>n[t]),e}),e.faces=t.faces.map((t,i)=>{const s=0===i?e.unboundedFace:new kn(r[t.boundary]);return h[t.id]=s,s.holes=t.holes.map(t=>r[t]),s.windingMap=t.windingMap,s.filled=t.filled,s}),t.edges.forEach((t,i)=>{const s=e.edges[i];s.forwardHalf.face=null===t.forwardHalf.face?null:h[t.forwardHalf.face],s.reversedHalf.face=null===t.reversedHalf.face?null:h[t.reversedHalf.face]}),e}addShape(t,e,i){for(let s=0;s<e.subpaths.length;s++)this.addSubpath(t,e.subpaths[s],i)}addSubpath(t,e,i){if(i=m({ensureClosed:!0},i),this.shapeIds.indexOf(t)<0&&this.shapeIds.push(t),0===e.segments.length)return;const s=e.closed||i.ensureClosed,n=i.ensureClosed?e.getFillSegments():e.segments;let r;const a=[];for(r=0;r<n.length;r++){let t=r-1;t<0&&(t=n.length-1);let e=n[t].end;const i=n[r].start;s||0!==r||(e=i),i.equals(e)?a.push(Cn.createFromPool(i)):a.push(Cn.createFromPool(i.average(e)))}s||a.push(Cn.createFromPool(n[n.length-1].end));const h=Zn.createFromPool(t,s);for(r=0;r<n.length;r++){let t=r+1;s&&t===n.length&&(t=0);const e=Rn.createFromPool(n[r],a[r],a[t]);h.halfEdges.push(e.forwardHalf),this.addEdge(e)}this.loops.push(h),this.vertices.push(...a)}computeSimplifiedFaces(){this.eliminateOverlap(),this.eliminateSelfIntersection(),this.eliminateIntersection(),this.collapseVertices(),this.removeBridges(),this.removeLowOrderVertices(),this.orderVertexEdges(),this.extractFaces(),this.computeBoundaryTree(),this.computeWindingMap()}computeFaceInclusion(t){for(let e=0;e<this.faces.length;e++){const i=this.faces[e];i.filled=t(i.windingMap)}}createFilledSubGraph(){const t=new tr,e={};for(let i=0;i<this.edges.length;i++){const s=this.edges[i];if(s.forwardHalf.face.filled!==s.reversedHalf.face.filled){if(!e[s.startVertex.id]){const i=Cn.createFromPool(s.startVertex.point);t.vertices.push(i),e[s.startVertex.id]=i}if(!e[s.endVertex.id]){const i=Cn.createFromPool(s.endVertex.point);t.vertices.push(i),e[s.endVertex.id]=i}const i=e[s.startVertex.id],n=e[s.endVertex.id];t.addEdge(Rn.createFromPool(s.segment,i,n))}}return t.collapseAdjacentEdges(),t.orderVertexEdges(),t.extractFaces(),t.computeBoundaryTree(),t.fillAlternatingFaces(),t}facesToShape(){const t=[];for(let e=0;e<this.faces.length;e++){const i=this.faces[e];if(i.filled){t.push(i.boundary.toSubpath());for(let e=0;e<i.holes.length;e++)t.push(i.holes[e].toSubpath())}}return new Bs.Shape(t)}dispose(){for(;this.boundaries.length;)this.boundaries.pop().dispose();for(ws(this.innerBoundaries),ws(this.outerBoundaries);this.loops.length;)this.loops.pop().dispose();for(;this.faces.length;)this.faces.pop().dispose();for(;this.vertices.length;)this.vertices.pop().dispose();for(;this.edges.length;)this.edges.pop().dispose()}addEdge(t){this.edges.push(t),t.startVertex.incidentHalfEdges.push(t.reversedHalf),t.endVertex.incidentHalfEdges.push(t.forwardHalf)}removeEdge(t){k(this.edges,t),k(t.startVertex.incidentHalfEdges,t.reversedHalf),k(t.endVertex.incidentHalfEdges,t.forwardHalf)}replaceEdgeInLoops(t,e){const i=[];for(let s=0;s<e.length;s++)i.push(e[e.length-1-s].getReversed());for(let s=0;s<this.loops.length;s++){const n=this.loops[s];for(let s=n.halfEdges.length-1;s>=0;s--){const r=n.halfEdges[s];if(r.edge===t){const a=r===t.forwardHalf?e:i;Array.prototype.splice.apply(n.halfEdges,[s,1].concat(a))}}}}collapseAdjacentEdges(){let t=!0;for(;t;){t=!1;for(let e=0;e<this.vertices.length;e++){const i=this.vertices[e];if(2===i.incidentHalfEdges.length){const e=i.incidentHalfEdges[0].edge,s=i.incidentHalfEdges[1].edge;let n=e.segment,r=s.segment;const a=e.getOtherVertex(i),h=s.getOtherVertex(i);if(e.startVertex===i&&(n=n.reversed()),s.endVertex===i&&(r=r.reversed()),n instanceof rn&&r instanceof rn&&n.tangentAt(0).normalized().distance(r.tangentAt(0).normalized())<1e-6){this.removeEdge(e),this.removeEdge(s),e.dispose(),s.dispose(),k(this.vertices,i),i.dispose();const n=new rn(a.point,h.point);this.addEdge(new Rn(n,a,h)),t=!0;break}}}}}eliminateOverlap(){const t=new window.FlatQueue,e=new Wn(1e-4),i=Kn++,s=e=>{const i=e.segment.bounds;t.push({start:!0,edge:e},i.minY-1e-4),t.push({start:!1,edge:e},i.maxY+1e-4)},n=t=>{t.internalData.removedId=i};for(let a=0;a<this.edges.length;a++)s(this.edges[a]);const r=[];for(;t.length;){const a=t.pop(),h=a.edge;if(h.internalData.removedId!==i)if(a.start){let t,i,a=!1;if(e.query(h,e=>{const s=h.segment.getOverlaps(e.segment);if(null!==s&&s.length)for(let n=0;n<s.length;n++){const r=s[n];if(Math.abs(r.t1-r.t0)>1e-5&&Math.abs(r.qt1-r.qt0)>1e-5)return i=this.splitOverlap(h,e,r),a=!0,t=e,!0}return!1}),a){e.removeItem(t),n(t),n(h);for(let t=0;t<i.length;t++)s(i[t]);r.push(h),r.push(t)}else e.addItem(h)}else e.removeItem(h)}for(let a=0;a<r.length;a++)r[a].dispose()}splitOverlap(t,e,i){const s=[],n=t.segment,r=e.segment;this.removeEdge(t),this.removeEdge(e);let a=i.t0,h=i.t1,o=i.qt0,l=i.qt1;a<1e-5&&(a=0),h>.99999&&(h=1),o<1e-5&&(o=0),l>.99999&&(l=1);const u=a>0?n.subdivided(a)[0]:null,m=o>0?r.subdivided(o)[0]:null,d=h<1?n.subdivided(h)[1]:null,c=l<1?r.subdivided(l)[1]:null;let p,g,f=n;a>0&&(f=f.subdivided(a)[1]),h<1&&(f=f.subdivided(ni.linear(a,1,0,1,h))[0]),u&&m?(p=Cn.createFromPool(f.start),this.vertices.push(p)):p=u?i.a>0?e.startVertex:e.endVertex:t.startVertex,d&&c?(g=Cn.createFromPool(f.end),this.vertices.push(g)):g=d?i.a>0?e.endVertex:e.startVertex:t.endVertex;const y=Rn.createFromPool(f,p,g);let x,_,w,v;s.push(y),u&&(x=Rn.createFromPool(u,t.startVertex,p),s.push(x)),d&&(_=Rn.createFromPool(d,g,t.endVertex),s.push(_)),m&&(w=Rn.createFromPool(m,e.startVertex,i.a>0?p:g),s.push(w)),c&&(v=Rn.createFromPool(c,i.a>0?g:p,e.endVertex),s.push(v));for(let M=0;M<s.length;M++)this.addEdge(s[M]);const b=(u?[x]:[]).concat([y]).concat(d?[_]:[]),T=(m?[w]:[]).concat([y]).concat(c?[v]:[]),E=[],A=[];for(let M=0;M<b.length;M++)E.push(b[M].forwardHalf);for(let M=0;M<T.length;M++){const t=T[M]!==y||i.a>0;A.push(t?T[M].forwardHalf:T[M].reversedHalf)}return this.replaceEdgeInLoops(t,E),this.replaceEdgeInLoops(e,A),s}eliminateSelfIntersection(){for(let t=this.edges.length-1;t>=0;t--){const e=this.edges[t],i=e.segment;if(i instanceof yn){const t=i.getSelfIntersection();if(t){const s=i.subdivisions([t.aT,t.bT]),n=Cn.createFromPool(t.point);this.vertices.push(n);const r=Rn.createFromPool(s[0],e.startVertex,n),a=Rn.createFromPool(s[1],n,n),h=Rn.createFromPool(s[2],n,e.endVertex);this.removeEdge(e),this.addEdge(r),this.addEdge(a),this.addEdge(h),this.replaceEdgeInLoops(e,[r.forwardHalf,a.forwardHalf,h.forwardHalf]),e.dispose()}}}}eliminateIntersection(){const t=new window.FlatQueue,e=new Wn(1e-4),i=Kn++,s=e=>{const i=e.segment.bounds;t.push({start:!0,edge:e},i.minY-1e-4),t.push({start:!1,edge:e},i.maxY+1e-4)},n=t=>{t.internalData.removedId=i};for(let a=0;a<this.edges.length;a++)s(this.edges[a]);const r=[];for(;t.length;){const a=t.pop(),h=a.edge;if(h.internalData.removedId!==i)if(a.start){let t,i,a,o=!1;if(e.query(h,e=>{const s=h.segment,n=e.segment;let r=en.intersect(s,n);if(r=r.filter(t=>{const e=t.aT,i=t.bT;return e>1e-5&&e<.99999||i>1e-5&&i<.99999}),r.length){const s=r[0],n=this.simpleSplit(h,e,s.aT,s.bT,s.point);if(n)return o=!0,t=e,i=n.addedEdges,a=n.removedEdges,!0}return!1}),o){a.includes(h)?(n(h),r.push(h)):e.addItem(h),a.includes(t)&&(e.removeItem(t),n(t),r.push(t));for(let t=0;t<i.length;t++)s(i[t])}else e.addItem(h)}else e.removeItem(h)}for(let a=0;a<r.length;a++)r[a].dispose()}simpleSplit(t,e,i,s,n){const r=i>1e-6&&i<.999999,a=s>1e-6&&s<.999999;let h=null;r?a?(h=Cn.createFromPool(n),this.vertices.push(h)):h=s<.5?e.startVertex:e.endVertex:h=i<.5?t.startVertex:t.endVertex;let o=!1;const l=[],u=[];return r&&h!==t.startVertex&&h!==t.endVertex&&(l.push(...this.splitEdge(t,i,h)),u.push(t),o=!0),a&&h!==e.startVertex&&h!==e.endVertex&&(l.push(...this.splitEdge(e,s,h)),u.push(e),o=!0),o?{addedEdges:l,removedEdges:u}:null}splitEdge(t,e,i){const s=t.segment.subdivided(e),n=Rn.createFromPool(s[0],t.startVertex,i),r=Rn.createFromPool(s[1],i,t.endVertex);return this.removeEdge(t),this.addEdge(n),this.addEdge(r),this.replaceEdgeInLoops(t,[n.forwardHalf,r.forwardHalf]),[n,r]}collapseVertices(){const t=new window.FlatQueue,e=new Qn(1e-4),i=Kn++,s=e=>{t.push({start:!0,vertex:e},e.point.y-1e-4),t.push({start:!1,vertex:e},e.point.y+1e-4)},n=t=>{t.internalData.removedId=i};for(let a=0;a<this.vertices.length;a++)s(this.vertices[a]);const r=[];for(;t.length;){const a=t.pop(),h=a.vertex;if(h.internalData.removedId!==i)if(a.start){let t,i,a=!1;if(e.query(h,e=>{const s=h.point.distance(e.point);if(s<1e-5){const n=Cn.createFromPool(0===s?h.point:h.point.average(e.point));this.vertices.push(n),k(this.vertices,h),k(this.vertices,e);for(let t=this.edges.length-1;t>=0;t--){const i=this.edges[t],s=i.startVertex===h||i.startVertex===e,r=i.endVertex===h||i.endVertex===e;if(s&&r){if((i.segment.bounds.width>1e-5||i.segment.bounds.height>1e-5)&&(i.segment instanceof yn||i.segment instanceof _n||i.segment instanceof vn)){const t=Rn.createFromPool(i.segment,n,n);this.addEdge(t),this.replaceEdgeInLoops(i,[t.forwardHalf])}else this.replaceEdgeInLoops(i,[]);this.removeEdge(i),i.dispose()}else s?(i.startVertex=n,n.incidentHalfEdges.push(i.reversedHalf),i.updateReferences()):r&&(i.endVertex=n,n.incidentHalfEdges.push(i.forwardHalf),i.updateReferences())}return i=[n],a=!0,t=e,!0}return!1}),a){e.removeItem(t),n(t),n(h);for(let t=0;t<i.length;t++)s(i[t]);r.push(h),r.push(t)}else e.addItem(h)}else e.removeItem(h)}for(let a=0;a<r.length;a++)r[a].dispose()}markBridges(t,e){e.visited=!0,e.visitIndex=e.lowIndex=Jn++;for(let i=0;i<e.incidentHalfEdges.length;i++){const s=e.incidentHalfEdges[i].edge,n=e.incidentHalfEdges[i].startVertex;n.visited?s.visited||(e.lowIndex=Math.min(e.lowIndex,n.visitIndex)):(s.visited=!0,n.parent=e,this.markBridges(t,n),e.lowIndex=Math.min(e.lowIndex,n.lowIndex),n.lowIndex>e.visitIndex&&t.push(s))}}removeBridges(){const t=[];for(let e=0;e<this.vertices.length;e++){const i=this.vertices[e];i.visited||this.markBridges(t,i)}for(let e=0;e<t.length;e++){const i=t[e];this.removeEdge(i),this.replaceEdgeInLoops(i,[]),i.dispose()}}removeLowOrderVertices(){let t=!0;for(;t;){t=!1;for(let e=this.vertices.length-1;e>=0;e--){const i=this.vertices[e];if(i.incidentHalfEdges.length<2){for(let t=0;t<i.incidentHalfEdges.length;t++){const e=i.incidentHalfEdges[t].edge;this.removeEdge(e),this.replaceEdgeInLoops(e,[]),e.dispose()}this.vertices.splice(e,1),i.dispose(),t=!0;break}}}}orderVertexEdges(){for(let t=0;t<this.vertices.length;t++)this.vertices[t].sortEdges()}extractFaces(){const t=[];for(let e=0;e<this.edges.length;e++)t.push(this.edges[e].forwardHalf),t.push(this.edges[e].reversedHalf);for(;t.length;){const e=[];let i=t[0];const s=i;for(;i&&(k(t,i),e.push(i),i=i.getNext(),i!==s););const n=nr.createFromPool(e);(n.signedArea>0?this.innerBoundaries:this.outerBoundaries).push(n),this.boundaries.push(n)}for(let e=0;e<this.innerBoundaries.length;e++)this.faces.push(kn.createFromPool(this.innerBoundaries[e]))}computeBoundaryTree(){const t=[],e=new gs(ts.rotation2(1.5729657));for(let i=0;i<this.outerBoundaries.length;i++){const s=this.outerBoundaries[i],n=s.computeExtremeRay(e);let r=null,a=Number.POSITIVE_INFINITY,h=!1;for(let t=0;t<this.edges.length;t++){const e=this.edges[t],i=e.segment.intersection(n);for(let t=0;t<i.length;t++){const s=i[t];s.distance<a&&(r=e,a=s.distance,h=s.wind)}}if(null===r)t.push(s);else{const t=h<0?r.reversedHalf:r.forwardHalf;this.getBoundaryOfHalfEdge(t).childBoundaries.push(s)}}t.forEach(this.unboundedFace.recursivelyAddHoles.bind(this.unboundedFace));for(let i=0;i<this.faces.length;i++){const t=this.faces[i];null!==t.boundary&&t.boundary.childBoundaries.forEach(t.recursivelyAddHoles.bind(t))}}computeWindingMap(){const t=this.edges.slice(),e={};for(let i=0;i<this.shapeIds.length;i++)e[this.shapeIds[i]]=0;for(this.unboundedFace.windingMap=e;t.length;)for(let e=t.length-1;e>=0;e--){const i=t[e],s=i.forwardHalf,n=i.reversedHalf,r=s.face,a=n.face,h=null!==r.windingMap,o=null!==a.windingMap;if(h&&o)t.splice(e,1);else{if(!h&&!o)continue;{const t=h?r:a,e=h?a:r,s={};for(let n=0;n<this.shapeIds.length;n++){const e=this.shapeIds[n],r=this.computeDifferential(i,e);s[e]=t.windingMap[e]+r*(h?-1:1)}e.windingMap=s}}}}computeDifferential(t,e){let i=0;for(let s=0;s<this.loops.length;s++){const n=this.loops[s];if(n.shapeId===e)for(let e=0;e<n.halfEdges.length;e++){const s=n.halfEdges[e];s===t.forwardHalf?i++:s===t.reversedHalf&&i--}}return i}fillAlternatingFaces(){let t=0;for(let e=0;e<this.faces.length;e++)this.faces[e].filled=null,t++;for(this.unboundedFace.filled=!1,t--;t;)for(let e=0;e<this.edges.length;e++){const i=this.edges[e],s=i.forwardHalf.face,n=i.reversedHalf.face,r=null===s.filled,a=null===n.filled;r&&!a?(s.filled=!n.filled,t--):!r&&a&&(n.filled=!s.filled,t--)}}getBoundaryOfHalfEdge(t){for(let e=0;e<this.boundaries.length;e++){const i=this.boundaries[e];if(i.hasHalfEdge(t))return i}throw new Error("Could not find boundary")}static BINARY_NONZERO_UNION(t){return 0!==t[0]||0!==t[1]}static BINARY_NONZERO_INTERSECTION(t){return 0!==t[0]&&0!==t[1]}static BINARY_NONZERO_DIFFERENCE(t){return 0!==t[0]&&0===t[1]}static BINARY_NONZERO_XOR(t){return 1==(0!==t[0]^0!==t[1])}static binaryResult(t,e,i){const s=new tr;s.addShape(0,t),s.addShape(1,e),s.computeSimplifiedFaces(),s.computeFaceInclusion(i);const n=s.createFilledSubGraph(),r=n.facesToShape();return s.dispose(),n.dispose(),r}static unionNonZero(t){const e=new tr;for(let n=0;n<t.length;n++)e.addShape(n,t[n]);e.computeSimplifiedFaces(),e.computeFaceInclusion(e=>{for(let i=0;i<t.length;i++)if(0!==e[i])return!0;return!1});const i=e.createFilledSubGraph(),s=i.facesToShape();return e.dispose(),i.dispose(),s}static intersectionNonZero(t){const e=new tr;for(let n=0;n<t.length;n++)e.addShape(n,t[n]);e.computeSimplifiedFaces(),e.computeFaceInclusion(e=>{for(let i=0;i<t.length;i++)if(0===e[i])return!1;return!0});const i=e.createFilledSubGraph(),s=i.facesToShape();return e.dispose(),i.dispose(),s}static xorNonZero(t){const e=new tr;for(let n=0;n<t.length;n++)e.addShape(n,t[n]);e.computeSimplifiedFaces(),e.computeFaceInclusion(e=>{let i=!1;for(let s=0;s<t.length;s++)0!==e[s]&&(i=!i);return i});const i=e.createFilledSubGraph(),s=i.facesToShape();return e.dispose(),i.dispose(),s}static simplifyNonZero(t){const e=new tr;e.addShape(0,t),e.computeSimplifiedFaces(),e.computeFaceInclusion(t=>0!==t[0]);const i=e.createFilledSubGraph(),s=i.facesToShape();return e.dispose(),i.dispose(),s}static clipShape(t,e,i){let s,n,r;i=m({includeExterior:!1,includeBoundary:!0,includeInterior:!0},i);const a=tr.simplifyNonZero(t),h=new tr;for(h.addShape(0,e,{ensureClosed:!1}),h.addShape(1,a),h.eliminateOverlap(),h.eliminateSelfIntersection(),h.eliminateIntersection(),h.collapseVertices(),s=0;s<h.loops.length;s++)if(r=h.loops[s],1===r.shapeId)for(n=0;n<r.halfEdges.length;n++)r.halfEdges[n].edge.data=!0;const o=[];for(s=0;s<h.loops.length;s++)if(r=h.loops[s],0===r.shapeId){let t=[];for(n=0;n<r.halfEdges.length;n++){const e=r.halfEdges[n];(e.edge.data?i.includeBoundary:a.containsPoint(e.edge.segment.positionAt(.5))?i.includeInterior:i.includeExterior)?t.push(e.getDirectionalSegment()):t.length&&(o.push(new En(t,void 0,r.closed)),t=[])}t.length&&o.push(new En(t,void 0,r.closed))}return h.dispose(),new Bs.Shape(o)}}Bs.register("Graph",tr);const er=tr;let ir=0;class sr{constructor(t){this.id=++ir,this.initialize(t)}initialize(t){return this.halfEdges=t,this.signedArea=this.computeSignedArea(),this.bounds=this.computeBounds(),this.childBoundaries=ws(this.childBoundaries),this}serialize(){return{type:"Boundary",id:this.id,halfEdges:this.halfEdges.map(t=>t.id),signedArea:this.signedArea,bounds:ui.Bounds2IO.toStateObject(this.bounds),childBoundaries:this.childBoundaries.map(t=>t.id)}}dispose(){this.halfEdges=[],ws(this.childBoundaries),this.freeToPool()}isInner(){return this.signedArea>0}computeSignedArea(){let t=0;for(let e=0;e<this.halfEdges.length;e++)t+=this.halfEdges[e].signedAreaFragment;return t}computeBounds(){const t=ui.NOTHING.copy();for(let e=0;e<this.halfEdges.length;e++)t.includeBounds(this.halfEdges[e].edge.segment.getBounds());return t}computeExtremePoint(t){const e=[];for(let s=0;s<this.halfEdges.length;s++)e.push(this.halfEdges[s].edge.segment.transformed(t.getMatrix()));const i=ui.NOTHING.copy();for(let s=0;s<e.length;s++)i.includeBounds(e[s].getBounds());for(let s=0;s<e.length;s++){const n=e[s];if(n.getBounds().top===i.top){let e=new Ge(0,Number.POSITIVE_INFINITY);const i=[0,1].concat(n.getInteriorExtremaTs());for(let t=0;t<i.length;t++){const s=n.positionAt(i[t]);s.y<e.y&&(e=s)}return t.inversePosition2(e)}}throw new Error("Should not reach here if we have segments")}computeExtremeRay(t){const e=this.computeExtremePoint(t),i=t.inverseDelta2(new Ge(0,-1)).normalized();return new ls(e.plus(i.timesScalar(1e-4)),i)}hasHalfEdge(t){for(let e=0;e<this.halfEdges.length;e++)if(this.halfEdges[e]===t)return!0;return!1}toSubpath(){const t=[];for(let e=0;e<this.halfEdges.length;e++)t.push(this.halfEdges[e].getDirectionalSegment());return new En(t,null,!0)}}Bs.register("Boundary",sr),yi.mixInto(sr);const nr=sr;if(!window.hasOwnProperty("_"))throw new Error("Underscore/Lodash not found: _")})()})()}();